[0;34m[2025-07-09 18:23:16][0m Running all Pest tests
[0;34m[2025-07-09 18:23:17][0m Starting Pest test run with ID: 1752081796
[0;34m[2025-07-09 18:23:17][0m Using test database: lifespan_beta_testing

  [37;44m INFO [39;49m Configuration cache cleared successfully.  


  [37;44m INFO [39;49m Application cache cleared successfully.  


  Dropping all tables [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 137ms[39m [32;1mDONE[39;22m

  [37;44m INFO [39;49m Preparing database.  

  Creating migration table [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 9ms[39m [32;1mDONE[39;22m

  [37;44m INFO [39;49m Running migrations.  

  2018_08_08_100000_create_telescope_entries_table [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 39ms[39m [32;1mDONE[39;22m
  2019_12_14_000001_create_personal_access_tokens_table [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 8ms[39m [32;1mDONE[39;22m
  2023_09_29_000000_prepare_testing_environment [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2024_02_06_000000_create_temporal_constraints_table [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 0ms[39m [32;1mDONE[39;22m
  2024_02_07_000000_create_base_schema [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 83ms[39m [32;1mDONE[39;22m
  2024_03_19_000000_remove_redundant_span_types [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2024_03_20_000000_add_thing_span_type [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 0ms[39m [32;1mDONE[39;22m
  2024_03_20_000000_update_connection_type_allowed_spans [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 2ms[39m [32;1mDONE[39;22m
  2024_03_20_000001_add_created_connection_type [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2024_03_20_000001_create_connections_view [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2024_03_20_000002_add_band_span_type [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 0ms[39m [32;1mDONE[39;22m
  2024_03_20_000003_update_created_connection_allowed_types [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 0ms[39m [32;1mDONE[39;22m
  2024_03_20_000004_update_membership_connection_allowed_types [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 0ms[39m [32;1mDONE[39;22m
  2024_03_20_000005_fix_membership_connection_directions [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2024_03_20_000005_update_band_span_type_metadata [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 0ms[39m [32;1mDONE[39;22m
  2024_03_21_000000_add_contains_connection_type [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2024_03_21_000000_update_connection_span_type_metadata [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2024_03_21_000001_add_contains_connection_type [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 0ms[39m [32;1mDONE[39;22m
  2024_03_21_000001_rename_connection_spans_to_spo [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 2ms[39m [32;1mDONE[39;22m
  2024_03_21_000002_sync_connection_span_metadata [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2024_03_27_000000_create_invitation_codes_table [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 16ms[39m [32;1mDONE[39;22m
  2024_04_02_000000_change_invitation_codes_id_to_uuid [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 10ms[39m [32;1mDONE[39;22m
  2025_02_14_000001_create_span_connections_view [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 9ms[39m [32;1mDONE[39;22m
  2025_03_02_213453_drop_connection_unique_constraint [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2025_03_02_214232_add_temporal_constraint_triggers [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 0ms[39m [32;1mDONE[39;22m
  2025_03_03_194256_fix_temporal_constraints [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 6ms[39m [32;1mDONE[39;22m
  2025_03_13_182254_update_span_types_use_subtype [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 2ms[39m [32;1mDONE[39;22m
  2025_03_24_000000_add_family_connection_date_trigger [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2025_03_24_000000_fix_placeholder_temporal_constraints [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 2ms[39m [32;1mDONE[39;22m
  2025_03_24_000001_clarify_placeholder_date_validation [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2025_04_18_145646_add_personal_span_constraint [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 2ms[39m [32;1mDONE[39;22m
  2025_06_27_121217_create_unified_span_schema [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 8ms[39m [32;1mDONE[39;22m
  2025_06_27_130151_enhance_thing_subtypes [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 2ms[39m [32;1mDONE[39;22m
  2025_06_27_130416_enhance_organisation_subtypes [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2025_06_27_132650_create_role_span_type [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2025_06_27_140000_add_has_role_connection_type [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2025_06_27_140100_add_at_organisation_connection_type [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2025_06_27_191813_remove_attendance_connection_type [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2025_07_03_000000_make_things_public_by_default [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 0ms[39m [32;1mDONE[39;22m
  2025_07_03_140758_add_located_connection_type [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 2ms[39m [32;1mDONE[39;22m
  2025_07_03_141708_add_timeless_property_to_span_types [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2025_07_03_144821_create_set_span_type_and_contains_connection [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2025_07_03_164346_update_temporal_constraint_for_timeless_spans [90m.[39m[90m.[39m[90m.[39m[90m 4ms[39m [32;1mDONE[39;22m
  2025_07_03_180008_add_filter_fields_to_spans_table [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2025_07_03_220000_add_has_set_connection_type [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2025_07_03_230000_add_subtype_to_set_span_type [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2025_07_04_160410_remove_connection_type_from_metadata_schema [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 2ms[39m [32;1mDONE[39;22m
  2025_07_04_223556_create_span_versions_table [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 23ms[39m [32;1mDONE[39;22m
  2025_07_04_223751_create_connection_versions_table [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 9ms[39m [32;1mDONE[39;22m
  2025_07_06_130352_add_initial_versions_for_existing_spans_and_connections [2025-07-09T17:23:19.503333+00:00] testing.INFO: Migration: Added initial versions {"spans_processed":0,"connections_processed":0} []
[2025-07-09 17:23:19] testing.INFO: Migration: Added initial versions {"spans_processed":0,"connections_processed":0} 

[90m 14ms[39m [32;1mDONE[39;22m
  2025_07_08_064600_add_during_connection_type [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2025_07_08_113538_add_phase_span_type [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 1ms[39m [32;1mDONE[39;22m
  2025_07_08_165019_create_sessions_table [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 15ms[39m [32;1mDONE[39;22m
  2025_07_08_175128_add_set_performance_indexes [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 8ms[39m [32;1mDONE[39;22m
  2025_07_09_000000_optimize_desert_island_discs_indexes [90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m.[39m[90m 6ms[39m [32;1mDONE[39;22m


  [90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m
Descendants of Grandparent 1:
- Parent 1 (ID: 9f59d565-d80c-4052-a215-0eae2d609e87, Generation: 1)
- Child (ID: 9f59d566-0001-44a3-8e28-40eaa634ffdd, Generation: 2)
- Sibling (ID: 9f59d566-09ae-45be-9c2c-c40ff36340ad, Generation: 2)
- Uncle (ID: 9f59d565-ebee-4241-9d88-7a7d47079c9c, Generation: 1)
- Cousin (ID: 9f59d565-f567-48d6-8f9c-3cb32025e0ce, Generation: 2)
[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m
  [90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[33;1ms[39;22m[33;1ms[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[33;1ms[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[90;1m.[39;22m[90;1m.[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[90;1m.[39;22m[33;1ms[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[31;1m⨯[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m
  [90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[33;1ms[39;22m[31;1m⨯[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[31;1m⨯[39;22m[31;1m⨯[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[33;1ms[39;22m[90;1m.[39;22m[90;1m.[39;22m[33;1ms[39;22m[33;1ms[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[31;1m⨯[39;22m[31;1m⨯[39;22m[2025-07-09T17:24:27.815768+00:00] testing.ERROR: MusicBrainz API error {"status":404,"body":"{\"error\":\"Not found\"}"} []
[2025-07-09 17:24:27] testing.ERROR: MusicBrainz API error {"status":404,"body":"{\"error\":\"Not found\"}"} 

[31;1m⨯[39;22m[31;1m⨯[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m
  [90;1m.[39;22m[90;1m.[39;22m[2025-07-09T17:24:29.587734+00:00] testing.ERROR: SQLSTATE[23503]: Foreign key violation: 7 ERROR:  update or delete on table "users" violates foreign key constraint "span_versions_changed_by_foreign" on table "span_versions" DETAIL:  Key (id)=(9f59d5be-a2ac-47c6-a8db-2525e4910806) is still referenced from table "span_versions". (Connection: testing, SQL: delete from "users" where "id" = 9f59d5be-a2ac-47c6-a8db-2525e4910806) {"exception":"[object] (Illuminate\\Database\\QueryException(code: 23503): SQLSTATE[23503]: Foreign key violation: 7 ERROR:  update or delete on table \"users\" violates foreign key constraint \"span_versions_changed_by_foreign\" on table \"span_versions\"\nDETAIL:  Key (id)=(9f59d5be-a2ac-47c6-a8db-2525e4910806) is still referenced from table \"span_versions\". (Connection: testing, SQL: delete from \"users\" where \"id\" = 9f59d5be-a2ac-47c6-a8db-2525e4910806) at /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php:829)\n[previous exception] [object] (PDOException(code: 23503): SQLSTATE[23503]: Foreign key violation: 7 ERROR:  update or delete on table \"users\" violates foreign key constraint \"span_versions_changed_by_foreign\" on table \"span_versions\"\nDETAIL:  Key (id)=(9f59d5be-a2ac-47c6-a8db-2525e4910806) is still referenced from table \"span_versions\". at /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php:612)"} []
[2025-07-09 17:24:29] testing.ERROR: SQLSTATE[23503]: Foreign key violation: 7 ERROR:  update or delete on table "users" violates foreign key constraint "span_versions_changed_by_foreign" on table "span_versions"
DETAIL:  Key (id)=(9f59d5be-a2ac-47c6-a8db-2525e4910806) is still referenced from table "span_versions". (Connection: testing, SQL: delete from "users" where "id" = 9f59d5be-a2ac-47c6-a8db-2525e4910806) {"exception":"[object] (Illuminate\\Database\\QueryException(code: 23503): SQLSTATE[23503]: Foreign key violation: 7 ERROR:  update or delete on table \"users\" violates foreign key constraint \"span_versions_changed_by_foreign\" on table \"span_versions\"
DETAIL:  Key (id)=(9f59d5be-a2ac-47c6-a8db-2525e4910806) is still referenced from table \"span_versions\". (Connection: testing, SQL: delete from \"users\" where \"id\" = 9f59d5be-a2ac-47c6-a8db-2525e4910806) at /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php:829)
[stacktrace]
#0 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(783): Illuminate\\Database\\Connection->runQueryCallback('delete from \"us...', Array, Object(Closure))
#1 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(600): Illuminate\\Database\\Connection->run('delete from \"us...', Array, Object(Closure))
#2 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(564): Illuminate\\Database\\Connection->affectingStatement('delete from \"us...', Array)
#3 /var/www/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php(3796): Illuminate\\Database\\Connection->delete('delete from \"us...', Array)
#4 /var/www/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php(1273): Illuminate\\Database\\Query\\Builder->delete()
#5 /var/www/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php(1463): Illuminate\\Database\\Eloquent\\Builder->delete()
#6 /var/www/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php(1408): Illuminate\\Database\\Eloquent\\Model->performDeleteOnModel()
#7 /var/www/app/Http/Controllers/ProfileController.php(161): Illuminate\\Database\\Eloquent\\Model->delete()
#8 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Controller.php(54): App\\Http\\Controllers\\ProfileController->destroy(Object(Illuminate\\Http\\Request))
#9 /var/www/vendor/laravel/framework/src/Illuminate/Routing/ControllerDispatcher.php(43): Illuminate\\Routing\\Controller->callAction('destroy', Array)
#10 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Route.php(259): Illuminate\\Routing\\ControllerDispatcher->dispatch(Object(Illuminate\\Routing\\Route), Object(App\\Http\\Controllers\\ProfileController), 'destroy')
#11 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Route.php(205): Illuminate\\Routing\\Route->runController()
#12 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(806): Illuminate\\Routing\\Route->run()
#13 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(144): Illuminate\\Routing\\Router->Illuminate\\Routing\\{closure}(Object(Illuminate\\Http\\Request))
#14 /var/www/vendor/barryvdh/laravel-debugbar/src/Middleware/InjectDebugbar.php(59): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#15 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Barryvdh\\Debugbar\\Middleware\\InjectDebugbar->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#16 /var/www/app/Http/Middleware/LoadUserRelations.php(46): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#17 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\\Http\\Middleware\\LoadUserRelations->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#18 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Middleware/SubstituteBindings.php(50): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#19 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Routing\\Middleware\\SubstituteBindings->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#20 /var/www/vendor/laravel/framework/src/Illuminate/Auth/Middleware/Authenticate.php(57): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#21 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Auth\\Middleware\\Authenticate->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#22 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php(180): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#23 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): class@anonymous->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#24 /var/www/vendor/laravel/framework/src/Illuminate/View/Middleware/ShareErrorsFromSession.php(49): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#25 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\View\\Middleware\\ShareErrorsFromSession->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#26 /var/www/vendor/laravel/framework/src/Illuminate/Session/Middleware/StartSession.php(121): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#27 /var/www/vendor/laravel/framework/src/Illuminate/Session/Middleware/StartSession.php(64): Illuminate\\Session\\Middleware\\StartSession->handleStatefulRequest(Object(Illuminate\\Http\\Request), Object(Illuminate\\Session\\Store), Object(Closure))
#28 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Session\\Middleware\\StartSession->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#29 /var/www/vendor/laravel/framework/src/Illuminate/Cookie/Middleware/AddQueuedCookiesToResponse.php(37): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#30 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Cookie\\Middleware\\AddQueuedCookiesToResponse->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#31 /var/www/vendor/laravel/framework/src/Illuminate/Cookie/Middleware/EncryptCookies.php(67): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#32 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Cookie\\Middleware\\EncryptCookies->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#33 /var/www/app/Http/Middleware/FixSessionInRailway.php(46): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#34 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\\Http\\Middleware\\FixSessionInRailway->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#35 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(119): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#36 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(805): Illuminate\\Pipeline\\Pipeline->then(Object(Closure))
#37 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(784): Illuminate\\Routing\\Router->runRouteWithinStack(Object(Illuminate\\Routing\\Route), Object(Illuminate\\Http\\Request))
#38 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(748): Illuminate\\Routing\\Router->runRoute(Object(Illuminate\\Http\\Request), Object(Illuminate\\Routing\\Route))
#39 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(737): Illuminate\\Routing\\Router->dispatchToRoute(Object(Illuminate\\Http\\Request))
#40 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(200): Illuminate\\Routing\\Router->dispatch(Object(Illuminate\\Http\\Request))
#41 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(144): Illuminate\\Foundation\\Http\\Kernel->Illuminate\\Foundation\\Http\\{closure}(Object(Illuminate\\Http\\Request))
#42 /var/www/vendor/barryvdh/laravel-debugbar/src/Middleware/InjectDebugbar.php(59): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#43 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Barryvdh\\Debugbar\\Middleware\\InjectDebugbar->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#44 /var/www/vendor/sentry/sentry-laravel/src/Sentry/Laravel/Http/FlushEventsMiddleware.php(13): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#45 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Sentry\\Laravel\\Http\\FlushEventsMiddleware->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#46 /var/www/vendor/sentry/sentry-laravel/src/Sentry/Laravel/Http/SetRequestIpMiddleware.php(45): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#47 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Sentry\\Laravel\\Http\\SetRequestIpMiddleware->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#48 /var/www/vendor/sentry/sentry-laravel/src/Sentry/Laravel/Http/SetRequestMiddleware.php(31): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#49 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Sentry\\Laravel\\Http\\SetRequestMiddleware->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#50 /var/www/app/Http/Middleware/DatabaseConnectionLogger.php(48): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#51 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\\Http\\Middleware\\DatabaseConnectionLogger->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#52 /var/www/app/Http/Middleware/RequestResponseLogger.php(22): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#53 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\\Http\\Middleware\\RequestResponseLogger->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#54 /var/www/app/Http/Middleware/ForceHttpsInProduction.php(30): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#55 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\\Http\\Middleware\\ForceHttpsInProduction->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#56 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#57 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/ConvertEmptyStringsToNull.php(31): Illuminate\\Foundation\\Http\\Middleware\\TransformsRequest->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#58 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Foundation\\Http\\Middleware\\ConvertEmptyStringsToNull->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#59 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#60 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TrimStrings.php(40): Illuminate\\Foundation\\Http\\Middleware\\TransformsRequest->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#61 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Foundation\\Http\\Middleware\\TrimStrings->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#62 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/ValidatePostSize.php(27): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#63 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Foundation\\Http\\Middleware\\ValidatePostSize->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#64 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/PreventRequestsDuringMaintenance.php(99): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#65 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Foundation\\Http\\Middleware\\PreventRequestsDuringMaintenance->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#66 /var/www/vendor/laravel/framework/src/Illuminate/Http/Middleware/HandleCors.php(49): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#67 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Http\\Middleware\\HandleCors->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#68 /var/www/vendor/laravel/framework/src/Illuminate/Http/Middleware/TrustProxies.php(39): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#69 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Http\\Middleware\\TrustProxies->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#70 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(119): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#71 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(175): Illuminate\\Pipeline\\Pipeline->then(Object(Closure))
#72 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(144): Illuminate\\Foundation\\Http\\Kernel->sendRequestThroughRouter(Object(Illuminate\\Http\\Request))
#73 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php(585): Illuminate\\Foundation\\Http\\Kernel->handle(Object(Illuminate\\Http\\Request))
#74 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php(465): Illuminate\\Foundation\\Testing\\TestCase->call('DELETE', '/profile', Array, Array, Array, Array)
#75 /var/www/tests/Feature/ProfileTest.php(102): Illuminate\\Foundation\\Testing\\TestCase->delete('/profile', Array)
#76 /var/www/vendor/phpunit/phpunit/src/Framework/TestCase.php(1188): Tests\\Feature\\ProfileTest->test_user_can_delete_their_account()
#77 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/TestCase.php(61): PHPUnit\\Framework\\TestCase->runTest()
#78 /var/www/vendor/phpunit/phpunit/src/Framework/TestCase.php(687): Illuminate\\Foundation\\Testing\\TestCase->runTest()
#79 /var/www/vendor/phpunit/phpunit/src/Framework/TestRunner.php(106): PHPUnit\\Framework\\TestCase->runBare()
#80 /var/www/vendor/phpunit/phpunit/src/Framework/TestCase.php(517): PHPUnit\\Framework\\TestRunner->run(Object(Tests\\Feature\\ProfileTest))
#81 /var/www/vendor/phpunit/phpunit/src/Framework/TestSuite.php(380): PHPUnit\\Framework\\TestCase->run()
#82 /var/www/vendor/phpunit/phpunit/src/Framework/TestSuite.php(380): PHPUnit\\Framework\\TestSuite->run()
#83 /var/www/vendor/phpunit/phpunit/src/Framework/TestSuite.php(380): PHPUnit\\Framework\\TestSuite->run()
#84 /var/www/vendor/phpunit/phpunit/src/TextUI/TestRunner.php(64): PHPUnit\\Framework\\TestSuite->run()
#85 /var/www/vendor/phpunit/phpunit/src/TextUI/Application.php(202): PHPUnit\\TextUI\\TestRunner->run(Object(PHPUnit\\TextUI\\Configuration\\Configuration), Object(PHPUnit\\Runner\\ResultCache\\DefaultResultCache), Object(PHPUnit\\Framework\\TestSuite))
#86 /var/www/vendor/pestphp/pest/src/Kernel.php(103): PHPUnit\\TextUI\\Application->run(Array)
#87 /var/www/vendor/pestphp/pest/bin/pest(91): Pest\\Kernel->handle(Array, Array)
#88 /var/www/vendor/pestphp/pest/bin/pest(99): {closure}()
#89 /var/www/vendor/bin/pest(119): include('/var/www/vendor...')
#90 {main}

[previous exception] [object] (PDOException(code: 23503): SQLSTATE[23503]: Foreign key violation: 7 ERROR:  update or delete on table \"users\" violates foreign key constraint \"span_versions_changed_by_foreign\" on table \"span_versions\"
DETAIL:  Key (id)=(9f59d5be-a2ac-47c6-a8db-2525e4910806) is still referenced from table \"span_versions\". at /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php:612)
[stacktrace]
#0 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(612): PDOStatement->execute()
#1 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(816): Illuminate\\Database\\Connection->Illuminate\\Database\\{closure}('delete from \"us...', Array)
#2 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(783): Illuminate\\Database\\Connection->runQueryCallback('delete from \"us...', Array, Object(Closure))
#3 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(600): Illuminate\\Database\\Connection->run('delete from \"us...', Array, Object(Closure))
#4 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(564): Illuminate\\Database\\Connection->affectingStatement('delete from \"us...', Array)
#5 /var/www/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php(3796): Illuminate\\Database\\Connection->delete('delete from \"us...', Array)
#6 /var/www/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php(1273): Illuminate\\Database\\Query\\Builder->delete()
#7 /var/www/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php(1463): Illuminate\\Database\\Eloquent\\Builder->delete()
#8 /var/www/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php(1408): Illuminate\\Database\\Eloquent\\Model->performDeleteOnModel()
#9 /var/www/app/Http/Controllers/ProfileController.php(161): Illuminate\\Database\\Eloquent\\Model->delete()
#10 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Controller.php(54): App\\Http\\Controllers\\ProfileController->destroy(Object(Illuminate\\Http\\Request))
#11 /var/www/vendor/laravel/framework/src/Illuminate/Routing/ControllerDispatcher.php(43): Illuminate\\Routing\\Controller->callAction('destroy', Array)
#12 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Route.php(259): Illuminate\\Routing\\ControllerDispatcher->dispatch(Object(Illuminate\\Routing\\Route), Object(App\\Http\\Controllers\\ProfileController), 'destroy')
#13 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Route.php(205): Illuminate\\Routing\\Route->runController()
#14 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(806): Illuminate\\Routing\\Route->run()
#15 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(144): Illuminate\\Routing\\Router->Illuminate\\Routing\\{closure}(Object(Illuminate\\Http\\Request))
#16 /var/www/vendor/barryvdh/laravel-debugbar/src/Middleware/InjectDebugbar.php(59): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#17 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Barryvdh\\Debugbar\\Middleware\\InjectDebugbar->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#18 /var/www/app/Http/Middleware/LoadUserRelations.php(46): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#19 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\\Http\\Middleware\\LoadUserRelations->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#20 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Middleware/SubstituteBindings.php(50): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#21 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Routing\\Middleware\\SubstituteBindings->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#22 /var/www/vendor/laravel/framework/src/Illuminate/Auth/Middleware/Authenticate.php(57): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#23 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Auth\\Middleware\\Authenticate->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#24 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php(180): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#25 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): class@anonymous->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#26 /var/www/vendor/laravel/framework/src/Illuminate/View/Middleware/ShareErrorsFromSession.php(49): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#27 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\View\\Middleware\\ShareErrorsFromSession->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#28 /var/www/vendor/laravel/framework/src/Illuminate/Session/Middleware/StartSession.php(121): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#29 /var/www/vendor/laravel/framework/src/Illuminate/Session/Middleware/StartSession.php(64): Illuminate\\Session\\Middleware\\StartSession->handleStatefulRequest(Object(Illuminate\\Http\\Request), Object(Illuminate\\Session\\Store), Object(Closure))
#30 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Session\\Middleware\\StartSession->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#31 /var/www/vendor/laravel/framework/src/Illuminate/Cookie/Middleware/AddQueuedCookiesToResponse.php(37): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#32 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Cookie\\Middleware\\AddQueuedCookiesToResponse->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#33 /var/www/vendor/laravel/framework/src/Illuminate/Cookie/Middleware/EncryptCookies.php(67): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#34 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Cookie\\Middleware\\EncryptCookies->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#35 /var/www/app/Http/Middleware/FixSessionInRailway.php(46): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#36 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\\Http\\Middleware\\FixSessionInRailway->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#37 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(119): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#38 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(805): Illuminate\\Pipeline\\Pipeline->then(Object(Closure))
#39 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(784): Illuminate\\Routing\\Router->runRouteWithinStack(Object(Illuminate\\Routing\\Route), Object(Illuminate\\Http\\Request))
#40 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(748): Illuminate\\Routing\\Router->runRoute(Object(Illuminate\\Http\\Request), Object(Illuminate\\Routing\\Route))
#41 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(737): Illuminate\\Routing\\Router->dispatchToRoute(Object(Illuminate\\Http\\Request))
#42 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(200): Illuminate\\Routing\\Router->dispatch(Object(Illuminate\\Http\\Request))
#43 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(144): Illuminate\\Foundation\\Http\\Kernel->Illuminate\\Foundation\\Http\\{closure}(Object(Illuminate\\Http\\Request))
#44 /var/www/vendor/barryvdh/laravel-debugbar/src/Middleware/InjectDebugbar.php(59): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#45 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Barryvdh\\Debugbar\\Middleware\\InjectDebugbar->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#46 /var/www/vendor/sentry/sentry-laravel/src/Sentry/Laravel/Http/FlushEventsMiddleware.php(13): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#47 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Sentry\\Laravel\\Http\\FlushEventsMiddleware->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#48 /var/www/vendor/sentry/sentry-laravel/src/Sentry/Laravel/Http/SetRequestIpMiddleware.php(45): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#49 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Sentry\\Laravel\\Http\\SetRequestIpMiddleware->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#50 /var/www/vendor/sentry/sentry-laravel/src/Sentry/Laravel/Http/SetRequestMiddleware.php(31): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#51 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Sentry\\Laravel\\Http\\SetRequestMiddleware->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#52 /var/www/app/Http/Middleware/DatabaseConnectionLogger.php(48): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#53 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\\Http\\Middleware\\DatabaseConnectionLogger->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#54 /var/www/app/Http/Middleware/RequestResponseLogger.php(22): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#55 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\\Http\\Middleware\\RequestResponseLogger->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#56 /var/www/app/Http/Middleware/ForceHttpsInProduction.php(30): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#57 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\\Http\\Middleware\\ForceHttpsInProduction->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#58 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#59 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/ConvertEmptyStringsToNull.php(31): Illuminate\\Foundation\\Http\\Middleware\\TransformsRequest->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#60 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Foundation\\Http\\Middleware\\ConvertEmptyStringsToNull->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#61 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#62 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TrimStrings.php(40): Illuminate\\Foundation\\Http\\Middleware\\TransformsRequest->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#63 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Foundation\\Http\\Middleware\\TrimStrings->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#64 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/ValidatePostSize.php(27): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#65 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Foundation\\Http\\Middleware\\ValidatePostSize->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#66 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/PreventRequestsDuringMaintenance.php(99): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#67 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Foundation\\Http\\Middleware\\PreventRequestsDuringMaintenance->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#68 /var/www/vendor/laravel/framework/src/Illuminate/Http/Middleware/HandleCors.php(49): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#69 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Http\\Middleware\\HandleCors->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#70 /var/www/vendor/laravel/framework/src/Illuminate/Http/Middleware/TrustProxies.php(39): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#71 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\\Http\\Middleware\\TrustProxies->handle(Object(Illuminate\\Http\\Request), Object(Closure))
#72 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(119): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}(Object(Illuminate\\Http\\Request))
#73 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(175): Illuminate\\Pipeline\\Pipeline->then(Object(Closure))
#74 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(144): Illuminate\\Foundation\\Http\\Kernel->sendRequestThroughRouter(Object(Illuminate\\Http\\Request))
#75 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php(585): Illuminate\\Foundation\\Http\\Kernel->handle(Object(Illuminate\\Http\\Request))
#76 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php(465): Illuminate\\Foundation\\Testing\\TestCase->call('DELETE', '/profile', Array, Array, Array, Array)
#77 /var/www/tests/Feature/ProfileTest.php(102): Illuminate\\Foundation\\Testing\\TestCase->delete('/profile', Array)
#78 /var/www/vendor/phpunit/phpunit/src/Framework/TestCase.php(1188): Tests\\Feature\\ProfileTest->test_user_can_delete_their_account()
#79 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/TestCase.php(61): PHPUnit\\Framework\\TestCase->runTest()
#80 /var/www/vendor/phpunit/phpunit/src/Framework/TestCase.php(687): Illuminate\\Foundation\\Testing\\TestCase->runTest()
#81 /var/www/vendor/phpunit/phpunit/src/Framework/TestRunner.php(106): PHPUnit\\Framework\\TestCase->runBare()
#82 /var/www/vendor/phpunit/phpunit/src/Framework/TestCase.php(517): PHPUnit\\Framework\\TestRunner->run(Object(Tests\\Feature\\ProfileTest))
#83 /var/www/vendor/phpunit/phpunit/src/Framework/TestSuite.php(380): PHPUnit\\Framework\\TestCase->run()
#84 /var/www/vendor/phpunit/phpunit/src/Framework/TestSuite.php(380): PHPUnit\\Framework\\TestSuite->run()
#85 /var/www/vendor/phpunit/phpunit/src/Framework/TestSuite.php(380): PHPUnit\\Framework\\TestSuite->run()
#86 /var/www/vendor/phpunit/phpunit/src/TextUI/TestRunner.php(64): PHPUnit\\Framework\\TestSuite->run()
#87 /var/www/vendor/phpunit/phpunit/src/TextUI/Application.php(202): PHPUnit\\TextUI\\TestRunner->run(Object(PHPUnit\\TextUI\\Configuration\\Configuration), Object(PHPUnit\\Runner\\ResultCache\\DefaultResultCache), Object(PHPUnit\\Framework\\TestSuite))
#88 /var/www/vendor/pestphp/pest/src/Kernel.php(103): PHPUnit\\TextUI\\Application->run(Array)
#89 /var/www/vendor/pestphp/pest/bin/pest(91): Pest\\Kernel->handle(Array, Array)
#90 /var/www/vendor/pestphp/pest/bin/pest(99): {closure}()
#91 /var/www/vendor/bin/pest(119): include('/var/www/vendor...')
#92 {main}
"} 

[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[31;1m⨯[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[31;1m⨯[39;22m[90;1m.[39;22m[31;1m⨯[39;22m[31;1m⨯[39;22m[31;1m⨯[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[31;1m⨯[39;22m[31;1m⨯[39;22m[90;1m.[39;22m[90;1m.[39;22m[31;1m⨯[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[90;1m.[39;22m[31;1m⨯[39;22m[31;1m⨯[39;22m[90;1m.[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[33;1ms[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m
  [90;1m.[39;22m[90;1m.[39;22m[31;1m⨯[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[31;1m⨯[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[31;1m⨯[39;22m[31;1m⨯[39;22m[31;1m⨯[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[31;1m⨯[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m[90;1m.[39;22m
  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\AiYamlGeneratorTest[22m [90m>[39m get placeholder spans returns…   
[39;1m  Failed asserting that actual size 3 matches expected size 2.[39;22m

  at [32mtests/Feature/AiYamlGeneratorTest.php[39m:[32m89[39m
    [90m 85[0m[90m▕ [0m[35;1m        [0m[39;1m$data [0m[35;1m= [0m[39;1m$response[0m[35;1m->[0m[39;1mjson[0m[35;1m();[0m
    [90m 86[0m[90m▕ [0m[35;1m        [0m[39;1m$placeholders [0m[35;1m= [0m[39;1m$data[0m[35;1m[[0m[37m'placeholders'[0m[35;1m];[0m
    [90m 87[0m[90m▕ [0m
    [90m 88[0m[90m▕ [0m[35;1m        [0m[90;3m// Should return only 2 placeholder person spans[0m
[31;1m  ➜ [0m[3;1m 89[0m[90m▕ [0m[90;3m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertCount[0m[35;1m([0m[39;1m2[0m[35;1m, [0m[39;1m$placeholders[0m[35;1m);[0m
    [90m 90[0m[90m▕ [0m[35;1m        [0m
    [90m 91[0m[90m▕ [0m[35;1m        [0m[90;3m// Should include only the person spans[0m
    [90m 92[0m[90m▕ [0m[90;3m        [0m[39;1m$spanNames [0m[35;1m= [0m[39;1mcollect[0m[35;1m([0m[39;1m$placeholders[0m[35;1m)->[0m[39;1mpluck[0m[35;1m([0m[37m'name'[0m[35;1m)->[0m[39;1mtoArray[0m[35;1m();[0m
    [90m 93[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertContains[0m[35;1m([0m[37m'John Doe'[0m[35;1m, [0m[39;1m$spanNames[0m[35;1m);[0m

  [33m1   [39m[39;1mtests/Feature/AiYamlGeneratorTest.php[39;22m:[39;1m89[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\ConfigurableStoryGeneratorServiceTest[22m [90m>[39m person stor…   
[39;1m  Failed asserting that '[39;22m[39;1m<a href="http://localhost:8000/spans/d9ed4e5c-9b3e-45dd-8e2e-67ea3037c1b0" class="text-decoration-none">[39;22m[39;1mJohn Lennon[39;22m[39;1m</a>[39;22m[39;1m was born on [39;22m[39;1m<a href="http://localhost:8000/date/1940-10-09" class="text-decoration-none">[39;22m[39;1m9 October, 1940[39;22m[39;1m</a>[39;22m[39;1m. They lived to the age of 40¼. They were the child of [39;22m[39;1m<a href="http://localhost:8000/spans/1de9729d-ef73-4597-8efd-726d1c56370f" class="text-decoration-none">[39;22m[39;1mAlfred Lennon[39;22m[39;1m</a>[39;22m[39;1m and [39;22m[39;1m<a href="http://localhost:8000/spans/9f732eeb-a2d1-4996-afeb-ac8570bf665f" class="text-decoration-none">[39;22m[39;1mJulia Lennon[39;22m[39;1m</a>[39;22m[39;1m. They had one child, [39;22m[39;1m<a href="http://localhost:8000/spans/174d16a7-82c6-44c8-ba29-583d6cb4eaa0" class="text-decoration-none">[39;22m[39;1mJulian Lennon[39;22m[39;1m</a>[39;22m[39;1m.' [UTF-8](length: 674) contains "was the child of" [ASCII](length: 16).[39;22m

  at [32mtests/Feature/ConfigurableStoryGeneratorServiceTest.php[39m:[32m57[39m
    [90m 53[0m[90m▕ [0m[35;1m        [0m[90;3m// The story structure has paragraphs as an array, get the first paragraph[0m
    [90m 54[0m[90m▕ [0m[90;3m        [0m[39;1m$storyText [0m[35;1m= [0m[39;1m$story[0m[35;1m[[0m[37m'paragraphs'[0m[35;1m][[0m[39;1m0[0m[35;1m] ?? [0m[37m''[0m[35;1m;[0m
    [90m 55[0m[90m▕ [0m
    [90m 56[0m[90m▕ [0m[35;1m        [0m[90;3m// Check that past tense is used[0m
[31;1m  ➜ [0m[3;1m 57[0m[90m▕ [0m[90;3m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertStringContainsString[0m[35;1m([0m[37m'was the child of'[0m[35;1m, [0m[39;1m$storyText[0m[35;1m);[0m
    [90m 58[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertStringContainsString[0m[35;1m([0m[37m'had one child'[0m[35;1m, [0m[39;1m$storyText[0m[35;1m);[0m
    [90m 59[0m[90m▕ [0m[35;1m    }[0m
    [90m 60[0m[90m▕ [0m
    [90m 61[0m[90m▕ [0m[35;1m    public function [0m[39;1mtest_deceased_person_age_sentence_uses_deceased_template[0m[35;1m()[0m

  [33m1   [39m[39;1mtests/Feature/ConfigurableStoryGeneratorServiceTest.php[39;22m:[39;1m57[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\ErrorPagesTest[22m [90m>[39m 419 error pa… [41;1m AssertionFailedError [49;22m  
[39;1m  The response is not a view.[39;22m

  at [32mtests/Feature/ErrorPagesTest.php[39m:[32m17[39m
    [90m 13[0m[90m▕ [0m[39;1m    [0m[35;1m{[0m
    [90m 14[0m[90m▕ [0m[35;1m        [0m[39;1m$response [0m[35;1m= [0m[39;1m$this[0m[35;1m->[0m[39;1mget[0m[35;1m([0m[37m'/error?code=419'[0m[35;1m);[0m
    [90m 15[0m[90m▕ [0m
    [90m 16[0m[90m▕ [0m[35;1m        [0m[39;1m$response[0m[35;1m->[0m[39;1massertStatus[0m[35;1m([0m[39;1m419[0m[35;1m);[0m
[31;1m  ➜ [0m[3;1m 17[0m[90m▕ [0m[35;1m        [0m[39;1m$response[0m[35;1m->[0m[39;1massertViewIs[0m[35;1m([0m[37m'errors.419'[0m[35;1m);[0m
    [90m 18[0m[90m▕ [0m[35;1m        [0m[39;1m$response[0m[35;1m->[0m[39;1massertSee[0m[35;1m([0m[37m'Session Expired'[0m[35;1m);[0m
    [90m 19[0m[90m▕ [0m[35;1m        [0m[39;1m$response[0m[35;1m->[0m[39;1massertSee[0m[35;1m([0m[37m'Your session has expired'[0m[35;1m);[0m
    [90m 20[0m[90m▕ [0m[35;1m        [0m[39;1m$response[0m[35;1m->[0m[39;1massertSee[0m[35;1m([0m[37m'Clear Session & Refresh'[0m[35;1m);[0m
    [90m 21[0m[90m▕ [0m[35;1m    }[0m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\ErrorPagesTest[22m [90m>[39m 419 error page has session clearin…   
[39;1m  Failed asserting that '<!DOCTYPE html>\n
[39;22m[39;1m<html lang="en">[39;22m[39;1m\n
[39;22m[39;1m<head>[39;22m[39;1m\n
    [39;22m[39;1m<meta charset="utf-8">[39;22m[39;1m\n
    [39;22m[39;1m<meta name="viewport" content="width=device-width, initial-scale=1">[39;22m[39;1m\n
    [39;22m[39;1m<meta name="csrf-token" content="OaVthFw7CiPgxo8TpDZ3toueyYVesaqz5azdTRUY">[39;22m[39;1m\n
\n
    [39;22m[39;1m<title>[39;22m[39;1mLifespan Beta Testing - Time has run out[39;22m[39;1m</title>[39;22m[39;1m\n
\n
    <!-- Bootstrap CSS -->\n
    [39;22m[39;1m<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">[39;22m[39;1m\n
    [39;22m[39;1m<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">[39;22m[39;1m\n
    \n
    <!-- Favicon -->\n
    [39;22m[39;1m<link rel="icon" href="http://localhost:8000/favicon.ico" type="image/x-icon">[39;22m[39;1m\n
    \n
    [39;22m[39;1m<style>[39;22m[39;1m\n
        body {\n
            background: #eee;\n
            min-height: 100vh;\n
            display: flex;\n
            align-items: center;\n
        }\n
        \n
        .error-card {\n
            background: rgba(255, 255, 255, 0.95);\n
            backdrop-filter: blur(10px);\n
            border: none;\n
            border-radius: 13px;\n
            box-shadow: 0 13px 35px rgba(0, 0, 0, 0.1);\n
        }\n
        \n
        .error-icon {\n
            font-size: 4rem;\n
            margin-bottom: 1rem;\n
        }\n
        \n
        .error-code {\n
            font-size: 6rem;\n
            font-weight: 700;\n
            color: #6c757d;\n
            line-height: 1;\n
            margin-bottom: 0.5rem;\n
        }\n
        \n
        .error-title {\n
            font-size: 1.5rem;\n
            font-weight: 600;\n
            margin-bottom: 1rem;\n
        }\n
        \n
        .error-message {\n
            color: #6c757d;\n
            font-size: 1.1rem;\n
            line-height: 1.6;\n
        }\n
        \n
        .btn-home {\n
            background: #6c757d;\n
            border: none;\n
            padding: 0.75rem 2rem;\n
            border-radius: 25px;\n
            font-weight: 500;\n
            color: #000;\n
        }\n
        \n
        .btn-home:hover {\n
            color: #000;\n
        }\n
    \n
    [39;22m[39;1m</style>[39;22m[39;1m\n
[39;22m[39;1m</head>[39;22m[39;1m\n
[39;22m[39;1m<body>[39;22m[39;1m\n
    [39;22m[39;1m<div class="container">[39;22m[39;1m\n
        [39;22m[39;1m<div class="row justify-content-center">[39;22m[39;1m\n
            [39;22m[39;1m<div class="col-md-6 col-lg-5">[39;22m[39;1m\n
                [39;22m[39;1m<div class="card error-card text-center p-5">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="error-icon text-warning">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi-hourglass-split">[39;22m[39;1m</i>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                    \n
                    [39;22m[39;1m<div class="error-code">[39;22m[39;1m419[39;22m[39;1m</div>[39;22m[39;1m\n
                    \n
                    [39;22m[39;1m<h1 class="error-title">[39;22m[39;1mTime has run out[39;22m[39;1m</h1>[39;22m[39;1m\n
                    \n
                    [39;22m[39;1m<p class="error-message mb-4">[39;22m[39;1m\n
                        Something to do with sessions...                    [39;22m[39;1m</p>[39;22m[39;1m\n
                    \n
                    [39;22m[39;1m<div class="alert alert-info mb-4" role="alert">[39;22m[39;1m\n
    [39;22m[39;1m<h6 class="alert-heading mb-2">[39;22m[39;1m\n
        [39;22m[39;1m<i class="bi bi-info-circle me-2">[39;22m[39;1m</i>[39;22m[39;1mHack-o-matic\n
    [39;22m[39;1m</h6>[39;22m[39;1m\n
    [39;22m[39;1m<p class="mb-3">[39;22m[39;1mThis will try to fix the problem...[39;22m[39;1m</p>[39;22m[39;1m\n
    \n
    [39;22m[39;1m<div class="d-grid gap-2">[39;22m[39;1m\n
        [39;22m[39;1m<button id="clearSessionBtn" class="btn btn-outline-primary btn-sm">[39;22m[39;1m\n
            [39;22m[39;1m<i class="bi bi-trash me-2">[39;22m[39;1m</i>[39;22m[39;1mEat the cookies\n
        [39;22m[39;1m</button>[39;22m[39;1m\n
        [39;22m[39;1m<small class="text-muted">[39;22m[39;1mThis will clear your cookies and reload the page[39;22m[39;1m</small>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m\n
\n
[39;22m[39;1m<div id="sessionStatus" class="alert alert-secondary mb-4" style="display: none;">[39;22m[39;1m\n
    [39;22m[39;1m<div class="d-flex align-items-center">[39;22m[39;1m\n
        [39;22m[39;1m<div class="spinner-border spinner-border-sm me-2" role="status">[39;22m[39;1m\n
            [39;22m[39;1m<span class="visually-hidden">[39;22m[39;1mLoading...[39;22m[39;1m</span>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m<span id="statusText">[39;22m[39;1mClearing session cookies...[39;22m[39;1m</span>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m\n
                    \n
                    [39;22m[39;1m<div class="d-flex flex-column flex-sm-row gap-3 justify-content-center">[39;22m[39;1m\n
                        [39;22m[39;1m<a href="http://localhost:8000/" class="btn btn-primary">[39;22m[39;1mHome[39;22m[39;1m</a>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
    \n
    <!-- Bootstrap JS -->\n
    [39;22m[39;1m<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">[39;22m[39;1m</script>[39;22m[39;1m\n
    \n
    [39;22m[39;1m<script>[39;22m[39;1m\n
/**\n
 * Session Utilities for handling 419 errors\n
 */\n
const SessionUtils = {\n
    clearSessionCookies() {\n
        const cookiesToClear = [\n
            'lifespan_session',           // Main Laravel session cookie\n
            'XSRF-TOKEN',                 // Laravel CSRF token cookie\n
            'sidebarCollapsed',           // App-specific cookie\n
            'remember_web_*',             // Remember me cookies\n
            'laravel_session',            // Fallback session cookie name\n
            'laravel_token',              // Fallback CSRF token\n
        ];\n
        \n
        console.log('Clearing session cookies to resolve 419 error...');\n
        \n
        cookiesToClear.forEach(cookieName => {\n
            // Clear cookie for current domain\n
            this.clearCookie(cookieName);\n
            \n
            // Clear for current hostname\n
            this.clearCookie(cookieName, window.location.hostname);\n
            \n
            // Clear for parent domain (e.g., if on app.example.com, clear for example.com)\n
            const domainParts = window.location.hostname.split('.');\n
            if (domainParts.length > 2) {\n
                const parentDomain = domainParts.slice(-2).join('.');\n
                this.clearCookie(cookieName, parentDomain);\n
            }\n
            \n
            // Clear for root domain (e.g., if on app.example.com, clear for .example.com)\n
            if (domainParts.length > 1) {\n
                const rootDomain = '.' + domainParts.slice(-2).join('.');\n
                this.clearCookie(cookieName, rootDomain);\n
            }\n
            \n
            // Also try without domain (for localhost/development)\n
            this.clearCookie(cookieName, null);\n
        });\n
        \n
        // Also clear any cookies that might have secure/httpOnly issues\n
        this.clearCookie('lifespan_session', null, false, false);\n
        this.clearCookie('XSRF-TOKEN', null, false, false);\n
        \n
        console.log('Session cookies cleared.');\n
    },\n
\n
    clearCookie(name, domain = null, secure = true, httpOnly = true) {\n
        const cookieOptions = [\n
            'expires=Thu, 01 Jan 1970 00:00:00 GMT',\n
            'path=/'\n
        ];\n
        \n
        if (domain) {\n
            cookieOptions.push(`domain=${domain}`);\n
        }\n
        \n
        if (secure) {\n
            cookieOptions.push('secure');\n
        }\n
        \n
        if (httpOnly) {\n
            cookieOptions.push('httpOnly');\n
        }\n
        \n
        cookieOptions.push('samesite=lax');\n
        \n
        // Set cookie with past expiration date to delete it\n
        document.cookie = `${name}=; ${cookieOptions.join('; ')}`;\n
        \n
        console.log(`Cleared cookie: ${name}${domain ? ` (domain: ${domain})` : ''}${secure ? ' (secure)' : ''}${httpOnly ? ' (httpOnly)' : ''}`);\n
    },\n
\n
    getCookie(name) {\n
        const value = `; ${document.cookie}`;\n
        const parts = value.split(`; ${name}=`);\n
        if (parts.length === 2) {\n
            return parts.pop().split(';').shift();\n
        }\n
        return null;\n
    }\n
};\n
\n
// Handle the clear session button click\n
document.addEventListener('DOMContentLoaded', function() {\n
    const clearBtn = document.getElementById('clearSessionBtn');\n
    const statusDiv = document.getElementById('sessionStatus');\n
    const statusText = document.getElementById('statusText');\n
    \n
    clearBtn.addEventListener('click', function() {\n
        // Disable button and show status\n
        clearBtn.disabled = true;\n
        clearBtn.innerHTML = '[39;22m[39;1m<i class="bi bi-hourglass-split me-2">[39;22m[39;1m</i>[39;22m[39;1mClearing...';\n
        statusDiv.style.display = 'block';\n
        statusText.textContent = 'Clearing session cookies...';\n
        \n
        // Clear cookies\n
        SessionUtils.clearSessionCookies();\n
        \n
        // Update status\n
        statusText.textContent = 'Session cleared! Getting fresh CSRF token...';\n
        \n
        // Get a fresh CSRF token before refreshing\n
        fetch('/sanctum/csrf-cookie', {\n
            method: 'GET',\n
            credentials: 'include'\n
        })\n
        .then(() => {\n
            statusText.textContent = 'Fresh token obtained! Redirecting to home...';\n
            // Redirect to home page after getting fresh token\n
            setTimeout(() => {\n
                window.location.href = '/';\n
            }, 1000);\n
        })\n
        .catch(() => {\n
            statusText.textContent = 'Redirecting to home...';\n
            // Fallback: redirect to home anyway\n
            setTimeout(() => {\n
                window.location.href = '/';\n
            }, 1000);\n
        });\n
    });\n
    \n
    // Also provide a fallback - if user clicks anywhere on the page, \n
    // show a subtle hint about the clear button\n
    document.addEventListener('click', function(e) {\n
        if (e.target !== clearBtn && !clearBtn.contains(e.target)) {\n
            clearBtn.classList.add('btn-outline-warning');\n
            clearBtn.classList.remove('btn-outline-primary');\n
            setTimeout(() => {\n
                clearBtn.classList.remove('btn-outline-warning');\n
                clearBtn.classList.add('btn-outline-primary');\n
            }, 200);\n
        }\n
    });\n
});\n
[39;22m[39;1m</script>[39;22m[39;1m\n
[39;22m[39;1m</body>[39;22m[39;1m\n
[39;22m[39;1m</html>[39;22m[39;1m ' [ASCII](length: 9082) contains "id=&quot;clearSessionBtn&quot;" [ASCII](length: 30).[39;22m

  at [32mtests/Feature/ErrorPagesTest.php[39m:[32m36[39m
    [90m 32[0m[90m▕ [0m[35;1m        [0m[39;1m$response[0m[35;1m->[0m[39;1massertSee[0m[35;1m([0m[37m'lifespan_session'[0m[35;1m);[0m
    [90m 33[0m[90m▕ [0m[35;1m        [0m[39;1m$response[0m[35;1m->[0m[39;1massertSee[0m[35;1m([0m[37m'XSRF-TOKEN'[0m[35;1m);[0m
    [90m 34[0m[90m▕ [0m[35;1m        [0m
    [90m 35[0m[90m▕ [0m[35;1m        [0m[90;3m// Check that the button is present[0m
[31;1m  ➜ [0m[3;1m 36[0m[90m▕ [0m[90;3m        [0m[39;1m$response[0m[35;1m->[0m[39;1massertSee[0m[35;1m([0m[37m'id="clearSessionBtn"'[0m[35;1m);[0m
    [90m 37[0m[90m▕ [0m[35;1m        [0m[39;1m$response[0m[35;1m->[0m[39;1massertSee[0m[35;1m([0m[37m'Clear Session & Refresh'[0m[35;1m);[0m
    [90m 38[0m[90m▕ [0m[35;1m    }[0m
    [90m 39[0m[90m▕ [0m
    [90m 40[0m[90m▕ [0m[35;1m    public function [0m[39;1mtest_419_error_page_has_proper_styling[0m[35;1m(): [0m[39;1mvoid[0m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\MusicBrainzImportTest[22m [90m>[39m does not set todays date as…   
[39;1m  Failed asserting that two strings are equal.
  [39;22m[31m-'complete'[39m[39;1m
  [39;22m[32m+'placeholder'[39m[39;1m
  [39;22m

  at [32mtests/Feature/MusicBrainzImportTest.php[39m:[32m450[39m
    [90m446[0m[90m▕ [0m
    [90m447[0m[90m▕ [0m[35;1m        [0m[90;3m// Test 1: Album with today's date should NOW have date fields set[0m
    [90m448[0m[90m▕ [0m[90;3m        [0m[39;1m$albumWithTodayDate [0m[35;1m= [0m[39;1mSpan[0m[35;1m::[0m[39;1mwhere[0m[35;1m([0m[37m'name'[0m[35;1m, [0m[37m'Test Album with Today Date'[0m[35;1m)->[0m[39;1mfirst[0m[35;1m();[0m
    [90m449[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertNotNull[0m[35;1m([0m[39;1m$albumWithTodayDate[0m[35;1m);[0m
[31;1m  ➜ [0m[3;1m450[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertEquals[0m[35;1m([0m[37m'complete'[0m[35;1m, [0m[39;1m$albumWithTodayDate[0m[35;1m->[0m[39;1mstate[0m[35;1m); [0m[90;3m// Now should be complete[0m
    [90m451[0m[90m▕ [0m[90;3m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertEquals[0m[35;1m((int)[0m[39;1mdate[0m[35;1m([0m[37m'Y'[0m[35;1m), [0m[39;1m$albumWithTodayDate[0m[35;1m->[0m[39;1mstart_year[0m[35;1m);[0m
    [90m452[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertEquals[0m[35;1m((int)[0m[39;1mdate[0m[35;1m([0m[37m'm'[0m[35;1m), [0m[39;1m$albumWithTodayDate[0m[35;1m->[0m[39;1mstart_month[0m[35;1m);[0m
    [90m453[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertEquals[0m[35;1m((int)[0m[39;1mdate[0m[35;1m([0m[37m'd'[0m[35;1m), [0m[39;1m$albumWithTodayDate[0m[35;1m->[0m[39;1mstart_day[0m[35;1m);[0m
    [90m454[0m[90m▕ [0m

  [33m1   [39m[39;1mtests/Feature/MusicBrainzImportTest.php[39;22m:[39;1m450[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\MusicBrainzImportTest[22m [90m>[39m does not set todays date as…   
[39;1m  Failed asserting that two strings are equal.
  [39;22m[31m-'complete'[39m[39;1m
  [39;22m[32m+'placeholder'[39m[39;1m
  [39;22m

  at [32mtests/Feature/MusicBrainzImportTest.php[39m:[32m545[39m
    [90m541[0m[90m▕ [0m
    [90m542[0m[90m▕ [0m[35;1m        [0m[90;3m// Test that albums with today's date are created as complete (matching the first test)[0m
    [90m543[0m[90m▕ [0m[90;3m        [0m[39;1m$albumWithTodayDate [0m[35;1m= [0m[39;1mSpan[0m[35;1m::[0m[39;1mwhere[0m[35;1m([0m[37m'name'[0m[35;1m, [0m[37m'Test Album with Today Date'[0m[35;1m)->[0m[39;1mfirst[0m[35;1m();[0m
    [90m544[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertNotNull[0m[35;1m([0m[39;1m$albumWithTodayDate[0m[35;1m);[0m
[31;1m  ➜ [0m[3;1m545[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertEquals[0m[35;1m([0m[37m'complete'[0m[35;1m, [0m[39;1m$albumWithTodayDate[0m[35;1m->[0m[39;1mstate[0m[35;1m);[0m
    [90m546[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertEquals[0m[35;1m((int)[0m[39;1mdate[0m[35;1m([0m[37m'Y'[0m[35;1m), [0m[39;1m$albumWithTodayDate[0m[35;1m->[0m[39;1mstart_year[0m[35;1m);[0m
    [90m547[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertEquals[0m[35;1m((int)[0m[39;1mdate[0m[35;1m([0m[37m'm'[0m[35;1m), [0m[39;1m$albumWithTodayDate[0m[35;1m->[0m[39;1mstart_month[0m[35;1m);[0m
    [90m548[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertEquals[0m[35;1m((int)[0m[39;1mdate[0m[35;1m([0m[37m'd'[0m[35;1m), [0m[39;1m$albumWithTodayDate[0m[35;1m->[0m[39;1mstart_day[0m[35;1m);[0m
    [90m549[0m[90m▕ [0m

  [33m1   [39m[39;1mtests/Feature/MusicBrainzImportTest.php[39;22m:[39;1m545[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\MusicBrainzRateLimitTest[22m [90m>[39m rate limiting ensures on…   
[39;1m  Failed asserting that actual size 4 matches expected size 2.[39;22m

  at [32mvendor/laravel/framework/src/Illuminate/Http/Client/Factory.php[39m:[32m377[39m
    [90m373[0m[90m▕ [0m[90;3m     * @return void[0m
    [90m374[0m[90m▕ [0m[90;3m     */[0m
    [90m375[0m[90m▕ [0m[90;3m    [0m[35;1mpublic function [0m[39;1massertSentCount[0m[35;1m([0m[39;1m$count[0m[35;1m)[0m
    [90m376[0m[90m▕ [0m[35;1m    {[0m
[31;1m  ➜ [0m[3;1m377[0m[90m▕ [0m[35;1m        [0m[39;1mPHPUnit[0m[35;1m::[0m[39;1massertCount[0m[35;1m([0m[39;1m$count[0m[35;1m, [0m[39;1m$this[0m[35;1m->[0m[39;1mrecorded[0m[35;1m);[0m
    [90m378[0m[90m▕ [0m[35;1m    }[0m
    [90m379[0m[90m▕ [0m
    [90m380[0m[90m▕ [0m[35;1m    [0m[90;3m/**[0m
    [90m381[0m[90m▕ [0m[90;3m     * Assert that every created response sequence is empty.[0m

      [2m+2 vendor frames [22m
  [33m3   [39m[39;1mtests/Feature/MusicBrainzRateLimitTest.php[39;22m:[39;1m57[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\MusicBrainzRateLimitTest[22m [90m>[39m ra… [41;1m OutOfBoundsException [49;22m  
[39;1m  A request was made, but the response sequence is empty.[39;22m

  at [32mvendor/laravel/framework/src/Illuminate/Http/Client/ResponseSequence.php[39m:[32m147[39m
    [90m143[0m[90m▕ [0m[90;3m     */[0m
    [90m144[0m[90m▕ [0m[90;3m    [0m[35;1mpublic function [0m[39;1m__invoke[0m[35;1m()[0m
    [90m145[0m[90m▕ [0m[35;1m    {[0m
    [90m146[0m[90m▕ [0m[35;1m        if ([0m[39;1m$this[0m[35;1m->[0m[39;1mfailWhenEmpty [0m[35;1m&& [0m[39;1m$this[0m[35;1m->[0m[39;1misEmpty[0m[35;1m()) {[0m
[31;1m  ➜ [0m[3;1m147[0m[90m▕ [0m[35;1m            throw new [0m[39;1mOutOfBoundsException[0m[35;1m([0m[37m'A request was made, but the response sequence is empty.'[0m[35;1m);[0m
    [90m148[0m[90m▕ [0m[35;1m        }[0m
    [90m149[0m[90m▕ [0m
    [90m150[0m[90m▕ [0m[35;1m        if (! [0m[39;1m$this[0m[35;1m->[0m[39;1mfailWhenEmpty [0m[35;1m&& [0m[39;1m$this[0m[35;1m->[0m[39;1misEmpty[0m[35;1m()) {[0m
    [90m151[0m[90m▕ [0m[35;1m            return [0m[39;1mvalue[0m[35;1m([0m[39;1m$this[0m[35;1m->[0m[39;1memptyResponse [0m[35;1m?? [0m[39;1mFactory[0m[35;1m::[0m[39;1mresponse[0m[35;1m());[0m

      [2m+24 vendor frames [22m
  [33m25  [39m[39;1mapp/Services/MusicBrainzImportService.php[39;22m:[39;1m58[39;22m
  [33m26  [39m[39;1mapp/Services/MusicBrainzImportService.php[39;22m:[39;1m126[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\ProfileTest[22m [90m>[39m user can delete their account            
[39;1m  Expected response status code [201, 301, 302, 303, 307, 308] but received 500.
Failed asserting that false is true.

The following exception occurred during the last request:

PDOException: SQLSTATE[23503]: Foreign key violation: 7 ERROR:  update or delete on table "users" violates foreign key constraint "span_versions_changed_by_foreign" on table "span_versions"
DETAIL:  Key (id)=(9f59d5be-a2ac-47c6-a8db-2525e4910806) is still referenced from table "span_versions". in /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php:612
Stack trace:
#0 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(612): PDOStatement->execute()
#1 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(816): Illuminate\Database\Connection->Illuminate\Database\{closure}('delete from "us...', Array)
#2 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(783): Illuminate\Database\Connection->runQueryCallback('delete from "us...', Array, Object(Closure))
#3 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(600): Illuminate\Database\Connection->run('delete from "us...', Array, Object(Closure))
#4 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(564): Illuminate\Database\Connection->affectingStatement('delete from "us...', Array)
#5 /var/www/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php(3796): Illuminate\Database\Connection->delete('delete from "us...', Array)
#6 /var/www/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php(1273): Illuminate\Database\Query\Builder->delete()
#7 /var/www/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php(1463): Illuminate\Database\Eloquent\Builder->delete()
#8 /var/www/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php(1408): Illuminate\Database\Eloquent\Model->performDeleteOnModel()
#9 /var/www/app/Http/Controllers/ProfileController.php(161): Illuminate\Database\Eloquent\Model->delete()
#10 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Controller.php(54): App\Http\Controllers\ProfileController->destroy(Object(Illuminate\Http\Request))
#11 /var/www/vendor/laravel/framework/src/Illuminate/Routing/ControllerDispatcher.php(43): Illuminate\Routing\Controller->callAction('destroy', Array)
#12 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Route.php(259): Illuminate\Routing\ControllerDispatcher->dispatch(Object(Illuminate\Routing\Route), Object(App\Http\Controllers\ProfileController), 'destroy')
#13 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Route.php(205): Illuminate\Routing\Route->runController()
#14 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(806): Illuminate\Routing\Route->run()
#15 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(144): Illuminate\Routing\Router->Illuminate\Routing\{closure}(Object(Illuminate\Http\Request))
#16 /var/www/vendor/barryvdh/laravel-debugbar/src/Middleware/InjectDebugbar.php(59): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#17 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Barryvdh\Debugbar\Middleware\InjectDebugbar->handle(Object(Illuminate\Http\Request), Object(Closure))
#18 /var/www/app/Http/Middleware/LoadUserRelations.php(46): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#19 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\Http\Middleware\LoadUserRelations->handle(Object(Illuminate\Http\Request), Object(Closure))
#20 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Middleware/SubstituteBindings.php(50): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#21 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Routing\Middleware\SubstituteBindings->handle(Object(Illuminate\Http\Request), Object(Closure))
#22 /var/www/vendor/laravel/framework/src/Illuminate/Auth/Middleware/Authenticate.php(57): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#23 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Auth\Middleware\Authenticate->handle(Object(Illuminate\Http\Request), Object(Closure))
#24 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php(180): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#25 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): class@anonymous->handle(Object(Illuminate\Http\Request), Object(Closure))
#26 /var/www/vendor/laravel/framework/src/Illuminate/View/Middleware/ShareErrorsFromSession.php(49): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#27 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\View\Middleware\ShareErrorsFromSession->handle(Object(Illuminate\Http\Request), Object(Closure))
#28 /var/www/vendor/laravel/framework/src/Illuminate/Session/Middleware/StartSession.php(121): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#29 /var/www/vendor/laravel/framework/src/Illuminate/Session/Middleware/StartSession.php(64): Illuminate\Session\Middleware\StartSession->handleStatefulRequest(Object(Illuminate\Http\Request), Object(Illuminate\Session\Store), Object(Closure))
#30 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Session\Middleware\StartSession->handle(Object(Illuminate\Http\Request), Object(Closure))
#31 /var/www/vendor/laravel/framework/src/Illuminate/Cookie/Middleware/AddQueuedCookiesToResponse.php(37): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#32 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse->handle(Object(Illuminate\Http\Request), Object(Closure))
#33 /var/www/vendor/laravel/framework/src/Illuminate/Cookie/Middleware/EncryptCookies.php(67): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#34 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Cookie\Middleware\EncryptCookies->handle(Object(Illuminate\Http\Request), Object(Closure))
#35 /var/www/app/Http/Middleware/FixSessionInRailway.php(46): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#36 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\Http\Middleware\FixSessionInRailway->handle(Object(Illuminate\Http\Request), Object(Closure))
#37 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(119): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#38 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(805): Illuminate\Pipeline\Pipeline->then(Object(Closure))
#39 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(784): Illuminate\Routing\Router->runRouteWithinStack(Object(Illuminate\Routing\Route), Object(Illuminate\Http\Request))
#40 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(748): Illuminate\Routing\Router->runRoute(Object(Illuminate\Http\Request), Object(Illuminate\Routing\Route))
#41 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(737): Illuminate\Routing\Router->dispatchToRoute(Object(Illuminate\Http\Request))
#42 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(200): Illuminate\Routing\Router->dispatch(Object(Illuminate\Http\Request))
#43 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(144): Illuminate\Foundation\Http\Kernel->Illuminate\Foundation\Http\{closure}(Object(Illuminate\Http\Request))
#44 /var/www/vendor/barryvdh/laravel-debugbar/src/Middleware/InjectDebugbar.php(59): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#45 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Barryvdh\Debugbar\Middleware\InjectDebugbar->handle(Object(Illuminate\Http\Request), Object(Closure))
#46 /var/www/vendor/sentry/sentry-laravel/src/Sentry/Laravel/Http/FlushEventsMiddleware.php(13): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#47 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Sentry\Laravel\Http\FlushEventsMiddleware->handle(Object(Illuminate\Http\Request), Object(Closure))
#48 /var/www/vendor/sentry/sentry-laravel/src/Sentry/Laravel/Http/SetRequestIpMiddleware.php(45): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#49 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Sentry\Laravel\Http\SetRequestIpMiddleware->handle(Object(Illuminate\Http\Request), Object(Closure))
#50 /var/www/vendor/sentry/sentry-laravel/src/Sentry/Laravel/Http/SetRequestMiddleware.php(31): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#51 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Sentry\Laravel\Http\SetRequestMiddleware->handle(Object(Illuminate\Http\Request), Object(Closure))
#52 /var/www/app/Http/Middleware/DatabaseConnectionLogger.php(48): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#53 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\Http\Middleware\DatabaseConnectionLogger->handle(Object(Illuminate\Http\Request), Object(Closure))
#54 /var/www/app/Http/Middleware/RequestResponseLogger.php(22): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#55 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\Http\Middleware\RequestResponseLogger->handle(Object(Illuminate\Http\Request), Object(Closure))
#56 /var/www/app/Http/Middleware/ForceHttpsInProduction.php(30): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#57 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\Http\Middleware\ForceHttpsInProduction->handle(Object(Illuminate\Http\Request), Object(Closure))
#58 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#59 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/ConvertEmptyStringsToNull.php(31): Illuminate\Foundation\Http\Middleware\TransformsRequest->handle(Object(Illuminate\Http\Request), Object(Closure))
#60 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull->handle(Object(Illuminate\Http\Request), Object(Closure))
#61 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#62 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TrimStrings.php(40): Illuminate\Foundation\Http\Middleware\TransformsRequest->handle(Object(Illuminate\Http\Request), Object(Closure))
#63 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Foundation\Http\Middleware\TrimStrings->handle(Object(Illuminate\Http\Request), Object(Closure))
#64 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/ValidatePostSize.php(27): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#65 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Foundation\Http\Middleware\ValidatePostSize->handle(Object(Illuminate\Http\Request), Object(Closure))
#66 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/PreventRequestsDuringMaintenance.php(99): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#67 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Foundation\Http\Middleware\PreventRequestsDuringMaintenance->handle(Object(Illuminate\Http\Request), Object(Closure))
#68 /var/www/vendor/laravel/framework/src/Illuminate/Http/Middleware/HandleCors.php(49): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#69 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Http\Middleware\HandleCors->handle(Object(Illuminate\Http\Request), Object(Closure))
#70 /var/www/vendor/laravel/framework/src/Illuminate/Http/Middleware/TrustProxies.php(39): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#71 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Http\Middleware\TrustProxies->handle(Object(Illuminate\Http\Request), Object(Closure))
#72 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(119): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#73 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(175): Illuminate\Pipeline\Pipeline->then(Object(Closure))
#74 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(144): Illuminate\Foundation\Http\Kernel->sendRequestThroughRouter(Object(Illuminate\Http\Request))
#75 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php(585): Illuminate\Foundation\Http\Kernel->handle(Object(Illuminate\Http\Request))
#76 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php(465): Illuminate\Foundation\Testing\TestCase->call('DELETE', '/profile', Array, Array, Array, Array)
#77 /var/www/tests/Feature/ProfileTest.php(102): Illuminate\Foundation\Testing\TestCase->delete('/profile', Array)
#78 /var/www/vendor/phpunit/phpunit/src/Framework/TestCase.php(1188): Tests\Feature\ProfileTest->test_user_can_delete_their_account()
#79 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/TestCase.php(61): PHPUnit\Framework\TestCase->runTest()
#80 /var/www/vendor/phpunit/phpunit/src/Framework/TestCase.php(687): Illuminate\Foundation\Testing\TestCase->runTest()
#81 /var/www/vendor/phpunit/phpunit/src/Framework/TestRunner.php(106): PHPUnit\Framework\TestCase->runBare()
#82 /var/www/vendor/phpunit/phpunit/src/Framework/TestCase.php(517): PHPUnit\Framework\TestRunner->run(Object(Tests\Feature\ProfileTest))
#83 /var/www/vendor/phpunit/phpunit/src/Framework/TestSuite.php(380): PHPUnit\Framework\TestCase->run()
#84 /var/www/vendor/phpunit/phpunit/src/Framework/TestSuite.php(380): PHPUnit\Framework\TestSuite->run()
#85 /var/www/vendor/phpunit/phpunit/src/Framework/TestSuite.php(380): PHPUnit\Framework\TestSuite->run()
#86 /var/www/vendor/phpunit/phpunit/src/TextUI/TestRunner.php(64): PHPUnit\Framework\TestSuite->run()
#87 /var/www/vendor/phpunit/phpunit/src/TextUI/Application.php(202): PHPUnit\TextUI\TestRunner->run(Object(PHPUnit\TextUI\Configuration\Configuration), Object(PHPUnit\Runner\ResultCache\DefaultResultCache), Object(PHPUnit\Framework\TestSuite))
#88 /var/www/vendor/pestphp/pest/src/Kernel.php(103): PHPUnit\TextUI\Application->run(Array)
#89 /var/www/vendor/pestphp/pest/bin/pest(91): Pest\Kernel->handle(Array, Array)
#90 /var/www/vendor/pestphp/pest/bin/pest(99): {closure}()
#91 /var/www/vendor/bin/pest(119): include('/var/www/vendor...')
#92 {main}

Next Illuminate\Database\QueryException: SQLSTATE[23503]: Foreign key violation: 7 ERROR:  update or delete on table "users" violates foreign key constraint "span_versions_changed_by_foreign" on table "span_versions"
DETAIL:  Key (id)=(9f59d5be-a2ac-47c6-a8db-2525e4910806) is still referenced from table "span_versions". (Connection: testing, SQL: delete from "users" where "id" = 9f59d5be-a2ac-47c6-a8db-2525e4910806) in /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php:829
Stack trace:
#0 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(783): Illuminate\Database\Connection->runQueryCallback('delete from "us...', Array, Object(Closure))
#1 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(600): Illuminate\Database\Connection->run('delete from "us...', Array, Object(Closure))
#2 /var/www/vendor/laravel/framework/src/Illuminate/Database/Connection.php(564): Illuminate\Database\Connection->affectingStatement('delete from "us...', Array)
#3 /var/www/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php(3796): Illuminate\Database\Connection->delete('delete from "us...', Array)
#4 /var/www/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php(1273): Illuminate\Database\Query\Builder->delete()
#5 /var/www/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php(1463): Illuminate\Database\Eloquent\Builder->delete()
#6 /var/www/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php(1408): Illuminate\Database\Eloquent\Model->performDeleteOnModel()
#7 /var/www/app/Http/Controllers/ProfileController.php(161): Illuminate\Database\Eloquent\Model->delete()
#8 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Controller.php(54): App\Http\Controllers\ProfileController->destroy(Object(Illuminate\Http\Request))
#9 /var/www/vendor/laravel/framework/src/Illuminate/Routing/ControllerDispatcher.php(43): Illuminate\Routing\Controller->callAction('destroy', Array)
#10 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Route.php(259): Illuminate\Routing\ControllerDispatcher->dispatch(Object(Illuminate\Routing\Route), Object(App\Http\Controllers\ProfileController), 'destroy')
#11 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Route.php(205): Illuminate\Routing\Route->runController()
#12 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(806): Illuminate\Routing\Route->run()
#13 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(144): Illuminate\Routing\Router->Illuminate\Routing\{closure}(Object(Illuminate\Http\Request))
#14 /var/www/vendor/barryvdh/laravel-debugbar/src/Middleware/InjectDebugbar.php(59): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#15 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Barryvdh\Debugbar\Middleware\InjectDebugbar->handle(Object(Illuminate\Http\Request), Object(Closure))
#16 /var/www/app/Http/Middleware/LoadUserRelations.php(46): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#17 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\Http\Middleware\LoadUserRelations->handle(Object(Illuminate\Http\Request), Object(Closure))
#18 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Middleware/SubstituteBindings.php(50): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#19 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Routing\Middleware\SubstituteBindings->handle(Object(Illuminate\Http\Request), Object(Closure))
#20 /var/www/vendor/laravel/framework/src/Illuminate/Auth/Middleware/Authenticate.php(57): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#21 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Auth\Middleware\Authenticate->handle(Object(Illuminate\Http\Request), Object(Closure))
#22 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php(180): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#23 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): class@anonymous->handle(Object(Illuminate\Http\Request), Object(Closure))
#24 /var/www/vendor/laravel/framework/src/Illuminate/View/Middleware/ShareErrorsFromSession.php(49): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#25 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\View\Middleware\ShareErrorsFromSession->handle(Object(Illuminate\Http\Request), Object(Closure))
#26 /var/www/vendor/laravel/framework/src/Illuminate/Session/Middleware/StartSession.php(121): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#27 /var/www/vendor/laravel/framework/src/Illuminate/Session/Middleware/StartSession.php(64): Illuminate\Session\Middleware\StartSession->handleStatefulRequest(Object(Illuminate\Http\Request), Object(Illuminate\Session\Store), Object(Closure))
#28 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Session\Middleware\StartSession->handle(Object(Illuminate\Http\Request), Object(Closure))
#29 /var/www/vendor/laravel/framework/src/Illuminate/Cookie/Middleware/AddQueuedCookiesToResponse.php(37): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#30 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse->handle(Object(Illuminate\Http\Request), Object(Closure))
#31 /var/www/vendor/laravel/framework/src/Illuminate/Cookie/Middleware/EncryptCookies.php(67): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#32 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Cookie\Middleware\EncryptCookies->handle(Object(Illuminate\Http\Request), Object(Closure))
#33 /var/www/app/Http/Middleware/FixSessionInRailway.php(46): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#34 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\Http\Middleware\FixSessionInRailway->handle(Object(Illuminate\Http\Request), Object(Closure))
#35 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(119): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#36 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(805): Illuminate\Pipeline\Pipeline->then(Object(Closure))
#37 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(784): Illuminate\Routing\Router->runRouteWithinStack(Object(Illuminate\Routing\Route), Object(Illuminate\Http\Request))
#38 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(748): Illuminate\Routing\Router->runRoute(Object(Illuminate\Http\Request), Object(Illuminate\Routing\Route))
#39 /var/www/vendor/laravel/framework/src/Illuminate/Routing/Router.php(737): Illuminate\Routing\Router->dispatchToRoute(Object(Illuminate\Http\Request))
#40 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(200): Illuminate\Routing\Router->dispatch(Object(Illuminate\Http\Request))
#41 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(144): Illuminate\Foundation\Http\Kernel->Illuminate\Foundation\Http\{closure}(Object(Illuminate\Http\Request))
#42 /var/www/vendor/barryvdh/laravel-debugbar/src/Middleware/InjectDebugbar.php(59): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#43 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Barryvdh\Debugbar\Middleware\InjectDebugbar->handle(Object(Illuminate\Http\Request), Object(Closure))
#44 /var/www/vendor/sentry/sentry-laravel/src/Sentry/Laravel/Http/FlushEventsMiddleware.php(13): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#45 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Sentry\Laravel\Http\FlushEventsMiddleware->handle(Object(Illuminate\Http\Request), Object(Closure))
#46 /var/www/vendor/sentry/sentry-laravel/src/Sentry/Laravel/Http/SetRequestIpMiddleware.php(45): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#47 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Sentry\Laravel\Http\SetRequestIpMiddleware->handle(Object(Illuminate\Http\Request), Object(Closure))
#48 /var/www/vendor/sentry/sentry-laravel/src/Sentry/Laravel/Http/SetRequestMiddleware.php(31): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#49 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Sentry\Laravel\Http\SetRequestMiddleware->handle(Object(Illuminate\Http\Request), Object(Closure))
#50 /var/www/app/Http/Middleware/DatabaseConnectionLogger.php(48): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#51 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\Http\Middleware\DatabaseConnectionLogger->handle(Object(Illuminate\Http\Request), Object(Closure))
#52 /var/www/app/Http/Middleware/RequestResponseLogger.php(22): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#53 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\Http\Middleware\RequestResponseLogger->handle(Object(Illuminate\Http\Request), Object(Closure))
#54 /var/www/app/Http/Middleware/ForceHttpsInProduction.php(30): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#55 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): App\Http\Middleware\ForceHttpsInProduction->handle(Object(Illuminate\Http\Request), Object(Closure))
#56 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#57 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/ConvertEmptyStringsToNull.php(31): Illuminate\Foundation\Http\Middleware\TransformsRequest->handle(Object(Illuminate\Http\Request), Object(Closure))
#58 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull->handle(Object(Illuminate\Http\Request), Object(Closure))
#59 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#60 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TrimStrings.php(40): Illuminate\Foundation\Http\Middleware\TransformsRequest->handle(Object(Illuminate\Http\Request), Object(Closure))
#61 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Foundation\Http\Middleware\TrimStrings->handle(Object(Illuminate\Http\Request), Object(Closure))
#62 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/ValidatePostSize.php(27): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#63 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Foundation\Http\Middleware\ValidatePostSize->handle(Object(Illuminate\Http\Request), Object(Closure))
#64 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/PreventRequestsDuringMaintenance.php(99): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#65 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Foundation\Http\Middleware\PreventRequestsDuringMaintenance->handle(Object(Illuminate\Http\Request), Object(Closure))
#66 /var/www/vendor/laravel/framework/src/Illuminate/Http/Middleware/HandleCors.php(49): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#67 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Http\Middleware\HandleCors->handle(Object(Illuminate\Http\Request), Object(Closure))
#68 /var/www/vendor/laravel/framework/src/Illuminate/Http/Middleware/TrustProxies.php(39): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#69 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(183): Illuminate\Http\Middleware\TrustProxies->handle(Object(Illuminate\Http\Request), Object(Closure))
#70 /var/www/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(119): Illuminate\Pipeline\Pipeline->Illuminate\Pipeline\{closure}(Object(Illuminate\Http\Request))
#71 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(175): Illuminate\Pipeline\Pipeline->then(Object(Closure))
#72 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(144): Illuminate\Foundation\Http\Kernel->sendRequestThroughRouter(Object(Illuminate\Http\Request))
#73 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php(585): Illuminate\Foundation\Http\Kernel->handle(Object(Illuminate\Http\Request))
#74 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php(465): Illuminate\Foundation\Testing\TestCase->call('DELETE', '/profile', Array, Array, Array, Array)
#75 /var/www/tests/Feature/ProfileTest.php(102): Illuminate\Foundation\Testing\TestCase->delete('/profile', Array)
#76 /var/www/vendor/phpunit/phpunit/src/Framework/TestCase.php(1188): Tests\Feature\ProfileTest->test_user_can_delete_their_account()
#77 /var/www/vendor/laravel/framework/src/Illuminate/Foundation/Testing/TestCase.php(61): PHPUnit\Framework\TestCase->runTest()
#78 /var/www/vendor/phpunit/phpunit/src/Framework/TestCase.php(687): Illuminate\Foundation\Testing\TestCase->runTest()
#79 /var/www/vendor/phpunit/phpunit/src/Framework/TestRunner.php(106): PHPUnit\Framework\TestCase->runBare()
#80 /var/www/vendor/phpunit/phpunit/src/Framework/TestCase.php(517): PHPUnit\Framework\TestRunner->run(Object(Tests\Feature\ProfileTest))
#81 /var/www/vendor/phpunit/phpunit/src/Framework/TestSuite.php(380): PHPUnit\Framework\TestCase->run()
#82 /var/www/vendor/phpunit/phpunit/src/Framework/TestSuite.php(380): PHPUnit\Framework\TestSuite->run()
#83 /var/www/vendor/phpunit/phpunit/src/Framework/TestSuite.php(380): PHPUnit\Framework\TestSuite->run()
#84 /var/www/vendor/phpunit/phpunit/src/TextUI/TestRunner.php(64): PHPUnit\Framework\TestSuite->run()
#85 /var/www/vendor/phpunit/phpunit/src/TextUI/Application.php(202): PHPUnit\TextUI\TestRunner->run(Object(PHPUnit\TextUI\Configuration\Configuration), Object(PHPUnit\Runner\ResultCache\DefaultResultCache), Object(PHPUnit\Framework\TestSuite))
#86 /var/www/vendor/pestphp/pest/src/Kernel.php(103): PHPUnit\TextUI\Application->run(Array)
#87 /var/www/vendor/pestphp/pest/bin/pest(91): Pest\Kernel->handle(Array, Array)
#88 /var/www/vendor/pestphp/pest/bin/pest(99): {closure}()
#89 /var/www/vendor/bin/pest(119): include('/var/www/vendor...')
#90 {main}

----------------------------------------------------------------------------------

SQLSTATE[23503]: Foreign key violation: 7 ERROR:  update or delete on table "users" violates foreign key constraint "span_versions_changed_by_foreign" on table "span_versions"
DETAIL:  Key (id)=(9f59d5be-a2ac-47c6-a8db-2525e4910806) is still referenced from table "span_versions". (Connection: testing, SQL: delete from "users" where "id" = 9f59d5be-a2ac-47c6-a8db-2525e4910806)[39;22m

  at [32mtests/Feature/ProfileTest.php[39m:[32m108[39m
    [90m104[0m[90m▕ [0m[35;1m            ]);[0m
    [90m105[0m[90m▕ [0m
    [90m106[0m[90m▕ [0m[35;1m        [0m[39;1m$response[0m
    [90m107[0m[90m▕ [0m[39;1m            [0m[35;1m->[0m[39;1massertSessionHasNoErrors[0m[35;1m()[0m
[31;1m  ➜ [0m[3;1m108[0m[90m▕ [0m[35;1m            ->[0m[39;1massertRedirect[0m[35;1m([0m[37m'/'[0m[35;1m);[0m
    [90m109[0m[90m▕ [0m
    [90m110[0m[90m▕ [0m[35;1m        [0m[39;1mLog[0m[35;1m::[0m[39;1minfo[0m[35;1m([0m[37m'Verifying account deletion'[0m[35;1m);[0m
    [90m111[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertGuest[0m[35;1m();[0m
    [90m112[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertNull[0m[35;1m([0m[39;1m$user[0m[35;1m->[0m[39;1mfresh[0m[35;1m());[0m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\SpanAccessTest[22m [90m>[39m public spa… [41;1m BadMethodCallException [49;22m  
[39;1m  Call to undefined method App\Models\Span::makePublic()[39;22m

  at [32mvendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php[39m:[32m67[39m
    [90m 63[0m[90m▕ [0m[90;3m     * @throws \BadMethodCallException[0m
    [90m 64[0m[90m▕ [0m[90;3m     */[0m
    [90m 65[0m[90m▕ [0m[90;3m    [0m[35;1mprotected static function [0m[39;1mthrowBadMethodCallException[0m[35;1m([0m[39;1m$method[0m[35;1m)[0m
    [90m 66[0m[90m▕ [0m[35;1m    {[0m
[31;1m  ➜ [0m[3;1m 67[0m[90m▕ [0m[35;1m        throw new [0m[39;1mBadMethodCallException[0m[35;1m([0m[39;1msprintf[0m[35;1m([0m
    [90m 68[0m[90m▕ [0m[35;1m            [0m[37m'Call to undefined method %s::%s()'[0m[35;1m, static::class, [0m[39;1m$method[0m
    [90m 69[0m[90m▕ [0m[39;1m        [0m[35;1m));[0m
    [90m 70[0m[90m▕ [0m[35;1m    }[0m
    [90m 71[0m[90m▕ [0m[35;1m}[0m

      [2m+3 vendor frames [22m
  [33m4   [39m[39;1mtests/Feature/SpanAccessTest.php[39;22m:[39;1m44[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\SpanAccessTest[22m [90m>[39m shared spa… [41;1m BadMethodCallException [49;22m  
[39;1m  Call to undefined method App\Models\Span::grantPermission()[39;22m

  at [32mvendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php[39m:[32m67[39m
    [90m 63[0m[90m▕ [0m[90;3m     * @throws \BadMethodCallException[0m
    [90m 64[0m[90m▕ [0m[90;3m     */[0m
    [90m 65[0m[90m▕ [0m[90;3m    [0m[35;1mprotected static function [0m[39;1mthrowBadMethodCallException[0m[35;1m([0m[39;1m$method[0m[35;1m)[0m
    [90m 66[0m[90m▕ [0m[35;1m    {[0m
[31;1m  ➜ [0m[3;1m 67[0m[90m▕ [0m[35;1m        throw new [0m[39;1mBadMethodCallException[0m[35;1m([0m[39;1msprintf[0m[35;1m([0m
    [90m 68[0m[90m▕ [0m[35;1m            [0m[37m'Call to undefined method %s::%s()'[0m[35;1m, static::class, [0m[39;1m$method[0m
    [90m 69[0m[90m▕ [0m[39;1m        [0m[35;1m));[0m
    [90m 70[0m[90m▕ [0m[35;1m    }[0m
    [90m 71[0m[90m▕ [0m[35;1m}[0m

      [2m+3 vendor frames [22m
  [33m4   [39m[39;1mtests/Feature/SpanAccessTest.php[39;22m:[39;1m117[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\SpanAccessTest[22m [90m>[39m span delet… [41;1m BadMethodCallException [49;22m  
[39;1m  Call to undefined method App\Models\Span::grantPermission()[39;22m

  at [32mvendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php[39m:[32m67[39m
    [90m 63[0m[90m▕ [0m[90;3m     * @throws \BadMethodCallException[0m
    [90m 64[0m[90m▕ [0m[90;3m     */[0m
    [90m 65[0m[90m▕ [0m[90;3m    [0m[35;1mprotected static function [0m[39;1mthrowBadMethodCallException[0m[35;1m([0m[39;1m$method[0m[35;1m)[0m
    [90m 66[0m[90m▕ [0m[35;1m    {[0m
[31;1m  ➜ [0m[3;1m 67[0m[90m▕ [0m[35;1m        throw new [0m[39;1mBadMethodCallException[0m[35;1m([0m[39;1msprintf[0m[35;1m([0m
    [90m 68[0m[90m▕ [0m[35;1m            [0m[37m'Call to undefined method %s::%s()'[0m[35;1m, static::class, [0m[39;1m$method[0m
    [90m 69[0m[90m▕ [0m[39;1m        [0m[35;1m));[0m
    [90m 70[0m[90m▕ [0m[35;1m    }[0m
    [90m 71[0m[90m▕ [0m[35;1m}[0m

      [2m+3 vendor frames [22m
  [33m4   [39m[39;1mtests/Feature/SpanAccessTest.php[39;22m:[39;1m155[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\SpanAccessTest[22m [90m>[39m span edita… [41;1m BadMethodCallException [49;22m  
[39;1m  Call to undefined method App\Models\Span::grantPermission()[39;22m

  at [32mvendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php[39m:[32m67[39m
    [90m 63[0m[90m▕ [0m[90;3m     * @throws \BadMethodCallException[0m
    [90m 64[0m[90m▕ [0m[90;3m     */[0m
    [90m 65[0m[90m▕ [0m[90;3m    [0m[35;1mprotected static function [0m[39;1mthrowBadMethodCallException[0m[35;1m([0m[39;1m$method[0m[35;1m)[0m
    [90m 66[0m[90m▕ [0m[35;1m    {[0m
[31;1m  ➜ [0m[3;1m 67[0m[90m▕ [0m[35;1m        throw new [0m[39;1mBadMethodCallException[0m[35;1m([0m[39;1msprintf[0m[35;1m([0m
    [90m 68[0m[90m▕ [0m[35;1m            [0m[37m'Call to undefined method %s::%s()'[0m[35;1m, static::class, [0m[39;1m$method[0m
    [90m 69[0m[90m▕ [0m[39;1m        [0m[35;1m));[0m
    [90m 70[0m[90m▕ [0m[35;1m    }[0m
    [90m 71[0m[90m▕ [0m[35;1m}[0m

      [2m+3 vendor frames [22m
  [33m4   [39m[39;1mtests/Feature/SpanAccessTest.php[39;22m:[39;1m206[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\SpanConnectionT[22m… [41;1m UniqueConstraintViolationException [49;22m  
[39;1m  SQLSTATE[23505]: Unique violation: 7 ERROR:  duplicate key value violates unique constraint "spans_slug_unique"
DETAIL:  Key (slug)=(test-person-1) already exists. (Connection: testing, SQL: insert into "spans" ("id", "name", "type_id", "start_year", "start_month", "start_day", "end_year", "end_month", "end_day", "owner_id", "updater_id", "metadata", "start_precision", "end_precision", "slug", "access_level", "updated_at", "created_at") values (c1e87b3a-32fe-45d0-a101-97cc7995c97e, Cassie Dach, organisation, 1981, 11, 24, ?, ?, ?, 9f59d5c9-9d5a-4447-b1c8-f5022aea57a6, 9f59d5c9-a8f4-4098-a908-9e9e2224235d, [], day, year, test-person-1, public, 2025-07-09 17:24:36, 2025-07-09 17:24:36))[39;22m

  at [32mvendor/laravel/framework/src/Illuminate/Database/Connection.php[39m:[32m587[39m
    [90m583[0m[90m▕ [0m[35;1m            [0m[39;1m$this[0m[35;1m->[0m[39;1mbindValues[0m[35;1m([0m[39;1m$statement[0m[35;1m, [0m[39;1m$this[0m[35;1m->[0m[39;1mprepareBindings[0m[35;1m([0m[39;1m$bindings[0m[35;1m));[0m
    [90m584[0m[90m▕ [0m
    [90m585[0m[90m▕ [0m[35;1m            [0m[39;1m$this[0m[35;1m->[0m[39;1mrecordsHaveBeenModified[0m[35;1m();[0m
    [90m586[0m[90m▕ [0m
[31;1m  ➜ [0m[3;1m587[0m[90m▕ [0m[35;1m            return [0m[39;1m$statement[0m[35;1m->[0m[39;1mexecute[0m[35;1m();[0m
    [90m588[0m[90m▕ [0m[35;1m        });[0m
    [90m589[0m[90m▕ [0m[35;1m    }[0m
    [90m590[0m[90m▕ [0m
    [90m591[0m[90m▕ [0m[35;1m    [0m[90;3m/**[0m

      [2m+14 vendor frames [22m
  [33m15  [39m[39;1mtests/Feature/SpanConnectionTypesTest.php[39;22m:[39;1m14[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\SpanConnectionT[22m… [41;1m UniqueConstraintViolationException [49;22m  
[39;1m  SQLSTATE[23505]: Unique violation: 7 ERROR:  duplicate key value violates unique constraint "spans_slug_unique"
DETAIL:  Key (slug)=(test-person-2) already exists. (Connection: testing, SQL: insert into "spans" ("id", "name", "type_id", "start_year", "start_month", "start_day", "end_year", "end_month", "end_day", "owner_id", "updater_id", "metadata", "start_precision", "end_precision", "slug", "access_level", "updated_at", "created_at") values (342853e6-a7cd-40af-985f-259473950e8c, Lewis Spinka, event, 1965, 6, 5, ?, ?, ?, 9f59d5c9-dd12-46ff-b38c-003c240f1a80, 9f59d5c9-f95a-4e14-b62e-98c9b3246fdd, [], day, year, test-person-2, public, 2025-07-09 17:24:36, 2025-07-09 17:24:36))[39;22m

  at [32mvendor/laravel/framework/src/Illuminate/Database/Connection.php[39m:[32m587[39m
    [90m583[0m[90m▕ [0m[35;1m            [0m[39;1m$this[0m[35;1m->[0m[39;1mbindValues[0m[35;1m([0m[39;1m$statement[0m[35;1m, [0m[39;1m$this[0m[35;1m->[0m[39;1mprepareBindings[0m[35;1m([0m[39;1m$bindings[0m[35;1m));[0m
    [90m584[0m[90m▕ [0m
    [90m585[0m[90m▕ [0m[35;1m            [0m[39;1m$this[0m[35;1m->[0m[39;1mrecordsHaveBeenModified[0m[35;1m();[0m
    [90m586[0m[90m▕ [0m
[31;1m  ➜ [0m[3;1m587[0m[90m▕ [0m[35;1m            return [0m[39;1m$statement[0m[35;1m->[0m[39;1mexecute[0m[35;1m();[0m
    [90m588[0m[90m▕ [0m[35;1m        });[0m
    [90m589[0m[90m▕ [0m[35;1m    }[0m
    [90m590[0m[90m▕ [0m
    [90m591[0m[90m▕ [0m[35;1m    [0m[90;3m/**[0m

      [2m+14 vendor frames [22m
  [33m15  [39m[39;1mtests/Feature/SpanConnectionTypesTest.php[39;22m:[39;1m27[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\SpanConnectionTypesTest[22m [90m>[39m specific connection shows…   
[39;1m  Failed asserting that '<!DOCTYPE html>\n
[39;22m[39;1m<html lang="en">[39;22m[39;1m\n
    [39;22m[39;1m<head>[39;22m[39;1m\n
        [39;22m[39;1m<meta charset="utf-8">[39;22m[39;1m\n
        [39;22m[39;1m<meta name="viewport" content="width=device-width, initial-scale=1">[39;22m[39;1m\n
        [39;22m[39;1m<meta name="csrf-token" content="hGvL3t0txUmKFLFzTyZFCA6LXzg1aMBIxZDG907y">[39;22m[39;1m\n
        [39;22m[39;1m<base href="http://localhost:8000/spans/9e00e530-e21c-438e-8c80-073adbae0e57/lived-in/57f73eb0-4717-4917-bc43-2bfcbf306175">[39;22m[39;1m\n
\n
        [39;22m[39;1m<title>[39;22m[39;1mLifespan Beta Testing[39;22m[39;1m</title>[39;22m[39;1m\n
\n
        <!-- Favicon -->\n
        [39;22m[39;1m<link rel="icon" href="http://localhost:8000/favicon.ico" type="image/x-icon">[39;22m[39;1m\n
\n
        <!-- jQuery -->\n
        [39;22m[39;1m<script src="https://code.jquery.com/jquery-3.7.1.min.js">[39;22m[39;1m</script>[39;22m[39;1m\n
\n
        <!-- Bootstrap -->\n
        [39;22m[39;1m<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">[39;22m[39;1m</script>[39;22m[39;1m\n
\n
        <!-- Bootstrap Icons -->\n
        [39;22m[39;1m<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">[39;22m[39;1m\n
        <!-- Fallback for Bootstrap Icons if local fonts fail -->\n
        [39;22m[39;1m<style>[39;22m[39;1m\n
            @font-face {\n
                font-display: block;\n
                font-family: "bootstrap-icons";\n
                src: url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/fonts/bootstrap-icons.woff2") format("woff2"),\n
                     url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/fonts/bootstrap-icons.woff") format("woff");\n
            }\n
        [39;22m[39;1m</style>[39;22m[39;1m\n
        \n
        <!-- Select2 -->\n
        [39;22m[39;1m<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />[39;22m[39;1m\n
        [39;22m[39;1m<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />[39;22m[39;1m\n
        [39;22m[39;1m<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js">[39;22m[39;1m</script>[39;22m[39;1m\n
\n
        <!-- Scripts and Styles -->\n
        [39;22m[39;1m<script type="module" >[39;22m[39;1m\n
    import RefreshRuntime from 'http://localhost:5173/@react-refresh'\n
    RefreshRuntime.injectIntoGlobalHook(window)\n
    window.$RefreshReg$ = () => {}\n
    window.$RefreshSig$ = () => (type) => type\n
    window.__vite_plugin_react_preamble_installed__ = true\n
[39;22m[39;1m</script>[39;22m[39;1m        [39;22m[39;1m<script type="module" src="http://localhost:5173/@vite/client">[39;22m[39;1m</script>[39;22m[39;1m<link rel="stylesheet" href="http://localhost:5173/resources/scss/app.scss" />[39;22m[39;1m<script type="module" src="http://localhost:5173/resources/js/app.js">[39;22m[39;1m</script>[39;22m[39;1m<script type="module" src="http://localhost:5173/resources/js/routes.js">[39;22m[39;1m</script>[39;22m[39;1m\n
        <!-- Google Analytics - Production Only -->\n
        \n
        <!-- Page-specific styles -->\n
                \n
        <!-- Custom styles -->\n
        [39;22m[39;1m<style>[39;22m[39;1m\n
            /* Only add minimal custom styling, prefer Bootstrap classes */\n
            .nav-link {\n
                color: rgba(255, 255, 255, 0.8) !important;\n
            }\n
            .nav-link:hover, .nav-link.active {\n
                color: #fff !important;\n
                background-color: rgba(255, 255, 255, 0.1);\n
            }\n
            \n
            /* Collapsible sidebar styles */\n
            :root {\n
                --sidebar-width-lg: 280px;\n
                --sidebar-width-md: 240px;\n
                --sidebar-width-collapsed: 60px;\n
                --sidebar-transition: 0.3s ease-in-out;\n
            }\n
            \n
            /* Prevent animations on initial load */\n
            .sidebar {\n
                transition: none !important;\n
                overflow: hidden;\n
                width: var(--sidebar-width-md);\n
                margin: 0;\n
                padding: 0;\n
                flex-shrink: 0;\n
            }\n
            \n
            /* Responsive widths */\n
            @media (min-width: 992px) {\n
                .sidebar {\n
                    width: var(--sidebar-width-lg);\n
                }\n
            }\n
            \n
            /* Enable animations after page load */\n
            .sidebar.animated {\n
                transition: width var(--sidebar-transition) !important;\n
            }\n
            \n
            .sidebar.collapsed {\n
                width: var(--sidebar-width-collapsed) !important;\n
            }\n
            \n
            .sidebar.collapsed .nav-link {\n
                text-align: center;\n
                padding: 0.75rem 0.5rem;\n
            }\n
            \n
            .sidebar.collapsed .nav-link span {\n
                display: none;\n
            }\n
            \n
            .sidebar.collapsed .sidebar-heading {\n
                display: none;\n
            }\n
            \n
            .sidebar.collapsed .sidebar-footer {\n
                display: none;\n
            }\n
            \n
            .sidebar.collapsed .sidebar-brand span {\n
                display: none;\n
            }\n
            \n
            /* Hide text during animation */\n
            .sidebar.animating .nav-link span,\n
            .sidebar.animating .sidebar-brand span {\n
                display: none;\n
            }\n
            \n
            .sidebar.collapsed .nav-link i {\n
                margin-right: 0 !important;\n
                font-size: 1.1em;\n
            }\n
            \n
            .main-content {\n
                transition: none !important;\n
                flex: 1;\n
                margin: 0;\n
                padding: 0;\n
                min-width: 0;\n
            }\n
            \n
            .main-content.animated {\n
                transition: margin-left var(--sidebar-transition) !important;\n
            }\n
            \n
            .sidebar-toggle {\n
                transition: none !important;\n
            }\n
            \n
            .sidebar-toggle.animated {\n
                transition: transform var(--sidebar-transition) !important;\n
            }\n
            \n
            .sidebar-toggle.collapsed {\n
                transform: rotate(180deg);\n
            }\n
            \n
            /* Subtle border toggle button */\n
            .sidebar-toggle-btn {\n
                position: fixed;\n
                top: 0;\n
                left: var(--sidebar-width-md);\n
                width: 20px;\n
                height: 56px;\n
                background: transparent;\n
                border: none;\n
                display: flex;\n
                align-items: center;\n
                justify-content: center;\n
                cursor: pointer;\n
                z-index: 1000;\n
                transition: none !important;\n
                color: #6c757d;\n
            }\n
            \n
            .sidebar-toggle-btn:hover {\n
                color: #495057;\n
            }\n
            \n
            .sidebar-toggle-btn.animated {\n
                transition: left var(--sidebar-transition) !important;\n
            }\n
            \n
            .sidebar-toggle-btn.collapsed {\n
                left: var(--sidebar-width-collapsed);\n
                transform: rotate(180deg);\n
            }\n
            \n
            /* Responsive positioning for toggle button */\n
            @media (min-width: 992px) {\n
                .sidebar-toggle-btn {\n
                    left: var(--sidebar-width-lg);\n
                }\n
                \n
                .sidebar-toggle-btn.collapsed {\n
                    left: var(--sidebar-width-collapsed);\n
                }\n
            }\n
            \n
            /* Tooltip positioning for collapsed sidebar */\n
            .sidebar.collapsed .nav-link[data-bs-toggle="tooltip"] {\n
                position: relative;\n
            }\n
            \n
            /* Remove any gaps from Bootstrap row/col system */\n
            .row {\n
                margin: 0;\n
            }\n
            \n
            .row > * {\n
                padding: 0;\n
            }\n
            \n
            /* Ensure sidebar and main content are side by side */\n
            .sidebar-row {\n
                display: flex;\n
                flex-direction: row;\n
            }\n
            \n
            /* Preserve Bootstrap spacing for main content area */\n
            .main-content .row {\n
                margin-left: -0.75rem;\n
                margin-right: -0.75rem;\n
            }\n
            \n
            .main-content .row > * {\n
                padding-left: 0.75rem;\n
                padding-right: 0.75rem;\n
            }\n
            \n
            /* Preserve Bootstrap spacing for card layouts */\n
            .spans-list .row,\n
            .card-grid .row {\n
                margin-left: -0.75rem;\n
                margin-right: -0.75rem;\n
            }\n
            \n
            .spans-list .row > *,\n
            .card-grid .row > * {\n
                padding-left: 0.75rem;\n
                padding-right: 0.75rem;\n
            }\n
        [39;22m[39;1m</style>[39;22m[39;1m\n
        \n
        <!-- Page-specific scripts -->\n
                [39;22m[39;1m<script src="https://d3js.org/d3.v7.min.js">[39;22m[39;1m</script>[39;22m[39;1m\n
[39;22m[39;1m<script>[39;22m[39;1m\n
// Use a unique identifier to avoid conflicts with other timeline components\n
const combinedTimelineId = 'combined_ea3988ac_cd1e_440c_95b9_cc09039d152f';\n
\n
document.addEventListener('DOMContentLoaded', function() {\n
    // Add a small delay to ensure DOM is fully ready\n
    setTimeout(() => {\n
        initializeCombinedTimeline_ea3988ac_cd1e_440c_95b9_cc09039d152f();\n
    }, 100);\n
});\n
\n
function initializeCombinedTimeline_ea3988ac_cd1e_440c_95b9_cc09039d152f() {\n
    const spanId = 'ea3988ac-cd1e-440c-95b9-cc09039d152f';\n
    const currentUserSpanId = '';\n
    const container = document.getElementById(`timeline-combined-container-${spanId}`);\n
    \n
    // Check if container exists\n
    if (!container) {\n
        console.error('Combined timeline container not found:', `timeline-combined-container-${spanId}`);\n
        return;\n
    }\n
    \n
    console.log('Initializing combined timeline for span:', spanId);\n
    console.log('Current user span ID:', currentUserSpanId);\n
    \n
    // Fetch both the current span's timeline and object connections\n
    Promise.all([\n
        fetch(`/api/spans/${spanId}`, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } }).then(response => response.json()),\n
        fetch(`/api/spans/${spanId}/object-connections`, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } }).then(response => response.json()),\n
        fetch(`/api/spans/${spanId}/during-connections`, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } }).then(response => response.json())\n
    ])\n
    .then(([currentSpanData, objectConnectionsData, duringConnectionsData]) => {\n
        // Extract unique subjects from the object connections, excluding connection spans\n
        const subjects = [...new Set(\n
            objectConnectionsData.connections\n
                .filter(conn => conn.target_type !== 'connection') // Exclude connections to connection spans\n
                .map(conn => conn.target_id)\n
        )];\n
        \n
        // Check if we need to add the current user's span\n
        const allSubjectIds = new Set(subjects);\n
        const needsUserSpan = currentUserSpanId && \n
                             currentUserSpanId !== spanId && \n
                             !allSubjectIds.has(currentUserSpanId);\n
        \n
        if (needsUserSpan) {\n
            allSubjectIds.add(currentUserSpanId);\n
        }\n
        \n
        // Prepare timeline data array - we'll build it in the desired order\n
        let timelineData = [];\n
        \n
        // Add user's span first if it exists and is different from current span\n
        if (needsUserSpan) {\n
            timelineData.push({\n
                id: currentUserSpanId,\n
                name: 'You',\n
                timeline: null, // Will be fetched\n
                isCurrentSpan: false,\n
                isCurrentUser: true\n
            });\n
        }\n
        \n
        // Add current span\n
        timelineData.push({\n
            id: spanId,\n
            name: currentSpanData.span.name,\n
            timeline: currentSpanData,\n
            duringConnections: duringConnectionsData.connections || [],\n
            isCurrentSpan: true,\n
            isCurrentUser: false\n
        });\n
        \n
        if (allSubjectIds.size > 0) {\n
            // Fetch timeline data for each subject (excluding user and current span)\n
            const subjectIdsToFetch = Array.from(allSubjectIds).filter(subjectId => \n
                subjectId !== currentUserSpanId && subjectId !== spanId\n
            );\n
            \n
            const subjectPromises = subjectIdsToFetch.map(subjectId => \n
                Promise.all([\n
                    fetch(`/api/spans/${subjectId}`, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } }).then(response => response.json()),\n
                    fetch(`/api/spans/${subjectId}/during-connections`, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } }).then(response => response.json())\n
                ])\n
                .then(([subjectData, duringData]) => ({\n
                    id: subjectId,\n
                    name: objectConnectionsData.connections.find(conn => conn.target_id === subjectId)?.target_name || 'Unknown',\n
                    timeline: subjectData,\n
                    duringConnections: duringData.connections || [],\n
                    isCurrentSpan: false,\n
                    isCurrentUser: false\n
                }))\n
                .catch(error => {\n
                    console.error(`Error loading timeline for subject ${subjectId}:`, error);\n
                    return null;\n
                })\n
            );\n
            \n
            // If we need to fetch user's timeline data, add it to the promises\n
            if (needsUserSpan) {\n
                subjectPromises.unshift(\n
                    Promise.all([\n
                        fetch(`/api/spans/${currentUserSpanId}`, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } }).then(response => response.json()),\n
                        fetch(`/api/spans/${currentUserSpanId}/during-connections`, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } }).then(response => response.json())\n
                    ])\n
                    .then(([subjectData, duringData]) => ({\n
                        id: currentUserSpanId,\n
                        name: 'You',\n
                        timeline: subjectData,\n
                        duringConnections: duringData.connections || [],\n
                        isCurrentSpan: false,\n
                        isCurrentUser: true\n
                    }))\n
                    .catch(error => {\n
                        console.error(`Error loading timeline for user ${currentUserSpanId}:`, error);\n
                        return null;\n
                    })\n
                );\n
            }\n
            \n
            Promise.all(subjectPromises)\n
                .then(subjectData => {\n
                    const validSubjects = subjectData.filter(subject => subject !== null);\n
                    \n
                    // Update the timeline data with fetched data\n
                    if (needsUserSpan) {\n
                        const userData = validSubjects.find(subject => subject.id === currentUserSpanId);\n
                        if (userData) {\n
                            timelineData[0] = userData; // Update the user's entry with fetched data\n
                        }\n
                    }\n
                    \n
                    // Add other subjects after current span\n
                    const otherSubjects = validSubjects.filter(subject => \n
                        subject.id !== currentUserSpanId && subject.id !== spanId\n
                    );\n
                    timelineData.push(...otherSubjects);\n
                    \n
                    // Collect all during connections and nested connections from all timelines\n
                    const allDuringConnections = [];\n
                    timelineData.forEach(timeline => {\n
                        if (timeline.duringConnections) {\n
                            allDuringConnections.push(...timeline.duringConnections);\n
                        }\n
                        // Also collect nested connections from the timeline data itself\n
                        if (timeline.timeline.connections) {\n
                            timeline.timeline.connections.forEach(connection => {\n
                                if (connection.nested_connections) {\n
                                    allDuringConnections.push(...connection.nested_connections);\n
                                }\n
                            });\n
                        }\n
                    });\n
                    \n
                    // Add all during connections to the person's timeline (assuming the first timeline is the person)\n
                    if (timelineData.length > 0) {\n
                        timelineData[0].duringConnections = allDuringConnections;\n
                    }\n
                    \n
                    renderCombinedTimeline_ea3988ac_cd1e_440c_95b9_cc09039d152f(timelineData, currentSpanData.span, 'absolute', currentUserSpanId);\n
                    \n
                    // Add event listeners for mode toggle\n
                    setupModeToggle_ea3988ac_cd1e_440c_95b9_cc09039d152f(timelineData, currentSpanData.span, currentUserSpanId);\n
                })\n
                .catch(error => {\n
                    console.error('Error loading subject timelines:', error);\n
                    // Still render with what we have\n
                    renderCombinedTimeline_ea3988ac_cd1e_440c_95b9_cc09039d152f(timelineData, currentSpanData.span, 'absolute', currentUserSpanId);\n
                    \n
                    // Add event listeners for mode toggle\n
                    setupModeToggle_ea3988ac_cd1e_440c_95b9_cc09039d152f(timelineData, currentSpanData.span, currentUserSpanId);\n
                });\n
        } else {\n
            // No subjects, just render current span (and user span if needed)\n
            renderCombinedTimeline_ea3988ac_cd1e_440c_95b9_cc09039d152f(timelineData, currentSpanData.span, 'absolute', currentUserSpanId);\n
            \n
            // Add event listeners for mode toggle\n
            setupModeToggle_ea3988ac_cd1e_440c_95b9_cc09039d152f(timelineData, currentSpanData.span, currentUserSpanId);\n
        }\n
    })\n
    .catch(error => {\n
        console.error('Error loading combined timeline data:', error);\n
        const container = document.getElementById(`timeline-combined-container-${spanId}`);\n
        if (container) {\n
            container.innerHTML = '[39;22m[39;1m<div class="text-danger text-center py-4">[39;22m[39;1mError loading combined timeline data[39;22m[39;1m</div>[39;22m[39;1m';\n
        }\n
    });\n
}\n
\n
function renderCombinedTimeline_ea3988ac_cd1e_440c_95b9_cc09039d152f(timelineData, currentSpan, mode = 'absolute', currentUserSpanId = null) {\n
    const spanId = 'ea3988ac-cd1e-440c-95b9-cc09039d152f';\n
    console.log('Rendering combined timeline with mode:', mode);\n
    console.log('Current user span ID:', currentUserSpanId);\n
    const container = document.getElementById(`timeline-combined-container-${spanId}`);\n
    \n
    // Check if container exists\n
    if (!container) {\n
        console.error('Combined timeline container not found during render:', `timeline-combined-container-${spanId}`);\n
        return;\n
    }\n
    \n
    const width = container.clientWidth;\n
    const margin = { top: 20, right: 20, bottom: 30, left: 20 };\n
    const swimlaneHeight = 20;\n
    const swimlaneSpacing = 10;\n
    const swimlaneBottomMargin = 30; // Extra space between swimlanes and scale\n
    const totalSwimlanes = timelineData.length;\n
    const totalHeight = totalSwimlanes * (swimlaneHeight + swimlaneSpacing) - swimlaneSpacing + swimlaneBottomMargin;\n
    const adjustedHeight = totalHeight + margin.top + margin.bottom;\n
    \n
    // Set container height to fit content\n
    container.style.height = `${adjustedHeight}px`;\n
\n
    container.innerHTML = '';\n
    const svg = d3.select(container)\n
        .append('svg')\n
        .attr('width', width)\n
        .attr('height', adjustedHeight);\n
\n
    // Calculate global time range across all timelines based on mode\n
    const timeRange = mode === 'absolute' \n
        ? calculateCombinedTimeRange_ea3988ac_cd1e_440c_95b9_cc09039d152f(timelineData, currentSpan)\n
        : calculateRelativeTimeRange_ea3988ac_cd1e_440c_95b9_cc09039d152f(timelineData, currentSpan);\n
    \n
    const xScale = d3.scaleLinear()\n
        .domain([timeRange.start, timeRange.end])\n
        .range([margin.left, width - margin.right]);\n
\n
    const xAxis = d3.axisBottom(xScale)\n
        .tickFormat(mode === 'absolute' ? d3.format('d') : (d) => `Age ${d}`)\n
        .ticks(10);\n
\n
    svg.append('g')\n
        .attr('transform', `translate(0, ${adjustedHeight - margin.bottom})`)\n
        .call(xAxis);\n
\n
    function getConnectionColor(typeId) {\n
        const cssColor = getComputedStyle(document.documentElement)\n
            .getPropertyValue(`--connection-${typeId}-color`);\n
        if (cssColor && cssColor.trim() !== '') return cssColor.trim();\n
        const testElement = document.createElement('div');\n
        testElement.className = `bg-${typeId}`;\n
        testElement.style.display = 'none';\n
        document.body.appendChild(testElement);\n
        const computedStyle = getComputedStyle(testElement);\n
        const backgroundColor = computedStyle.backgroundColor;\n
        document.body.removeChild(testElement);\n
        if (backgroundColor && backgroundColor !== 'rgba(0, 0, 0, 0)' && backgroundColor !== 'transparent') return backgroundColor;\n
        const fallbackColors = {\n
            'residence': '#007bff', 'employment': '#28a745', 'education': '#ffc107', 'membership': '#dc3545',\n
            'family': '#6f42c1', 'relationship': '#fd7e14', 'travel': '#20c997', 'participation': '#e83e8c',\n
            'ownership': '#6c757d', 'created': '#17a2b8', 'contains': '#6610f2', 'has_role': '#fd7e14',\n
            'at_organisation': '#20c997', 'life': '#000000'\n
        };\n
        return fallbackColors[typeId] || '#6c757d';\n
    }\n
\n
    const connectionColors = { 'life': '#000000' };\n
\n
    // Create swimlanes for each timeline\n
    timelineData.forEach((timeline, index) => {\n
        const swimlaneY = margin.top + index * (swimlaneHeight + swimlaneSpacing);\n
        const isCurrentSpan = timeline.isCurrentSpan;\n
        const isCurrentUser = currentUserSpanId && timeline.id === currentUserSpanId;\n
        \n
        // Draw swimlane background with special styling for current span and current user\n
        svg.append('rect')\n
            .attr('x', margin.left)\n
            .attr('y', swimlaneY)\n
            .attr('width', width - margin.left - margin.right)\n
            .attr('height', swimlaneHeight)\n
            .attr('fill', isCurrentSpan ? '#e3f2fd' : '#f8f9fa')\n
            .attr('stroke', isCurrentUser ? '#000000' : (isCurrentSpan ? '#dee2e6' : '#dee2e6'))\n
            .attr('stroke-width', isCurrentUser ? 1 : (isCurrentSpan ? 1 : 1))\n
            .attr('rx', 4)\n
            .attr('ry', 4);\n
\n
        // Store label info for later rendering (after all timeline elements)\n
        timeline.labelInfo = {\n
            name: timeline.name,\n
            swimlaneY: swimlaneY,\n
            isCurrentSpan: isCurrentSpan,\n
            isCurrentUser: isCurrentUser\n
        };\n
\n
        // Add life span bar for this timeline\n
        const timelineSpan = timeline.timeline.span;\n
        if (timelineSpan && timelineSpan.start_year) {\n
            const lifeStartYear = mode === 'absolute' ? timelineSpan.start_year : 0;\n
            const lifeEndYear = mode === 'absolute' \n
                ? (timelineSpan.end_year || new Date().getFullYear())\n
                : (timelineSpan.end_year ? timelineSpan.end_year - timelineSpan.start_year : new Date().getFullYear() - timelineSpan.start_year);\n
            const hasConnections = timeline.timeline.connections && timeline.timeline.connections.length > 0;\n
            \n
            svg.append('rect')\n
                .attr('class', 'life-span')\n
                .attr('x', xScale(lifeStartYear))\n
                .attr('y', swimlaneY + 2)\n
                .attr('width', xScale(lifeEndYear) - xScale(lifeStartYear))\n
                .attr('height', swimlaneHeight - 4)\n
                .attr('fill', connectionColors.life)\n
                .attr('stroke', 'white')\n
                .attr('stroke-width', hasConnections ? 2 : 3)\n
                .attr('rx', 2)\n
                .attr('ry', 2)\n
                .style('opacity', hasConnections ? 0.3 : 0.7)\n
                .style('pointer-events', 'auto') // Always allow interaction\n
                .on('mouseover', function(event) {\n
                    d3.select(this).style('opacity', 0.9);\n
                    updateLifeSpanTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f(event, timelineSpan, timelineData, timeline.name, isCurrentSpan, mode);\n
                })\n
                .on('mousemove', function(event) {\n
                    updateLifeSpanTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f(event, timelineSpan, timelineData, timeline.name, isCurrentSpan, mode);\n
                })\n
                .on('mouseout', function() {\n
                    d3.select(this).style('opacity', hasConnections ? 0.3 : 0.7);\n
                    hideCombinedTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f();\n
                });\n
        }\n
\n
        // Add connections for this timeline\n
        if (timeline.timeline.connections) {\n
            timeline.timeline.connections\n
                .filter(connection => connection.target_type !== 'connection') // Exclude connections to connection spans\n
                .forEach(connection => {\n
                const connectionType = connection.type_id;\n
                \n
                if (connectionType === 'created') {\n
                    const connectionStartYear = mode === 'absolute' ? connection.start_year : connection.start_year - timelineSpan.start_year;\n
                    const x = xScale(connectionStartYear);\n
                    const y1 = swimlaneY;\n
                    const y2 = swimlaneY + swimlaneHeight;\n
                    const circleY = (y1 + y2) / 2;\n
                    const circleRadius = 3;\n
                    \n
                    svg.append('line')\n
                        .attr('class', 'timeline-moment')\n
                        .attr('x1', x)\n
                        .attr('x2', x)\n
                        .attr('y1', y1)\n
                        .attr('y2', y2)\n
                        .attr('stroke', getConnectionColor(connectionType))\n
                        .attr('stroke-width', 2)\n
                        .style('opacity', 0.8)\n
                        .on('mouseover', function(event) {\n
                            d3.select(this).style('opacity', 0.9);\n
                            updateConnectionTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f(event, [connection], timeline.name, isCurrentSpan, mode);\n
                        })\n
                        .on('mousemove', function(event) {\n
                            updateConnectionTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f(event, [connection], timeline.name, isCurrentSpan, mode);\n
                        })\n
                        .on('mouseout', function() {\n
                            d3.select(this).style('opacity', 0.8);\n
                            hideCombinedTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f();\n
                        });\n
                    \n
                    svg.append('circle')\n
                        .attr('class', 'timeline-moment-circle')\n
                        .attr('cx', x)\n
                        .attr('cy', circleY)\n
                        .attr('r', circleRadius)\n
                        .attr('fill', getConnectionColor(connectionType))\n
                        .attr('stroke', 'white')\n
                        .attr('stroke-width', 1)\n
                        .style('opacity', 0.9)\n
                        .on('mouseover', function(event) {\n
                            d3.select(this).style('opacity', 1);\n
                            updateConnectionTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f(event, [connection], timeline.name, isCurrentSpan, mode);\n
                        })\n
                        .on('mousemove', function(event) {\n
                            updateConnectionTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f(event, [connection], timeline.name, isCurrentSpan, mode);\n
                        })\n
                        .on('mouseout', function() {\n
                            d3.select(this).style('opacity', 0.9);\n
                            hideCombinedTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f();\n
                        });\n
                } else {\n
                    const connectionStartYear = mode === 'absolute' ? connection.start_year : connection.start_year - timelineSpan.start_year;\n
                    const connectionEndYear = mode === 'absolute' \n
                        ? (connection.end_year || new Date().getFullYear())\n
                        : (connection.end_year ? connection.end_year - timelineSpan.start_year : new Date().getFullYear() - timelineSpan.start_year);\n
                    const connectionWidth = xScale(connectionEndYear) - xScale(connectionStartYear);\n
                    \n
                    svg.append('rect')\n
                        .attr('class', 'timeline-bar')\n
                        .attr('x', xScale(connectionStartYear))\n
                        .attr('y', swimlaneY + 2)\n
                        .attr('width', Math.max(1, connectionWidth))\n
                        .attr('height', swimlaneHeight - 4)\n
                        .attr('fill', getConnectionColor(connectionType))\n
                        .attr('stroke', 'white')\n
                        .attr('stroke-width', 1)\n
                        .attr('rx', 2)\n
                        .attr('ry', 2)\n
                        .style('opacity', 0.6)\n
                        .on('mouseover', function(event) {\n
                            d3.select(this).style('opacity', 0.9);\n
                            updateConnectionTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f(event, [connection], timeline.name, isCurrentSpan, mode);\n
                        })\n
                        .on('mousemove', function(event) {\n
                            updateConnectionTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f(event, [connection], timeline.name, isCurrentSpan, mode);\n
                        })\n
                        .on('mouseout', function() {\n
                            d3.select(this).style('opacity', 0.6);\n
                            hideCombinedTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f();\n
                        });\n
                }\n
            });\n
        }\n
\n
        // Add "during" connections for this timeline (nested within the span)\n
        if (timeline.duringConnections && timeline.duringConnections.length > 0 && index === 0) {\n
            // Only show during connections in the person's timeline (first timeline)\n
            timeline.duringConnections.forEach(connection => {\n
                const connectionStartYear = mode === 'absolute' ? connection.start_year : connection.start_year - timelineSpan.start_year;\n
                const connectionEndYear = mode === 'absolute' \n
                    ? (connection.end_year || new Date().getFullYear())\n
                    : (connection.end_year ? connection.end_year - timelineSpan.start_year : new Date().getFullYear() - timelineSpan.start_year);\n
                const connectionWidth = xScale(connectionEndYear) - xScale(connectionStartYear);\n
                \n
                // Create a nested bar with a different style to show it's within the span\n
                svg.append('rect')\n
                    .attr('class', 'timeline-during-bar')\n
                    .attr('x', xScale(connectionStartYear))\n
                    .attr('y', swimlaneY + 4)\n
                    .attr('width', Math.max(1, connectionWidth))\n
                    .attr('height', swimlaneHeight - 8)\n
                    .attr('fill', getConnectionColor(connection.type_id))\n
                    .attr('stroke', 'white')\n
                    .attr('stroke-width', 1)\n
                    .attr('rx', 1)\n
                    .attr('ry', 1)\n
                    .style('opacity', 0.4) // Make more subtle\n
                    // .style('stroke-dasharray', '2,2') // Remove dashed border\n
                    .on('mouseover', function(event) {\n
                        d3.select(this).style('opacity', 1);\n
                        updateConnectionTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f(event, [connection], timeline.name, isCurrentSpan, mode, true);\n
                    })\n
                    .on('mousemove', function(event) {\n
                        updateConnectionTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f(event, [connection], timeline.name, isCurrentSpan, mode, true);\n
                    })\n
                    .on('mouseout', function() {\n
                        d3.select(this).style('opacity', 0.4);\n
                        hideCombinedTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f();\n
                    });\n
            });\n
        }\n
    });\n
\n
    // Add "now" line (current year) - only in absolute mode\n
    if (mode === 'absolute') {\n
        const currentYear = new Date().getFullYear();\n
        const nowX = xScale(currentYear);\n
        \n
        // Only show the "now" line if it's within the visible time range\n
        if (nowX >= margin.left && nowX <= width - margin.right) {\n
            svg.append('line')\n
                .attr('class', 'now-line')\n
                .attr('x1', nowX)\n
                .attr('x2', nowX)\n
                .attr('y1', margin.top)\n
                .attr('y2', adjustedHeight - margin.bottom)\n
                .attr('stroke', '#dc3545')\n
                .attr('stroke-width', 1)\n
                .style('opacity', 0.8);\n
            \n
            // Add "NOW" label\n
            svg.append('text')\n
                .attr('class', 'now-label')\n
                .attr('x', nowX + 5)\n
                .attr('y', margin.top + 15)\n
                .attr('text-anchor', 'start')\n
                .attr('font-size', '10px')\n
                .attr('font-weight', 'bold')\n
                .attr('fill', '#dc3545')\n
                .text('NOW');\n
        }\n
    }\n
\n
    // Add swimlane labels at the very end to ensure they're on top\n
    timelineData.forEach((timeline) => {\n
        if (timeline.labelInfo) {\n
            const { name, swimlaneY, isCurrentSpan, isCurrentUser } = timeline.labelInfo;\n
            \n
            // Add swimlane label floating on top\n
            svg.append('text')\n
                .attr('class', 'swimlane-label')\n
                .attr('x', margin.left + 8)\n
                .attr('y', swimlaneY + swimlaneHeight / 2 + 4)\n
                .attr('text-anchor', 'start')\n
                .attr('font-size', '11px')\n
                .attr('font-weight', (isCurrentSpan || isCurrentUser) ? 'bold' : 'normal')\n
                .attr('fill', mode === 'relative' ? 'white' : (isCurrentSpan ? '#1976d2' : (isCurrentUser ? '#000000' : '#495057')))\n
                .style('pointer-events', 'none')\n
                .style('z-index', '1001')\n
                .text(name);\n
        }\n
    });\n
\n
    // Create tooltip\n
    const tooltip = d3.select('body').append('div')\n
        .attr('class', `combined-tooltip-${spanId}`)\n
        .style('position', 'absolute')\n
        .style('background', 'rgba(0, 0, 0, 0.8)')\n
        .style('color', 'white')\n
        .style('padding', '8px')\n
        .style('border-radius', '4px')\n
        .style('font-size', '12px')\n
        .style('pointer-events', 'none')\n
        .style('opacity', 0);\n
\n
    function showCombinedTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f(event, connections, timelineName, isCurrentSpan, hoverYear, mode = 'absolute', isDuring = false) {\n
        tooltip.transition().duration(200).style('opacity', 1);\n
        let tooltipContent = '';\n
        \n
        console.log('showCombinedTooltip called with hoverYear:', hoverYear, 'timelineName:', timelineName, 'isDuring:', isDuring);\n
        \n
        if (mode === 'relative') {\n
            // In relative mode, show "At age X" as the main header\n
            tooltipContent = `[39;22m[39;1m<strong>[39;22m[39;1mAt age ${hoverYear}[39;22m[39;1m</strong>[39;22m[39;1m`;\n
        } else {\n
            // In absolute mode, show "In {year}" as the main header\n
            tooltipContent = `[39;22m[39;1m<strong>[39;22m[39;1mIn ${hoverYear}[39;22m[39;1m</strong>[39;22m[39;1m`;\n
        }\n
        \n
        // Add connection details\n
        if (connections && connections.length > 0) {\n
            const connection = connections[0];\n
            const connectionType = isDuring ? 'during' : connection.type_id;\n
            const targetName = connection.target_name || 'Unknown';\n
            const targetType = connection.target_type || 'unknown';\n
            \n
            tooltipContent += `[39;22m[39;1m<br/>[39;22m[39;1m<br/>[39;22m[39;1m`;\n
            if (isDuring) {\n
                tooltipContent += `[39;22m[39;1m<strong>[39;22m[39;1m${targetName}[39;22m[39;1m</strong>[39;22m[39;1m (${targetType})[39;22m[39;1m<br/>[39;22m[39;1m`;\n
                tooltipContent += `[39;22m[39;1m<em>[39;22m[39;1mPhase during ${timelineName}'s activities[39;22m[39;1m</em>[39;22m[39;1m`;\n
            } else {\n
                tooltipContent += `[39;22m[39;1m<strong>[39;22m[39;1m${connectionType}[39;22m[39;1m</strong>[39;22m[39;1m ${targetName} (${targetType})`;\n
            }\n
            \n
            // Add time information\n
            const startYear = connection.start_year;\n
            const endYear = connection.end_year || 'Present';\n
            if (mode === 'absolute') {\n
                tooltipContent += `[39;22m[39;1m<br/>[39;22m[39;1m${startYear} - ${endYear}`;\n
            } else {\n
                const startAge = startYear - (timelineData.find(t => t.name === timelineName)?.timeline?.span?.start_year || startYear);\n
                const endAge = endYear === 'Present' ? 'Present' : (endYear - (timelineData.find(t => t.name === timelineName)?.timeline?.span?.start_year || endYear));\n
                tooltipContent += `[39;22m[39;1m<br/>[39;22m[39;1mAge ${startAge} - ${endAge}`;\n
            }\n
        }\n
        \n
        // Add what others were doing at the specific hover time\n
        const concurrentActivities = findActivitiesAtTime_ea3988ac_cd1e_440c_95b9_cc09039d152f(hoverYear, timelineData, timelineName, mode);\n
        console.log('Found concurrent activities:', concurrentActivities.length);\n
        if (concurrentActivities.length > 0) {\n
            // In both modes, just show the activities directly since header already shows the time context\n
            tooltipContent += `[39;22m[39;1m<br/>[39;22m[39;1m<br/>[39;22m[39;1m`;\n
            tooltipContent += formatActivitiesWithDividers_ea3988ac_cd1e_440c_95b9_cc09039d152f(concurrentActivities, mode, hoverYear);\n
        }\n
        \n
        tooltip.html(tooltipContent)\n
            .style('left', (event.pageX - 50) + 'px')\n
            .style('top', (event.pageY + 20) + 'px');\n
    }\n
\n
    function findActivitiesAtTime_ea3988ac_cd1e_440c_95b9_cc09039d152f(year, timelineData, currentTimelineName, mode = 'absolute') {\n
        const activities = [];\n
        \n
        if (mode === 'absolute') {\n
            timelineData.forEach(timeline => {\n
                if (timeline.timeline.connections) {\n
                    timeline.timeline.connections\n
                        .filter(otherConnection => otherConnection.target_type !== 'connection') // Exclude connections to connection spans\n
                        .forEach(otherConnection => {\n
                        const otherStart = otherConnection.start_year;\n
                        const otherEnd = otherConnection.end_year || new Date().getFullYear();\n
                        if (otherStart <= year && otherEnd >= year) {\n
                            activities.push({\n
                                timelineName: timeline.name,\n
                                type_name: otherConnection.type_name,\n
                                type_id: otherConnection.type_id,\n
                                target_name: otherConnection.target_name,\n
                                start_year: otherConnection.start_year,\n
                                end_year: otherConnection.end_year,\n
                                isCurrentSpan: timeline.isCurrentSpan,\n
                                nested_connections: otherConnection.nested_connections || []\n
                            });\n
                        }\n
                    });\n
                }\n
            });\n
        } else {\n
            // Relative mode: always include all group members and their life span\n
            timelineData.forEach(timeline => {\n
                let found = false;\n
                let lifeSpanIncluded = false;\n
                let timelineSpan = timeline.timeline.span;\n
                let lifeStartAge = 0;\n
                let lifeEndAge = null;\n
                if (timelineSpan && timelineSpan.start_year) {\n
                    lifeEndAge = (timelineSpan.end_year ? timelineSpan.end_year : new Date().getFullYear()) - timelineSpan.start_year;\n
                }\n
                // Check if alive at this age\n
                let alive = (lifeEndAge !== null && year >= lifeStartAge && year <= lifeEndAge);\n
                // Add life span entry\n
                if (lifeEndAge !== null) {\n
                    activities.push({\n
                        timelineName: timeline.name,\n
                        type_name: 'Life span',\n
                        type_id: 'life-span',\n
                        target_name: '',\n
                        start_age: lifeStartAge,\n
                        end_age: lifeEndAge,\n
                        isCurrentSpan: timeline.isCurrentSpan,\n
                        isLifeSpan: true,\n
                        alive: alive\n
                    });\n
                    lifeSpanIncluded = true;\n
                }\n
                // Add subspans if any\n
                if (timeline.timeline.connections) {\n
                    timeline.timeline.connections\n
                        .filter(otherConnection => otherConnection.target_type !== 'connection') // Exclude connections to connection spans\n
                        .forEach(otherConnection => {\n
                        if (timelineSpan && timelineSpan.start_year) {\n
                            const otherStart = otherConnection.start_year - timelineSpan.start_year;\n
                            const otherEnd = otherConnection.end_year \n
                                ? otherConnection.end_year - timelineSpan.start_year \n
                                : new Date().getFullYear() - timelineSpan.start_year;\n
                            if (otherStart <= year && otherEnd >= year) {\n
                                activities.push({\n
                                    timelineName: timeline.name,\n
                                    type_name: otherConnection.type_name,\n
                                    type_id: otherConnection.type_id,\n
                                    target_name: otherConnection.target_name,\n
                                    start_year: otherConnection.start_year,\n
                                    end_year: otherConnection.end_year,\n
                                    start_age: otherStart,\n
                                    end_age: otherEnd,\n
                                    isCurrentSpan: timeline.isCurrentSpan,\n
                                    nested_connections: otherConnection.nested_connections || []\n
                                });\n
                                found = true;\n
                            }\n
                        }\n
                    });\n
                }\n
                if (!lifeSpanIncluded) {\n
                    // No life span info, show not alive\n
                    activities.push({\n
                        timelineName: timeline.name,\n
                        notAlive: true,\n
                        isCurrentSpan: timeline.isCurrentSpan\n
                    });\n
                } else if (!alive) {\n
                    // Not alive at this age\n
                    activities.push({\n
                        timelineName: timeline.name,\n
                        notAlive: true,\n
                        isCurrentSpan: timeline.isCurrentSpan\n
                    });\n
                } else if (!found) {\n
                    // Alive but no subspans at this age\n
                    activities.push({\n
                        timelineName: timeline.name,\n
                        noActivity: true,\n
                        isCurrentSpan: timeline.isCurrentSpan\n
                    });\n
                }\n
            });\n
        }\n
        // Preserve the original order from timelineData to match swimlane order\n
        return activities.sort((a, b) => {\n
            // Find the original indices in timelineData\n
            const aIndex = timelineData.findIndex(t => t.name === a.timelineName);\n
            const bIndex = timelineData.findIndex(t => t.name === b.timelineName);\n
            return aIndex - bIndex;\n
        });\n
    }\n
\n
    function formatActivitiesWithDividers_ea3988ac_cd1e_440c_95b9_cc09039d152f(activities, mode = 'absolute', hoverYear = null) {\n
        if (activities.length === 0) return '';\n
        \n
        let formattedContent = '';\n
        let currentTimeline = '';\n
        \n
        activities.forEach((activity, index) => {\n
            // Add divider if we're switching to a new timeline\n
            if (activity.timelineName !== currentTimeline) {\n
                if (currentTimeline !== '') {\n
                    formattedContent += '[39;22m[39;1m<hr style="margin: 4px 0; border: none; border-top: 1px solid white;">[39;22m[39;1m';\n
                }\n
                currentTimeline = activity.timelineName;\n
            }\n
            \n
            if (activity.notAlive) {\n
                formattedContent += `[39;22m[39;1m<span style='color: #ccc;'>[39;22m[39;1m●[39;22m[39;1m</span>[39;22m[39;1m [39;22m[39;1m<em>[39;22m[39;1m${activity.timelineName}[39;22m[39;1m</em>[39;22m[39;1m: [39;22m[39;1m<span style='color:#aaa'>[39;22m[39;1mNot alive at this age[39;22m[39;1m</span>[39;22m[39;1m<br/>[39;22m[39;1m`;\n
            } else if (activity.noActivity) {\n
                formattedContent += `[39;22m[39;1m<span style='color: #ccc;'>[39;22m[39;1m●[39;22m[39;1m</span>[39;22m[39;1m [39;22m[39;1m<em>[39;22m[39;1m${activity.timelineName}[39;22m[39;1m</em>[39;22m[39;1m: [39;22m[39;1m<span style='color:#aaa'>[39;22m[39;1mNo span at this age[39;22m[39;1m</span>[39;22m[39;1m<br/>[39;22m[39;1m`;\n
            } else if (activity.isLifeSpan && mode === 'absolute') {\n
                // Only show life span in absolute mode, not in relative mode\n
                let timeInfo = ` (${activity.start_year} - ${activity.end_year})`;\n
                formattedContent += `[39;22m[39;1m<span style='color: black;'>[39;22m[39;1m●[39;22m[39;1m</span>[39;22m[39;1m [39;22m[39;1m<em>[39;22m[39;1m${activity.timelineName}[39;22m[39;1m</em>[39;22m[39;1m: [39;22m[39;1m<strong>[39;22m[39;1mLife span[39;22m[39;1m</strong>[39;22m[39;1m${timeInfo}[39;22m[39;1m<br/>[39;22m[39;1m`;\n
            } else if (!activity.isLifeSpan) {\n
                // Show regular activities (not life span)\n
                const bulletColor = getConnectionColor(activity.type_id);\n
                let timeInfo = '';\n
                if (mode === 'absolute') {\n
                    const endYear = activity.end_year || 'Present';\n
                    timeInfo = ` (${activity.start_year} - ${endYear})`;\n
                } else {\n
                    const endAge = activity.end_age || 'Present';\n
                    timeInfo = ` (Age ${activity.start_age} - ${endAge})`;\n
                }\n
                formattedContent += `[39;22m[39;1m<span style="color: ${bulletColor};">[39;22m[39;1m●[39;22m[39;1m</span>[39;22m[39;1m [39;22m[39;1m<em>[39;22m[39;1m${activity.timelineName}[39;22m[39;1m</em>[39;22m[39;1m: ${activity.type_name} ${activity.target_name}${timeInfo}[39;22m[39;1m<br/>[39;22m[39;1m`;\n
                \n
                // Add nested connections (phases) if they exist\n
                if (activity.nested_connections && activity.nested_connections.length > 0) {\n
                    activity.nested_connections.forEach(nestedConnection => {\n
                        const nestedStart = nestedConnection.start_year;\n
                        const nestedEnd = nestedConnection.end_year || new Date().getFullYear();\n
                        \n
                        // Only show phases that are active at the current hover time\n
                        if (nestedStart <= hoverYear && nestedEnd >= hoverYear) {\n
                            let nestedTimeInfo = '';\n
                            if (mode === 'absolute') {\n
                                const nestedEndYear = nestedConnection.end_year || 'Present';\n
                                nestedTimeInfo = ` (${nestedConnection.start_year} - ${nestedEndYear})`;\n
                            } else {\n
                                const timelineSpan = timelineData.find(t => t.name === activity.timelineName)?.timeline?.span;\n
                                if (timelineSpan && timelineSpan.start_year) {\n
                                    const nestedStartAge = nestedConnection.start_year - timelineSpan.start_year;\n
                                    const nestedEndAge = nestedConnection.end_year \n
                                        ? nestedConnection.end_year - timelineSpan.start_year \n
                                        : new Date().getFullYear() - timelineSpan.start_year;\n
                                    nestedTimeInfo = ` (Age ${nestedStartAge} - ${nestedEndAge})`;\n
                                }\n
                            }\n
                            \n
                            const nestedBulletColor = getConnectionColor(nestedConnection.type_id);\n
                            formattedContent += `[39;22m[39;1m<span style="color: ${nestedBulletColor}; margin-left: 12px;">[39;22m[39;1m└─[39;22m[39;1m</span>[39;22m[39;1m ${nestedConnection.type_name} ${nestedConnection.target_name}${nestedTimeInfo}[39;22m[39;1m<br/>[39;22m[39;1m`;\n
                        }\n
                    });\n
                }\n
            }\n
            // Skip life span entries in relative mode (they're already shown as the black bar)\n
        });\n
        \n
        return formattedContent;\n
    }\n
\n
    function findConcurrentActivities_ea3988ac_cd1e_440c_95b9_cc09039d152f(connection, timelineData, currentTimelineName) {\n
        const activities = [];\n
        const connectionStart = connection.start_year;\n
        const connectionEnd = connection.end_year || new Date().getFullYear();\n
        \n
        timelineData.forEach(timeline => {\n
            if (timeline.name === currentTimelineName) return; // Skip the current timeline\n
            \n
            if (timeline.timeline.connections) {\n
                timeline.timeline.connections\n
                    .filter(otherConnection => otherConnection.target_type !== 'connection') // Exclude connections to connection spans\n
                    .forEach(otherConnection => {\n
                    const otherStart = otherConnection.start_year;\n
                    const otherEnd = otherConnection.end_year || new Date().getFullYear();\n
                    \n
                    // Check if the connections overlap in time\n
                    if (otherStart <= connectionEnd && otherEnd >= connectionStart) {\n
                        activities.push({\n
                            timelineName: timeline.name,\n
                            type_name: otherConnection.type_name,\n
                            type_id: otherConnection.type_id,\n
                            target_name: otherConnection.target_name,\n
                            start_year: otherStart,\n
                            end_year: otherEnd,\n
                            isCurrentSpan: timeline.isCurrentSpan\n
                        });\n
                    }\n
                });\n
            }\n
        });\n
        \n
        // Sort by timeline name for consistent ordering\n
        return activities.sort((a, b) => a.timelineName.localeCompare(b.timelineName));\n
    }\n
\n
    function updateLifeSpanTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f(event, span, timelineData, timelineName, isCurrentSpan, mode = 'absolute') {\n
        const svgRect = svg.node().getBoundingClientRect();\n
        const mouseX = event.clientX - svgRect.left;\n
        const hoverYear = Math.round(xScale.invert(mouseX));\n
        console.log('Life span mousemove - mouseX:', mouseX, 'hoverYear:', hoverYear, 'mode:', mode);\n
        \n
        tooltip.transition().duration(100).style('opacity', 1);\n
        \n
        // Use consistent headers like connection tooltips\n
        let tooltipContent = '';\n
        if (mode === 'relative') {\n
            tooltipContent = `[39;22m[39;1m<strong>[39;22m[39;1mAt age ${hoverYear}[39;22m[39;1m</strong>[39;22m[39;1m`;\n
        } else {\n
            tooltipContent = `[39;22m[39;1m<strong>[39;22m[39;1mIn ${hoverYear}[39;22m[39;1m</strong>[39;22m[39;1m`;\n
        }\n
        \n
        // Add what others were doing at the specific hover time\n
        const concurrentActivities = findActivitiesAtTime_ea3988ac_cd1e_440c_95b9_cc09039d152f(hoverYear, timelineData, timelineName, mode);\n
        if (concurrentActivities.length > 0) {\n
            tooltipContent += `[39;22m[39;1m<br/>[39;22m[39;1m<br/>[39;22m[39;1m`;\n
            tooltipContent += formatActivitiesWithDividers_ea3988ac_cd1e_440c_95b9_cc09039d152f(concurrentActivities, mode);\n
        }\n
        \n
        tooltip.html(tooltipContent)\n
            .style('left', (event.pageX - 50) + 'px')\n
            .style('top', (event.pageY + 20) + 'px');\n
    }\n
\n
    function updateConnectionTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f(event, connections, timelineName, isCurrentSpan, mode = 'absolute', isDuring = false) {\n
        const svgRect = svg.node().getBoundingClientRect();\n
        const mouseX = event.clientX - svgRect.left;\n
        const hoverYear = Math.round(xScale.invert(mouseX));\n
        console.log('Connection mousemove - mouseX:', mouseX, 'hoverYear:', hoverYear, 'isDuring:', isDuring);\n
        \n
        showCombinedTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f(event, connections, timelineName, isCurrentSpan, hoverYear, mode, isDuring);\n
    }\n
\n
    function showCombinedLifeSpanTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f(event, span, timelineData, timelineName, isCurrentSpan, hoverYear, mode = 'absolute') {\n
        tooltip.transition().duration(200).style('opacity', 1);\n
        \n
        // Use consistent headers like connection tooltips\n
        let tooltipContent = '';\n
        if (mode === 'relative') {\n
            tooltipContent = `[39;22m[39;1m<strong>[39;22m[39;1mAt age ${hoverYear}[39;22m[39;1m</strong>[39;22m[39;1m`;\n
        } else {\n
            tooltipContent = `[39;22m[39;1m<strong>[39;22m[39;1mIn ${hoverYear}[39;22m[39;1m</strong>[39;22m[39;1m`;\n
        }\n
        \n
        // Add what others were doing at the specific hover time\n
        const concurrentActivities = findActivitiesAtTime_ea3988ac_cd1e_440c_95b9_cc09039d152f(hoverYear, timelineData, timelineName, mode);\n
        if (concurrentActivities.length > 0) {\n
            tooltipContent += `[39;22m[39;1m<br/>[39;22m[39;1m<br/>[39;22m[39;1m`;\n
            tooltipContent += formatActivitiesWithDividers_ea3988ac_cd1e_440c_95b9_cc09039d152f(concurrentActivities, mode, hoverYear);\n
        }\n
        \n
        tooltip.html(tooltipContent)\n
            .style('left', (event.pageX - 50) + 'px')\n
            .style('top', (event.pageY + 20) + 'px');\n
    }\n
\n
    function hideCombinedTooltip_ea3988ac_cd1e_440c_95b9_cc09039d152f() {\n
        tooltip.transition().duration(500).style('opacity', 0);\n
    }\n
    \n
    // Set up mode toggle after rendering\n
    setupModeToggle_ea3988ac_cd1e_440c_95b9_cc09039d152f(timelineData, currentSpan, currentUserSpanId);\n
}\n
\n
function calculateCombinedTimeRange_ea3988ac_cd1e_440c_95b9_cc09039d152f(timelineData, currentSpan) {\n
        const currentYear = new Date().getFullYear();\n
        let start = currentSpan.start_year || 1900;\n
        let end = currentYear; // Always extend to current year\n
\n
        // Extend range to include all timelines and their connections\n
        timelineData.forEach(timeline => {\n
            const timelineSpan = timeline.timeline.span;\n
            if (timelineSpan && timelineSpan.start_year && timelineSpan.start_year < start) {\n
                start = timelineSpan.start_year;\n
            }\n
            // Note: We don't check timelineSpan.end_year here since we always want to go to current year\n
\n
            if (timeline.timeline.connections) {\n
                timeline.timeline.connections.forEach(connection => {\n
                    if (connection.start_year && connection.start_year < start) {\n
                        start = connection.start_year;\n
                    }\n
                    // Note: We don't check connection.end_year here since we always want to go to current year\n
                });\n
            }\n
            \n
            // Include during connections in time range calculation\n
            if (timeline.duringConnections) {\n
                timeline.duringConnections.forEach(connection => {\n
                    if (connection.start_year && connection.start_year < start) {\n
                        start = connection.start_year;\n
                    }\n
                    // Note: We don't check connection.end_year here since we always want to go to current year\n
                });\n
            }\n
        });\n
\n
        const padding = Math.max(5, Math.floor((end - start) * 0.1));\n
        return { start: start - padding, end: end + padding };\n
    }\n
\n
    function calculateRelativeTimeRange_ea3988ac_cd1e_440c_95b9_cc09039d152f(timelineData, currentSpan) {\n
        const currentYear = new Date().getFullYear();\n
        // Calculate ages for all timelines and their connections\n
        const allAges = [];\n
        \n
        // Add ages for each timeline\n
        timelineData.forEach(timeline => {\n
            const timelineSpan = timeline.timeline.span;\n
            if (timelineSpan && timelineSpan.start_year) {\n
                // Add life span ages - always extend to current year for living people\n
                const lifeEndAge = timelineSpan.end_year \n
                    ? timelineSpan.end_year - timelineSpan.start_year \n
                    : currentYear - timelineSpan.start_year;\n
                allAges.push(0, lifeEndAge);\n
                \n
                // Add connection ages\n
                if (timeline.timeline.connections) {\n
                    timeline.timeline.connections.forEach(connection => {\n
                        if (connection.start_year) {\n
                            const startAge = connection.start_year - timelineSpan.start_year;\n
                            allAges.push(startAge);\n
                            \n
                            if (connection.end_year) {\n
                                const endAge = connection.end_year - timelineSpan.start_year;\n
                                allAges.push(endAge);\n
                            }\n
                        }\n
                    });\n
                }\n
                \n
                // Add during connection ages\n
                if (timeline.duringConnections) {\n
                    timeline.duringConnections.forEach(connection => {\n
                        if (connection.start_year) {\n
                            const startAge = connection.start_year - timelineSpan.start_year;\n
                            allAges.push(startAge);\n
                            \n
                            if (connection.end_year) {\n
                                const endAge = connection.end_year - timelineSpan.start_year;\n
                                allAges.push(endAge);\n
                            }\n
                        }\n
                    });\n
                }\n
            }\n
        });\n
\n
        const minAge = Math.min(...allAges);\n
        const maxAge = Math.max(...allAges);\n
\n
        // Add some padding\n
        const padding = Math.max(2, Math.floor((maxAge - minAge) * 0.1));\n
        return {\n
            start: Math.max(0, minAge - padding),\n
            end: maxAge + padding\n
        };\n
    }\n
\n
function setupModeToggle_ea3988ac_cd1e_440c_95b9_cc09039d152f(timelineData, currentSpan, currentUserSpanId = null) {\n
    const spanId = 'ea3988ac-cd1e-440c-95b9-cc09039d152f';\n
    \n
    console.log('Setting up mode toggle for span:', spanId);\n
    const radioButtons = document.querySelectorAll(`input[name="timeline-mode-${spanId}"]`);\n
    console.log('Found radio buttons:', radioButtons.length);\n
    \n
    // Remove existing event listeners to prevent duplicates\n
    radioButtons.forEach(radio => {\n
        radio.removeEventListener('change', radio._modeToggleHandler);\n
    });\n
    \n
    // Handle mode toggle\n
    radioButtons.forEach(radio => {\n
        const handler = function() {\n
            const selectedMode = this.value;\n
            console.log('Mode changed to:', selectedMode);\n
            \n
            if (this.checked) {\n
                // Re-render timeline with new mode\n
                renderCombinedTimeline_ea3988ac_cd1e_440c_95b9_cc09039d152f(timelineData, currentSpan, selectedMode, currentUserSpanId);\n
            }\n
        };\n
        \n
        // Store the handler reference so we can remove it later\n
        radio._modeToggleHandler = handler;\n
        radio.addEventListener('change', handler);\n
    });\n
}\n
[39;22m[39;1m</script>[39;22m[39;1m\n
[39;22m[39;1m<script>[39;22m[39;1m\n
    document.addEventListener('DOMContentLoaded', function() {\n
        // Initialize tooltips for status buttons\n
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');\n
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));\n
    });\n
[39;22m[39;1m</script>[39;22m[39;1m\n
[39;22m[39;1m<script src="http://localhost:8000/js/tools-button-functions.js">[39;22m[39;1m</script>[39;22m[39;1m\n
[39;22m[39;1m<script>[39;22m[39;1m\n
document.addEventListener('DOMContentLoaded', function() {\n
    // Delete span confirmation\n
    const deleteBtn = document.getElementById('delete-span-btn');\n
    if (deleteBtn) {\n
        deleteBtn.addEventListener('click', function(e) {\n
            e.preventDefault();\n
            if (confirm('Are you sure you want to delete this span?')) {\n
                document.getElementById('delete-span-form').submit();\n
            }\n
        });\n
    }\n
    \n
    // Edit span keyboard shortcut (Cmd+E or Ctrl+E)\n
    document.addEventListener('keydown', function(e) {\n
        // Check for Cmd+E (Mac) or Ctrl+E (Windows/Linux)\n
        if ((e.metaKey || e.ctrlKey) && e.key === 'e') {\n
            e.preventDefault(); // Prevent any potential conflicts\n
            \n
            // Check if edit button exists and user has permission\n
            const editSpanBtn = document.getElementById('edit-span-btn');\n
            if (editSpanBtn) {\n
                editSpanBtn.click();\n
            }\n
        }\n
    });\n
    \n
    // Initialize Bootstrap tooltips\n
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));\n
    tooltipTriggerList.map(function (tooltipTriggerEl) {\n
        return new bootstrap.Tooltip(tooltipTriggerEl);\n
    });\n
});\n
[39;22m[39;1m</script>[39;22m[39;1m\n
    [39;22m[39;1m</head>[39;22m[39;1m\n
    [39;22m[39;1m<body class="bg-light">[39;22m[39;1m\n
        [39;22m[39;1m<div class="row">[39;22m[39;1m\n
                            <!-- Guest Top Navigation Bar -->\n
                <!-- Guest Top Navigation Bar -->\n
[39;22m[39;1m<div class="bg-light border-bottom shadow-sm" style="height: 56px;">[39;22m[39;1m\n
    [39;22m[39;1m<div class="d-flex align-items-center h-100 px-3">[39;22m[39;1m\n
        <!-- Brand/Logo -->\n
        [39;22m[39;1m<div class="px-3 d-flex align-items-center">[39;22m[39;1m\n
            [39;22m[39;1m<a class="text-decoration-none" href="http://localhost:8000">[39;22m[39;1m\n
                [39;22m[39;1m<h5 class="mb-0 text-primary">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-bar-chart-steps me-1">[39;22m[39;1m</i>[39;22m[39;1m Lifespan\n
                [39;22m[39;1m</h5>[39;22m[39;1m\n
            [39;22m[39;1m</a>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
        \n
        <!-- Spacer -->\n
        [39;22m[39;1m<div class="flex-grow-1">[39;22m[39;1m</div>[39;22m[39;1m\n
        \n
        <!-- Guest Actions -->\n
        [39;22m[39;1m<div class="px-3 d-flex align-items-center">[39;22m[39;1m\n
            [39;22m[39;1m<div class="d-flex gap-2">[39;22m[39;1m\n
                [39;22m[39;1m<a href="http://localhost:8000/login" class="btn btn-primary btn-sm">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-box-arrow-in-right me-1">[39;22m[39;1m</i>[39;22m[39;1mSign In\n
                [39;22m[39;1m</a>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m                 \n
                <!-- Guest Content Area -->\n
                [39;22m[39;1m<div class="row">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="col-12 bg-light py-3">[39;22m[39;1m\n
                        [39;22m[39;1m<div class="header-section mb-4">[39;22m[39;1m\n
                                                                                [39;22m[39;1m</div>[39;22m[39;1m\n
                            [39;22m[39;1m<div data-span-id="ea3988ac-cd1e-440c-95b9-cc09039d152f" class="container-fluid">[39;22m[39;1m\n
\n
        <!-- Timeline Cards -->\n
                \n
                \n
                [39;22m[39;1m<div class="row mb-4">[39;22m[39;1m\n
            [39;22m[39;1m<div class="col-12">[39;22m[39;1m\n
                [39;22m[39;1m<div class="card">[39;22m[39;1m\n
    [39;22m[39;1m<div class="card-header d-flex justify-content-between align-items-center">[39;22m[39;1m\n
        [39;22m[39;1m<h5 class="card-title mb-0">[39;22m[39;1m\n
            [39;22m[39;1m<i class="bi bi-person-lines-fill me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
            Timeline\n
        [39;22m[39;1m</h5>[39;22m[39;1m\n
        [39;22m[39;1m<div class="btn-group btn-group-sm" role="group">[39;22m[39;1m\n
            [39;22m[39;1m<input type="radio" class="btn-check" name="timeline-mode-ea3988ac-cd1e-440c-95b9-cc09039d152f" id="absolute-mode-ea3988ac-cd1e-440c-95b9-cc09039d152f" value="absolute" checked>[39;22m[39;1m\n
            [39;22m[39;1m<label class="btn btn-outline-primary" for="absolute-mode-ea3988ac-cd1e-440c-95b9-cc09039d152f">[39;22m[39;1m\n
                Absolute\n
            [39;22m[39;1m</label>[39;22m[39;1m\n
            \n
            [39;22m[39;1m<input type="radio" class="btn-check" name="timeline-mode-ea3988ac-cd1e-440c-95b9-cc09039d152f" id="relative-mode-ea3988ac-cd1e-440c-95b9-cc09039d152f" value="relative">[39;22m[39;1m\n
            [39;22m[39;1m<label class="btn btn-outline-primary" for="relative-mode-ea3988ac-cd1e-440c-95b9-cc09039d152f">[39;22m[39;1m\n
                Relative\n
            [39;22m[39;1m</label>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m<div class="card-body">[39;22m[39;1m\n
        [39;22m[39;1m<div id="timeline-combined-container-ea3988ac-cd1e-440c-95b9-cc09039d152f" style="height: 300px; width: 100%; cursor: crosshair;">[39;22m[39;1m\n
            <!-- D3 combined timeline will be rendered here -->\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m\n
\n
             [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
                \n
        \n
        [39;22m[39;1m<div class="row">[39;22m[39;1m\n
            [39;22m[39;1m<div class="col-md-8">[39;22m[39;1m\n
                <!-- Main Content -->\n
                [39;22m[39;1m<div class="row">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="col-12">[39;22m[39;1m\n
                        [39;22m[39;1m<div class="card mb-4">[39;22m[39;1m\n
    [39;22m[39;1m<div class="card-body">[39;22m[39;1m\n
        [39;22m[39;1m<h2 class="card-title h5 mb-3">[39;22m[39;1m\n
            [39;22m[39;1m<a href="http://localhost:8000/spans/ea3988ac-cd1e-440c-95b9-cc09039d152f/story" class="text-decoration-none">[39;22m[39;1m\n
            [39;22m[39;1m<i class="bi bi-book me-2">[39;22m[39;1m</i>[39;22m[39;1mStory\n
        [39;22m[39;1m</h2>[39;22m[39;1m\n
        \n
                    [39;22m[39;1m<div class="story-content">[39;22m[39;1m\n
                                                        [39;22m[39;1m<p class="lead mb-4">[39;22m[39;1m<a href="http://localhost:8000/spans/ea3988ac-cd1e-440c-95b9-cc09039d152f" class="text-decoration-none">[39;22m[39;1mEvangeline Reinger[39;22m[39;1m</a>[39;22m[39;1m was a residence connection. It started on [39;22m[39;1m<a href="http://localhost:8000/date/2000-01-01" class="text-decoration-none">[39;22m[39;1m1 January, 2000[39;22m[39;1m</a>[39;22m[39;1m and ended on [39;22m[39;1m<a href="http://localhost:8000/date/2010-12-31" class="text-decoration-none">[39;22m[39;1m31 December, 2010[39;22m[39;1m</a>[39;22m[39;1m. That's all for now.[39;22m[39;1m</p>[39;22m[39;1m\n
                            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            <!-- Story metadata -->\n
            [39;22m[39;1m<div class="mt-4 pt-3 border-top">[39;22m[39;1m\n
                [39;22m[39;1m<small class="text-muted">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-magic me-1">[39;22m[39;1m</i>[39;22m[39;1m\n
                    Yes, this was automagically generated. There is grammar bugs... [39;22m[39;1m<i class="bi bi-bug text-danger">[39;22m[39;1m</i>[39;22m[39;1m\n
                [39;22m[39;1m</small>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m                     [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                            [39;22m[39;1m</div>[39;22m[39;1m\n
\n
            [39;22m[39;1m<div class="col-md-4">[39;22m[39;1m\n
                <!-- Sidebar Content -->\n
                                                                [39;22m[39;1m<style>[39;22m[39;1m\n
    .status-disabled {\n
        opacity: 0.7 !important;\n
        cursor: default !important;\n
        pointer-events: auto !important;\n
    }\n
    \n
    .status-disabled:hover {\n
        opacity: 0.8 !important;\n
    }\n
    \n
    .status-disabled:active {\n
        transform: none !important;\n
    }\n
    \n
    .status-disabled:focus {\n
        box-shadow: none !important;\n
    }\n
[39;22m[39;1m</style>[39;22m[39;1m\n
\n
        [39;22m[39;1m<div class="btn-group btn-group-sm" role="group">[39;22m[39;1m\n
            <!-- Visibility -->\n
                            [39;22m[39;1m<button type="button" \n
                        class="btn btn-success status-disabled" \n
                        data-bs-toggle="tooltip" \n
                        data-bs-placement="top" \n
                        data-bs-custom-class="tooltip-mini"\n
                        data-bs-title="This span is publicly visible to all users">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-globe me-1">[39;22m[39;1m</i>[39;22m[39;1mPublic\n
                [39;22m[39;1m</button>[39;22m[39;1m\n
            \n
            <!-- Personal Span Indicator -->\n
            \n
            <!-- Owner -->\n
            [39;22m[39;1m<button type="button" class="btn btn-sm btn-outline-secondary" disabled\n
                    data-bs-toggle="tooltip" \n
                    data-bs-placement="top" \n
                    data-bs-custom-class="tooltip-mini"\n
                    data-bs-title="Owner of this span">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi me-1 bi-person">[39;22m[39;1m</i>[39;22m[39;1m Test User 9f59d5cc-14e3-46d2-919c-8ffd76af3669\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
\n
            <!-- Created Date -->\n
            [39;22m[39;1m<button type="button" class="btn btn-sm btn-outline-secondary" disabled\n
                    data-bs-toggle="tooltip" \n
                    data-bs-placement="top" \n
                    data-bs-custom-class="tooltip-mini"\n
                    data-bs-title="Date this span was created">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi me-1 bi-calendar-plus">[39;22m[39;1m</i>[39;22m[39;1m 2025-07-09\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
\n
            <!-- Updated Date (if different from created) -->\n
            \n
            <!-- State -->\n
            [39;22m[39;1m<button type="button" \n
                    class="btn btn-warning status-disabled" \n
                    data-bs-toggle="tooltip" \n
                    data-bs-placement="top" \n
                    data-bs-custom-class="tooltip-mini"\n
                    data-bs-title="This span is a draft and may need more information">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-pencil me-1">[39;22m[39;1m</i>[39;22m[39;1m\n
                Draft\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    \n
\n
 \n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
        \n
        <!-- Modals -->\n
                \n
        <!-- Global Access Level Modal -->\n
        <!-- Access Level Selection Modal -->\n
[39;22m[39;1m<div class="modal fade" id="accessLevelModal" tabindex="-1" aria-labelledby="accessLevelModalLabel" aria-hidden="true">[39;22m[39;1m\n
    [39;22m[39;1m<div class="modal-dialog">[39;22m[39;1m\n
        [39;22m[39;1m<div class="modal-content">[39;22m[39;1m\n
            [39;22m[39;1m<div class="modal-header">[39;22m[39;1m\n
                [39;22m[39;1m<h5 class="modal-title" id="accessLevelModalLabel">[39;22m[39;1mChange Access Level[39;22m[39;1m</h5>[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">[39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m<div class="modal-body">[39;22m[39;1m\n
                [39;22m[39;1m<p class="text-muted mb-3">[39;22m[39;1mSelect the new access level for this item:[39;22m[39;1m</p>[39;22m[39;1m\n
                \n
                [39;22m[39;1m<div class="form-check mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<input class="form-check-input" type="radio" name="accessLevel" id="accessPrivate" value="private">[39;22m[39;1m\n
                    [39;22m[39;1m<label class="form-check-label d-flex align-items-center" for="accessPrivate">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-lock text-danger me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                        [39;22m[39;1m<div>[39;22m[39;1m\n
                            [39;22m[39;1m<strong>[39;22m[39;1mPrivate[39;22m[39;1m</strong>[39;22m[39;1m\n
                            [39;22m[39;1m<div class="text-muted small">[39;22m[39;1mOnly you can see this item[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</label>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                \n
                [39;22m[39;1m<div class="form-check mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<input class="form-check-input" type="radio" name="accessLevel" id="accessShared" value="shared">[39;22m[39;1m\n
                    [39;22m[39;1m<label class="form-check-label d-flex align-items-center" for="accessShared">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-people text-warning me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                        [39;22m[39;1m<div>[39;22m[39;1m\n
                            [39;22m[39;1m<strong>[39;22m[39;1mShared[39;22m[39;1m</strong>[39;22m[39;1m\n
                            [39;22m[39;1m<div class="text-muted small">[39;22m[39;1mVisible to people you've shared with[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</label>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                \n
                [39;22m[39;1m<div class="form-check mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<input class="form-check-input" type="radio" name="accessLevel" id="accessPublic" value="public">[39;22m[39;1m\n
                    [39;22m[39;1m<label class="form-check-label d-flex align-items-center" for="accessPublic">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-globe text-success me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                        [39;22m[39;1m<div>[39;22m[39;1m\n
                            [39;22m[39;1m<strong>[39;22m[39;1mPublic[39;22m[39;1m</strong>[39;22m[39;1m\n
                            [39;22m[39;1m<div class="text-muted small">[39;22m[39;1mVisible to everyone[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</label>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m<div class="modal-footer">[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">[39;22m[39;1mCancel[39;22m[39;1m</button>[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn btn-primary" id="confirmAccessLevel">[39;22m[39;1mConfirm Change[39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m         \n
        <!-- Consent Banner -->\n
                \n
        <!-- Global Sets Modal -->\n
        <!-- Sets Management Modal -->\n
[39;22m[39;1m<div class="modal fade" id="setsModal" tabindex="-1" aria-labelledby="setsModalLabel" aria-hidden="true">[39;22m[39;1m\n
    [39;22m[39;1m<div class="modal-dialog modal-lg">[39;22m[39;1m\n
        [39;22m[39;1m<div class="modal-content">[39;22m[39;1m\n
            [39;22m[39;1m<div class="modal-header">[39;22m[39;1m\n
                [39;22m[39;1m<h5 class="modal-title" id="setsModalLabel">[39;22m[39;1mAdd to Set[39;22m[39;1m</h5>[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">[39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m<div class="modal-body">[39;22m[39;1m\n
                [39;22m[39;1m<div id="setsModalContent">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="text-center">[39;22m[39;1m\n
                        [39;22m[39;1m<div class="spinner-border text-primary" role="status">[39;22m[39;1m\n
                            [39;22m[39;1m<span class="visually-hidden">[39;22m[39;1mLoading...[39;22m[39;1m</span>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m<p class="mt-2 text-muted">[39;22m[39;1mLoading sets...[39;22m[39;1m</p>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m<div class="modal-footer">[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">[39;22m[39;1mClose[39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m         \n
        <!-- New Span Modal -->\n
        <!-- New Span Modal -->\n
[39;22m[39;1m<div class="modal fade" id="newSpanModal" tabindex="-1" aria-labelledby="newSpanModalLabel" aria-hidden="true">[39;22m[39;1m\n
    [39;22m[39;1m<div class="modal-dialog modal-md">[39;22m[39;1m\n
        [39;22m[39;1m<div class="modal-content">[39;22m[39;1m\n
            [39;22m[39;1m<div class="modal-header border-bottom">[39;22m[39;1m\n
                [39;22m[39;1m<h5 class="modal-title fw-bold" id="newSpanModalLabel">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-plus-circle me-2 text-primary">[39;22m[39;1m</i>[39;22m[39;1mCreate New Span\n
                [39;22m[39;1m</h5>[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">[39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            <!-- Dynamic content area -->\n
            [39;22m[39;1m<div class="modal-body" id="modal-content">[39;22m[39;1m\n
                <!-- Content will be dynamically replaced -->\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
\n
            [39;22m[39;1m<div class="modal-footer border-top" id="modal-footer">[39;22m[39;1m\n
                <!-- Footer will be dynamically replaced -->\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m\n
\n
[39;22m[39;1m<style>[39;22m[39;1m\n
    /* Custom modal styling */\n
    #newSpanModal .modal-content {\n
        border: none;\n
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);\n
        border-radius: 0.75rem;\n
    }\n
    \n
    #newSpanModal .modal-header {\n
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);\n
        border-radius: 0.75rem 0.75rem 0 0;\n
        padding: 1rem 1.5rem;\n
    }\n
    \n
    #newSpanModal .modal-body {\n
        padding: 1.5rem;\n
    }\n
    \n
    #newSpanModal .modal-footer {\n
        padding: 1rem 1.5rem;\n
        background-color: #f8f9fa;\n
        border-radius: 0 0 0.75rem 0.75rem;\n
        display: flex;\n
        justify-content: space-between;\n
        align-items: flex-start;\n
    }\n
    \n
    #newSpanModal .form-label {\n
        color: #495057;\n
        margin-bottom: 0.5rem;\n
        font-size: 0.9rem;\n
    }\n
    \n
    #newSpanModal .form-control,\n
    #newSpanModal .form-select {\n
        border-radius: 0.5rem;\n
        border: 1px solid #dee2e6;\n
        transition: all 0.2s ease;\n
        font-size: 0.9rem;\n
    }\n
    \n
    #newSpanModal .form-control:focus,\n
    #newSpanModal .form-select:focus {\n
        border-color: #0d6efd;\n
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);\n
    }\n
    \n
    #newSpanModal .btn {\n
        border-radius: 0.5rem;\n
        font-weight: 500;\n
        transition: all 0.2s ease;\n
        font-size: 0.9rem;\n
    }\n
    \n
    #newSpanModal .btn-primary {\n
        background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);\n
        border: none;\n
    }\n
    \n
    #newSpanModal .btn-primary:hover {\n
        background: linear-gradient(135deg, #0b5ed7 0%, #0a58ca 100%);\n
        transform: translateY(-1px);\n
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);\n
    }\n
    \n
    /* Button group styling */\n
    #newSpanModal .btn-group {\n
        border-radius: 0.5rem;\n
        overflow: hidden;\n
    }\n
    \n
    #newSpanModal .btn-group .btn {\n
        border: 1px solid #dee2e6;\n
        border-radius: 0;\n
        transition: all 0.2s ease;\n
        font-weight: 500;\n
        font-size: 0.8rem;\n
        padding: 0.375rem 0.75rem;\n
    }\n
    \n
    #newSpanModal .btn-group .btn:first-child {\n
        border-top-left-radius: 0.5rem;\n
        border-bottom-left-radius: 0.5rem;\n
    }\n
    \n
    #newSpanModal .btn-group .btn:last-child {\n
        border-top-right-radius: 0.5rem;\n
        border-bottom-right-radius: 0.5rem;\n
    }\n
    \n
    #newSpanModal .btn-group .btn:hover {\n
        background-color: #e9ecef;\n
        border-color: #adb5bd;\n
    }\n
    \n
    #newSpanModal .btn-group .btn-check:checked + .btn {\n
        background-color: #0d6efd;\n
        border-color: #0d6efd;\n
        color: white;\n
    }\n
    \n
    #newSpanModal .btn-group.is-invalid {\n
        border: 1px solid #dc3545;\n
    }\n
    \n
    #newSpanModal .btn-group.is-invalid .btn {\n
        border-color: #dc3545;\n
    }\n
    \n
    /* Card selection styling */\n
    #newSpanModal .card {\n
        cursor: pointer;\n
        transition: all 0.2s ease;\n
        border: 2px solid #dee2e6;\n
        border-radius: 0.5rem;\n
    }\n
    \n
    #newSpanModal .card:hover {\n
        border-color: #0d6efd;\n
        transform: translateY(-2px);\n
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);\n
    }\n
    \n
    #newSpanModal .card.selected {\n
        border-color: #0d6efd;\n
        background-color: #f8f9ff;\n
    }\n
    \n
    #newSpanModal .card-body {\n
        padding: 1rem;\n
    }\n
    \n
    /* Badge styling */\n
    #newSpanModal .badge {\n
        font-size: 0.75rem;\n
        padding: 0.5rem 0.75rem;\n
    }\n
    \n
    /* Alert styling */\n
    #newSpanModal .alert {\n
        border-radius: 0.5rem;\n
        font-size: 0.85rem;\n
    }\n
    \n
    /* Responsive adjustments */\n
    @media (max-width: 768px) {\n
        #newSpanModal .modal-body {\n
            padding: 1rem;\n
        }\n
        \n
        #newSpanModal .modal-footer {\n
            padding: 0.75rem 1rem;\n
        }\n
    }\n
[39;22m[39;1m</style>[39;22m[39;1m\n
\n
[39;22m[39;1m<script>[39;22m[39;1m\n
$(document).ready(function() {\n
    let currentStep = 1;\n
    let aiData = null;\n
    let selectedCreationMethod = null;\n
    let formData = {};\n
    let isImproveMode = false;\n
    \n
    // Get timeless span types from the server\n
    const timelessSpanTypes = ["place","role","set"];\n
    \n
    // Handle Improve button click\n
    $('#improve-span-btn').on('click', function() {\n
        isImproveMode = true;\n
        const spanName = $(this).data('span-name');\n
        const spanType = $(this).data('span-type');\n
        \n
        // Prefill the form data\n
        formData.name = spanName;\n
        formData.type_id = spanType;\n
        \n
        // Update modal title\n
        $('#newSpanModalLabel').html('[39;22m[39;1m<i class="bi bi-magic me-2 text-success">[39;22m[39;1m</i>[39;22m[39;1mImprove Span');\n
        \n
        // For people, skip directly to the creation method selection\n
        if (spanType === 'person') {\n
            // Show step 1 first to set up the form, then immediately go to step 2\n
            showStep(1);\n
            setTimeout(() => {\n
                showStep(2);\n
            }, 100);\n
        }\n
    });\n
    \n
    // Handle New button click (reset improve mode)\n
    $('#new-span-btn').on('click', function() {\n
        isImproveMode = false;\n
        formData = {};\n
        $('#newSpanModalLabel').html('[39;22m[39;1m<i class="bi bi-plus-circle me-2 text-primary">[39;22m[39;1m</i>[39;22m[39;1mCreate New Span');\n
    });\n
    \n
    // Reset modal state when closed\n
    $('#newSpanModal').on('hidden.bs.modal', function() {\n
        isImproveMode = false;\n
        currentStep = 1;\n
        aiData = null;\n
        selectedCreationMethod = null;\n
        formData = {};\n
        $('#newSpanModalLabel').html('[39;22m[39;1m<i class="bi bi-plus-circle me-2 text-primary">[39;22m[39;1m</i>[39;22m[39;1mCreate New Span');\n
    });\n
    \n
    // Step content templates\n
    const stepContent = {\n
        1: `\n
            [39;22m[39;1m<div class="text-center mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<div class="badge bg-primary mb-2">[39;22m[39;1mStep 1 of 3[39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<h6 class="text-muted">[39;22m[39;1mBasic Information[39;22m[39;1m</h6>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            [39;22m[39;1m<div class="mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<label for="modal_name" class="form-label fw-medium">[39;22m[39;1mName [39;22m[39;1m<span class="text-danger">[39;22m[39;1m*[39;22m[39;1m</span>[39;22m[39;1m</label>[39;22m[39;1m\n
                [39;22m[39;1m<input type="text" class="form-control" \n
                       id="modal_name" name="name" required \n
                       placeholder="Enter span name...">[39;22m[39;1m\n
                [39;22m[39;1m<div class="invalid-feedback" id="name-error">[39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
\n
            [39;22m[39;1m<div class="mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<label for="modal_type_id" class="form-label fw-medium">[39;22m[39;1mType [39;22m[39;1m<span class="text-danger">[39;22m[39;1m*[39;22m[39;1m</span>[39;22m[39;1m</label>[39;22m[39;1m\n
                [39;22m[39;1m<select class="form-select" id="modal_type_id" name="type_id" required>[39;22m[39;1m\n
                    [39;22m[39;1m<option value="">[39;22m[39;1mChoose a type...[39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="thing">[39;22m[39;1m\n
                            Thing\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="organisation">[39;22m[39;1m\n
                            Organisation\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="place">[39;22m[39;1m\n
                            Place\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="person">[39;22m[39;1m\n
                            Person\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="event">[39;22m[39;1m\n
                            Event\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="band">[39;22m[39;1m\n
                            Band\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="connection">[39;22m[39;1m\n
                            Connection\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="phase">[39;22m[39;1m\n
                            Phase\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="role">[39;22m[39;1m\n
                            Role\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="set">[39;22m[39;1m\n
                            Set\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                    [39;22m[39;1m</select>[39;22m[39;1m\n
                [39;22m[39;1m<div class="invalid-feedback" id="type_id-error">[39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `,\n
        \n
        2: `\n
            [39;22m[39;1m<div class="text-center mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<div class="badge bg-primary mb-2">[39;22m[39;1mStep 2 of 3[39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<h6 class="text-muted">[39;22m[39;1mCreate Person[39;22m[39;1m</h6>[39;22m[39;1m\n
                [39;22m[39;1m<p class="text-muted small">[39;22m[39;1mHow would you like to create this person?[39;22m[39;1m</p>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            [39;22m[39;1m<div class="row g-3">[39;22m[39;1m\n
                [39;22m[39;1m<div class="col-6">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card h-100 border-2" id="create-manual-card" \n
                         tabindex="2" role="button" aria-label="Create manually - fill in all details yourself"\n
                         onkeydown="if(event.key === 'Enter' || event.key === ' ') { event.preventDefault(); $(this).click(); }">[39;22m[39;1m\n
                        [39;22m[39;1m<div class="card-body text-center p-3">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-pencil-square text-primary mb-2" style="font-size: 1.5rem;">[39;22m[39;1m</i>[39;22m[39;1m\n
                            [39;22m[39;1m<h6 class="card-title mb-1">[39;22m[39;1mCreate Manually[39;22m[39;1m</h6>[39;22m[39;1m\n
                            [39;22m[39;1m<p class="card-text text-muted small mb-0">[39;22m[39;1mFill in all the details yourself[39;22m[39;1m</p>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<div class="col-6">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card h-100 border-2" id="create-ai-card" \n
                         tabindex="1" role="button" aria-label="Use AI to create - AI will research and fill in details" autofocus\n
                         onkeydown="if(event.key === 'Enter' || event.key === ' ') { event.preventDefault(); $(this).click(); }">[39;22m[39;1m\n
                        [39;22m[39;1m<div class="card-body text-center p-3">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-robot text-success mb-2" style="font-size: 1.5rem;">[39;22m[39;1m</i>[39;22m[39;1m\n
                            [39;22m[39;1m<h6 class="card-title mb-1">[39;22m[39;1mUse AI to Create[39;22m[39;1m</h6>[39;22m[39;1m\n
                            [39;22m[39;1m<p class="card-text text-muted small mb-0">[39;22m[39;1mAI will research and fill in details[39;22m[39;1m</p>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `,\n
        \n
        3: `\n
            [39;22m[39;1m<div class="text-center mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<div class="badge bg-primary mb-2">[39;22m[39;1mStep 3 of 3[39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<h6 class="text-muted">[39;22m[39;1mAdditional Details[39;22m[39;1m</h6>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            [39;22m[39;1m<form id="new-span-form">[39;22m[39;1m\n
                [39;22m[39;1m<div class="mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<label class="form-label fw-medium">[39;22m[39;1mStart Date[39;22m[39;1m</label>[39;22m[39;1m\n
                    [39;22m[39;1m<div class="row g-2">[39;22m[39;1m\n
                        [39;22m[39;1m<div class="col-4">[39;22m[39;1m\n
                            [39;22m[39;1m<input type="number" class="form-control form-control-sm" \n
                                   id="modal_start_year" name="start_year"\n
                                   placeholder="Year">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="invalid-feedback" id="start_year-error">[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="col-4">[39;22m[39;1m\n
                            [39;22m[39;1m<input type="number" class="form-control form-control-sm" \n
                                   id="modal_start_month" name="start_month" min="1" max="12"\n
                                   placeholder="Month">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="invalid-feedback" id="start_month-error">[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="col-4">[39;22m[39;1m\n
                            [39;22m[39;1m<input type="number" class="form-control form-control-sm" \n
                                   id="modal_start_day" name="start_day" min="1" max="31"\n
                                   placeholder="Day">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="invalid-feedback" id="start_day-error">[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
\n
                [39;22m[39;1m<div class="mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<label class="form-label fw-medium">[39;22m[39;1mEnd Date[39;22m[39;1m</label>[39;22m[39;1m\n
                    [39;22m[39;1m<div class="row g-2">[39;22m[39;1m\n
                        [39;22m[39;1m<div class="col-4">[39;22m[39;1m\n
                            [39;22m[39;1m<input type="number" class="form-control form-control-sm" \n
                                   id="modal_end_year" name="end_year"\n
                                   placeholder="Year">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="invalid-feedback" id="end_year-error">[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="col-4">[39;22m[39;1m\n
                            [39;22m[39;1m<input type="number" class="form-control form-control-sm" \n
                                   id="modal_end_month" name="end_month" min="1" max="12"\n
                                   placeholder="Month">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="invalid-feedback" id="end_month-error">[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="col-4">[39;22m[39;1m\n
                            [39;22m[39;1m<input type="number" class="form-control form-control-sm" \n
                                   id="modal_end_day" name="end_day" min="1" max="31"\n
                                   placeholder="Day">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="invalid-feedback" id="end_day-error">[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                    \n
                    [39;22m[39;1m<small class="text-muted">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-info-circle me-1">[39;22m[39;1m</i>[39;22m[39;1m\n
                        Leave dates empty for timeless spans or placeholders\n
                    [39;22m[39;1m</small>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</form>[39;22m[39;1m\n
        `,\n
        \n
        4: `\n
            [39;22m[39;1m<div class="text-center">[39;22m[39;1m\n
                [39;22m[39;1m<div class="spinner-border text-primary mb-3" role="status">[39;22m[39;1m\n
                    [39;22m[39;1m<span class="visually-hidden">[39;22m[39;1mLoading...[39;22m[39;1m</span>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<h6 class="text-muted mb-2">[39;22m[39;1mAI is doing its thing...[39;22m[39;1m</h6>[39;22m[39;1m\n
                [39;22m[39;1m<p class="text-muted small">[39;22m[39;1mFinding out about [39;22m[39;1m<span id="ai-person-name">[39;22m[39;1m</span>[39;22m[39;1m</p>[39;22m[39;1m\n
                [39;22m[39;1m<p class="text-muted small">[39;22m[39;1mYes, it's [39;22m[39;1m<strike>[39;22m[39;1ma bit[39;22m[39;1m</strike>[39;22m[39;1m [39;22m[39;1m<strong>[39;22m[39;1mvery[39;22m[39;1m</strong>[39;22m[39;1m slow...[39;22m[39;1m</p>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `,\n
        \n
        5: `\n
            [39;22m[39;1m<div class="text-center mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<div class="badge bg-success mb-2">[39;22m[39;1mAI Results[39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<h6 class="text-muted">[39;22m[39;1mOK, I think it worked...[39;22m[39;1m</h6>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            [39;22m[39;1m<div id="ai-success-content" class="d-none">[39;22m[39;1m\n
                [39;22m[39;1m<div class="alert alert-success py-2">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-check-circle me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                    [39;22m[39;1m<strong>[39;22m[39;1mSuccess![39;22m[39;1m</strong>[39;22m[39;1m AI found information about this person.\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                \n
                [39;22m[39;1m<div class="card mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card-body p-3">[39;22m[39;1m\n
                        [39;22m[39;1m<h6 class="card-title">[39;22m[39;1mSummary of Found Information[39;22m[39;1m</h6>[39;22m[39;1m\n
                        [39;22m[39;1m<div id="ai-summary" class="small">[39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                \n
                [39;22m[39;1m<div class="card">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card-body p-3">[39;22m[39;1m\n
                        [39;22m[39;1m<h6 class="card-title">[39;22m[39;1mRaw YAML Data[39;22m[39;1m</h6>[39;22m[39;1m\n
                        [39;22m[39;1m<div id="ai-details" class="small">[39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            [39;22m[39;1m<div id="ai-error-content" class="d-none">[39;22m[39;1m\n
                [39;22m[39;1m<div class="alert alert-warning py-2">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-exclamation-triangle me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                    [39;22m[39;1m<strong>[39;22m[39;1mLimited Information[39;22m[39;1m</strong>[39;22m[39;1m AI couldn't find much information about this person.\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                \n
                [39;22m[39;1m<div class="card">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card-body p-3">[39;22m[39;1m\n
                        [39;22m[39;1m<h6 class="card-title">[39;22m[39;1mAvailable Information[39;22m[39;1m</h6>[39;22m[39;1m\n
                        [39;22m[39;1m<div id="ai-error-details" class="small">[39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `,\n
        \n
        6: `\n
            [39;22m[39;1m<div class="text-center mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<div class="badge bg-warning mb-2">[39;22m[39;1mMerge Available[39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<h6 class="text-muted">[39;22m[39;1mMerge Confirmation[39;22m[39;1m</h6>[39;22m[39;1m\n
                [39;22m[39;1m<p class="mb-3">[39;22m[39;1mA span with this name and type already exists. Do you want to merge the AI data into the existing span?[39;22m[39;1m</p>[39;22m[39;1m\n
                [39;22m[39;1m<div class="card mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card-body p-2">[39;22m[39;1m\n
                        [39;22m[39;1m<strong>[39;22m[39;1mExisting Span:[39;22m[39;1m</strong>[39;22m[39;1m<br>[39;22m[39;1m\n
                        [39;22m[39;1m<span id="merge-existing-name">[39;22m[39;1m</span>[39;22m[39;1m [39;22m[39;1m<span class="text-muted">[39;22m[39;1m([39;22m[39;1m<span id="merge-existing-type">[39;22m[39;1m</span>[39;22m[39;1m)[39;22m[39;1m</span>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `,\n
        \n
        7: `\n
            [39;22m[39;1m<div class="text-center mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<div class="badge bg-success mb-2">[39;22m[39;1mSuccess![39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<h6 class="text-muted">[39;22m[39;1mSpan Created Successfully[39;22m[39;1m</h6>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            [39;22m[39;1m<div class="alert alert-success">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-check-circle me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                [39;22m[39;1m<strong>[39;22m[39;1mSpan created successfully![39;22m[39;1m</strong>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `\n
    };\n
    \n
    // Footer templates\n
    const stepFooter = {\n
        1: `\n
            [39;22m[39;1m<button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-x-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mCancel\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m<button type="button" class="btn btn-primary px-4" id="next-step-btn" tabindex="1" autofocus>[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-arrow-right me-1">[39;22m[39;1m</i>[39;22m[39;1mNext\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
        `,\n
        \n
        2: `\n
            [39;22m[39;1m<button type="button" class="btn btn-outline-secondary me-2" id="back-to-step1">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-arrow-left me-1">[39;22m[39;1m</i>[39;22m[39;1mBack\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
        `,\n
        \n
        3: `\n
            [39;22m[39;1m<div class="d-flex align-items-center">[39;22m[39;1m\n
                [39;22m[39;1m<div class="me-3">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="btn-group btn-group-sm" role="group" aria-label="Span state selection">[39;22m[39;1m                                 \n
                        [39;22m[39;1m<input type="radio" class="btn-check" name="state" id="state_placeholder" value="placeholder" checked>[39;22m[39;1m\n
                        [39;22m[39;1m<label class="btn btn-outline-secondary" for="state_placeholder">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-question-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mPlaceholder\n
                        [39;22m[39;1m</label>[39;22m[39;1m\n
                        \n
                        [39;22m[39;1m<input type="radio" class="btn-check" name="state" id="state_draft" value="draft">[39;22m[39;1m\n
                        [39;22m[39;1m<label class="btn btn-outline-secondary" for="state_draft">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-pencil me-1">[39;22m[39;1m</i>[39;22m[39;1mDraft\n
                        [39;22m[39;1m</label>[39;22m[39;1m\n
\n
                        [39;22m[39;1m<input type="radio" class="btn-check" name="state" id="state_complete" value="complete">[39;22m[39;1m\n
                        [39;22m[39;1m<label class="btn btn-outline-secondary" for="state_complete">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-check-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mComplete\n
                        [39;22m[39;1m</label>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m<div class="invalid-feedback" id="state-error">[39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            [39;22m[39;1m<div class="ms-auto">[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-x-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mCancel\n
                [39;22m[39;1m</button>[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn btn-primary px-4" id="save-span-btn" tabindex="1" autofocus>[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-check-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mCreate Span\n
                [39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `,\n
        \n
        4: `\n
            [39;22m[39;1m<button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-x-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mCancel\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
        `,\n
        \n
        5: `\n
            [39;22m[39;1m<button type="button" class="btn btn-outline-secondary me-2" id="back-to-manual" \n
                    aria-label="Go back to manual creation form">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-pencil me-1">[39;22m[39;1m</i>[39;22m[39;1mCreate Manually\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m<button type="button" class="btn btn-primary px-4" id="confirm-ai-btn" \n
                    aria-label="Create span using AI generated data" tabindex="1" autofocus>[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-check-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mCreate with AI Data\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
        `,\n
        \n
        6: `\n
            [39;22m[39;1m<button type="button" class="btn btn-outline-secondary me-2" id="cancel-merge-btn">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-x-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mCancel\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m<button type="button" class="btn btn-primary px-4" id="confirm-merge-btn" tabindex="1" autofocus>[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-arrow-repeat me-1">[39;22m[39;1m</i>[39;22m[39;1mMerge and Update\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
        `,\n
        \n
        7: `\n
            [39;22m[39;1m<button type="button" class="btn btn-primary px-4" id="view-span-btn" \n
                    aria-label="View the newly created span" tabindex="1" autofocus>[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-eye me-1">[39;22m[39;1m</i>[39;22m[39;1mView Span\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
        `\n
    };\n
    \n
    function showStep(step) {\n
        currentStep = step;\n
        \n
        // Update modal content\n
        $('#modal-content').html(stepContent[step]);\n
        $('#modal-footer').html(stepFooter[step]);\n
        \n
        // Re-attach event listeners for the new content\n
        attachEventListeners(step);\n
        \n
        // Prefill form fields if in improve mode\n
        if (isImproveMode && step === 1) {\n
            $('#modal_name').val(formData.name);\n
            $('#modal_type_id').val(formData.type_id);\n
        }\n
        \n
        // Autofill merge info if merge step\n
        if (step === 6 && window.mergeData) {\n
            $('#merge-existing-name').text(window.mergeData.existing_span.name);\n
            $('#merge-existing-type').text(window.mergeData.existing_span.type_id);\n
        }\n
    }\n
    \n
    function attachEventListeners(step) {\n
        if (step === 1) {\n
            // Step 1: Next button\n
            $('#next-step-btn').on('click', function() {\n
                const name = $('#modal_name').val().trim();\n
                const typeId = $('#modal_type_id').val();\n
                \n
                if (!name || !typeId) {\n
                    if (!name) {\n
                        $('#modal_name').addClass('is-invalid');\n
                        $('#name-error').text('Name is required');\n
                    }\n
                    if (!typeId) {\n
                        $('#modal_type_id').addClass('is-invalid');\n
                        $('#type_id-error').text('Type is required');\n
                    }\n
                    return;\n
                }\n
                \n
                // Clear validation errors\n
                $('.is-invalid').removeClass('is-invalid');\n
                $('.invalid-feedback').text('');\n
                \n
                // Store form data\n
                formData.name = name;\n
                formData.type_id = typeId;\n
                \n
                if (typeId === 'person') {\n
                    showStep(2);\n
                } else {\n
                    showStep(3);\n
                }\n
            });\n
        }\n
        \n
        if (step === 2) {\n
            // Step 2: Card selection\n
            $('#create-manual-card, #create-ai-card').on('click', function() {\n
                $('.card').removeClass('selected');\n
                $(this).addClass('selected');\n
                \n
                if ($(this).attr('id') === 'create-manual-card') {\n
                    selectedCreationMethod = 'manual';\n
                    showStep(3);\n
                } else {\n
                    selectedCreationMethod = 'ai';\n
                    showStep(4);\n
                    startAiProcess();\n
                }\n
            });\n
            \n
            // Back button\n
            $('#back-to-step1').on('click', function() {\n
                showStep(1);\n
            });\n
        }\n
        \n
        if (step === 3) {\n
            // Step 3: Manual form\n
            $('#save-span-btn').on('click', function() {\n
                const form = $('#new-span-form');\n
                const formDataObj = new FormData(form[0]);\n
                \n
                // Add stored data\n
                formDataObj.append('name', formData.name);\n
                formDataObj.append('type_id', formData.type_id);\n
                formDataObj.append('_token', $('meta[name="csrf-token"]').attr('content'));\n
                \n
                // Ensure state is set\n
                const selectedState = $('input[name="state"]:checked').val();\n
                if (!selectedState) {\n
                    $('#state_placeholder').prop('checked', true);\n
                    formDataObj.set('state', 'placeholder');\n
                } else {\n
                    formDataObj.set('state', selectedState);\n
                }\n
                \n
                // Clear previous errors\n
                $('.is-invalid').removeClass('is-invalid');\n
                $('.invalid-feedback').text('');\n
                \n
                $.ajax({\n
                    url: 'http://localhost:8000/spans',\n
                    method: 'POST',\n
                    data: formDataObj,\n
                    processData: false,\n
                    contentType: false,\n
                    headers: {\n
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content'),\n
                        'Accept': 'application/json'\n
                    },\n
                    success: function(response) {\n
                        $('#newSpanModal').modal('hide');\n
                        \n
                        if (typeof showAlert === 'function') {\n
                            showAlert('Span created successfully!', 'success');\n
                        } else {\n
                            alert('Span created successfully!');\n
                        }\n
                        \n
                        if (response.span_id) {\n
                            window.location.href = '/spans/' + response.span_id;\n
                        } else {\n
                            window.location.reload();\n
                        }\n
                    },\n
                    error: function(xhr) {\n
                        if (xhr.status === 422) {\n
                            const errors = xhr.responseJSON.errors;\n
                            Object.keys(errors).forEach(function(field) {\n
                                let input;\n
                                if (field === 'state') {\n
                                    input = $('input[name="state"]').closest('.btn-group');\n
                                } else {\n
                                    input = $('#modal_' + field);\n
                                }\n
                                const errorDiv = $('#' + field + '-error');\n
                                \n
                                input.addClass('is-invalid');\n
                                errorDiv.text(errors[field][0]);\n
                            });\n
                        } else {\n
                            alert('An error occurred while creating the span. Please try again.');\n
                        }\n
                    }\n
                });\n
            });\n
        }\n
        \n
        if (step === 5) {\n
            // Step 5: AI results\n
            $('#back-to-manual').on('click', function() {\n
                showStep(3);\n
            });\n
            \n
            $('#confirm-ai-btn').on('click', function() {\n
                if (!aiData) {\n
                    alert('No AI data available');\n
                    return;\n
                }\n
                \n
                // Show loading state\n
                const btn = $(this);\n
                const originalText = btn.html();\n
                btn.prop('disabled', true);\n
                btn.html('[39;22m[39;1m<span class="spinner-border spinner-border-sm me-1">[39;22m[39;1m</span>[39;22m[39;1mCreating...');\n
                \n
                // Create span with AI data\n
                $.ajax({\n
                    url: 'http://localhost:8000/spans',\n
                    method: 'POST',\n
                    data: {\n
                        name: formData.name,\n
                        type_id: formData.type_id,\n
                        state: 'placeholder',\n
                        ai_yaml: aiData.yaml,\n
                        _token: $('meta[name="csrf-token"]').attr('content')\n
                    },\n
                    success: function(response) {\n
                        if (response.merge_available) {\n
                            window.mergeData = response;\n
                            showStep(6);\n
                            return;\n
                        }\n
                        showCreationSuccess(response);\n
                    },\n
                    error: function(xhr) {\n
                        // Reset button state\n
                        btn.prop('disabled', false);\n
                        btn.html(originalText);\n
                        showStep(5);\n
                        alert('Failed to create span with AI data. Please try again.');\n
                    }\n
                });\n
            });\n
        }\n
        if (step === 6) {\n
            // Merge confirmation step\n
            $('#confirm-merge-btn').on('click', function() {\n
                if (!window.mergeData) return;\n
                \n
                // Show loading state\n
                const btn = $(this);\n
                const originalText = btn.html();\n
                btn.prop('disabled', true);\n
                btn.html('[39;22m[39;1m<span class="spinner-border spinner-border-sm me-1">[39;22m[39;1m</span>[39;22m[39;1mMerging...');\n
                \n
                // Send confirm_merge=true\n
                $.ajax({\n
                    url: 'http://localhost:8000/spans',\n
                    method: 'POST',\n
                    data: {\n
                        name: formData.name,\n
                        type_id: formData.type_id,\n
                        state: 'placeholder',\n
                        ai_yaml: aiData.yaml,\n
                        confirm_merge: true,\n
                        _token: $('meta[name="csrf-token"]').attr('content')\n
                    },\n
                    success: function(response) {\n
                        showCreationSuccess(response);\n
                    },\n
                    error: function(xhr) {\n
                        // Reset button state\n
                        btn.prop('disabled', false);\n
                        btn.html(originalText);\n
                        alert('Failed to merge and update span. Please try again.');\n
                    }\n
                });\n
            });\n
            $('#cancel-merge-btn').on('click', function() {\n
                showStep(5);\n
            });\n
        }\n
        \n
        if (step === 7) {\n
            // Step 7: Success summary\n
            $('#view-span-btn').on('click', function() {\n
                $('#newSpanModal').modal('hide');\n
                \n
                if (window.aiCreationResponse && window.aiCreationResponse.span_id) {\n
                    window.location.href = '/spans/' + window.aiCreationResponse.span_id;\n
                } else {\n
                    window.location.reload();\n
                }\n
            });\n
        }\n
    }\n
    \n
    function updateStartYearRequirement() {\n
        const typeSelect = document.getElementById('modal_type_id');\n
        const stateInputs = document.querySelectorAll('input[name="state"]');\n
        const startYearInput = document.getElementById('modal_start_year');\n
        \n
        if (!typeSelect || !startYearInput) return;\n
        \n
        const selectedType = typeSelect.value;\n
        const selectedState = Array.from(stateInputs).find(input => input.checked)?.value;\n
        \n
        const isTimeless = timelessSpanTypes.includes(selectedType);\n
        const isPlaceholder = selectedState === 'placeholder';\n
        \n
        if (isTimeless || isPlaceholder) {\n
            startYearInput.removeAttribute('required');\n
        } else {\n
            startYearInput.setAttribute('required', 'required');\n
        }\n
    }\n
    \n
    // AI Process\n
    function startAiProcess() {\n
        const name = formData.name;\n
        $('#ai-person-name').text(name);\n
        \n
        $.ajax({\n
            url: 'http://localhost:8000/ai-yaml-generator/generate',\n
            method: 'POST',\n
            data: {\n
                name: name,\n
                _token: $('meta[name="csrf-token"]').attr('content')\n
            },\n
            success: function(response) {\n
                if (response.success) {\n
                    aiData = response;\n
                    showAiResults(true);\n
                } else {\n
                    showAiResults(false, response.error);\n
                }\n
            },\n
            error: function(xhr) {\n
                showAiResults(false, 'Failed to generate AI data');\n
            }\n
        });\n
    }\n
    \n
    function showAiResults(success, error = null) {\n
        if (success) {\n
            $('#ai-success-content').removeClass('d-none');\n
            $('#ai-error-content').addClass('d-none');\n
            \n
            // Parse YAML and generate summary\n
            const summary = parseYamlSummary(aiData.yaml);\n
            $('#ai-summary').html(summary);\n
            \n
            // Display AI generated details (truncated for compact view)\n
            const details = aiData.yaml;\n
            const truncatedDetails = details.length > 300 ? details.substring(0, 300) + '...' : details;\n
            $('#ai-details').html(`[39;22m[39;1m<pre class="mb-0 small">[39;22m[39;1m<code>[39;22m[39;1m${truncatedDetails}[39;22m[39;1m</code>[39;22m[39;1m</pre>[39;22m[39;1m`);\n
        } else {\n
            $('#ai-success-content').addClass('d-none');\n
            $('#ai-error-content').removeClass('d-none');\n
            $('#ai-error-details').text(error || 'An error occurred');\n
        }\n
        \n
        showStep(5);\n
    }\n
    \n
    function parseYamlSummary(yamlText) {\n
        try {\n
            // Simple YAML parsing to extract key information\n
            const lines = yamlText.split('\n');\n
            const summary = [];\n
            \n
            // Extract basic info\n
            const nameMatch = yamlText.match(/name:\s*['"]?([^'\n]+)['"]?/);\n
            const typeMatch = yamlText.match(/type:\s*(\w+)/);\n
            const startMatch = yamlText.match(/start:\s*['"]?([^'\n]+)['"]?/);\n
            const endMatch = yamlText.match(/end:\s*['"]?([^'\n]+)['"]?/);\n
            \n
            if (nameMatch) summary.push(`[39;22m[39;1m<strong>[39;22m[39;1mName:[39;22m[39;1m</strong>[39;22m[39;1m ${nameMatch[1]}`);\n
            if (typeMatch) summary.push(`[39;22m[39;1m<strong>[39;22m[39;1mType:[39;22m[39;1m</strong>[39;22m[39;1m ${typeMatch[1]}`);\n
            if (startMatch) summary.push(`[39;22m[39;1m<strong>[39;22m[39;1mStart:[39;22m[39;1m</strong>[39;22m[39;1m ${startMatch[1]}`);\n
            if (endMatch) summary.push(`[39;22m[39;1m<strong>[39;22m[39;1mEnd:[39;22m[39;1m</strong>[39;22m[39;1m ${endMatch[1]}`);\n
            \n
            // Count connections\n
            const connectionTypes = ['parents', 'children', 'relationship', 'employment', 'education', 'residence'];\n
            const connections = [];\n
            \n
            connectionTypes.forEach(type => {\n
                const regex = new RegExp(`${type}:\\s*\\n\\s*-\\s*name:`, 'g');\n
                const matches = yamlText.match(regex);\n
                if (matches) {\n
                    connections.push(`${matches.length} ${type}`);\n
                }\n
            });\n
            \n
            if (connections.length > 0) {\n
                summary.push(`[39;22m[39;1m<strong>[39;22m[39;1mConnections:[39;22m[39;1m</strong>[39;22m[39;1m ${connections.join(', ')}`);\n
            }\n
            \n
            // Extract metadata\n
            const metadataMatches = yamlText.match(/metadata:\s*\n((?:\s+[^:\n]+:\s*[^\n]+\n?)+)/);\n
            if (metadataMatches) {\n
                const metadataLines = metadataMatches[1].split('\n').filter(line => line.trim());\n
                const metadata = metadataLines.map(line => {\n
                    const match = line.match(/\s+([^:]+):\s*(.+)/);\n
                    return match ? `${match[1].trim()}: ${match[2].trim()}` : null;\n
                }).filter(Boolean);\n
                \n
                if (metadata.length > 0) {\n
                    summary.push(`[39;22m[39;1m<strong>[39;22m[39;1mDetails:[39;22m[39;1m</strong>[39;22m[39;1m ${metadata.join(', ')}`);\n
                }\n
            }\n
            \n
            return summary.length > 0 ? summary.join('[39;22m[39;1m<br>[39;22m[39;1m') : 'Information found but details not parsed';\n
            \n
        } catch (error) {\n
            return 'Information found but could not parse details';\n
        }\n
    }\n
    \n
    function showCreationSuccess(response) {\n
        // Store the response for the view button\n
        window.aiCreationResponse = response;\n
        \n
        // Show success step\n
        showStep(7);\n
    }\n
    \n
    function showCreationSummary(response) {\n
        if (response.span) {\n
            // Format the start date nicely\n
            let startDate = 'Not specified';\n
            if (response.span.start_year) {\n
                if (response.span.start_month && response.span.start_day) {\n
                    startDate = `${response.span.start_day}/${response.span.start_month}/${response.span.start_year}`;\n
                } else if (response.span.start_month) {\n
                    startDate = `${response.span.start_month}/${response.span.start_year}`;\n
                } else {\n
                    startDate = response.span.start_year.toString();\n
                }\n
            }\n
            \n
            return `\n
                [39;22m[39;1m<div class="text-center">[39;22m[39;1m\n
                    [39;22m[39;1m<h5 class="mb-3">[39;22m[39;1m${response.span.name}[39;22m[39;1m</h5>[39;22m[39;1m\n
                    [39;22m[39;1m<p class="text-muted mb-3">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-calendar-event me-1">[39;22m[39;1m</i>[39;22m[39;1m\n
                        ${startDate}\n
                    [39;22m[39;1m</p>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            `;\n
        }\n
        \n
        return '[39;22m[39;1m<p class="text-muted">[39;22m[39;1mSpan created successfully[39;22m[39;1m</p>[39;22m[39;1m';\n
    }\n
    \n
    // Initialize modal\n
    $('#newSpanModal').on('show.bs.modal', function() {\n
        showStep(1);\n
    });\n
    \n
    // Reset form when modal is hidden\n
    $('#newSpanModal').on('hidden.bs.modal', function() {\n
        // Reset variables\n
        currentStep = 1;\n
        aiData = null;\n
        selectedCreationMethod = null;\n
        formData = {};\n
        window.aiCreationResponse = null;\n
        window.mergeData = null; // Reset merge data\n
        \n
        // Clear any validation errors\n
        $('.is-invalid').removeClass('is-invalid');\n
        $('.invalid-feedback').text('');\n
    });\n
});\n
[39;22m[39;1m</script>[39;22m[39;1m         \n
        <!-- Sidebar Toggle Script -->\n
            [39;22m[39;1m</body>[39;22m[39;1m\n
[39;22m[39;1m</html>[39;22m[39;1m\n
' [UTF-8](length: 111157) contains "lived in" [ASCII](length: 8).[39;22m

  at [32mtests/Feature/SpanConnectionTypesTest.php[39m:[32m151[39m
    [90m147[0m[90m▕ [0m[35;1m        [0m
    [90m148[0m[90m▕ [0m[35;1m        [0m[39;1m$response[0m[35;1m->[0m[39;1massertStatus[0m[35;1m([0m[39;1m200[0m[35;1m);[0m
    [90m149[0m[90m▕ [0m[35;1m        [0m[90;3m// The connection route shows the connection span's page, which should contain the connection details[0m
    [90m150[0m[90m▕ [0m[90;3m        // We should see the connection span's name which typically includes both subject and object[0m
[31;1m  ➜ [0m[3;1m151[0m[90m▕ [0m[90;3m        [0m[39;1m$response[0m[35;1m->[0m[39;1massertSee[0m[35;1m([0m[39;1m$connectionType[0m[35;1m->[0m[39;1mforward_predicate[0m[35;1m);[0m
    [90m152[0m[90m▕ [0m[35;1m    }[0m
    [90m153[0m[90m▕ [0m
    [90m154[0m[90m▕ [0m[35;1m    public function [0m[39;1mtest_invalid_predicate_redirects_to_span_show[0m[35;1m()[0m
    [90m155[0m[90m▕ [0m[35;1m    {[0m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\SpanManagementTest[22m [90m>[39m user c… [41;1m BadMethodCallException [49;22m  
[39;1m  Call to undefined method App\Models\Span::grantPermission()[39;22m

  at [32mvendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php[39m:[32m67[39m
    [90m 63[0m[90m▕ [0m[90;3m     * @throws \BadMethodCallException[0m
    [90m 64[0m[90m▕ [0m[90;3m     */[0m
    [90m 65[0m[90m▕ [0m[90;3m    [0m[35;1mprotected static function [0m[39;1mthrowBadMethodCallException[0m[35;1m([0m[39;1m$method[0m[35;1m)[0m
    [90m 66[0m[90m▕ [0m[35;1m    {[0m
[31;1m  ➜ [0m[3;1m 67[0m[90m▕ [0m[35;1m        throw new [0m[39;1mBadMethodCallException[0m[35;1m([0m[39;1msprintf[0m[35;1m([0m
    [90m 68[0m[90m▕ [0m[35;1m            [0m[37m'Call to undefined method %s::%s()'[0m[35;1m, static::class, [0m[39;1m$method[0m
    [90m 69[0m[90m▕ [0m[39;1m        [0m[35;1m));[0m
    [90m 70[0m[90m▕ [0m[35;1m    }[0m
    [90m 71[0m[90m▕ [0m[35;1m}[0m

      [2m+3 vendor frames [22m
  [33m4   [39m[39;1mtests/Feature/SpanManagementTest.php[39;22m:[39;1m169[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\SpanManagementTest[22m [90m>[39m user c… [41;1m BadMethodCallException [49;22m  
[39;1m  Call to undefined method App\Models\Span::grantPermission()[39;22m

  at [32mvendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php[39m:[32m67[39m
    [90m 63[0m[90m▕ [0m[90;3m     * @throws \BadMethodCallException[0m
    [90m 64[0m[90m▕ [0m[90;3m     */[0m
    [90m 65[0m[90m▕ [0m[90;3m    [0m[35;1mprotected static function [0m[39;1mthrowBadMethodCallException[0m[35;1m([0m[39;1m$method[0m[35;1m)[0m
    [90m 66[0m[90m▕ [0m[35;1m    {[0m
[31;1m  ➜ [0m[3;1m 67[0m[90m▕ [0m[35;1m        throw new [0m[39;1mBadMethodCallException[0m[35;1m([0m[39;1msprintf[0m[35;1m([0m
    [90m 68[0m[90m▕ [0m[35;1m            [0m[37m'Call to undefined method %s::%s()'[0m[35;1m, static::class, [0m[39;1m$method[0m
    [90m 69[0m[90m▕ [0m[39;1m        [0m[35;1m));[0m
    [90m 70[0m[90m▕ [0m[35;1m    }[0m
    [90m 71[0m[90m▕ [0m[35;1m}[0m

      [2m+3 vendor frames [22m
  [33m4   [39m[39;1mtests/Feature/SpanManagementTest.php[39;22m:[39;1m242[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\SpanSearchControllerTest[22m [90m>[39m timeline includes nested…   
[39;1m  Failed asserting that two strings are equal.
  [39;22m[31m-'9f59d5d3-b030-4395-9c85-379d26faef5b'[39m[39;1m
  [39;22m[32m+'9f59d5d3-9bd8-41fb-b347-60827e25e9e2'[39m[39;1m
  [39;22m

  at [32mtests/Feature/SpanSearchControllerTest.php[39m:[32m287[39m
    [90m283[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertEquals[0m[35;1m([0m[37m'First Year'[0m[35;1m, [0m[39;1m$nestedConnections[0m[35;1m[[0m[39;1m0[0m[35;1m][[0m[37m'target_name'[0m[35;1m]);[0m
    [90m284[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertEquals[0m[35;1m([0m[37m'phase'[0m[35;1m, [0m[39;1m$nestedConnections[0m[35;1m[[0m[39;1m0[0m[35;1m][[0m[37m'target_type'[0m[35;1m]);[0m
    [90m285[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertEquals[0m[35;1m([0m[37m'during'[0m[35;1m, [0m[39;1m$nestedConnections[0m[35;1m[[0m[39;1m0[0m[35;1m][[0m[37m'type_id'[0m[35;1m]);[0m
    [90m286[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertTrue[0m[35;1m([0m[39;1m$nestedConnections[0m[35;1m[[0m[39;1m0[0m[35;1m][[0m[37m'is_nested'[0m[35;1m]);[0m
[31;1m  ➜ [0m[3;1m287[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertEquals[0m[35;1m([0m[39;1m$data[0m[35;1m[[0m[37m'connections'[0m[35;1m][[0m[39;1m0[0m[35;1m][[0m[37m'id'[0m[35;1m], [0m[39;1m$nestedConnections[0m[35;1m[[0m[39;1m0[0m[35;1m][[0m[37m'parent_connection_id'[0m[35;1m]);[0m
    [90m288[0m[90m▕ [0m
    [90m289[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertEquals[0m[35;1m([0m[37m'Second Year'[0m[35;1m, [0m[39;1m$nestedConnections[0m[35;1m[[0m[39;1m1[0m[35;1m][[0m[37m'target_name'[0m[35;1m]);[0m
    [90m290[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertEquals[0m[35;1m([0m[37m'phase'[0m[35;1m, [0m[39;1m$nestedConnections[0m[35;1m[[0m[39;1m1[0m[35;1m][[0m[37m'target_type'[0m[35;1m]);[0m
    [90m291[0m[90m▕ [0m[35;1m        [0m[39;1m$this[0m[35;1m->[0m[39;1massertEquals[0m[35;1m([0m[37m'during'[0m[35;1m, [0m[39;1m$nestedConnections[0m[35;1m[[0m[39;1m1[0m[35;1m][[0m[37m'type_id'[0m[35;1m]);[0m

  [33m1   [39m[39;1mtests/Feature/SpanSearchControllerTest.php[39;22m:[39;1m287[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\SpanSearchControllerTest[22m [90m>[39m…  [41;1m BadMethodCallException [49;22m  
[39;1m  Call to undefined method App\Models\Span::grantPermission()[39;22m

  at [32mvendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php[39m:[32m67[39m
    [90m 63[0m[90m▕ [0m[90;3m     * @throws \BadMethodCallException[0m
    [90m 64[0m[90m▕ [0m[90;3m     */[0m
    [90m 65[0m[90m▕ [0m[90;3m    [0m[35;1mprotected static function [0m[39;1mthrowBadMethodCallException[0m[35;1m([0m[39;1m$method[0m[35;1m)[0m
    [90m 66[0m[90m▕ [0m[35;1m    {[0m
[31;1m  ➜ [0m[3;1m 67[0m[90m▕ [0m[35;1m        throw new [0m[39;1mBadMethodCallException[0m[35;1m([0m[39;1msprintf[0m[35;1m([0m
    [90m 68[0m[90m▕ [0m[35;1m            [0m[37m'Call to undefined method %s::%s()'[0m[35;1m, static::class, [0m[39;1m$method[0m
    [90m 69[0m[90m▕ [0m[39;1m        [0m[35;1m));[0m
    [90m 70[0m[90m▕ [0m[35;1m    }[0m
    [90m 71[0m[90m▕ [0m[35;1m}[0m

      [2m+3 vendor frames [22m
  [33m4   [39m[39;1mtests/Feature/SpanSearchControllerTest.php[39;22m:[39;1m693[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\SpanViewTest[22m [90m>[39m uuid redirec… [41;1m UrlGenerationException [49;22m  
[39;1m  Missing required parameter for [Route: spans.show] [URI: spans/{subject}] [Missing parameter: subject].[39;22m

  at [32mvendor/laravel/framework/src/Illuminate/Routing/Exceptions/UrlGenerationException.php[39m:[32m35[39m
    [90m 31[0m[90m▕ [0m[35;1m        }[0m
    [90m 32[0m[90m▕ [0m
    [90m 33[0m[90m▕ [0m[35;1m        [0m[39;1m$message [0m[35;1m.= [0m[37m'.'[0m[35;1m;[0m
    [90m 34[0m[90m▕ [0m
[31;1m  ➜ [0m[3;1m 35[0m[90m▕ [0m[35;1m        return new static([0m[39;1m$message[0m[35;1m);[0m
    [90m 36[0m[90m▕ [0m[35;1m    }[0m
    [90m 37[0m[90m▕ [0m[35;1m}[0m
    [90m 38[0m[90m▕ [0m

      [2m+5 vendor frames [22m
  [33m6   [39m[39;1mtests/Feature/SpanViewTest.php[39;22m:[39;1m176[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\SpanViewTest[22m [90m>[39m slug access…  [41;1m UrlGenerationException [49;22m  
[39;1m  Missing required parameter for [Route: spans.show] [URI: spans/{subject}] [Missing parameter: subject].[39;22m

  at [32mvendor/laravel/framework/src/Illuminate/Routing/Exceptions/UrlGenerationException.php[39m:[32m35[39m
    [90m 31[0m[90m▕ [0m[35;1m        }[0m
    [90m 32[0m[90m▕ [0m
    [90m 33[0m[90m▕ [0m[35;1m        [0m[39;1m$message [0m[35;1m.= [0m[37m'.'[0m[35;1m;[0m
    [90m 34[0m[90m▕ [0m
[31;1m  ➜ [0m[3;1m 35[0m[90m▕ [0m[35;1m        return new static([0m[39;1m$message[0m[35;1m);[0m
    [90m 36[0m[90m▕ [0m[35;1m    }[0m
    [90m 37[0m[90m▕ [0m[35;1m}[0m
    [90m 38[0m[90m▕ [0m

      [2m+5 vendor frames [22m
  [33m6   [39m[39;1mtests/Feature/SpanViewTest.php[39;22m:[39;1m202[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\SpanViewTest[22m [90m>[39m invalid slug… [41;1m UrlGenerationException [49;22m  
[39;1m  Missing required parameter for [Route: spans.show] [URI: spans/{subject}] [Missing parameter: subject].[39;22m

  at [32mvendor/laravel/framework/src/Illuminate/Routing/Exceptions/UrlGenerationException.php[39m:[32m35[39m
    [90m 31[0m[90m▕ [0m[35;1m        }[0m
    [90m 32[0m[90m▕ [0m
    [90m 33[0m[90m▕ [0m[35;1m        [0m[39;1m$message [0m[35;1m.= [0m[37m'.'[0m[35;1m;[0m
    [90m 34[0m[90m▕ [0m
[31;1m  ➜ [0m[3;1m 35[0m[90m▕ [0m[35;1m        return new static([0m[39;1m$message[0m[35;1m);[0m
    [90m 36[0m[90m▕ [0m[35;1m    }[0m
    [90m 37[0m[90m▕ [0m[35;1m}[0m
    [90m 38[0m[90m▕ [0m

      [2m+5 vendor frames [22m
  [33m6   [39m[39;1mtests/Feature/SpanViewTest.php[39;22m:[39;1m213[39;22m

  [31m────────────────────────────────────────────────────────────────────────────[39m  
  [41;1m FAILED [49;22m [1mTests\Feature\YamlMergeTest[22m [90m>[39m yaml editor detects existing span f…   
[39;1m  Failed asserting that '<!DOCTYPE html>\n
[39;22m[39;1m<html lang="en">[39;22m[39;1m\n
    [39;22m[39;1m<head>[39;22m[39;1m\n
        [39;22m[39;1m<meta charset="utf-8">[39;22m[39;1m\n
        [39;22m[39;1m<meta name="viewport" content="width=device-width, initial-scale=1">[39;22m[39;1m\n
        [39;22m[39;1m<meta name="csrf-token" content="kXfgiKCYxENBtwlsStlvZRbOjkcAnN9trXxYKadw">[39;22m[39;1m\n
        [39;22m[39;1m<base href="http://localhost:8000/spans/editor/new">[39;22m[39;1m\n
\n
        [39;22m[39;1m<title>[39;22m[39;1mLifespan Beta Testing[39;22m[39;1m</title>[39;22m[39;1m\n
\n
        <!-- Favicon -->\n
        [39;22m[39;1m<link rel="icon" href="http://localhost:8000/favicon.ico" type="image/x-icon">[39;22m[39;1m\n
\n
        <!-- jQuery -->\n
        [39;22m[39;1m<script src="https://code.jquery.com/jquery-3.7.1.min.js">[39;22m[39;1m</script>[39;22m[39;1m\n
\n
        <!-- Bootstrap -->\n
        [39;22m[39;1m<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">[39;22m[39;1m</script>[39;22m[39;1m\n
\n
        <!-- Bootstrap Icons -->\n
        [39;22m[39;1m<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">[39;22m[39;1m\n
        <!-- Fallback for Bootstrap Icons if local fonts fail -->\n
        [39;22m[39;1m<style>[39;22m[39;1m\n
            @font-face {\n
                font-display: block;\n
                font-family: "bootstrap-icons";\n
                src: url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/fonts/bootstrap-icons.woff2") format("woff2"),\n
                     url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/fonts/bootstrap-icons.woff") format("woff");\n
            }\n
        [39;22m[39;1m</style>[39;22m[39;1m\n
        \n
        <!-- Select2 -->\n
        [39;22m[39;1m<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />[39;22m[39;1m\n
        [39;22m[39;1m<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />[39;22m[39;1m\n
        [39;22m[39;1m<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js">[39;22m[39;1m</script>[39;22m[39;1m\n
\n
        <!-- Scripts and Styles -->\n
        [39;22m[39;1m<script type="module" >[39;22m[39;1m\n
    import RefreshRuntime from 'http://localhost:5173/@react-refresh'\n
    RefreshRuntime.injectIntoGlobalHook(window)\n
    window.$RefreshReg$ = () => {}\n
    window.$RefreshSig$ = () => (type) => type\n
    window.__vite_plugin_react_preamble_installed__ = true\n
[39;22m[39;1m</script>[39;22m[39;1m        [39;22m[39;1m<script type="module" src="http://localhost:5173/@vite/client">[39;22m[39;1m</script>[39;22m[39;1m<link rel="stylesheet" href="http://localhost:5173/resources/scss/app.scss" />[39;22m[39;1m<script type="module" src="http://localhost:5173/resources/js/app.js">[39;22m[39;1m</script>[39;22m[39;1m<script type="module" src="http://localhost:5173/resources/js/routes.js">[39;22m[39;1m</script>[39;22m[39;1m\n
        <!-- Google Analytics - Production Only -->\n
        \n
        <!-- Page-specific styles -->\n
        [39;22m[39;1m<style>[39;22m[39;1m\n
    .yaml-editor-container {\n
        height: calc(100vh - 250px);\n
        min-height: 600px;\n
    }\n
    \n
    .middle-column {\n
        height: calc(100vh - 250px);\n
        min-height: 600px;\n
        display: flex;\n
        flex-direction: column;\n
    }\n
    \n
    .middle-column .card {\n
        display: flex;\n
        flex-direction: column;\n
    }\n
    \n
    .middle-column .card:first-child {\n
        flex: 0 0 auto;\n
        max-height: 40%;\n
    }\n
    \n
    .middle-column .card:last-child {\n
        flex: 1;\n
    }\n
    \n
    .middle-column .card-body {\n
        flex: 1;\n
        overflow-y: auto;\n
    }\n
    \n
    .yaml-textarea {\n
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;\n
        font-size: 14px;\n
        line-height: 1.5;\n
        border-radius: 8px;\n
        border: 2px solid #e9ecef;\n
        background-color: #f8f9fa;\n
        transition: border-color 0.15s ease-in-out;\n
    }\n
    \n
    .yaml-textarea:focus {\n
        border-color: #0d6efd;\n
        outline: 0;\n
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);\n
    }\n
    \n
    .yaml-textarea.is-invalid {\n
        border-color: #dc3545;\n
    }\n
    \n
    .yaml-textarea.is-valid {\n
        border-color: #198754;\n
    }\n
    \n
\n
    \n
    .error-list {\n
        margin: 0;\n
        padding-left: 1.5rem;\n
    }\n
    \n
    .error-list li {\n
        margin-bottom: 0.5rem;\n
    }\n
    \n
\n
    \n
    .spinner-border-sm {\n
        width: 1rem;\n
        height: 1rem;\n
    }\n
    \n
    /* Enhanced Visual Translation Styling */\n
    #visual-translation .badge {\n
        font-size: 0.9rem;\n
        padding: 0.4rem 0.6rem;\n
        margin-right: 0.3rem;\n
        margin-bottom: 0.3rem;\n
    }\n
\n
    /* Interactive Button Styling */\n
    #visual-translation .interactive-entity,\n
    #visual-translation .interactive-predicate,\n
    #visual-translation .interactive-date {\n
        font-size: 0.85rem;\n
        padding: 0.3rem 0.6rem;\n
        margin: 0.1rem 0.2rem;\n
        border-radius: 0.375rem;\n
        transition: all 0.2s ease-in-out;\n
        cursor: pointer;\n
        white-space: nowrap;\n
        display: inline-block;\n
        text-decoration: none;\n
        border: 1px solid transparent;\n
    }\n
\n
    #visual-translation .interactive-entity:hover,\n
    #visual-translation .interactive-predicate:hover,\n
    #visual-translation .interactive-date:hover {\n
        transform: translateY(-1px);\n
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n
        border-color: rgba(0,0,0,0.1);\n
    }\n
\n
    #visual-translation .interactive-entity:active,\n
    #visual-translation .interactive-predicate:active,\n
    #visual-translation .interactive-date:active {\n
        transform: translateY(0);\n
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);\n
    }\n
\n
    /* Entity button colors */\n
    #visual-translation .interactive-entity.btn-primary {\n
        background-color: #0d6efd;\n
        color: white;\n
    }\n
\n
    #visual-translation .interactive-entity.btn-success {\n
        background-color: #198754;\n
        color: white;\n
    }\n
\n
    #visual-translation .interactive-entity.btn-warning {\n
        background-color: #ffc107;\n
        color: #000;\n
    }\n
\n
    #visual-translation .interactive-entity.btn-danger {\n
        background-color: #dc3545;\n
        color: white;\n
    }\n
\n
    #visual-translation .interactive-entity.btn-info {\n
        background-color: #0dcaf0;\n
        color: #000;\n
    }\n
\n
    #visual-translation .interactive-entity.btn-dark {\n
        background-color: #212529;\n
        color: white;\n
    }\n
\n
    #visual-translation .interactive-entity.btn-secondary {\n
        background-color: #6c757d;\n
        color: white;\n
    }\n
\n
    /* Predicate button styling */\n
    #visual-translation .interactive-predicate {\n
        background-color: #f8f9fa;\n
        color: #495057;\n
        border-color: #dee2e6;\n
    }\n
\n
    #visual-translation .interactive-predicate:hover {\n
        background-color: #e9ecef;\n
        border-color: #adb5bd;\n
    }\n
\n
    /* Date button styling */\n
    #visual-translation .interactive-date {\n
        background-color: #e7f3ff;\n
        color: #0c63e4;\n
        border-color: #b6d4fe;\n
    }\n
\n
    #visual-translation .interactive-date:hover {\n
        background-color: #d1ecf1;\n
        border-color: #9bd3d6;\n
    }\n
\n
    /* Connector button styling */\n
    #visual-translation .interactive-connector {\n
        background-color: #f8f9fa;\n
        color: #6c757d;\n
        border-color: #dee2e6;\n
        font-weight: 500;\n
    }\n
\n
    #visual-translation .interactive-connector:hover {\n
        background-color: #e9ecef;\n
        border-color: #adb5bd;\n
        color: #495057;\n
    }\n
\n
    /* Inactive connector button styling */\n
    #visual-translation .btn.inactive {\n
        background-color: #e9ecef;\n
        color: #6c757d;\n
        border-color: #ced4da;\n
        font-weight: 500;\n
        opacity: 0.8;\n
        cursor: default;\n
    }\n
\n
    #visual-translation .btn.inactive:hover {\n
        background-color: #e9ecef;\n
        color: #6c757d;\n
        border-color: #ced4da;\n
        opacity: 0.8;\n
    }\n
\n
    /* Button group styling */\n
    #visual-translation .btn-group {\n
        margin: 0.2rem 0.3rem;\n
        display: inline-flex;\n
        vertical-align: middle;\n
    }\n
\n
    #visual-translation .btn-group .btn {\n
        border-radius: 0;\n
        margin: 0;\n
        border-right-width: 0;\n
    }\n
\n
    #visual-translation .btn-group .btn:first-child {\n
        border-top-left-radius: 0.375rem;\n
        border-bottom-left-radius: 0.375rem;\n
    }\n
\n
    #visual-translation .btn-group .btn:last-child {\n
        border-top-right-radius: 0.375rem;\n
        border-bottom-right-radius: 0.375rem;\n
        border-right-width: 1px;\n
    }\n
\n
    #visual-translation .btn-group .btn:only-child {\n
        border-radius: 0.375rem;\n
        border-right-width: 1px;\n
    }\n
\n
    /* Sentence container styling */\n
    #visual-translation .sentence-container {\n
        display: flex;\n
        flex-wrap: wrap;\n
        align-items: center;\n
        gap: 0.2rem;\n
        margin-bottom: 0.5rem;\n
        padding: 0.5rem;\n
        background-color: #f8f9fa;\n
        border-radius: 0.5rem;\n
        border: 1px solid #e9ecef;\n
    }\n
\n
    /* Text elements between buttons */\n
    #visual-translation .sentence-text {\n
        color: #6c757d;\n
        font-size: 0.9rem;\n
        margin: 0 0.2rem;\n
    }\n
[39;22m[39;1m</style>[39;22m[39;1m\n
        \n
        <!-- Custom styles -->\n
        [39;22m[39;1m<style>[39;22m[39;1m\n
            /* Only add minimal custom styling, prefer Bootstrap classes */\n
            .nav-link {\n
                color: rgba(255, 255, 255, 0.8) !important;\n
            }\n
            .nav-link:hover, .nav-link.active {\n
                color: #fff !important;\n
                background-color: rgba(255, 255, 255, 0.1);\n
            }\n
            \n
            /* Collapsible sidebar styles */\n
            :root {\n
                --sidebar-width-lg: 280px;\n
                --sidebar-width-md: 240px;\n
                --sidebar-width-collapsed: 60px;\n
                --sidebar-transition: 0.3s ease-in-out;\n
            }\n
            \n
            /* Prevent animations on initial load */\n
            .sidebar {\n
                transition: none !important;\n
                overflow: hidden;\n
                width: var(--sidebar-width-md);\n
                margin: 0;\n
                padding: 0;\n
                flex-shrink: 0;\n
            }\n
            \n
            /* Responsive widths */\n
            @media (min-width: 992px) {\n
                .sidebar {\n
                    width: var(--sidebar-width-lg);\n
                }\n
            }\n
            \n
            /* Enable animations after page load */\n
            .sidebar.animated {\n
                transition: width var(--sidebar-transition) !important;\n
            }\n
            \n
            .sidebar.collapsed {\n
                width: var(--sidebar-width-collapsed) !important;\n
            }\n
            \n
            .sidebar.collapsed .nav-link {\n
                text-align: center;\n
                padding: 0.75rem 0.5rem;\n
            }\n
            \n
            .sidebar.collapsed .nav-link span {\n
                display: none;\n
            }\n
            \n
            .sidebar.collapsed .sidebar-heading {\n
                display: none;\n
            }\n
            \n
            .sidebar.collapsed .sidebar-footer {\n
                display: none;\n
            }\n
            \n
            .sidebar.collapsed .sidebar-brand span {\n
                display: none;\n
            }\n
            \n
            /* Hide text during animation */\n
            .sidebar.animating .nav-link span,\n
            .sidebar.animating .sidebar-brand span {\n
                display: none;\n
            }\n
            \n
            .sidebar.collapsed .nav-link i {\n
                margin-right: 0 !important;\n
                font-size: 1.1em;\n
            }\n
            \n
            .main-content {\n
                transition: none !important;\n
                flex: 1;\n
                margin: 0;\n
                padding: 0;\n
                min-width: 0;\n
            }\n
            \n
            .main-content.animated {\n
                transition: margin-left var(--sidebar-transition) !important;\n
            }\n
            \n
            .sidebar-toggle {\n
                transition: none !important;\n
            }\n
            \n
            .sidebar-toggle.animated {\n
                transition: transform var(--sidebar-transition) !important;\n
            }\n
            \n
            .sidebar-toggle.collapsed {\n
                transform: rotate(180deg);\n
            }\n
            \n
            /* Subtle border toggle button */\n
            .sidebar-toggle-btn {\n
                position: fixed;\n
                top: 0;\n
                left: var(--sidebar-width-md);\n
                width: 20px;\n
                height: 56px;\n
                background: transparent;\n
                border: none;\n
                display: flex;\n
                align-items: center;\n
                justify-content: center;\n
                cursor: pointer;\n
                z-index: 1000;\n
                transition: none !important;\n
                color: #6c757d;\n
            }\n
            \n
            .sidebar-toggle-btn:hover {\n
                color: #495057;\n
            }\n
            \n
            .sidebar-toggle-btn.animated {\n
                transition: left var(--sidebar-transition) !important;\n
            }\n
            \n
            .sidebar-toggle-btn.collapsed {\n
                left: var(--sidebar-width-collapsed);\n
                transform: rotate(180deg);\n
            }\n
            \n
            /* Responsive positioning for toggle button */\n
            @media (min-width: 992px) {\n
                .sidebar-toggle-btn {\n
                    left: var(--sidebar-width-lg);\n
                }\n
                \n
                .sidebar-toggle-btn.collapsed {\n
                    left: var(--sidebar-width-collapsed);\n
                }\n
            }\n
            \n
            /* Tooltip positioning for collapsed sidebar */\n
            .sidebar.collapsed .nav-link[data-bs-toggle="tooltip"] {\n
                position: relative;\n
            }\n
            \n
            /* Remove any gaps from Bootstrap row/col system */\n
            .row {\n
                margin: 0;\n
            }\n
            \n
            .row > * {\n
                padding: 0;\n
            }\n
            \n
            /* Ensure sidebar and main content are side by side */\n
            .sidebar-row {\n
                display: flex;\n
                flex-direction: row;\n
            }\n
            \n
            /* Preserve Bootstrap spacing for main content area */\n
            .main-content .row {\n
                margin-left: -0.75rem;\n
                margin-right: -0.75rem;\n
            }\n
            \n
            .main-content .row > * {\n
                padding-left: 0.75rem;\n
                padding-right: 0.75rem;\n
            }\n
            \n
            /* Preserve Bootstrap spacing for card layouts */\n
            .spans-list .row,\n
            .card-grid .row {\n
                margin-left: -0.75rem;\n
                margin-right: -0.75rem;\n
            }\n
            \n
            .spans-list .row > *,\n
            .card-grid .row > * {\n
                padding-left: 0.75rem;\n
                padding-right: 0.75rem;\n
            }\n
        [39;22m[39;1m</style>[39;22m[39;1m\n
        \n
        <!-- Page-specific scripts -->\n
                [39;22m[39;1m<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js">[39;22m[39;1m</script>[39;22m[39;1m\n
[39;22m[39;1m<script>[39;22m[39;1m\n
let yamlTextarea;\n
let activeDropdown = null; // Track the currently active dropdown\n
\n
$(document).ready(function() {\n
    const yamlTextarea = $('#yaml-content');\n
    const validateBtn = $('#validate-btn');\n
    const applyBtn = $('#apply-btn');\n
    const discardBtn = $('#discard-btn');\n
    const validationStatus = $('#validation-status');\n
    const validationResults = $('#validation-results');\n
    const charCount = $('#char-count');\n
    \n
    let lastValidationResult = null;\n
    let originalContent = yamlTextarea.val();\n
    let validationTimeout = null;\n
    \n
    // Update character count\n
    function updateCharCount() {\n
        const count = yamlTextarea.val().length;\n
        charCount.text(count.toLocaleString() + ' characters');\n
    }\n
    \n
    // Update validation status\n
    function updateValidationStatus(status, variant = 'secondary') {\n
        validationStatus\n
            .removeClass('bg-secondary bg-success bg-danger bg-warning')\n
            .addClass(`bg-${variant}`)\n
            .text(status);\n
        \n
        // Show the status badge when validation is complete\n
        if (status !== 'Modified') {\n
            $('#validation-status').show();\n
            validateBtn.hide();\n
        }\n
    }\n
    \n
    // Update apply button text based on state\n
    function updateApplyButtonText() {\n
        const isNewSpan = true;\n
        const hasChanges = yamlTextarea.val() !== originalContent;\n
        const isValid = lastValidationResult && lastValidationResult.success;\n
        \n
        if (isNewSpan) {\n
            // For new spans, the button should be enabled if YAML is valid\n
            if (!isValid) {\n
                applyBtn.html('[39;22m[39;1m<i class="bi bi-cloud-upload me-2">[39;22m[39;1m</i>[39;22m[39;1mValidate YAML First');\n
            } else {\n
                applyBtn.html('[39;22m[39;1m<i class="bi bi-cloud-upload me-2">[39;22m[39;1m</i>[39;22m[39;1mCreate Span from YAML');\n
            }\n
        } else {\n
            // For existing spans, check for changes\n
            if (!hasChanges) {\n
                applyBtn.html('[39;22m[39;1m<i class="bi bi-cloud-upload me-2">[39;22m[39;1m</i>[39;22m[39;1mNo Changes to Save');\n
            } else if (!isValid) {\n
                applyBtn.html('[39;22m[39;1m<i class="bi bi-cloud-upload me-2">[39;22m[39;1m</i>[39;22m[39;1mValidate YAML First');\n
            } else {\n
                applyBtn.html('[39;22m[39;1m<i class="bi bi-cloud-upload me-2">[39;22m[39;1m</i>[39;22m[39;1mSave Changes');\n
            }\n
        }\n
    }\n
    \n
    // Show validation results\n
    function showValidationResults(result) {\n
        let html = '';\n
        \n
        if (result.success) {\n
            html = `\n
                [39;22m[39;1m<div class="text-success">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-check-circle-fill me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                    [39;22m[39;1m<strong>[39;22m[39;1mValid YAML[39;22m[39;1m</strong>[39;22m[39;1m\n
                    [39;22m[39;1m<div class="mt-2 small">[39;22m[39;1m\n
                        Ready to create span from YAML.\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            `;\n
            yamlTextarea.removeClass('is-invalid').addClass('is-valid');\n
            \n
            // Only enable apply button if there are changes (for existing spans) or if it's a new span\n
            const isNewSpan = true;\n
            const hasChanges = yamlTextarea.val() !== originalContent;\n
            applyBtn.prop('disabled', !isNewSpan && !hasChanges);\n
            updateApplyButtonText();\n
            \n
            updateValidationStatus('Valid', 'success');\n
            \n
            // Show visual translation and impact analysis\n
            showVisualTranslation(result.visual || []);\n
            showImpactAnalysis(result.impacts || []);\n
            showChangesSummary(result.data || {});\n
        } else {\n
            html = `\n
                [39;22m[39;1m<div class="text-danger">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-exclamation-circle-fill me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                    [39;22m[39;1m<strong>[39;22m[39;1mValidation Errors[39;22m[39;1m</strong>[39;22m[39;1m\n
                    [39;22m[39;1m<ul class="error-list mt-2">[39;22m[39;1m\n
                        ${result.errors.map(error => `[39;22m[39;1m<li>[39;22m[39;1m${error}[39;22m[39;1m</li>[39;22m[39;1m`).join('')}\n
                    [39;22m[39;1m</ul>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            `;\n
            yamlTextarea.removeClass('is-valid').addClass('is-invalid');\n
            applyBtn.prop('disabled', true);\n
            updateApplyButtonText();\n
            updateValidationStatus('Invalid', 'danger');\n
            \n
            // Hide visual translation and impact analysis on error  \n
            $('#visual-translation').html(`\n
                [39;22m[39;1m<div class="text-muted">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-info-circle me-1">[39;22m[39;1m</i>[39;22m[39;1m\n
                    Visual translation will appear here when YAML is valid\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            `);\n
            $('#impact-results').hide();\n
            $('#changes-summary').hide();\n
        }\n
        \n
        validationResults.html(html);\n
        lastValidationResult = result;\n
        \n
        // Show debug info if present (admin only)\n
            }\n
    \n
    // Clear validation errors when user starts editing\n
    function clearValidationErrors() {\n
        // Only clear if we currently have validation errors\n
        if (lastValidationResult && !lastValidationResult.success) {\n
            validationResults.html(`\n
                [39;22m[39;1m<div class="text-muted">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-info-circle me-1">[39;22m[39;1m</i>[39;22m[39;1m\n
                    Make changes to see validation results\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            `);\n
            yamlTextarea.removeClass('is-invalid');\n
            updateValidationStatus('Modified', 'warning');\n
        }\n
    }\n
    \n
    // Show validation spinner\n
    function showValidationSpinner() {\n
        const html = `\n
            [39;22m[39;1m<div class="text-primary">[39;22m[39;1m\n
                [39;22m[39;1m<div class="d-flex align-items-center">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="spinner-border spinner-border-sm me-2" role="status">[39;22m[39;1m\n
                        [39;22m[39;1m<span class="visually-hidden">[39;22m[39;1mValidating...[39;22m[39;1m</span>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m<strong>[39;22m[39;1mValidating YAML...[39;22m[39;1m</strong>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<div class="mt-2 small text-muted">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-info-circle me-1">[39;22m[39;1m</i>[39;22m[39;1m\n
                    Please wait while we check your YAML content\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `;\n
        validationResults.html(html);\n
    }\n
\n
    // Show visual translation\n
    function showVisualTranslation(translations) {\n
        if (!translations || translations.length === 0) {\n
            $('#visual-translation').html(`\n
                [39;22m[39;1m<div class="text-muted">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-info-circle me-1">[39;22m[39;1m</i>[39;22m[39;1m\n
                    No visual translations available\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            `);\n
            return;\n
        }\n
\n
        let html = '';\n
        let currentSection = '';\n
\n
        translations.forEach((translation, index) => {\n
            if (translation.section !== currentSection) {\n
                if (currentSection !== '') {\n
                    html += '[39;22m[39;1m</div>[39;22m[39;1m';\n
                }\n
                currentSection = translation.section;\n
                \n
                let sectionTitle = '';\n
                let sectionIcon = '';\n
                switch (translation.section) {\n
                    case 'identity':\n
                        sectionTitle = 'Identity';\n
                        sectionIcon = 'bi-person-badge';\n
                        break;\n
                    case 'dates':\n
                        sectionTitle = 'Timeline';\n
                        sectionIcon = 'bi-calendar-event';\n
                        break;\n
                    case 'connections':\n
                        sectionTitle = 'Connections';\n
                        sectionIcon = 'bi-diagram-3';\n
                        break;\n
                    default:\n
                        sectionTitle = translation.section;\n
                        sectionIcon = 'bi-info-circle';\n
                }\n
                \n
                html += `\n
                    [39;22m[39;1m<div class="mb-3">[39;22m[39;1m\n
                        [39;22m[39;1m<h6 class="text-muted mb-2">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="${sectionIcon} me-1">[39;22m[39;1m</i>[39;22m[39;1m${sectionTitle}\n
                        [39;22m[39;1m</h6>[39;22m[39;1m\n
                `;\n
            }\n
            \n
            html += `[39;22m[39;1m<div class="mb-2">[39;22m[39;1m${translation.text}[39;22m[39;1m</div>[39;22m[39;1m`;\n
        });\n
\n
        if (currentSection !== '') {\n
            html += '[39;22m[39;1m</div>[39;22m[39;1m';\n
        }\n
\n
        $('#visual-translation').html(html);\n
        \n
        // Initialize interactive buttons after a short delay to ensure DOM is ready\n
        setTimeout(() => {\n
            initializeInteractiveButtons();\n
        }, 100);\n
    }\n
\n
    // Show impact analysis\n
    function showImpactAnalysis(impacts) {\n
        if (!impacts || impacts.length === 0) {\n
            $('#impact-results').hide();\n
            return;\n
        }\n
\n
        let html = '';\n
        impacts.forEach((impact, index) => {\n
            let badgeClass = '';\n
            let icon = '';\n
            \n
            switch (impact.type) {\n
                case 'info':\n
                    badgeClass = 'bg-info';\n
                    icon = 'bi-info-circle';\n
                    break;\n
                case 'warning':\n
                    badgeClass = 'bg-warning';\n
                    icon = 'bi-exclamation-triangle';\n
                    break;\n
                case 'danger':\n
                    badgeClass = 'bg-danger';\n
                    icon = 'bi-exclamation-octagon';\n
                    break;\n
                default:\n
                    badgeClass = 'bg-secondary';\n
                    icon = 'bi-info-circle';\n
            }\n
            \n
            html += `\n
                [39;22m[39;1m<div class="impact-item mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="d-flex align-items-start mb-2">[39;22m[39;1m\n
                        [39;22m[39;1m<span class="badge ${badgeClass} me-2 mt-1">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="${icon}">[39;22m[39;1m</i>[39;22m[39;1m\n
                        [39;22m[39;1m</span>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="small ${impact.indent ? 'ms-4' : ''}">[39;22m[39;1m${impact.message}[39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
            `;\n
            \n
            // Show action options for name conflicts\n
            if (impact.action_options) {\n
                html += `\n
                    [39;22m[39;1m<div class="ms-4 mt-2">[39;22m[39;1m\n
                        [39;22m[39;1m<div class="small text-muted mb-2">[39;22m[39;1mChoose how to handle this:[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="btn-group-vertical w-100" role="group">[39;22m[39;1m\n
                `;\n
                \n
                Object.entries(impact.action_options).forEach(([key, description]) => {\n
                    let btnClass = 'btn-outline-secondary';\n
                    let btnIcon = 'bi-circle';\n
                    \n
                    if (key === 'update_span') {\n
                        btnClass = 'btn-outline-primary';\n
                        btnIcon = 'bi-arrow-repeat';\n
                    } else if (key === 'keep_reference') {\n
                        btnClass = 'btn-outline-success';\n
                        btnIcon = 'bi-shield-check';\n
                    } else if (key === 'ignore') {\n
                        btnClass = 'btn-outline-warning';\n
                        btnIcon = 'bi-exclamation-triangle';\n
                    }\n
                    \n
                    html += `\n
                        [39;22m[39;1m<button type="button" class="btn ${btnClass} btn-sm text-start name-conflict-action" \n
                                data-impact-index="${index}" \n
                                data-action="${key}"\n
                                data-span-id="${impact.span_id || ''}"\n
                                data-current-name="${impact.current_name || ''}"\n
                                data-yaml-name="${impact.yaml_name || ''}">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="${btnIcon} me-2">[39;22m[39;1m</i>[39;22m[39;1m${description}\n
                        [39;22m[39;1m</button>[39;22m[39;1m\n
                    `;\n
                });\n
                \n
                html += `\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                `;\n
            }\n
            \n
            html += `[39;22m[39;1m</div>[39;22m[39;1m`;\n
        });\n
\n
        $('#impact-results').html(html).show();\n
        \n
        // Add click handlers for action buttons\n
        $('.name-conflict-action').on('click', function() {\n
            const action = $(this).data('action');\n
            const spanId = $(this).data('span-id');\n
            const currentName = $(this).data('current-name');\n
            const yamlName = $(this).data('yaml-name');\n
            const impactIndex = $(this).data('impact-index');\n
            \n
            handleNameConflictAction(action, spanId, currentName, yamlName, impactIndex);\n
                 });\n
    }\n
    \n
    // Handle name conflict action selection\n
    function handleNameConflictAction(action, spanId, currentName, yamlName, impactIndex) {\n
        console.log('Name conflict action:', { action, spanId, currentName, yamlName, impactIndex });\n
        \n
        // Visual feedback - highlight selected action\n
        $(`.name-conflict-action[data-impact-index="${impactIndex}"]`).removeClass('btn-outline-primary btn-outline-success btn-outline-warning active');\n
        $(`.name-conflict-action[data-impact-index="${impactIndex}"][data-action="${action}"]`).addClass('active');\n
        \n
        switch (action) {\n
            case 'update_span':\n
                if (confirm(`This will update "${currentName}" to "${yamlName}" everywhere it appears. Continue?`)) {\n
                    updateSpanName(spanId, yamlName, impactIndex);\n
                } else {\n
                    // User cancelled - remove the active state from the button\n
                    $(`.name-conflict-action[data-impact-index="${impactIndex}"][data-action="${action}"]`).removeClass('active');\n
                    return;\n
                }\n
                break;\n
                \n
            case 'keep_reference':\n
                updateYamlWithDatabaseName(spanId, currentName, impactIndex);\n
                break;\n
                \n
            case 'ignore':\n
                // Just mark as resolved, no action needed\n
                markConflictResolved(impactIndex, 'ignored');\n
                break;\n
        }\n
    }\n
    \n
    // Update span name in database\n
    function updateSpanName(spanId, newName, impactIndex) {\n
        console.log('Updating span name:', { spanId, newName, impactIndex });\n
        \n
        $.ajax({\n
            url: `/spans/${spanId}`,\n
            method: 'POST',\n
            headers: {\n
                'Accept': 'application/json',\n
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')\n
            },\n
            data: {\n
                name: newName,\n
                state: 'placeholder', // Required field for validation\n
                _method: 'PUT'\n
            },\n
            success: function(result) {\n
                console.log('Span name updated successfully:', result);\n
                markConflictResolved(impactIndex, 'span_updated');\n
                // Re-validate to refresh impact analysis\n
                validateYaml();\n
            },\n
            error: function(xhr) {\n
                console.error('Failed to update span name:', xhr);\n
                let errorMessage = 'Unknown error';\n
                \n
                if (xhr.status === 403) {\n
                    errorMessage = 'You do not have permission to update this span';\n
                } else if (xhr.responseJSON?.message) {\n
                    errorMessage = xhr.responseJSON.message;\n
                } else if (xhr.responseJSON?.errors) {\n
                    // Handle validation errors\n
                    const errors = Object.values(xhr.responseJSON.errors).flat();\n
                    errorMessage = errors.join(', ');\n
                } else if (xhr.responseText) {\n
                    errorMessage = xhr.responseText;\n
                }\n
                \n
                alert('Failed to update span name: ' + errorMessage);\n
                \n
                // Remove the active state from the button since the update failed\n
                $(`.name-conflict-action[data-impact-index="${impactIndex}"]`).removeClass('active');\n
            }\n
        });\n
    }\n
    \n
    // Update YAML content to match database name\n
    function updateYamlWithDatabaseName(spanId, databaseName, impactIndex) {\n
        const currentYaml = yamlTextarea.val();\n
        // This is a simple approach - in production you might want more sophisticated YAML parsing\n
        const updatedYaml = currentYaml.replace(\n
            new RegExp(`id: ${spanId}[\\s\\S]*?name: '[^']*'`, 'g'),\n
            (match) => match.replace(/name: '[^']*'/, `name: '${databaseName}'`)\n
        );\n
        \n
        yamlTextarea.val(updatedYaml);\n
        markConflictResolved(impactIndex, 'yaml_updated');\n
        // Re-validate with updated YAML\n
        validateYaml();\n
    }\n
    \n
    // Mark conflict as resolved\n
    function markConflictResolved(impactIndex, resolution) {\n
        const impactItem = $(`.impact-item:eq(${impactIndex})`);\n
        let message = '';\n
        let badgeClass = '';\n
        \n
        switch (resolution) {\n
            case 'span_updated':\n
                message = 'Span name updated in database';\n
                badgeClass = 'bg-success';\n
                break;\n
            case 'yaml_updated':\n
                message = 'YAML updated to match database';\n
                badgeClass = 'bg-success';\n
                break;\n
            case 'ignored':\n
                message = 'Conflict ignored - will apply as-is';\n
                badgeClass = 'bg-warning';\n
                break;\n
        }\n
        \n
        impactItem.find('.badge').removeClass('bg-warning bg-danger').addClass(badgeClass);\n
        impactItem.find('.small').append(`[39;22m[39;1m<br>[39;22m[39;1m<em class="text-success">[39;22m[39;1m${message}[39;22m[39;1m</em>[39;22m[39;1m`);\n
        impactItem.find('.btn-group-vertical').hide();\n
    }\n
    \n
    // Validate YAML content\n
    function validateYaml() {\n
        const content = yamlTextarea.val().trim();\n
        \n
        if (!content) {\n
            showValidationResults({\n
                success: false,\n
                errors: ['YAML content is required']\n
            });\n
            return;\n
        }\n
        \n
        updateValidationStatus('Validating...', 'warning');\n
        showValidationSpinner();\n
        \n
        $.ajax({\n
            url: 'http://localhost:8000/spans/editor/new/validate',\n
            method: 'POST',\n
            data: {\n
                yaml_content: content,\n
                _token: $('meta[name="csrf-token"]').attr('content')\n
            },\n
            success: function(result) {\n
                showValidationResults(result);\n
                // Reset change detection after validation completes\n
                resetChangeDetection();\n
            },\n
            error: function(xhr) {\n
                let errorMsg = 'Validation failed';\n
                let debugInfo = null;\n
                \n
                if (xhr.responseJSON) {\n
                    if (xhr.responseJSON.message) {\n
                        errorMsg = xhr.responseJSON.message;\n
                    }\n
                    if (xhr.responseJSON.errors) {\n
                        errorMsg = xhr.responseJSON.errors.join(', ');\n
                    }\n
                    debugInfo = xhr.responseJSON.debug || null;\n
                }\n
                \n
                showValidationResults({\n
                    success: false,\n
                    errors: [errorMsg],\n
                    debug: debugInfo\n
                });\n
                // Reset change detection after validation completes (even on error)\n
                resetChangeDetection();\n
            }\n
        });\n
    }\n
    \n
    // Apply YAML changes\n
    function applyChanges() {\n
        if (!lastValidationResult || !lastValidationResult.success) {\n
            alert('Please validate the YAML first');\n
            return;\n
        }\n
        \n
        const content = yamlTextarea.val();\n
        \n
        applyBtn.prop('disabled', true);\n
        const originalText = applyBtn.html();\n
        applyBtn.html('[39;22m[39;1m<span class="spinner-border spinner-border-sm me-1">[39;22m[39;1m</span>[39;22m[39;1mApplying...');\n
        \n
        $.ajax({\n
            url: 'http://localhost:8000/spans/editor/new/apply',\n
            method: 'POST',\n
            data: {\n
                yaml_content: content,\n
                _token: $('meta[name="csrf-token"]').attr('content')\n
            },\n
            success: function(result) {\n
                if (result.success) {\n
                    // Show success message\n
                    const successTitle = 'Span Created Successfully';\n
                    validationResults.html(`\n
                        [39;22m[39;1m<div class="text-success">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-check-circle-fill me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                            [39;22m[39;1m<strong>[39;22m[39;1m${successTitle}[39;22m[39;1m</strong>[39;22m[39;1m\n
                            [39;22m[39;1m<div class="mt-2 small">[39;22m[39;1m\n
                                ${result.message}\n
                            [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    `);\n
                    \n
                    updateValidationStatus('Applied', 'success');\n
                    \n
                    // Update original content to prevent unsaved changes warning\n
                    originalContent = content;\n
                    \n
                    // Redirect after a delay\n
                    if (result.redirect) {\n
                        setTimeout(() => {\n
                            window.location.href = result.redirect;\n
                        }, 1500);\n
                    }\n
                } else {\n
                    throw new Error(result.message || 'Failed to apply changes');\n
                }\n
            },\n
            error: function(xhr) {\n
                let errorMsg = 'Failed to apply changes';\n
                let debugInfo = null;\n
                \n
                if (xhr.responseJSON) {\n
                    if (xhr.responseJSON.message) {\n
                        errorMsg = xhr.responseJSON.message;\n
                    }\n
                    if (xhr.responseJSON.errors) {\n
                        errorMsg = xhr.responseJSON.errors.join(', ');\n
                    }\n
                    debugInfo = xhr.responseJSON.debug || null;\n
                }\n
                \n
                validationResults.html(`\n
                    [39;22m[39;1m<div class="text-danger">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-exclamation-circle-fill me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                        [39;22m[39;1m<strong>[39;22m[39;1mError Applying Changes[39;22m[39;1m</strong>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="mt-2 small">[39;22m[39;1m${errorMsg}[39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                `);\n
                \n
                updateValidationStatus('Error', 'danger');\n
                \n
                // Show debug info if present (admin only)\n
                            },\n
            complete: function() {\n
                applyBtn.html(originalText);\n
                // After successful application, disable the button since there are no changes\n
                applyBtn.prop('disabled', true);\n
                updateApplyButtonText();\n
            }\n
        });\n
    }\n
\n
    // Merge AI data with existing span\n
    function mergeWithExistingSpan() {\n
        const content = yamlTextarea.val();\n
        \n
        if (!content.trim()) {\n
            alert('Please enter YAML content first');\n
            return;\n
        }\n
        \n
        const mergeBtn = $('#merge-btn');\n
        mergeBtn.prop('disabled', true);\n
        const originalText = mergeBtn.html();\n
        mergeBtn.html('[39;22m[39;1m<span class="spinner-border spinner-border-sm me-1">[39;22m[39;1m</span>[39;22m[39;1mMerging...');\n
        \n
        $.ajax({\n
            url: 'http://localhost:8000/spans/9f59d597-1604-4b73-bd70-5048bd3742ce/editor/merge',\n
            method: 'POST',\n
            data: {\n
                yaml_content: content,\n
                _token: $('meta[name="csrf-token"]').attr('content')\n
            },\n
            success: function(result) {\n
                if (result.success) {\n
                    // Show success message\n
                    validationResults.html(`\n
                        [39;22m[39;1m<div class="text-success">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-check-circle-fill me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                            [39;22m[39;1m<strong>[39;22m[39;1mMerge Completed Successfully[39;22m[39;1m</strong>[39;22m[39;1m\n
                            [39;22m[39;1m<div class="mt-2 small">[39;22m[39;1m\n
                                ${result.message}\n
                            [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    `);\n
                    \n
                    updateValidationStatus('Merged', 'success');\n
                    \n
                    // Redirect after a delay\n
                    if (result.redirect) {\n
                        setTimeout(() => {\n
                            window.location.href = result.redirect;\n
                        }, 1500);\n
                    }\n
                } else {\n
                    throw new Error(result.message || 'Failed to merge data');\n
                }\n
            },\n
            error: function(xhr) {\n
                let errorMsg = 'Failed to merge data';\n
                let debugInfo = null;\n
                \n
                if (xhr.responseJSON) {\n
                    if (xhr.responseJSON.message) {\n
                        errorMsg = xhr.responseJSON.message;\n
                    }\n
                    if (xhr.responseJSON.errors) {\n
                        errorMsg = xhr.responseJSON.errors.join(', ');\n
                    }\n
                    debugInfo = xhr.responseJSON.debug || null;\n
                }\n
                \n
                validationResults.html(`\n
                    [39;22m[39;1m<div class="text-danger">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-exclamation-circle-fill me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                        [39;22m[39;1m<strong>[39;22m[39;1mError Merging Data[39;22m[39;1m</strong>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="mt-2 small">[39;22m[39;1m${errorMsg}[39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                `);\n
                \n
                updateValidationStatus('Error', 'danger');\n
                \n
                // Show debug info if present (admin only)\n
                            },\n
            complete: function() {\n
                mergeBtn.html(originalText);\n
                mergeBtn.prop('disabled', false);\n
            }\n
        });\n
    }\n
\n
    // Create new span despite existing span\n
    function createNewSpanAnyway() {\n
        // Hide the merge detection section\n
        $('.card.border-warning').hide();\n
        \n
        // Enable the normal apply button for creating a new span\n
        applyBtn.prop('disabled', false);\n
        updateApplyButtonText();\n
        \n
        // Show a message that we're now in "create new" mode\n
        validationResults.html(`\n
            [39;22m[39;1m<div class="text-info">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-info-circle me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                [39;22m[39;1m<strong>[39;22m[39;1mCreating New Span[39;22m[39;1m</strong>[39;22m[39;1m\n
                [39;22m[39;1m<div class="mt-2 small">[39;22m[39;1m\n
                    You've chosen to create a new span. Validate and apply the YAML to create it.\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `);\n
        \n
        updateValidationStatus('Ready to Create', 'info');\n
    }\n
    \n
    // Function to check for changes and update UI accordingly\n
    function checkForChanges() {\n
        const hasChanges = yamlTextarea.val() !== originalContent;\n
        const isNewSpan = true;\n
        const isValid = lastValidationResult && lastValidationResult.success;\n
        \n
        if (hasChanges) {\n
            yamlTextarea.removeClass('is-valid is-invalid');\n
            updateValidationStatus('Modified', 'warning');\n
            \n
            // Enable apply button if YAML is valid (for new spans) or if there are changes (for existing spans)\n
            applyBtn.prop('disabled', !isValid || (!isNewSpan && !hasChanges));\n
            updateApplyButtonText();\n
            \n
            // Show validate button and hide status badge\n
            validateBtn.show();\n
            $('#validation-status').hide();\n
            \n
            // Show discard button for existing spans\n
            if (!isNewSpan) {\n
                discardBtn.show();\n
            }\n
            \n
            // Hide analysis sections while editing\n
            $('#changes-summary').hide();\n
            $('#impact-results').hide();\n
        } else {\n
            // No changes - disable apply button and reset validation status\n
            applyBtn.prop('disabled', true);\n
            updateApplyButtonText();\n
            updateValidationStatus('Ready', 'secondary');\n
            \n
            // Hide validate button and show status badge\n
            validateBtn.hide();\n
            $('#validation-status').show();\n
            \n
            // Hide discard button\n
            discardBtn.hide();\n
        }\n
    }\n
    \n
    // Function to reset change detection after validation\n
    function resetChangeDetection() {\n
        // Clear any pending validation timeout\n
        if (validationTimeout) {\n
            clearTimeout(validationTimeout);\n
            validationTimeout = null;\n
        }\n
        \n
        // Update the UI to reflect that validation is complete\n
        const isNewSpan = true;\n
        \n
        if (!isNewSpan) {\n
            // For existing spans, show the validation status and hide the validate button\n
            $('#validation-status').show();\n
            validateBtn.hide();\n
        }\n
        \n
        // Update apply button state based on validation result and changes\n
        if (lastValidationResult && lastValidationResult.success) {\n
            const hasChanges = yamlTextarea.val() !== originalContent;\n
            // For new spans, enable apply button since validation succeeded\n
            // For existing spans, enable apply button only if there are changes\n
            applyBtn.prop('disabled', !isNewSpan && !hasChanges);\n
            updateApplyButtonText();\n
        }\n
    }\n
    \n
    // Function to discard changes and reset to original content\n
    function discardChanges() {\n
        if (confirm('Are you sure you want to discard all changes? This will reset the editor to the database saved version.')) {\n
            // Clear any pending validation timeout\n
            if (validationTimeout) {\n
                clearTimeout(validationTimeout);\n
                validationTimeout = null;\n
            }\n
            \n
            yamlTextarea.val(originalContent);\n
            yamlTextarea.removeClass('is-valid is-invalid');\n
            updateValidationStatus('Ready', 'secondary');\n
            applyBtn.prop('disabled', true);\n
            updateApplyButtonText();\n
            discardBtn.hide();\n
            \n
            // Show status badge and hide validate button\n
            $('#validation-status').show();\n
            validateBtn.hide();\n
            \n
            // Clear validation results\n
            validationResults.html(`\n
                [39;22m[39;1m<div class="text-muted">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-info-circle me-1">[39;22m[39;1m</i>[39;22m[39;1m\n
                    Make changes to see validation results\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            `);\n
            \n
            // Reset visual translation\n
            $('#visual-translation').html(`\n
                [39;22m[39;1m<div class="text-muted">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-info-circle me-1">[39;22m[39;1m</i>[39;22m[39;1m\n
                    Visual translation will appear here when YAML is valid\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            `);\n
            \n
            // Hide analysis sections\n
            $('#changes-summary').hide();\n
            $('#impact-results').hide();\n
            \n
            updateCharCount();\n
        }\n
    }\n
    \n
    // Auto-validate on content change (debounced)\n
    yamlTextarea.on('input', function() {\n
        updateCharCount();\n
        \n
        // Clear validation errors when user starts editing\n
        clearValidationErrors();\n
        \n
        checkForChanges();\n
        \n
        // Clear existing timeout\n
        if (validationTimeout) {\n
            clearTimeout(validationTimeout);\n
        }\n
        \n
        // Set new timeout for auto-validation after 2 seconds of inactivity\n
        validationTimeout = setTimeout(function() {\n
            const hasChanges = yamlTextarea.val() !== originalContent;\n
            if (hasChanges) {\n
                validateYaml();\n
            }\n
        }, 2000);\n
    });\n
    \n
    // Validate when user focuses away from the editor\n
    yamlTextarea.on('blur', function() {\n
        // Clear the auto-validation timeout since user is actively editing\n
        if (validationTimeout) {\n
            clearTimeout(validationTimeout);\n
            validationTimeout = null;\n
        }\n
        \n
        const hasChanges = yamlTextarea.val() !== originalContent;\n
        if (hasChanges) {\n
            validateYaml();\n
        }\n
    });\n
    \n
    // Manual validation\n
    validateBtn.on('click', validateYaml);\n
    \n
    // Apply changes\n
    applyBtn.on('click', applyChanges);\n
    \n
    // Discard changes\n
    discardBtn.on('click', discardChanges);\n
    \n
    // Merge functionality\n
    $('#merge-btn').on('click', mergeWithExistingSpan);\n
    $('#create-new-btn').on('click', createNewSpanAnyway);\n
    \n
    // Warn about unsaved changes\n
    $(window).on('beforeunload', function() {\n
        if (yamlTextarea.val() !== originalContent) {\n
            return 'You have unsaved changes. Are you sure you want to leave?';\n
        }\n
    });\n
    \n
    // Keyboard shortcuts\n
    yamlTextarea.on('keydown', function(e) {\n
        // Ctrl/Cmd + S to validate\n
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {\n
            e.preventDefault();\n
            validateYaml();\n
        }\n
        \n
        // Ctrl/Cmd + Enter to apply (if valid)\n
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {\n
            e.preventDefault();\n
            if (!applyBtn.prop('disabled')) {\n
                applyChanges();\n
            }\n
        }\n
    });\n
    \n
    // Initial setup\n
    updateCharCount();\n
    \n
    // Ensure apply button starts disabled\n
    applyBtn.prop('disabled', true);\n
    updateApplyButtonText();\n
    \n
    // Auto-validate on load if content exists\n
    if (yamlTextarea.val().trim()) {\n
        // Initialize visual translation for existing content\n
        validateYaml();\n
    }\n
    \n
    // Connection search functionality\n
    $('#connection-name-field').on('input', function() {\n
        const searchTerm = $(this).val().trim();\n
        \n
        // Clear existing timeout\n
        if (searchTimeout) {\n
            clearTimeout(searchTimeout);\n
        }\n
        \n
        if (searchTerm.length < 2) {\n
            $('#connection-search-results').hide();\n
            $('#connection-create-new').hide();\n
            $('#create-new-span-btn').hide();\n
            return;\n
        }\n
        \n
        // Debounce search\n
        searchTimeout = setTimeout(() => {\n
            searchForSpans(searchTerm);\n
        }, 300);\n
    });\n
    \n
    // YAML Tools Functions - Enhanced Connection Flow\n
    let currentConnectionType = null;\n
    let currentAllowedTypes = null;\n
    let searchTimeout = null;\n
    \n
    window.startConnectionFlow = function() {\n
        const selectElement = $('#connection-type-select');\n
        const connectionType = selectElement.val();\n
        \n
        if (!connectionType) {\n
            alert('Please select a connection type');\n
            return;\n
        }\n
        \n
        // Get allowed types from the selected option\n
        const selectedOption = selectElement.find('option:selected');\n
        const allowedTypesJson = selectedOption.data('allowed-types');\n
        \n
        console.log('startConnectionFlow - connectionType:', connectionType);\n
        console.log('startConnectionFlow - allowedTypesJson:', allowedTypesJson);\n
        console.log('startConnectionFlow - allowedTypesJson type:', typeof allowedTypesJson);\n
        \n
        // Store current connection details\n
        currentConnectionType = connectionType;\n
        \n
        // Handle the case where allowedTypesJson might be a string that needs parsing\n
        if (typeof allowedTypesJson === 'string') {\n
            try {\n
                currentAllowedTypes = JSON.parse(allowedTypesJson);\n
            } catch (e) {\n
                console.error('Failed to parse allowed types JSON:', e);\n
                currentAllowedTypes = [];\n
            }\n
        } else if (Array.isArray(allowedTypesJson)) {\n
            currentAllowedTypes = allowedTypesJson;\n
        } else {\n
            console.error('allowedTypesJson is neither string nor array:', allowedTypesJson);\n
            currentAllowedTypes = [];\n
        }\n
        \n
        console.log('startConnectionFlow - final currentAllowedTypes:', currentAllowedTypes);\n
        \n
        // Update UI\n
        const connectionTitle = $('#connection-title');\n
        const typeDisplay = connectionType.replace('_incoming', ' (incoming)');\n
        connectionTitle.text(`Add ${typeDisplay.charAt(0).toUpperCase() + typeDisplay.slice(1)} Connection`);\n
        \n
        // Show the connection input form\n
        $('#connection-name-input').slideDown();\n
        $('#connection-name-field').focus();\n
        \n
        // Clear previous state\n
        $('#connection-name-field').val('');\n
        $('#connection-search-results').hide();\n
        $('#connection-create-new').hide();\n
        $('#create-new-span-btn').hide();\n
        $('#search-results-list').empty();\n
    };\n
    \n
    window.cancelConnectionFlow = function() {\n
        $('#connection-name-input').slideUp();\n
        $('#connection-type-select').val('');\n
        currentConnectionType = null;\n
        currentAllowedTypes = null;\n
    };\n
    \n
    window.createNewSpanConnection = function() {\n
        const name = $('#connection-name-field').val().trim();\n
        if (!name) {\n
            alert('Please enter a name');\n
            return;\n
        }\n
        \n
        // Determine the span type - use selected type if available, otherwise default\n
        let spanType;\n
        const typeSelect = $('#new-span-type-select');\n
        if (typeSelect.is(':visible') && typeSelect.val()) {\n
            spanType = typeSelect.val();\n
        } else {\n
            spanType = currentAllowedTypes && currentAllowedTypes.length > 0 ? currentAllowedTypes[0] : 'person';\n
        }\n
        \n
        // Create the connection YAML with placeholder for new span\n
        addConnectionWithNewSpan(name, spanType);\n
    };\n
    \n
    window.addConnectionWithExistingSpan = function(spanId, spanName, spanType) {\n
        // Create the connection YAML with existing span details\n
        addConnectionWithSpan(spanId, spanName, spanType);\n
    };\n
    \n
    function addConnectionWithSpan(spanId, spanName, spanType) {\n
        // For connection spans, add connection_type as a root field instead of in metadata\n
        const connectionTypeField = spanType === 'connection' ? \n
            `    connection_type: '${currentConnectionType}'` : \n
            '';\n
        \n
        const connectionTemplate = `\n
${currentConnectionType}:\n
  - name: '${spanName}'\n
    id: '${spanId}'\n
    type: ${spanType}${connectionTypeField ? '\n' + connectionTypeField : ''}\n
    metadata: {}`;\n
        \n
        insertYamlSection('connections', connectionTemplate);\n
        cancelConnectionFlow();\n
    }\n
    \n
    function addConnectionWithNewSpan(spanName, spanType) {\n
        // Generate a new UUID for the span\n
        const newUuid = generateUUID();\n
        \n
        // For connection spans, add connection_type as a root field instead of in metadata\n
        const connectionTypeField = spanType === 'connection' ? \n
            `    connection_type: '${currentConnectionType}'` : \n
            '';\n
        \n
        const connectionTemplate = `\n
${currentConnectionType}:\n
  - name: '${spanName}'\n
    id: '${newUuid}'\n
    type: ${spanType}${connectionTypeField ? '\n' + connectionTypeField : ''}\n
    metadata: {}`;\n
        \n
        insertYamlSection('connections', connectionTemplate);\n
        cancelConnectionFlow();\n
    }\n
    \n
    // Simple UUID generator (v4)\n
    function generateUUID() {\n
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n
            const r = Math.random() * 16 | 0;\n
            const v = c == 'x' ? r : (r & 0x3 | 0x8);\n
            return v.toString(16);\n
        });\n
    }\n
    \n
    // Legacy function for backwards compatibility\n
    window.addConnection = function() {\n
        startConnectionFlow();\n
    };\n
    \n
    // Make the create form function globally accessible\n
    window.showCreateNewForm = showCreateNewForm;\n
    \n
    // Search for existing spans\n
    function searchForSpans(searchTerm) {\n
        console.log('searchForSpans called with:', searchTerm);\n
        console.log('currentAllowedTypes:', currentAllowedTypes);\n
        \n
        if (!currentAllowedTypes || currentAllowedTypes.length === 0) {\n
            console.log('No allowed types, exiting search');\n
            return;\n
        }\n
        \n
        // Build search parameters\n
        const searchParams = new URLSearchParams({\n
            q: searchTerm,\n
            types: currentAllowedTypes.join(','),\n
            limit: 5\n
        });\n
        \n
        console.log('Search URL:', `/api/spans/search?${searchParams.toString()}`);\n
        \n
        // Make AJAX request to search for spans\n
        fetch(`/spans/search?${searchParams.toString()}`, {\n
            headers: {\n
                'Accept': 'application/json',\n
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')\n
            }\n
        })\n
        .then(response => {\n
            console.log('Search response status:', response.status);\n
            return response.json();\n
        })\n
        .then(data => {\n
            console.log('Search response data:', data);\n
            displaySearchResults(data.spans || [], searchTerm);\n
        })\n
        .catch(error => {\n
            console.error('Search error:', error);\n
            displaySearchResults([], searchTerm);\n
        });\n
    }\n
    \n
    function displaySearchResults(spans, searchTerm) {\n
        const resultsContainer = $('#search-results-list');\n
        const searchResults = $('#connection-search-results');\n
        const createNew = $('#connection-create-new');\n
        const createNewBtn = $('#create-new-span-btn');\n
        const typeSelection = $('#new-span-type-selection');\n
        const typeSelect = $('#new-span-type-select');\n
        \n
        resultsContainer.empty();\n
        \n
        if (spans.length > 0) {\n
            // Show existing spans\n
            searchResults.show();\n
            createNew.hide();\n
            createNewBtn.hide();\n
            typeSelection.hide();\n
            \n
            spans.forEach(span => {\n
                const resultItem = $(`\n
                    [39;22m[39;1m<button type="button" class="list-group-item list-group-item-action" \n
                            onclick="addConnectionWithExistingSpan('${span.id}', '${span.name}', '${span.type_id}')">[39;22m[39;1m\n
                        [39;22m[39;1m<div class="d-flex justify-content-between align-items-center">[39;22m[39;1m\n
                            [39;22m[39;1m<div>[39;22m[39;1m\n
                                [39;22m[39;1m<strong>[39;22m[39;1m${span.name}[39;22m[39;1m</strong>[39;22m[39;1m\n
                                [39;22m[39;1m<small class="text-muted d-block">[39;22m[39;1m${span.type_id} • ${span.state}[39;22m[39;1m</small>[39;22m[39;1m\n
                            [39;22m[39;1m</div>[39;22m[39;1m\n
                            [39;22m[39;1m<span class="badge bg-primary">[39;22m[39;1mExisting[39;22m[39;1m</span>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</button>[39;22m[39;1m\n
                `);\n
                resultsContainer.append(resultItem);\n
            });\n
            \n
            // Also show create new option\n
            const defaultType = currentAllowedTypes && currentAllowedTypes.length > 0 ? currentAllowedTypes[0] : 'person';\n
            const createNewItem = $(`\n
                [39;22m[39;1m<button type="button" class="list-group-item list-group-item-action list-group-item-light" \n
                        onclick="showCreateNewForm('${searchTerm}')">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="d-flex justify-content-between align-items-center">[39;22m[39;1m\n
                        [39;22m[39;1m<div>[39;22m[39;1m\n
                            [39;22m[39;1m<strong>[39;22m[39;1mCreate: "${searchTerm}"[39;22m[39;1m</strong>[39;22m[39;1m\n
                            [39;22m[39;1m<small class="text-muted d-block">[39;22m[39;1mNew ${defaultType} span[39;22m[39;1m</small>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m<span class="badge bg-success">[39;22m[39;1mNew[39;22m[39;1m</span>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</button>[39;22m[39;1m\n
            `);\n
            resultsContainer.append(createNewItem);\n
        } else {\n
            // No existing spans found, show create new option\n
            searchResults.hide();\n
            showCreateNewForm(searchTerm);\n
        }\n
    }\n
    \n
    function showCreateNewForm(searchTerm) {\n
        const createNew = $('#connection-create-new');\n
        const createNewBtn = $('#create-new-span-btn');\n
        const typeSelection = $('#new-span-type-selection');\n
        const typeSelect = $('#new-span-type-select');\n
        \n
        createNew.show();\n
        createNewBtn.show();\n
        createNewBtn.html(`[39;22m[39;1m<i class="bi bi-plus-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mCreate "${searchTerm}"`);\n
        \n
        // Set up type selection if multiple types are allowed\n
        if (currentAllowedTypes && currentAllowedTypes.length > 1) {\n
            typeSelection.show();\n
            typeSelect.empty();\n
            \n
            currentAllowedTypes.forEach(type => {\n
                typeSelect.append(`[39;22m[39;1m<option value="${type}">[39;22m[39;1m${type.charAt(0).toUpperCase() + type.slice(1)}[39;22m[39;1m</option>[39;22m[39;1m`);\n
            });\n
        } else {\n
            typeSelection.hide();\n
        }\n
    }\n
    \n
    window.addMetadataField = function() {\n
        const fieldName = $('#metadata-key-input').val().trim();\n
        if (!fieldName) {\n
            alert('Please enter a field name');\n
            return;\n
        }\n
        \n
        const metadataTemplate = `\n
${fieldName}: ''`;\n
        \n
        insertYamlSection('metadata', metadataTemplate);\n
        $('#metadata-key-input').val('');\n
    };\n
    \n
    window.addDateFields = function() {\n
        const dateTemplate = `\n
start: ''\n
end: ''`;\n
        \n
        insertYamlAtLevel('root', dateTemplate);\n
    };\n
    \n
    window.addCustomFields = function() {\n
        const customTemplate = `\n
metadata:\n
  custom_field: 'value'`;\n
        \n
        insertYamlAtLevel('root', customTemplate);\n
    };\n
    \n
    // Helper function to insert YAML sections\n
    function insertYamlSection(sectionName, content) {\n
        const currentYaml = yamlTextarea.val();\n
        const lines = currentYaml.split('\n');\n
        \n
        // Find the section or create it\n
        let sectionStartIndex = -1;\n
        let sectionEndIndex = -1;\n
        let indentLevel = 0;\n
        \n
        for (let i = 0; i < lines.length; i++) {\n
            const line = lines[i];\n
            if (line.trim().startsWith(sectionName + ':')) {\n
                sectionStartIndex = i;\n
                indentLevel = line.length - line.trimStart().length;\n
                \n
                // Find the end of this section\n
                for (let j = i + 1; j < lines.length; j++) {\n
                    const nextLine = lines[j];\n
                    if (nextLine.trim() === '' || nextLine.startsWith(' ')) {\n
                        continue; // Still in the section\n
                    } else if (nextLine.length - nextLine.trimStart().length <= indentLevel) {\n
                        sectionEndIndex = j - 1;\n
                        break;\n
                    }\n
                }\n
                \n
                if (sectionEndIndex === -1) {\n
                    sectionEndIndex = lines.length - 1;\n
                }\n
                break;\n
            }\n
        }\n
        \n
        if (sectionStartIndex === -1) {\n
            // Section doesn't exist, add it at the end\n
            const newSection = `${sectionName}:${content}`;\n
            const updatedYaml = currentYaml + (currentYaml.endsWith('\n') ? '' : '\n') + newSection + '\n';\n
            yamlTextarea.val(updatedYaml);\n
        } else {\n
            // Section exists, add to it\n
            const beforeSection = lines.slice(0, sectionEndIndex + 1);\n
            const afterSection = lines.slice(sectionEndIndex + 1);\n
            const indentedContent = content.split('\n').map(line => \n
                line.trim() ? '  ' + line : line\n
            ).join('\n');\n
            \n
            const updatedLines = [...beforeSection, indentedContent, ...afterSection];\n
            yamlTextarea.val(updatedLines.join('\n'));\n
        }\n
        \n
        // Trigger validation\n
        yamlTextarea.trigger('input');\n
        \n
        // Focus and scroll to the added content\n
        yamlTextarea.focus();\n
        const textArea = yamlTextarea[0];\n
        textArea.scrollTop = textArea.scrollHeight;\n
    }\n
    \n
    // Helper function to insert YAML at root level\n
    function insertYamlAtLevel(level, content) {\n
        const currentYaml = yamlTextarea.val();\n
        const lines = currentYaml.split('\n');\n
        \n
        // Find a good place to insert (after existing root-level fields)\n
        let insertIndex = -1;\n
        \n
        for (let i = lines.length - 1; i >= 0; i--) {\n
            const line = lines[i];\n
            if (line.trim() && !line.startsWith(' ')) {\n
                insertIndex = i + 1;\n
                break;\n
            }\n
        }\n
        \n
        if (insertIndex === -1) {\n
            insertIndex = lines.length;\n
        }\n
        \n
        const beforeInsert = lines.slice(0, insertIndex);\n
        const afterInsert = lines.slice(insertIndex);\n
        \n
        const updatedLines = [...beforeInsert, ...content.split('\n'), ...afterInsert];\n
        yamlTextarea.val(updatedLines.join('\n'));\n
        \n
        // Trigger validation\n
        yamlTextarea.trigger('input');\n
        \n
        // Focus and scroll to the added content\n
        yamlTextarea.focus();\n
        const textArea = yamlTextarea[0];\n
        textArea.scrollTop = textArea.scrollHeight;\n
    }\n
\n
    // Initialize interactive buttons after visual translation is shown\n
    function initializeInteractiveButtons() {\n
        // Initialize tooltips\n
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));\n
        tooltipTriggerList.map(function (tooltipTriggerEl) {\n
            return new bootstrap.Tooltip(tooltipTriggerEl);\n
        });\n
\n
        // Handle entity button clicks\n
        $(document).on('click', '.interactive-entity', function(e) {\n
            e.preventDefault();\n
            const entityName = $(this).data('entity-name');\n
            const entityType = $(this).data('entity-type');\n
            const role = $(this).data('role');\n
            \n
            console.log('Entity clicked:', { entityName, entityType, role });\n
            \n
            // Show edit dialog for entity\n
            showEntityEditDialog(entityName, entityType, role);\n
        });\n
\n
        // Handle predicate button clicks\n
        $(document).on('click', '.interactive-predicate', function(e) {\n
            e.preventDefault();\n
            const connectionType = $(this).data('connection-type');\n
            const isIncoming = $(this).data('is-incoming') === 'true';\n
            \n
            console.log('Predicate clicked:', { connectionType, isIncoming });\n
            \n
            // Show relationship type selector\n
            showRelationshipTypeSelector(connectionType, isIncoming);\n
        });\n
\n
        // Handle date button clicks\n
        $(document).on('click', '.interactive-date', function(e) {\n
            e.preventDefault();\n
            const date = $(this).data('date');\n
            const dateType = $(this).data('date-type');\n
            \n
            console.log('Date clicked:', { date, dateType });\n
            \n
            // Show date picker\n
            showDatePicker(date, dateType);\n
        });\n
\n
        // Handle connector button clicks\n
        $(document).on('click', '.interactive-connector', function(e) {\n
            e.preventDefault();\n
            const connectorText = $(this).data('connector-text');\n
            \n
            console.log('Connector clicked:', { connectorText });\n
            \n
            // Show connector edit dialog\n
            showConnectorEditDialog(connectorText);\n
        });\n
    }\n
\n
    // Show entity edit dialog\n
    function showEntityEditDialog(entityName, entityType, role) {\n
        // Close any existing dropdown\n
        if (activeDropdown) {\n
            activeDropdown.remove();\n
            activeDropdown = null;\n
        }\n
        \n
        // Create dropdown menu with searchable filter\n
        const dropdownId = 'entityDropdown_' + Date.now();\n
        const dropdown = $(`\n
            [39;22m[39;1m<div class="dropdown-menu pt-0 mx-0 rounded-3 shadow overflow-hidden w-280px" \n
                 id="${dropdownId}" data-bs-theme="light" style="z-index: 9999; display: block;">[39;22m[39;1m\n
                [39;22m[39;1m<form class="p-2 mb-2 bg-body-tertiary border-bottom">[39;22m[39;1m\n
                    [39;22m[39;1m<input type="search" class="form-control" autocomplete="false" placeholder="Type to filter...">[39;22m[39;1m\n
                [39;22m[39;1m</form>[39;22m[39;1m\n
                [39;22m[39;1m<ul class="list-unstyled mb-0">[39;22m[39;1m\n
                    [39;22m[39;1m<li>[39;22m[39;1m<a class="dropdown-item d-flex align-items-center gap-2 py-2" href="#" data-value="${entityName}">[39;22m[39;1m\n
                        [39;22m[39;1m<span class="d-inline-block bg-primary rounded-circle p-1">[39;22m[39;1m</span>[39;22m[39;1m\n
                        ${entityName} (current)\n
                    [39;22m[39;1m</a>[39;22m[39;1m</li>[39;22m[39;1m\n
                    [39;22m[39;1m<li>[39;22m[39;1m<a class="dropdown-item d-flex align-items-center gap-2 py-2" href="#" data-value="New Name 1">[39;22m[39;1m\n
                        [39;22m[39;1m<span class="d-inline-block bg-success rounded-circle p-1">[39;22m[39;1m</span>[39;22m[39;1m\n
                        New Name 1\n
                    [39;22m[39;1m</a>[39;22m[39;1m</li>[39;22m[39;1m\n
                    [39;22m[39;1m<li>[39;22m[39;1m<a class="dropdown-item d-flex align-items-center gap-2 py-2" href="#" data-value="New Name 2">[39;22m[39;1m\n
                        [39;22m[39;1m<span class="d-inline-block bg-info rounded-circle p-1">[39;22m[39;1m</span>[39;22m[39;1m\n
                        New Name 2\n
                    [39;22m[39;1m</a>[39;22m[39;1m</li>[39;22m[39;1m\n
                    [39;22m[39;1m<li>[39;22m[39;1m<hr class="dropdown-divider">[39;22m[39;1m</li>[39;22m[39;1m\n
                    [39;22m[39;1m<li>[39;22m[39;1m<a class="dropdown-item d-flex align-items-center gap-2 py-2" href="#" data-value="custom">[39;22m[39;1m\n
                        [39;22m[39;1m<span class="d-inline-block bg-warning rounded-circle p-1">[39;22m[39;1m</span>[39;22m[39;1m\n
                        Enter custom name...\n
                    [39;22m[39;1m</a>[39;22m[39;1m</li>[39;22m[39;1m\n
                [39;22m[39;1m</ul>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `);\n
        \n
        // Set as active dropdown\n
        activeDropdown = dropdown;\n
        \n
        // Position the dropdown near the clicked button\n
        const button = $(`.interactive-entity[data-entity-name="${entityName}"]`);\n
        const buttonPos = button.offset();\n
        const buttonWidth = button.outerWidth();\n
        const dropdownWidth = 280; // Width of the dropdown\n
        \n
        dropdown.css({\n
            position: 'absolute',\n
            top: buttonPos.top - 10, // Position above the button\n
            left: buttonPos.left + (buttonWidth / 2) - (dropdownWidth / 2), // Center over the button\n
            zIndex: 9999\n
        });\n
        \n
        $('body').append(dropdown);\n
        \n
        // Handle search filter\n
        dropdown.find('input[type="search"]').on('input', function() {\n
            const searchTerm = $(this).val().toLowerCase();\n
            dropdown.find('.dropdown-item').each(function() {\n
                const text = $(this).text().toLowerCase();\n
                $(this).toggle(text.includes(searchTerm));\n
            });\n
        });\n
        \n
        // Handle dropdown item clicks\n
        dropdown.find('.dropdown-item').on('click', function(e) {\n
            e.preventDefault();\n
            const value = $(this).data('value');\n
            \n
            if (value === 'custom') {\n
                const customName = prompt(`Enter custom ${role} name:`, entityName);\n
                if (customName && customName.trim() !== entityName) {\n
                    updateEntityInYaml(entityName, customName.trim(), entityType, role);\n
                }\n
            } else if (value !== entityName) {\n
                updateEntityInYaml(entityName, value, entityType, role);\n
            }\n
            \n
            dropdown.remove();\n
            activeDropdown = null;\n
        });\n
        \n
        // Close dropdown when clicking outside\n
        $(document).on('click.dropdown', function(e) {\n
            if (!dropdown.is(e.target) && dropdown.has(e.target).length === 0) {\n
                dropdown.remove();\n
                activeDropdown = null;\n
                $(document).off('click.dropdown');\n
            }\n
        });\n
        \n
        // Focus on search input\n
        setTimeout(() => dropdown.find('input[type="search"]').focus(), 100);\n
    }\n
\n
    // Show relationship type selector\n
    function showRelationshipTypeSelector(currentType, isIncoming) {\n
        // Close any existing dropdown\n
        if (activeDropdown) {\n
            activeDropdown.remove();\n
            activeDropdown = null;\n
        }\n
        \n
        const relationshipTypes = [\n
            { value: 'education', label: 'Education', color: 'success' },\n
            { value: 'employment', label: 'Employment', color: 'primary' },\n
            { value: 'residence', label: 'Residence', color: 'info' },\n
            { value: 'membership', label: 'Membership', color: 'warning' },\n
            { value: 'created', label: 'Created', color: 'danger' },\n
            { value: 'friend', label: 'Friend', color: 'secondary' },\n
            { value: 'relationship', label: 'Relationship', color: 'dark' },\n
            { value: 'contains', label: 'Contains', color: 'success' },\n
            { value: 'travel', label: 'Travel', color: 'info' },\n
            { value: 'participation', label: 'Participation', color: 'warning' },\n
            { value: 'ownership', label: 'Ownership', color: 'danger' },\n
            { value: 'has_role', label: 'Has Role', color: 'primary' },\n
            { value: 'at_organisation', label: 'At Organisation', color: 'secondary' }\n
        ];\n
        \n
        const dropdownId = 'relationshipDropdown_' + Date.now();\n
        const dropdown = $(`\n
            [39;22m[39;1m<div class="dropdown-menu pt-0 mx-0 rounded-3 shadow overflow-hidden w-280px" \n
                 id="${dropdownId}" data-bs-theme="light" style="z-index: 9999; display: block;">[39;22m[39;1m\n
                [39;22m[39;1m<form class="p-2 mb-2 bg-body-tertiary border-bottom">[39;22m[39;1m\n
                    [39;22m[39;1m<input type="search" class="form-control" autocomplete="false" placeholder="Type to filter...">[39;22m[39;1m\n
                [39;22m[39;1m</form>[39;22m[39;1m\n
                [39;22m[39;1m<ul class="list-unstyled mb-0">[39;22m[39;1m\n
                    ${relationshipTypes.map(type => `\n
                        [39;22m[39;1m<li>[39;22m[39;1m<a class="dropdown-item d-flex align-items-center gap-2 py-2" href="#" data-value="${type.value}">[39;22m[39;1m\n
                            [39;22m[39;1m<span class="d-inline-block bg-${type.color} rounded-circle p-1">[39;22m[39;1m</span>[39;22m[39;1m\n
                            ${type.label}${type.value === currentType ? ' (current)' : ''}\n
                        [39;22m[39;1m</a>[39;22m[39;1m</li>[39;22m[39;1m\n
                    `).join('')}\n
                [39;22m[39;1m</ul>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `);\n
        \n
        // Set as active dropdown\n
        activeDropdown = dropdown;\n
        \n
        // Position the dropdown near the clicked button\n
        const button = $(`.interactive-predicate[data-connection-type="${currentType}"]`);\n
        const buttonPos = button.offset();\n
        const buttonWidth = button.outerWidth();\n
        const dropdownWidth = 280; // Width of the dropdown\n
        \n
        dropdown.css({\n
            position: 'absolute',\n
            top: buttonPos.top - 10, // Position above the button\n
            left: buttonPos.left + (buttonWidth / 2) - (dropdownWidth / 2), // Center over the button\n
            zIndex: 9999\n
        });\n
        \n
        $('body').append(dropdown);\n
        \n
        // Handle search filter\n
        dropdown.find('input[type="search"]').on('input', function() {\n
            const searchTerm = $(this).val().toLowerCase();\n
            dropdown.find('.dropdown-item').each(function() {\n
                const text = $(this).text().toLowerCase();\n
                $(this).toggle(text.includes(searchTerm));\n
            });\n
        });\n
        \n
        // Handle dropdown item clicks\n
        dropdown.find('.dropdown-item').on('click', function(e) {\n
            e.preventDefault();\n
            const newType = $(this).data('value');\n
            if (newType !== currentType) {\n
                updateRelationshipType(currentType, isIncoming, newType);\n
            }\n
            dropdown.remove();\n
            activeDropdown = null;\n
        });\n
        \n
        // Close dropdown when clicking outside\n
        $(document).on('click.dropdown', function(e) {\n
            if (!dropdown.is(e.target) && dropdown.has(e.target).length === 0) {\n
                dropdown.remove();\n
                activeDropdown = null;\n
                $(document).off('click.dropdown');\n
            }\n
        });\n
        \n
        // Focus on search input\n
        setTimeout(() => dropdown.find('input[type="search"]').focus(), 100);\n
    }\n
\n
    // Show date picker\n
    function showDatePicker(currentDate, dateType) {\n
        // Close any existing dropdown\n
        if (activeDropdown) {\n
            activeDropdown.remove();\n
            activeDropdown = null;\n
        }\n
        \n
        const dropdownId = 'dateDropdown_' + Date.now();\n
        const dropdown = $(`\n
            [39;22m[39;1m<div class="dropdown-menu pt-0 mx-0 rounded-3 shadow overflow-hidden w-280px" \n
                 id="${dropdownId}" data-bs-theme="light" style="z-index: 9999; display: block;">[39;22m[39;1m\n
                [39;22m[39;1m<form class="p-2 mb-2 bg-body-tertiary border-bottom">[39;22m[39;1m\n
                    [39;22m[39;1m<input type="search" class="form-control" autocomplete="false" placeholder="Type to filter...">[39;22m[39;1m\n
                [39;22m[39;1m</form>[39;22m[39;1m\n
                [39;22m[39;1m<ul class="list-unstyled mb-0">[39;22m[39;1m\n
                    [39;22m[39;1m<li>[39;22m[39;1m<a class="dropdown-item d-flex align-items-center gap-2 py-2" href="#" data-value="${currentDate}">[39;22m[39;1m\n
                        [39;22m[39;1m<span class="d-inline-block bg-primary rounded-circle p-1">[39;22m[39;1m</span>[39;22m[39;1m\n
                        ${currentDate} (current)\n
                    [39;22m[39;1m</a>[39;22m[39;1m</li>[39;22m[39;1m\n
                    [39;22m[39;1m<li>[39;22m[39;1m<a class="dropdown-item d-flex align-items-center gap-2 py-2" href="#" data-value="1990">[39;22m[39;1m\n
                        [39;22m[39;1m<span class="d-inline-block bg-success rounded-circle p-1">[39;22m[39;1m</span>[39;22m[39;1m\n
                        1990\n
                    [39;22m[39;1m</a>[39;22m[39;1m</li>[39;22m[39;1m\n
                    [39;22m[39;1m<li>[39;22m[39;1m<a class="dropdown-item d-flex align-items-center gap-2 py-2" href="#" data-value="1995">[39;22m[39;1m\n
                        [39;22m[39;1m<span class="d-inline-block bg-info rounded-circle p-1">[39;22m[39;1m</span>[39;22m[39;1m\n
                        1995\n
                    [39;22m[39;1m</a>[39;22m[39;1m</li>[39;22m[39;1m\n
                    [39;22m[39;1m<li>[39;22m[39;1m<a class="dropdown-item d-flex align-items-center gap-2 py-2" href="#" data-value="2000">[39;22m[39;1m\n
                        [39;22m[39;1m<span class="d-inline-block bg-warning rounded-circle p-1">[39;22m[39;1m</span>[39;22m[39;1m\n
                        2000\n
                    [39;22m[39;1m</a>[39;22m[39;1m</li>[39;22m[39;1m\n
                    [39;22m[39;1m<li>[39;22m[39;1m<hr class="dropdown-divider">[39;22m[39;1m</li>[39;22m[39;1m\n
                    [39;22m[39;1m<li>[39;22m[39;1m<a class="dropdown-item d-flex align-items-center gap-2 py-2" href="#" data-value="custom">[39;22m[39;1m\n
                        [39;22m[39;1m<span class="d-inline-block bg-secondary rounded-circle p-1">[39;22m[39;1m</span>[39;22m[39;1m\n
                        Enter custom date...\n
                    [39;22m[39;1m</a>[39;22m[39;1m</li>[39;22m[39;1m\n
                [39;22m[39;1m</ul>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `);\n
        \n
        // Set as active dropdown\n
        activeDropdown = dropdown;\n
        \n
        // Position the dropdown near the clicked button\n
        const button = $(`.interactive-date[data-date="${currentDate}"]`);\n
        const buttonPos = button.offset();\n
        const buttonWidth = button.outerWidth();\n
        const dropdownWidth = 280; // Width of the dropdown\n
        \n
        dropdown.css({\n
            position: 'absolute',\n
            top: buttonPos.top - 10, // Position above the button\n
            left: buttonPos.left + (buttonWidth / 2) - (dropdownWidth / 2), // Center over the button\n
            zIndex: 9999\n
        });\n
        \n
        $('body').append(dropdown);\n
        \n
        // Handle search filter\n
        dropdown.find('input[type="search"]').on('input', function() {\n
            const searchTerm = $(this).val().toLowerCase();\n
            dropdown.find('.dropdown-item').each(function() {\n
                const text = $(this).text().toLowerCase();\n
                $(this).toggle(text.includes(searchTerm));\n
            });\n
        });\n
        \n
        // Handle dropdown item clicks\n
        dropdown.find('.dropdown-item').on('click', function(e) {\n
            e.preventDefault();\n
            const value = $(this).data('value');\n
            \n
            if (value === 'custom') {\n
                const customDate = prompt(`Edit ${dateType} date (YYYY-MM-DD):`, currentDate);\n
                if (customDate && customDate.trim() !== currentDate) {\n
                    updateDateInYaml(currentDate, customDate.trim(), dateType);\n
                }\n
            } else if (value !== currentDate) {\n
                updateDateInYaml(currentDate, value, dateType);\n
            }\n
            \n
            dropdown.remove();\n
            activeDropdown = null;\n
        });\n
        \n
        // Close dropdown when clicking outside\n
        $(document).on('click.dropdown', function(e) {\n
            if (!dropdown.is(e.target) && dropdown.has(e.target).length === 0) {\n
                dropdown.remove();\n
                activeDropdown = null;\n
                $(document).off('click.dropdown');\n
            }\n
        });\n
        \n
        // Focus on search input\n
        setTimeout(() => dropdown.find('input[type="search"]').focus(), 100);\n
    }\n
\n
    // Show connector edit dialog\n
    function showConnectorEditDialog(currentConnector) {\n
        // Close any existing dropdown\n
        if (activeDropdown) {\n
            activeDropdown.remove();\n
            activeDropdown = null;\n
        }\n
        \n
        const connectorOptions = [\n
            { value: 'is the child of', label: 'Is the child of', color: 'primary' },\n
            { value: 'is the parent of', label: 'Is the parent of', color: 'success' },\n
            { value: 'was educated at', label: 'Was educated at', color: 'info' },\n
            { value: 'was employed by', label: 'Was employed by', color: 'warning' },\n
            { value: 'lived in', label: 'Lived in', color: 'danger' },\n
            { value: 'was a member of', label: 'Was a member of', color: 'secondary' },\n
            { value: 'created', label: 'Created', color: 'dark' },\n
            { value: 'was friends with', label: 'Was friends with', color: 'primary' },\n
            { value: 'had a relationship with', label: 'Had a relationship with', color: 'success' },\n
            { value: 'contains', label: 'Contains', color: 'info' },\n
            { value: 'traveled to', label: 'Traveled to', color: 'warning' },\n
            { value: 'participated in', label: 'Participated in', color: 'danger' },\n
            { value: 'owned', label: 'Owned', color: 'secondary' },\n
            { value: 'had role', label: 'Had role', color: 'dark' },\n
            { value: 'was at', label: 'Was at', color: 'primary' }\n
        ];\n
        \n
        const dropdownId = 'connectorDropdown_' + Date.now();\n
        const dropdown = $(`\n
            [39;22m[39;1m<div class="dropdown-menu pt-0 mx-0 rounded-3 shadow overflow-hidden w-280px" \n
                 id="${dropdownId}" data-bs-theme="light" style="z-index: 9999; display: block;">[39;22m[39;1m\n
                [39;22m[39;1m<form class="p-2 mb-2 bg-body-tertiary border-bottom">[39;22m[39;1m\n
                    [39;22m[39;1m<input type="search" class="form-control" autocomplete="false" placeholder="Type to filter...">[39;22m[39;1m\n
                [39;22m[39;1m</form>[39;22m[39;1m\n
                [39;22m[39;1m<ul class="list-unstyled mb-0">[39;22m[39;1m\n
                    ${connectorOptions.map(option => `\n
                        [39;22m[39;1m<li>[39;22m[39;1m<a class="dropdown-item d-flex align-items-center gap-2 py-2" href="#" data-value="${option.value}">[39;22m[39;1m\n
                            [39;22m[39;1m<span class="d-inline-block bg-${option.color} rounded-circle p-1">[39;22m[39;1m</span>[39;22m[39;1m\n
                            ${option.label}${option.value === currentConnector ? ' (current)' : ''}\n
                        [39;22m[39;1m</a>[39;22m[39;1m</li>[39;22m[39;1m\n
                    `).join('')}\n
                    [39;22m[39;1m<li>[39;22m[39;1m<hr class="dropdown-divider">[39;22m[39;1m</li>[39;22m[39;1m\n
                    [39;22m[39;1m<li>[39;22m[39;1m<a class="dropdown-item d-flex align-items-center gap-2 py-2" href="#" data-value="custom">[39;22m[39;1m\n
                        [39;22m[39;1m<span class="d-inline-block bg-secondary rounded-circle p-1">[39;22m[39;1m</span>[39;22m[39;1m\n
                        Enter custom connector...\n
                    [39;22m[39;1m</a>[39;22m[39;1m</li>[39;22m[39;1m\n
                [39;22m[39;1m</ul>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `);\n
        \n
        // Set as active dropdown\n
        activeDropdown = dropdown;\n
        \n
        // Position the dropdown near the clicked button\n
        const button = $(`.interactive-connector[data-connector-text="${currentConnector}"]`);\n
        const buttonPos = button.offset();\n
        const buttonWidth = button.outerWidth();\n
        const dropdownWidth = 280; // Width of the dropdown\n
        \n
        dropdown.css({\n
            position: 'absolute',\n
            top: buttonPos.top - 10, // Position above the button\n
            left: buttonPos.left + (buttonWidth / 2) - (dropdownWidth / 2), // Center over the button\n
            zIndex: 9999\n
        });\n
        \n
        $('body').append(dropdown);\n
        \n
        // Handle search filter\n
        dropdown.find('input[type="search"]').on('input', function() {\n
            const searchTerm = $(this).val().toLowerCase();\n
            dropdown.find('.dropdown-item').each(function() {\n
                const text = $(this).text().toLowerCase();\n
                $(this).toggle(text.includes(searchTerm));\n
            });\n
        });\n
        \n
        // Handle dropdown item clicks\n
        dropdown.find('.dropdown-item').on('click', function(e) {\n
            e.preventDefault();\n
            const value = $(this).data('value');\n
            \n
            if (value === 'custom') {\n
                const customConnector = prompt(`Edit connector:`, currentConnector);\n
                if (customConnector && customConnector.trim() !== currentConnector) {\n
                    updateConnectorInYaml(currentConnector, customConnector.trim());\n
                }\n
            } else if (value !== currentConnector) {\n
                updateConnectorInYaml(currentConnector, value);\n
            }\n
            \n
            dropdown.remove();\n
            activeDropdown = null;\n
        });\n
        \n
        // Close dropdown when clicking outside\n
        $(document).on('click.dropdown', function(e) {\n
            if (!dropdown.is(e.target) && dropdown.has(e.target).length === 0) {\n
                dropdown.remove();\n
                activeDropdown = null;\n
                $(document).off('click.dropdown');\n
            }\n
        });\n
        \n
        // Focus on search input\n
        setTimeout(() => dropdown.find('input[type="search"]').focus(), 100);\n
    }\n
\n
    // Update relationship type in YAML\n
    window.updateRelationshipType = function(oldType, isIncoming, newType) {\n
        const currentYaml = yamlTextarea.val();\n
        const oldTypeWithIncoming = isIncoming === 'true' ? `${oldType}_incoming` : oldType;\n
        const newTypeWithIncoming = isIncoming === 'true' ? `${newType}_incoming` : newType;\n
        \n
        const updatedYaml = currentYaml.replace(new RegExp(`\\b${oldTypeWithIncoming}\\b`, 'g'), newTypeWithIncoming);\n
        yamlTextarea.val(updatedYaml);\n
        yamlTextarea.trigger('input');\n
        \n
        // Show feedback\n
        showUpdateFeedback(`Updated relationship type from "${oldType}" to "${newType}"`);\n
    };\n
\n
    // Update entity in YAML\n
    function updateEntityInYaml(oldName, newName, entityType, role) {\n
        const currentYaml = yamlTextarea.val();\n
        const updatedYaml = currentYaml.replace(new RegExp(`\\b${oldName}\\b`, 'g'), newName);\n
        yamlTextarea.val(updatedYaml);\n
        yamlTextarea.trigger('input');\n
        \n
        // Show feedback\n
        showUpdateFeedback(`Updated ${role} name from "${oldName}" to "${newName}"`);\n
    }\n
\n
    // Show update feedback\n
    function showUpdateFeedback(message) {\n
        const feedback = $(`\n
            [39;22m[39;1m<div class="alert alert-success alert-dismissible fade show position-fixed" \n
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-check-circle me-2">[39;22m[39;1m</i>[39;22m[39;1m${message}\n
                [39;22m[39;1m<button type="button" class="btn-close" data-bs-dismiss="alert">[39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `);\n
        \n
        $('body').append(feedback);\n
        \n
        // Auto-dismiss after 3 seconds\n
        setTimeout(() => {\n
            feedback.alert('close');\n
        }, 3000);\n
    }\n
\n
    // Update date in YAML\n
    function updateDateInYaml(oldDate, newDate, dateType) {\n
        const currentYaml = yamlTextarea.val();\n
        const updatedYaml = currentYaml.replace(new RegExp(`\\b${oldDate}\\b`, 'g'), newDate);\n
        yamlTextarea.val(updatedYaml);\n
        yamlTextarea.trigger('input');\n
        \n
        // Show feedback\n
        showUpdateFeedback(`Updated ${dateType} date from "${oldDate}" to "${newDate}"`);\n
    }\n
\n
    // Update connector in YAML\n
    function updateConnectorInYaml(oldConnector, newConnector) {\n
        const currentYaml = yamlTextarea.val();\n
        const updatedYaml = currentYaml.replace(new RegExp(`\\b${oldConnector}\\b`, 'g'), newConnector);\n
        yamlTextarea.val(updatedYaml);\n
        yamlTextarea.trigger('input');\n
        \n
        // Show feedback\n
        showUpdateFeedback(`Updated connector from "${oldConnector}" to "${newConnector}"`);\n
    }\n
\n
    // Show changes summary\n
    function showChangesSummary(newData) {\n
        // For new spans, always show the summary since everything is a "change"\n
        const isNewSpan = true;\n
        \n
        console.log('showChangesSummary called:', { isNewSpan, newData });\n
        \n
        if (!newData || Object.keys(newData).length === 0) {\n
            console.log('No newData, hiding changes summary');\n
            $('#changes-summary').hide();\n
            return;\n
        }\n
        \n
        const changes = [];\n
        \n
        if (isNewSpan) {\n
            console.log('Processing new span changes');\n
            // For new spans, treat all fields as new additions\n
            const basicFields = ['name', 'slug', 'type', 'state', 'description', 'notes', 'access_level', 'sources'];\n
            basicFields.forEach(field => {\n
                if (newData[field] !== undefined && newData[field] !== '' && newData[field] !== null) {\n
                    changes.push({\n
                        field: field,\n
                        type: 'add',\n
                        oldValue: 'Not set',\n
                        newValue: newData[field],\n
                        category: 'basic'\n
                    });\n
                }\n
            });\n
            \n
            // Add dates if present\n
            if (newData.start_year !== undefined || newData.start_month !== undefined || newData.start_day !== undefined) {\n
                const startDate = formatDateForDisplay(newData.start_year, newData.start_month, newData.start_day);\n
                if (startDate !== 'Not set') {\n
                    changes.push({\n
                        field: 'start_date',\n
                        type: 'add',\n
                        oldValue: 'Not set',\n
                        newValue: startDate,\n
                        category: 'dates'\n
                    });\n
                }\n
            }\n
            \n
            if (newData.end_year !== undefined || newData.end_month !== undefined || newData.end_day !== undefined) {\n
                const endDate = formatDateForDisplay(newData.end_year, newData.end_month, newData.end_day);\n
                if (endDate !== 'Not set') {\n
                    changes.push({\n
                        field: 'end_date',\n
                        type: 'add',\n
                        oldValue: 'Not set',\n
                        newValue: endDate,\n
                        category: 'dates'\n
                    });\n
                }\n
            }\n
            \n
            // Add metadata if present\n
            if (newData.metadata && Object.keys(newData.metadata).length > 0) {\n
                Object.entries(newData.metadata).forEach(([key, value]) => {\n
                    changes.push({\n
                        field: `metadata.${key}`,\n
                        type: 'add',\n
                        oldValue: 'Not set',\n
                        newValue: value,\n
                        category: 'metadata'\n
                    });\n
                });\n
            }\n
            \n
            // Add connections if present\n
            if (newData.connections && Object.keys(newData.connections).length > 0) {\n
                Object.entries(newData.connections).forEach(([connectionType, connections]) => {\n
                    connections.forEach((connection, index) => {\n
                        changes.push({\n
                            field: `connections.${connectionType}[${index}]`,\n
                            type: 'add',\n
                            oldValue: 'Not present',\n
                            newValue: `${connection.name} (${connection.type})`,\n
                            category: 'connections'\n
                        });\n
                    });\n
                });\n
            }\n
        } else {\n
            console.log('Processing existing span changes');\n
            // For existing spans, use the original comparison logic\n
            // Only show changes if the YAML content has actually been modified\n
            const hasChanges = yamlTextarea.val() !== originalContent;\n
            console.log('Content comparison:', { \n
                currentContent: yamlTextarea.val().substring(0, 100) + '...', \n
                originalContent: originalContent.substring(0, 100) + '...',\n
                hasChanges \n
            });\n
            \n
            if (!hasChanges) {\n
                console.log('No content changes detected, hiding changes summary');\n
                $('#changes-summary').hide();\n
                return;\n
            }\n
            \n
            // Compare basic fields\n
            const basicFields = ['name', 'slug', 'type', 'state', 'description', 'notes', 'access_level', 'sources'];\n
            basicFields.forEach(field => {\n
                if (newData[field] !== undefined) {\n
                    const currentValue = getCurrentSpanValue(field);\n
                    console.log(`Comparing ${field}:`, { currentValue, newValue: newData[field], equal: currentValue === newData[field] });\n
                    \n
                    // Skip if both values are null/empty (no change)\n
                    if (currentValue === null && newData[field] === null) return;\n
                    if (currentValue === '' && newData[field] === '') return;\n
                    if (currentValue === null && newData[field] === '') return;\n
                    if (currentValue === '' && newData[field] === null) return;\n
                    \n
                    if (newData[field] !== currentValue) {\n
                        changes.push({\n
                            field: field,\n
                            type: 'update',\n
                            oldValue: currentValue,\n
                            newValue: newData[field],\n
                            category: 'basic'\n
                        });\n
                    }\n
                }\n
            });\n
            \n
            // Compare dates\n
            if (newData.start_year !== undefined || newData.start_month !== undefined || newData.start_day !== undefined) {\n
                const currentStart = getCurrentSpanDate('start');\n
                const newStart = formatDateForDisplay(newData.start_year, newData.start_month, newData.start_day);\n
                console.log('Comparing start dates:', { currentStart, newStart, equal: currentStart === newStart });\n
                \n
                // Skip if both dates are "Not set" (no change)\n
                if (currentStart === 'Not set' && newStart === 'Not set') {\n
                    // Do nothing - no change\n
                } else if (currentStart !== newStart) {\n
                    changes.push({\n
                        field: 'start_date',\n
                        type: 'update',\n
                        oldValue: currentStart,\n
                        newValue: newStart,\n
                        category: 'dates'\n
                    });\n
                }\n
            }\n
            \n
            if (newData.end_year !== undefined || newData.end_month !== undefined || newData.end_day !== undefined) {\n
                const currentEnd = getCurrentSpanDate('end');\n
                const newEnd = formatDateForDisplay(newData.end_year, newData.end_month, newData.end_day);\n
                console.log('Comparing end dates:', { currentEnd, newEnd, equal: currentEnd === newEnd });\n
                \n
                // Skip if both dates are "Not set" (no change)\n
                if (currentEnd === 'Not set' && newEnd === 'Not set') {\n
                    // Do nothing - no change\n
                } else if (currentEnd !== newEnd) {\n
                    changes.push({\n
                        field: 'end_date',\n
                        type: 'update',\n
                        oldValue: currentEnd,\n
                        newValue: newEnd,\n
                        category: 'dates'\n
                    });\n
                }\n
            }\n
            \n
            // Compare metadata\n
            if (newData.metadata && Object.keys(newData.metadata).length > 0) {\n
                const currentMetadata = getCurrentSpanValue('metadata') || {};\n
                const metadataChanges = compareMetadata(currentMetadata, newData.metadata);\n
                changes.push(...metadataChanges);\n
            }\n
            \n
            // Compare connections using YAML comparison\n
            if (newData.connections && Object.keys(newData.connections).length > 0) {\n
                const connectionChanges = compareConnections(newData.connections);\n
                changes.push(...connectionChanges);\n
            }\n
        }\n
        \n
        console.log('Total changes found:', changes.length, changes);\n
        \n
        // Display changes\n
        if (changes.length === 0) {\n
            console.log('No changes to display, hiding changes summary');\n
            $('#changes-summary').hide();\n
            return;\n
        }\n
        \n
        let html = '';\n
        const categories = {\n
            'basic': { title: 'Basic Information', icon: 'bi-info-circle' },\n
            'dates': { title: 'Dates', icon: 'bi-calendar-event' },\n
            'metadata': { title: 'Metadata', icon: 'bi-tags' },\n
            'connections': { title: 'Connections', icon: 'bi-diagram-3' }\n
        };\n
        \n
        // Group changes by category\n
        const groupedChanges = {};\n
        changes.forEach(change => {\n
            if (!groupedChanges[change.category]) {\n
                groupedChanges[change.category] = [];\n
            }\n
            groupedChanges[change.category].push(change);\n
        });\n
        \n
        Object.keys(groupedChanges).forEach(category => {\n
            const categoryInfo = categories[category] || { title: category, icon: 'bi-gear' };\n
            html += `\n
                [39;22m[39;1m<div class="mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<h6 class="text-muted mb-2">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="${categoryInfo.icon} me-1">[39;22m[39;1m</i>[39;22m[39;1m${categoryInfo.title}\n
                    [39;22m[39;1m</h6>[39;22m[39;1m\n
            `;\n
            \n
            groupedChanges[category].forEach(change => {\n
                const changeIcon = change.type === 'add' ? 'bi-plus-circle text-success' : \n
                                 change.type === 'remove' ? 'bi-dash-circle text-danger' : \n
                                 'bi-arrow-right text-primary';\n
                \n
                html += `\n
                    [39;22m[39;1m<div class="small mb-1">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="${changeIcon} me-1">[39;22m[39;1m</i>[39;22m[39;1m\n
                        [39;22m[39;1m<strong>[39;22m[39;1m${formatFieldName(change.field)}:[39;22m[39;1m</strong>[39;22m[39;1m\n
                        ${change.type === 'add' ? \n
                            `[39;22m[39;1m<span class="text-success">[39;22m[39;1m${formatValue(change.newValue)}[39;22m[39;1m</span>[39;22m[39;1m` :\n
                            change.type === 'remove' ? \n
                            `[39;22m[39;1m<span class="text-danger">[39;22m[39;1m${formatValue(change.oldValue)}[39;22m[39;1m</span>[39;22m[39;1m [39;22m[39;1m<i class="bi bi-arrow-right mx-1 text-muted">[39;22m[39;1m</i>[39;22m[39;1m [39;22m[39;1m<span class="text-muted">[39;22m[39;1mRemoved[39;22m[39;1m</span>[39;22m[39;1m` :\n
                            `[39;22m[39;1m<span class="text-danger">[39;22m[39;1m${formatValue(change.oldValue)}[39;22m[39;1m</span>[39;22m[39;1m [39;22m[39;1m<i class="bi bi-arrow-right mx-1 text-muted">[39;22m[39;1m</i>[39;22m[39;1m [39;22m[39;1m<span class="text-success">[39;22m[39;1m${formatValue(change.newValue)}[39;22m[39;1m</span>[39;22m[39;1m`\n
                        }\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                `;\n
            });\n
            \n
            html += '[39;22m[39;1m</div>[39;22m[39;1m';\n
        });\n
        \n
        $('#changes-list').html(html);\n
        $('#changes-summary').show();\n
        console.log('Changes summary displayed');\n
    }\n
    \n
    // Helper functions for changes summary\n
    function getCurrentSpanValue(field) {\n
        const isNewSpan = true;\n
        \n
        if (isNewSpan) {\n
            // Use the dynamic baseline that can be updated when creating new templates\n
            return currentBaseline[field] || '';\n
        } else {\n
            // For existing spans, get the value from the span data\n
            const span = null;\n
            return span[field] || '';\n
        }\n
    }\n
    \n
    function getCurrentSpanDate(type) {\n
        const span = null;\n
        if (type === 'start') {\n
            if (span.start_year) {\n
                let date = span.start_year.toString();\n
                if (span.start_month) {\n
                    date += '-' + span.start_month.toString().padStart(2, '0');\n
                    if (span.start_day) {\n
                        date += '-' + span.start_day.toString().padStart(2, '0');\n
                    }\n
                }\n
                return date;\n
            }\n
        } else if (type === 'end') {\n
            if (span.end_year) {\n
                let date = span.end_year.toString();\n
                if (span.end_month) {\n
                    date += '-' + span.end_month.toString().padStart(2, '0');\n
                    if (span.end_day) {\n
                        date += '-' + span.end_day.toString().padStart(2, '0');\n
                    }\n
                }\n
                return date;\n
            }\n
        }\n
        return 'Not set';\n
    }\n
    \n
    function formatDateForDisplay(year, month, day) {\n
        if (!year) return 'Not set';\n
        let date = year.toString();\n
        if (month) {\n
            date += '-' + month.toString().padStart(2, '0');\n
            if (day) {\n
                date += '-' + day.toString().padStart(2, '0');\n
            }\n
        }\n
        return date;\n
    }\n
    \n
    function formatFieldName(field) {\n
        const fieldNames = {\n
            'name': 'Name',\n
            'slug': 'Slug',\n
            'type': 'Type',\n
            'state': 'State',\n
            'description': 'Description',\n
            'notes': 'Notes',\n
            'access_level': 'Access Level',\n
            'sources': 'Sources',\n
            'start_date': 'Start Date',\n
            'end_date': 'End Date'\n
        };\n
        \n
        // Handle connection field names (e.g., "connections.Residence[0].start_date")\n
        if (field.includes('connections.')) {\n
            const parts = field.split('.');\n
            if (parts.length >= 3) {\n
                const connectionType = parts[1]; // e.g., "Residence"\n
                const fieldName = parts[2]; // e.g., "start_date"\n
                const fieldDisplayName = fieldNames[fieldName] || fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());\n
                return `${connectionType} ${fieldDisplayName}`;\n
            }\n
        }\n
        \n
        return fieldNames[field] || field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());\n
    }\n
    \n
    function formatValue(value) {\n
        if (value === null || value === undefined) return 'Not set';\n
        if (typeof value === 'object') return JSON.stringify(value);\n
        return value.toString();\n
    }\n
    \n
    function compareMetadata(oldMetadata, newMetadata) {\n
        const changes = [];\n
        const allKeys = new Set([...Object.keys(oldMetadata), ...Object.keys(newMetadata)]);\n
        \n
        allKeys.forEach(key => {\n
            const oldValue = oldMetadata[key];\n
            const newValue = newMetadata[key];\n
            if (oldValue !== newValue) {\n
                changes.push({\n
                    field: `metadata.${key}`,\n
                    type: 'update',\n
                    oldValue: oldValue,\n
                    newValue: newValue,\n
                    category: 'metadata'\n
                });\n
            }\n
        });\n
        \n
        return changes;\n
    }\n
    \n
    function compareConnections(yamlConnections) {\n
        // Instead of trying to reconstruct database connections, let's compare YAML content\n
        // The current YAML content should represent the current state\n
        const currentYamlContent = originalContent;\n
        const newYamlContent = yamlTextarea.val();\n
        \n
        // If the content hasn't changed, no connection changes\n
        if (currentYamlContent === newYamlContent) {\n
            return [];\n
        }\n
        \n
        // Parse both YAML contents to compare\n
        let currentData, newData;\n
        \n
        try {\n
            currentData = jsyaml.load(currentYamlContent);\n
            newData = jsyaml.load(newYamlContent);\n
            \n
            // Debug logging\n
            console.log('Current YAML data:', currentData);\n
            console.log('New YAML data:', newData);\n
        } catch (e) {\n
            console.error('Failed to parse YAML for comparison:', e);\n
            return [];\n
        }\n
        \n
        const changes = [];\n
        \n
        // Compare connections if they exist in both\n
        const currentConnections = currentData.connections || {};\n
        const newConnections = newData.connections || {};\n
        \n
        // Get all connection types from both\n
        const allConnectionTypes = new Set([\n
            ...Object.keys(currentConnections),\n
            ...Object.keys(newConnections)\n
        ]);\n
        \n
        allConnectionTypes.forEach(connectionType => {\n
            const currentList = currentConnections[connectionType] || [];\n
            const newList = newConnections[connectionType] || [];\n
            \n
            // Debug logging for residence connections\n
            if (connectionType === 'residence') {\n
                console.log('Residence connections comparison:', {\n
                    current: currentList,\n
                    new: newList\n
                });\n
            }\n
            \n
            // Compare each connection in the new list\n
            newList.forEach((newConnection, index) => {\n
                // Try to find matching connection in current list - use connection_id as primary key\n
                const matchingCurrent = currentList.find(current => \n
                    current.connection_id === newConnection.connection_id\n
                );\n
                \n
                if (!matchingCurrent) {\n
                    // This is a new connection\n
                    changes.push({\n
                        field: `connections.${connectionType}[${index}]`,\n
                        type: 'add',\n
                        oldValue: 'Not present',\n
                        newValue: `${newConnection.name} (${newConnection.type})`,\n
                        category: 'connections'\n
                    });\n
                } else {\n
                    // Check if there are changes to the existing connection\n
                    const connectionChanges = getConnectionFieldChanges(matchingCurrent, newConnection);\n
                    if (connectionChanges.length > 0) {\n
                        // Add each changed field as a separate change\n
                        connectionChanges.forEach(fieldChange => {\n
                            changes.push({\n
                                field: `connections.${connectionType}[${index}].${fieldChange.field}`,\n
                                type: 'update',\n
                                oldValue: fieldChange.oldValue,\n
                                newValue: fieldChange.newValue,\n
                                category: 'connections'\n
                            });\n
                        });\n
                    }\n
                }\n
            });\n
            \n
            // Check for removed connections\n
            currentList.forEach((currentConnection, index) => {\n
                const stillExists = newList.find(newConn => \n
                    newConn.connection_id === currentConnection.connection_id\n
                );\n
                \n
                if (!stillExists) {\n
                    changes.push({\n
                        field: `connections.${connectionType}[${index}]`,\n
                        type: 'remove',\n
                        oldValue: `${currentConnection.name} (${currentConnection.type})`,\n
                        newValue: 'Removed',\n
                        category: 'connections'\n
                    });\n
                }\n
            });\n
        });\n
        \n
        return changes;\n
    }\n
    \n
    function getConnectionFieldChanges(existing, newConnection) {\n
        const changes = [];\n
        const fieldsToCompare = ['name', 'type', 'start_date', 'end_date'];\n
        \n
        for (const field of fieldsToCompare) {\n
            const existingValue = existing[field];\n
            const newValue = newConnection[field];\n
            \n
            // Debug logging\n
            console.log(`Comparing ${field}:`, { existing: existingValue, new: newValue, equal: existingValue === newValue });\n
            \n
            if (existingValue !== newValue) {\n
                changes.push({\n
                    field: field,\n
                    type: 'update',\n
                    oldValue: existingValue,\n
                    newValue: newValue\n
                });\n
            }\n
        }\n
        \n
        return changes;\n
    }\n
    \n
    // Create New Span functionality\n
    $(document).ready(function() {\n
        const newSpanNameInput = $('#new-span-name-input');\n
        const newSpanTypeSelector = $('#new-span-type-selector');\n
        const createNewSpanBtn = $('#create-new-span-btn');\n
        const yamlTextarea = $('#yaml-content');\n
        \n
        // Dynamic baseline for comparison - starts with current span data\n
        let currentBaseline =  {\n
            name: '',\n
            slug: '',\n
            type: '',\n
            state: 'placeholder',\n
            description: '',\n
            notes: '',\n
            access_level: 'private',\n
            sources: [],\n
            metadata: {}\n
        } ;\n
        \n
        // Enable/disable create button based on both name and type selection\n
        function updateCreateButton() {\n
            const hasName = newSpanNameInput.val().trim() !== '';\n
            const hasType = newSpanTypeSelector.val() !== '';\n
            createNewSpanBtn.prop('disabled', !hasName || !hasType);\n
        }\n
        \n
        newSpanNameInput.on('input', updateCreateButton);\n
        newSpanTypeSelector.on('change', updateCreateButton);\n
        \n
        // Handle create new span button click\n
        createNewSpanBtn.on('click', function() {\n
            const selectedType = newSpanTypeSelector.val();\n
            const spanName = newSpanNameInput.val().trim();\n
            \n
            if (!selectedType) {\n
                alert('Please select a span type first');\n
                return;\n
            }\n
            \n
            if (!spanName) {\n
                alert('Please enter a span name first');\n
                return;\n
            }\n
            \n
            // Generate basic YAML template with the provided name\n
            const yamlTemplate = generateNewSpanTemplate(spanName, selectedType);\n
            \n
            // Clear the editor and insert the template\n
            yamlTextarea.val(yamlTemplate);\n
            \n
            // Reset the baseline to the new template so future changes are compared against it\n
            originalContent = yamlTemplate;\n
            \n
            // Update the current baseline to match the new template\n
            currentBaseline = {\n
                name: spanName,\n
                slug: '',\n
                type: selectedType,\n
                state: 'placeholder',\n
                description: '',\n
                notes: '',\n
                access_level: 'private',\n
                sources: [],\n
                metadata: {}\n
            };\n
            \n
            // Trigger validation to show the template\n
            validateYaml();\n
            \n
            // Reset the inputs\n
            newSpanNameInput.val('');\n
            newSpanTypeSelector.val('');\n
            createNewSpanBtn.prop('disabled', true);\n
            \n
            // Show success message\n
            showFeedback('New span template created! Fill in the details and apply changes to create the span.', 'success');\n
        });\n
        \n
        // Intercept Apply Changes button to handle new span creation\n
        $(document).on('click', '#apply-btn', function(e) {\n
            const yaml = yamlTextarea.val();\n
            let data;\n
            try {\n
                data = jsyaml.load(yaml);\n
            } catch (err) {\n
                showFeedback('Invalid YAML: ' + err.message, 'danger');\n
                return;\n
            }\n
            if (!data.id) {\n
                // No id: create new span\n
                $.ajax({\n
                    url: '/spans/yaml-create',\n
                    method: 'POST',\n
                    data: {\n
                        yaml_content: yaml,\n
                        _token: $('meta[name="csrf-token"]').attr('content')\n
                    },\n
                    success: function(response) {\n
                        if (response.success && response.redirect) {\n
                            window.location.href = response.redirect;\n
                        } else {\n
                            showFeedback(response.message || 'Failed to create span', 'danger');\n
                        }\n
                    },\n
                    error: function(xhr) {\n
                        let msg = 'Failed to create span';\n
                        if (xhr.responseJSON && xhr.responseJSON.errors) {\n
                            msg = Object.values(xhr.responseJSON.errors).join('[39;22m[39;1m<br>[39;22m[39;1m');\n
                        } else if (xhr.responseJSON && xhr.responseJSON.message) {\n
                            msg = xhr.responseJSON.message;\n
                        }\n
                        showFeedback(msg, 'danger');\n
                    }\n
                });\n
                e.preventDefault();\n
            }\n
        });\n
        \n
        function generateNewSpanTemplate(spanName, spanType) {\n
            const template = `name: '${spanName}'\n
slug: ''\n
type: ${spanType}\n
state: placeholder\n
description: ''\n
notes: ''\n
metadata: {}\n
sources: []\n
access_level: private\n
`;\n
            return template;\n
        }\n
        \n
        function showFeedback(message, type = 'info') {\n
            // Create a temporary feedback element\n
            const feedback = $(`\n
                [39;22m[39;1m<div class="alert alert-${type === 'success' ? 'success' : 'info'} alert-dismissible fade show" role="alert">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-${type === 'success' ? 'check-circle' : 'info-circle'} me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                    ${message}\n
                    [39;22m[39;1m<button type="button" class="btn-close" data-bs-dismiss="alert">[39;22m[39;1m</button>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            `);\n
            \n
            // Insert at the top of the validation results\n
            $('#validation-results').prepend(feedback);\n
            \n
            // Auto-dismiss after 5 seconds\n
            setTimeout(() => {\n
                feedback.alert('close');\n
            }, 5000);\n
        }\n
    });\n
});\n
[39;22m[39;1m</script>[39;22m[39;1m\n
    [39;22m[39;1m</head>[39;22m[39;1m\n
    [39;22m[39;1m<body class="bg-light">[39;22m[39;1m\n
        [39;22m[39;1m<div class="row">[39;22m[39;1m\n
                            <!-- Sidebar and Main Content -->\n
                [39;22m[39;1m<div class="row sidebar-row">[39;22m[39;1m\n
                    <!-- Sidebar -->\n
                    [39;22m[39;1m<div id="sidebar" class="bg-dark border-end d-none d-md-block p-0 sidebar">[39;22m[39;1m\n
                        [39;22m[39;1m<div class="sticky-top" style="top: 0; height: 100vh; overflow-y: auto;">[39;22m[39;1m\n
                            <!-- Brand/Title -->\n
[39;22m[39;1m<div class="p-3 border-bottom border-white bg-primary">[39;22m[39;1m\n
    [39;22m[39;1m<a class="text-decoration-none" href="http://localhost:8000">[39;22m[39;1m\n
        [39;22m[39;1m<h5 class="mb-0 text-white sidebar-brand">[39;22m[39;1m\n
            [39;22m[39;1m<i class="bi bi-bar-chart-steps me-1">[39;22m[39;1m</i>[39;22m[39;1m [39;22m[39;1m<span>[39;22m[39;1mLifespan[39;22m[39;1m</span>[39;22m[39;1m\n
        [39;22m[39;1m</h5>[39;22m[39;1m\n
    [39;22m[39;1m</a>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m\n
\n
<!-- Main Navigation Links -->\n
[39;22m[39;1m<ul class="nav flex-column text-light mb-auto">[39;22m[39;1m\n
    [39;22m[39;1m<li class="nav-item">[39;22m[39;1m\n
        [39;22m[39;1m<a class="nav-link " href="http://localhost:8000">[39;22m[39;1m\n
            [39;22m[39;1m<i class="bi bi-house-fill me-1">[39;22m[39;1m</i>[39;22m[39;1m [39;22m[39;1m<span>[39;22m[39;1mHome[39;22m[39;1m</span>[39;22m[39;1m\n
        [39;22m[39;1m</a>[39;22m[39;1m\n
    [39;22m[39;1m</li>[39;22m[39;1m\n
            [39;22m[39;1m<li class="nav-item">[39;22m[39;1m\n
            [39;22m[39;1m<a class="nav-link " \n
               href="http://localhost:8000/spans/9f59d5dd-68d0-482a-af09-4129e3e82379">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-person-circle me-1">[39;22m[39;1m</i>[39;22m[39;1m [39;22m[39;1m<span>[39;22m[39;1mTest User 9f59d5dd-674f-4d82-8634-ea3a7f9ecdd0[39;22m[39;1m</span>[39;22m[39;1m\n
            [39;22m[39;1m</a>[39;22m[39;1m\n
        [39;22m[39;1m</li>[39;22m[39;1m\n
        [39;22m[39;1m<li class="nav-item">[39;22m[39;1m\n
        [39;22m[39;1m<a class="nav-link " href="http://localhost:8000/spans">[39;22m[39;1m\n
            [39;22m[39;1m<i class="bi bi-bar-chart-steps me-1">[39;22m[39;1m</i>[39;22m[39;1m [39;22m[39;1m<span>[39;22m[39;1mSpans[39;22m[39;1m</span>[39;22m[39;1m\n
        [39;22m[39;1m</a>[39;22m[39;1m\n
    [39;22m[39;1m</li>[39;22m[39;1m\n
    [39;22m[39;1m<li class="nav-item">[39;22m[39;1m\n
        [39;22m[39;1m<a class="nav-link " href="http://localhost:8000/spans/types">[39;22m[39;1m\n
            [39;22m[39;1m<i class="bi bi-collection me-1">[39;22m[39;1m</i>[39;22m[39;1m [39;22m[39;1m<span>[39;22m[39;1mTypes[39;22m[39;1m</span>[39;22m[39;1m\n
        [39;22m[39;1m</a>[39;22m[39;1m\n
    [39;22m[39;1m</li>[39;22m[39;1m\n
    [39;22m[39;1m<li class="nav-item">[39;22m[39;1m\n
        [39;22m[39;1m<a class="nav-link " href="http://localhost:8000/family">[39;22m[39;1m\n
            [39;22m[39;1m<i class="bi bi-people-fill me-1">[39;22m[39;1m</i>[39;22m[39;1m [39;22m[39;1m<span>[39;22m[39;1mFamily[39;22m[39;1m</span>[39;22m[39;1m\n
        [39;22m[39;1m</a>[39;22m[39;1m\n
    [39;22m[39;1m</li>[39;22m[39;1m\n
    [39;22m[39;1m<li class="nav-item">[39;22m[39;1m\n
        [39;22m[39;1m<a class="nav-link " href="http://localhost:8000/sets">[39;22m[39;1m\n
            [39;22m[39;1m<i class="bi bi-archive me-1">[39;22m[39;1m</i>[39;22m[39;1m [39;22m[39;1m<span>[39;22m[39;1mSets[39;22m[39;1m</span>[39;22m[39;1m\n
        [39;22m[39;1m</a>[39;22m[39;1m\n
    [39;22m[39;1m</li>[39;22m[39;1m\n
    [39;22m[39;1m<li class="nav-item">[39;22m[39;1m\n
        [39;22m[39;1m<a class="nav-link " href="http://localhost:8000/desert-island-discs">[39;22m[39;1m\n
            [39;22m[39;1m<i class="bi bi-vinyl-fill me-1">[39;22m[39;1m</i>[39;22m[39;1m [39;22m[39;1m<span>[39;22m[39;1mDesert Island Discs[39;22m[39;1m</span>[39;22m[39;1m\n
        [39;22m[39;1m</a>[39;22m[39;1m\n
    [39;22m[39;1m</li>[39;22m[39;1m\n
\n
[39;22m[39;1m</ul>[39;22m[39;1m                                                         <!-- Sidebar Footer -->\n
[39;22m[39;1m<div class="border-top border-light mt-3 sidebar-footer">[39;22m[39;1m\n
    [39;22m[39;1m<div class="p-3">[39;22m[39;1m\n
        [39;22m[39;1m<a href="https://info.lifespan.dev" target="_blank" class="text-decoration-none text-light small d-block mb-2">[39;22m[39;1m\n
            [39;22m[39;1m<i class="bi bi-info-circle me-1">[39;22m[39;1m</i>[39;22m[39;1m [39;22m[39;1m<span>[39;22m[39;1mAbout Lifespan[39;22m[39;1m</span>[39;22m[39;1m\n
        [39;22m[39;1m</a>[39;22m[39;1m\n
        [39;22m[39;1m<div class="text-light small opacity-75" \n
             data-bs-toggle="tooltip" \n
             data-bs-placement="top" \n
             title="{\n
    &quot;version&quot;: &quot;0.459&quot;,\n
    &quot;environment&quot;: &quot;testing&quot;\n
}">[39;22m[39;1m\n
            [39;22m[39;1m<i class="bi bi-code-square me-1">[39;22m[39;1m</i>[39;22m[39;1m [39;22m[39;1m<span>[39;22m[39;1mLifespan Beta 0.459[39;22m[39;1m</span>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m\n
\n
                         [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
\n
                    <!-- Main Content Area with Top Navigation -->\n
                    [39;22m[39;1m<div id="main-content" class="bg-light main-content">[39;22m[39;1m\n
                        <!-- Top Navigation Bar -->\n
                        [39;22m[39;1m<div class="bg-light border-bottom shadow-sm" style="height: 56px;">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="d-flex align-items-center h-100 px-3">[39;22m[39;1m\n
                                <!-- Page Title Section -->\n
[39;22m[39;1m<div class="px-3 d-flex align-items-center">[39;22m[39;1m\n
    [39;22m[39;1m<div class="d-flex flex-column">[39;22m[39;1m\n
                \n
        [39;22m[39;1m<h4 class="mb-0 fw-bold">[39;22m[39;1m    [39;22m[39;1m<nav aria-label="breadcrumb">[39;22m[39;1m\n
    [39;22m[39;1m<ol class="breadcrumb mb-0">[39;22m[39;1m\n
                                    \n
                [39;22m[39;1m<li class="breadcrumb-item">[39;22m[39;1m\n
                                            [39;22m[39;1m<a href="http://localhost:8000/spans" class="text-decoration-none">[39;22m[39;1m\n
                            Spans\n
                        [39;22m[39;1m</a>[39;22m[39;1m\n
                                    [39;22m[39;1m</li>[39;22m[39;1m\n
                                                \n
                [39;22m[39;1m<li class="breadcrumb-item">[39;22m[39;1m\n
                                            New Span\n
                                    [39;22m[39;1m</li>[39;22m[39;1m\n
                                                \n
                [39;22m[39;1m<li class="breadcrumb-item active" aria-current="page">[39;22m[39;1m\n
                    Edit\n
                [39;22m[39;1m</li>[39;22m[39;1m\n
                        [39;22m[39;1m</ol>[39;22m[39;1m\n
[39;22m[39;1m</nav>[39;22m[39;1m [39;22m[39;1m</h4>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m                                 <!-- Page Filters Section -->\n
[39;22m[39;1m<div class="px-3 d-flex align-items-center ms-auto">[39;22m[39;1m\n
    <!-- Page-specific filters -->\n
    [39;22m[39;1m</div>[39;22m[39;1m                                 <!-- Page Tools Section -->\n
[39;22m[39;1m<div class="d-flex align-items-center">[39;22m[39;1m\n
            [39;22m[39;1m<div class="me-3">[39;22m[39;1m\n
            [39;22m[39;1m<div class="btn-group">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="d-flex gap-2">[39;22m[39;1m\n
                    [39;22m[39;1m<a href="http://localhost:8000/spans" class="btn btn-sm btn-outline-secondary">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-arrow-left me-1">[39;22m[39;1m</i>[39;22m[39;1mBack to Spans\n
            [39;22m[39;1m</a>[39;22m[39;1m\n
            [39;22m[39;1m<a href="http://localhost:8000/spans/create" class="btn btn-sm btn-outline-primary">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-plus me-1">[39;22m[39;1m</i>[39;22m[39;1mCreate New Span\n
            [39;22m[39;1m</a>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m                                 <!-- DEBUG: User Profile Component Loaded -->\n
<!-- User Profile Section -->\n
[39;22m[39;1m<div class="px-3 d-flex align-items-center">[39;22m[39;1m\n
    <!-- Global Search -->\n
    <!-- Global Search Component -->\n
[39;22m[39;1m<div class="global-search-container position-relative me-3" style="width: 120px;">[39;22m[39;1m\n
    [39;22m[39;1m<div class="d-flex align-items-center position-relative">[39;22m[39;1m\n
        [39;22m[39;1m<i class="bi bi-search position-absolute ms-2 text-muted z-index-1" style="top: 50%; transform: translateY(-50%); font-size: 0.875rem;">[39;22m[39;1m</i>[39;22m[39;1m\n
        [39;22m[39;1m<input type="text" id="global-search" class="form-control form-control-sm ps-4" placeholder="Search..." autocomplete="off">[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m\n
\n
[39;22m[39;1m<style>[39;22m[39;1m\n
    /* Global search dropdown positioning */\n
    .global-search-container {\n
        position: relative;\n
        min-width: 120px;\n
        max-width: 400px;\n
        transition: width 0.3s ease;\n
    }\n
    \n
    .global-search-container:focus-within {\n
        width: 350px !important;\n
    }\n
    \n
    #global-search {\n
        width: 100%;\n
        min-width: 120px;\n
        transition: all 0.3s ease;\n
        /* Match button group dimensions */\n
        font-size: 0.875rem;\n
        padding: 0.25rem 0.5rem;\n
        border-radius: 0.375rem;\n
        height: calc(1.5em + 0.5rem + 2px);\n
        line-height: 1.5;\n
    }\n
    \n
    #global-search:focus {\n
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);\n
        border-color: #0d6efd;\n
    }\n
    \n
    #global-search-dropdown {\n
        position: absolute !important;\n
        top: 100% !important;\n
        left: 0 !important;\n
        right: auto !important;\n
        min-width: 300px;\n
        max-width: 400px;\n
        z-index: 1050;\n
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n
        border: 1px solid rgba(0, 0, 0, 0.125);\n
        /* Prevent overflow */\n
        max-width: calc(100vw - 2rem);\n
    }\n
    \n
    /* Responsive adjustments for search dropdown */\n
    @media (max-width: 768px) {\n
        .global-search-container {\n
            min-width: 150px;\n
            max-width: 300px;\n
        }\n
        \n
        .global-search-container:focus-within {\n
            width: 280px !important;\n
        }\n
        \n
        #global-search {\n
            min-width: 150px;\n
        }\n
        \n
        #global-search-dropdown {\n
            right: 0 !important;\n
            left: auto !important;\n
            min-width: auto;\n
            max-width: none;\n
            width: 100%;\n
        }\n
    }\n
    \n
    /* Additional responsive adjustments for very small screens */\n
    @media (max-width: 576px) {\n
        .global-search-container {\n
            min-width: 120px;\n
            max-width: 250px;\n
        }\n
        \n
        .global-search-container:focus-within {\n
            width: 220px !important;\n
        }\n
        \n
        #global-search {\n
            min-width: 120px;\n
        }\n
    }\n
    \n
    /* Ensure dropdown items are properly styled */\n
    #global-search-dropdown .dropdown-item {\n
        padding: 0.5rem 1rem;\n
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);\n
        cursor: pointer;\n
        transition: all 0.15s ease;\n
    }\n
    \n
    #global-search-dropdown .dropdown-item:last-child {\n
        border-bottom: none;\n
    }\n
    \n
    #global-search-dropdown .dropdown-item:hover {\n
        background-color: #f8f9fa;\n
        color: #495057;\n
    }\n
    \n
    #global-search-dropdown .dropdown-item.active {\n
        background-color: #0d6efd;\n
        color: white !important;\n
    }\n
    \n
    #global-search-dropdown .dropdown-item.active .fw-medium {\n
        color: white !important;\n
        font-weight: 600;\n
    }\n
    \n
    #global-search-dropdown .dropdown-item.active small {\n
        color: rgba(255, 255, 255, 0.8) !important;\n
    }\n
    \n
    #global-search-dropdown .dropdown-item.active i {\n
        color: rgba(255, 255, 255, 0.9) !important;\n
    }\n
    \n
    /* Keyboard shortcut hint */\n
    .search-shortcut-hint {\n
        position: absolute;\n
        right: 6px;\n
        top: 50%;\n
        transform: translateY(-50%);\n
        font-size: 0.75rem;\n
        color: #6c757d;\n
        background: rgba(255, 255, 255, 0.9);\n
        padding: 1px 4px;\n
        border-radius: 2px;\n
        border: 1px solid #dee2e6;\n
        opacity: 0.7;\n
        transition: opacity 0.3s ease;\n
        pointer-events: none;\n
    }\n
    \n
    .global-search-container:focus-within .search-shortcut-hint {\n
        opacity: 0;\n
    }\n
[39;22m[39;1m</style>[39;22m[39;1m\n
\n
[39;22m[39;1m<script>[39;22m[39;1m\n
$(document).ready(function() {\n
    console.log('Global search script loaded');\n
    \n
    const searchInput = $('#global-search');\n
    const searchContainer = $('.global-search-container');\n
    \n
    console.log('Global search input found:', searchInput.length);\n
    console.log('Global search container found:', searchContainer.length);\n
    \n
    let searchTimeout;\n
    let selectedIndex = -1;\n
    let searchResults = [];\n
\n
    // Get CSRF token from meta tag\n
    const csrfToken = $('meta[name="csrf-token"]').attr('content');\n
    console.log('CSRF token:', csrfToken);\n
\n
    // Create dropdown container\n
    const dropdown = $('[39;22m[39;1m<div class="dropdown-menu w-100 mt-1" id="global-search-dropdown">[39;22m[39;1m</div>[39;22m[39;1m');\n
    searchContainer.append(dropdown);\n
    \n
    // Add keyboard shortcut hint\n
    const shortcutHint = $('[39;22m[39;1m<div class="search-shortcut-hint">[39;22m[39;1m⌘F[39;22m[39;1m</div>[39;22m[39;1m');\n
    searchContainer.append(shortcutHint);\n
\n
    // Global keyboard shortcut (Cmd+F or Ctrl+F)\n
    $(document).on('keydown', function(e) {\n
        // Check for Cmd+F (Mac) or Ctrl+F (Windows/Linux)\n
        if ((e.metaKey || e.ctrlKey) && e.key === 'f') {\n
            e.preventDefault(); // Prevent browser's find functionality\n
            searchInput.focus();\n
            searchInput.select(); // Select any existing text\n
        }\n
    });\n
\n
    // Handle input changes\n
    searchInput.on('input', function() {\n
        const query = $(this).val().trim();\n
        console.log('Global search input:', query);\n
        \n
        // Clear previous timeout\n
        clearTimeout(searchTimeout);\n
        \n
        // Hide dropdown if query is empty\n
        if (query.length === 0) {\n
            hideDropdown();\n
            return;\n
        }\n
\n
        // Debounce search requests\n
        searchTimeout = setTimeout(() => {\n
            performSearch(query);\n
        }, 300);\n
    });\n
\n
    // Handle keyboard navigation\n
    searchInput.on('keydown', function(e) {\n
        const dropdownVisible = $('#global-search-dropdown').is(':visible');\n
        \n
        switch(e.key) {\n
            case 'ArrowDown':\n
                e.preventDefault();\n
                if (dropdownVisible && searchResults.length > 0) {\n
                    selectNext();\n
                }\n
                break;\n
            case 'ArrowUp':\n
                e.preventDefault();\n
                if (dropdownVisible && searchResults.length > 0) {\n
                    selectPrevious();\n
                }\n
                break;\n
            case 'Enter':\n
                e.preventDefault();\n
                if (dropdownVisible && selectedIndex >= 0 && selectedIndex < searchResults.length) {\n
                    selectResult(searchResults[selectedIndex]);\n
                } else if (searchInput.val().trim()) {\n
                    // If no dropdown is visible but there's text, perform a search\n
                    performSearch(searchInput.val().trim());\n
                }\n
                break;\n
            case 'Escape':\n
                e.preventDefault();\n
                hideDropdown();\n
                searchInput.blur(); // Remove focus to collapse the search\n
                break;\n
        }\n
    });\n
\n
    // Handle clicks outside dropdown\n
    $(document).on('click', function(e) {\n
        if (!searchContainer.is(e.target) && searchContainer.has(e.target).length === 0) {\n
            hideDropdown();\n
        }\n
    });\n
\n
    // Perform search\n
    function performSearch(query) {\n
        console.log('Performing global search for:', query);\n
        \n
        $.ajax({\n
            url: '/spans/search',\n
            method: 'GET',\n
            data: { q: query },\n
            headers: {\n
                'X-CSRF-TOKEN': csrfToken,\n
                'Accept': 'application/json'\n
            }\n
        })\n
        .done(function(response) {\n
            console.log('Global search results:', response);\n
            // Handle both array response and object with spans property\n
            const results = Array.isArray(response) ? response : (response.spans || []);\n
            searchResults = results;\n
            displayResults(results);\n
        })\n
        .fail(function(xhr) {\n
            console.error('Global search failed:', xhr.responseText);\n
            console.error('Status:', xhr.status);\n
            hideDropdown();\n
        });\n
    }\n
\n
    // Display search results\n
    function displayResults(results) {\n
        const dropdown = $('#global-search-dropdown');\n
        dropdown.empty();\n
\n
        if (results.length === 0) {\n
            dropdown.append('[39;22m[39;1m<div class="dropdown-item text-muted">[39;22m[39;1mNo results found[39;22m[39;1m</div>[39;22m[39;1m');\n
        } else {\n
            results.forEach((result, index) => {\n
                const item = $(`\n
                    [39;22m[39;1m<div class="dropdown-item d-flex align-items-center gap-2" data-index="${index}">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-${getTypeIcon(result.type_id)} text-muted">[39;22m[39;1m</i>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="flex-grow-1">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="fw-medium">[39;22m[39;1m${result.name}[39;22m[39;1m</div>[39;22m[39;1m\n
                            [39;22m[39;1m<small class="text-muted">[39;22m[39;1m${result.type_name}[39;22m[39;1m</small>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                `);\n
                \n
                item.on('click', function() {\n
                    selectResult(result);\n
                });\n
                \n
                item.on('mouseenter', function() {\n
                    selectedIndex = index;\n
                    updateSelection();\n
                });\n
                \n
                dropdown.append(item);\n
            });\n
        }\n
\n
        dropdown.show();\n
        selectedIndex = -1;\n
    }\n
\n
    // Select next item\n
    function selectNext() {\n
        if (searchResults.length === 0) return;\n
        \n
        if (selectedIndex < searchResults.length - 1) {\n
            selectedIndex++;\n
        } else {\n
            // Wrap to first item\n
            selectedIndex = 0;\n
        }\n
        updateSelection();\n
    }\n
\n
    // Select previous item\n
    function selectPrevious() {\n
        if (searchResults.length === 0) return;\n
        \n
        if (selectedIndex > 0) {\n
            selectedIndex--;\n
        } else {\n
            // Wrap to last item\n
            selectedIndex = searchResults.length - 1;\n
        }\n
        updateSelection();\n
    }\n
\n
    // Update visual selection\n
    function updateSelection() {\n
        $('#global-search-dropdown .dropdown-item').removeClass('active');\n
        if (selectedIndex >= 0 && selectedIndex < searchResults.length) {\n
            $(`#global-search-dropdown .dropdown-item[data-index="${selectedIndex}"]`).addClass('active');\n
        }\n
    }\n
\n
    // Select a result\n
    function selectResult(result) {\n
        console.log('Selected global search result:', result);\n
        // Navigate to the span\n
        window.location.href = `/spans/${result.id}`;\n
    }\n
\n
    // Hide dropdown\n
    function hideDropdown() {\n
        $('#global-search-dropdown').hide();\n
        selectedIndex = -1;\n
    }\n
\n
    // Get icon for span type\n
    function getTypeIcon(typeId) {\n
        const icons = {\n
            'person': 'person-fill',\n
            'organisation': 'building',\n
            'place': 'geo-alt-fill',\n
            'event': 'calendar-event-fill',\n
            'connection': 'link-45deg',\n
            'band': 'cassette',\n
            'thing': 'box'\n
        };\n
        return icons[typeId] || 'box';\n
    }\n
});\n
[39;22m[39;1m</script>[39;22m[39;1m     \n
    <!-- New Span Button -->\n
            [39;22m[39;1m<div class="me-3" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Create a new span (⌘K)">[39;22m[39;1m\n
            [39;22m[39;1m<button type="button" class="btn btn-sm btn-primary" \n
                    data-bs-toggle="modal" data-bs-target="#newSpanModal" \n
                    id="new-span-btn">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-plus-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mNew\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
        \n
    <!-- Improve Span Button (only on span show pages) -->\n
                    \n
\n
    \n
    <!-- Custom User Dropdown -->\n
    [39;22m[39;1m<div class="position-relative" id="customUserDropdown">[39;22m[39;1m\n
        [39;22m[39;1m<button class="btn btn-sm btn-secondary" type="button" id="customUserDropdownToggle">[39;22m[39;1m\n
            [39;22m[39;1m<i class="bi bi-person-circle me-1">[39;22m[39;1m</i>[39;22m[39;1m                     \n
            [39;22m[39;1m<i class="bi bi-caret-down-fill ms-1">[39;22m[39;1m</i>[39;22m[39;1m\n
        [39;22m[39;1m</button>[39;22m[39;1m\n
        [39;22m[39;1m<div class="position-absolute end-0 mt-1 bg-white shadow rounded d-none user-dropdown-menu" id="customUserDropdownMenu">[39;22m[39;1m\n
            [39;22m[39;1m<div class="p-2">[39;22m[39;1m\n
                <!-- User Info -->\n
                [39;22m[39;1m<div class="px-2 py-1 mb-2 border-bottom">[39;22m[39;1m\n
                                            [39;22m[39;1m<a href="http://localhost:8000/spans/9f59d5dd-68d0-482a-af09-4129e3e82379" \n
   class="text-decoration-none d-inline-flex align-items-center gap-1 text-person">[39;22m[39;1m\n
    [39;22m[39;1m<i class="bi bi-person-fill">[39;22m[39;1m</i>[39;22m[39;1m     Test User 9f59d5dd-674f-4d82-8634-ea3a7f9ecdd0\n
[39;22m[39;1m</a>[39;22m[39;1m                                         [39;22m[39;1m<div class="small text-muted">[39;22m[39;1muser_686ea5e198e2d@example.org[39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                \n
                <!-- Menu Items -->\n
                [39;22m[39;1m<a href="http://localhost:8000/profile" class="d-block p-2 text-decoration-none text-dark rounded hover-bg-light">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-person me-2">[39;22m[39;1m</i>[39;22m[39;1mYour Account\n
                [39;22m[39;1m</a>[39;22m[39;1m\n
                \n
                                \n
                                \n
                [39;22m[39;1m<hr class="my-2">[39;22m[39;1m\n
                \n
                [39;22m[39;1m<form method="POST" action="http://localhost:8000/logout">[39;22m[39;1m\n
                    [39;22m[39;1m<input type="hidden" name="_token" value="kXfgiKCYxENBtwlsStlvZRbOjkcAnN9trXxYKadw" autocomplete="off">[39;22m[39;1m                    [39;22m[39;1m<button type="submit" class="d-block w-100 text-start p-2 border-0 bg-transparent text-danger rounded hover-bg-light">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-box-arrow-right me-2">[39;22m[39;1m</i>[39;22m[39;1mSign Out\n
                    [39;22m[39;1m</button>[39;22m[39;1m\n
                [39;22m[39;1m</form>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m\n
\n
\n
\n
[39;22m[39;1m<script>[39;22m[39;1m\n
$(document).ready(function() {\n
    // Global keyboard shortcuts\n
    $(document).on('keydown', function(e) {\n
        // Check for Cmd+K (Mac) or Ctrl+K (Windows/Linux) - New Span\n
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {\n
            e.preventDefault(); // Prevent any potential conflicts\n
            \n
            // Check if user is authenticated and button exists\n
            const newSpanBtn = document.getElementById('new-span-btn');\n
            if (newSpanBtn) {\n
                newSpanBtn.click();\n
            }\n
        }\n
        \n
        // Check for Cmd+I (Mac) or Ctrl+I (Windows/Linux) - Improve Span\n
        if ((e.metaKey || e.ctrlKey) && e.key === 'i') {\n
            e.preventDefault(); // Prevent any potential conflicts\n
            \n
            // Check if user is authenticated and improve button exists\n
            const improveSpanBtn = document.getElementById('improve-span-btn');\n
            if (improveSpanBtn) {\n
                improveSpanBtn.click();\n
            }\n
        }\n
    });\n
    \n
    // Initialize Bootstrap tooltips\n
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));\n
    tooltipTriggerList.map(function (tooltipTriggerEl) {\n
        return new bootstrap.Tooltip(tooltipTriggerEl);\n
    });\n
});\n
[39;22m[39;1m</script>[39;22m[39;1m                             [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                        \n
                        <!-- Page Content -->\n
                        [39;22m[39;1m<div class="py-3 px-3">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="header-section mb-4">[39;22m[39;1m\n
                                                                                            [39;22m[39;1m</div>[39;22m[39;1m\n
                            <!-- Create New Span Button -->\n
<!-- [39;22m[39;1m<div class="container-fluid mb-3">[39;22m[39;1m\n
    [39;22m[39;1m<div class="row">[39;22m[39;1m\n
        [39;22m[39;1m<div class="col-12">[39;22m[39;1m\n
            [39;22m[39;1m<div class="card border-primary">[39;22m[39;1m\n
                [39;22m[39;1m<div class="card-body p-3">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="d-flex justify-content-between align-items-center">[39;22m[39;1m\n
                        [39;22m[39;1m<div>[39;22m[39;1m\n
                            [39;22m[39;1m<h6 class="card-title mb-1">[39;22m[39;1m\n
                                [39;22m[39;1m<i class="bi bi-plus-circle me-2">[39;22m[39;1m</i>[39;22m[39;1mCreate New Span\n
                            [39;22m[39;1m</h6>[39;22m[39;1m\n
                            [39;22m[39;1m<p class="card-text small text-muted mb-0">[39;22m[39;1m\n
                                Start with a blank YAML template and create a new span from scratch\n
                            [39;22m[39;1m</p>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="d-flex gap-2 align-items-center">[39;22m[39;1m\n
                            [39;22m[39;1m<input type="text" class="form-control form-control-sm" id="new-span-name-input" \n
                                   placeholder="Enter name..." style="width: 200px;">[39;22m[39;1m\n
                            [39;22m[39;1m<select class="form-select form-select-sm" id="new-span-type-selector" style="width: auto;">[39;22m[39;1m\n
                                [39;22m[39;1m<option value="">[39;22m[39;1mSelect type...[39;22m[39;1m</option>[39;22m[39;1m\n
                                                                    [39;22m[39;1m<option value="thing">[39;22m[39;1mThing[39;22m[39;1m</option>[39;22m[39;1m\n
                                                                    [39;22m[39;1m<option value="organisation">[39;22m[39;1mOrganisation[39;22m[39;1m</option>[39;22m[39;1m\n
                                                                    [39;22m[39;1m<option value="place">[39;22m[39;1mPlace[39;22m[39;1m</option>[39;22m[39;1m\n
                                                                    [39;22m[39;1m<option value="person">[39;22m[39;1mPerson[39;22m[39;1m</option>[39;22m[39;1m\n
                                                                    [39;22m[39;1m<option value="event">[39;22m[39;1mEvent[39;22m[39;1m</option>[39;22m[39;1m\n
                                                                    [39;22m[39;1m<option value="band">[39;22m[39;1mBand[39;22m[39;1m</option>[39;22m[39;1m\n
                                                                    [39;22m[39;1m<option value="connection">[39;22m[39;1mConnection[39;22m[39;1m</option>[39;22m[39;1m\n
                                                                    [39;22m[39;1m<option value="phase">[39;22m[39;1mPhase[39;22m[39;1m</option>[39;22m[39;1m\n
                                                                    [39;22m[39;1m<option value="role">[39;22m[39;1mRole[39;22m[39;1m</option>[39;22m[39;1m\n
                                                                    [39;22m[39;1m<option value="set">[39;22m[39;1mSet[39;22m[39;1m</option>[39;22m[39;1m\n
                                                            [39;22m[39;1m</select>[39;22m[39;1m\n
                            [39;22m[39;1m<button type="button" id="create-new-span-btn" class="btn btn-primary btn-sm" disabled>[39;22m[39;1m\n
                                [39;22m[39;1m<i class="bi bi-plus-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mCreate New Span\n
                            [39;22m[39;1m</button>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m -->\n
\n
[39;22m[39;1m<div class="container-fluid">[39;22m[39;1m\n
    [39;22m[39;1m<div class="row">[39;22m[39;1m\n
        <!-- Left column: YAML Editor -->\n
        [39;22m[39;1m<div class="col-lg-3">[39;22m[39;1m\n
            [39;22m[39;1m<div class="card h-100">[39;22m[39;1m\n
                [39;22m[39;1m<div class="card-header d-flex justify-content-between align-items-center">[39;22m[39;1m\n
                    [39;22m[39;1m<h5 class="card-title mb-0">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-code-square me-2">[39;22m[39;1m</i>[39;22m[39;1mYAML Editor\n
                    [39;22m[39;1m</h5>[39;22m[39;1m\n
                    [39;22m[39;1m<div class="d-flex gap-2 align-items-center">[39;22m[39;1m\n
                        [39;22m[39;1m<span id="validation-status" class="badge bg-secondary">[39;22m[39;1mReady[39;22m[39;1m</span>[39;22m[39;1m\n
                        [39;22m[39;1m<button type="button" id="validate-btn" class="btn btn-sm btn-outline-primary" style="display: none;">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-check-square me-1">[39;22m[39;1m</i>[39;22m[39;1mValidate\n
                        [39;22m[39;1m</button>[39;22m[39;1m\n
                        [39;22m[39;1m<span id="char-count" class="text-muted small">[39;22m[39;1m0 characters[39;22m[39;1m</span>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<div class="card-body p-0 yaml-editor-container">[39;22m[39;1m\n
                    [39;22m[39;1m<textarea \n
                        id="yaml-content" \n
                        class="form-control yaml-textarea h-100 border-0 rounded-0"\n
                        placeholder="Loading YAML content..."\n
                        style="resize: none; font-size: 12px;"\n
                    >[39;22m[39;1mname: &#039;John Doe&#039;\n
type: person\n
state: placeholder\n
description: &#039;New description from AI&#039;\n
metadata:\n
  occupation: &#039;Software Developer&#039;\n
sources:\n
  - &#039;AI Generated&#039;[39;22m[39;1m</textarea>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
        \n
        <!-- Middle column: Visual Translation -->\n
        [39;22m[39;1m<div class="col-lg-6">[39;22m[39;1m\n
            [39;22m[39;1m<div class="middle-column">[39;22m[39;1m\n
                <!-- Combined Analysis Card -->\n
                [39;22m[39;1m<div class="card mb-2">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card-header">[39;22m[39;1m\n
                        [39;22m[39;1m<h6 class="card-title mb-0">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-check-circle me-2">[39;22m[39;1m</i>[39;22m[39;1mWhat happened?\n
                        [39;22m[39;1m</h6>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card-body p-3">[39;22m[39;1m\n
                        [39;22m[39;1m<div id="validation-results">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="text-muted">[39;22m[39;1m\n
                                [39;22m[39;1m<i class="bi bi-info-circle me-1">[39;22m[39;1m</i>[39;22m[39;1m\n
                                Make changes to see validation results\n
                            [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                        \n
                        [39;22m[39;1m<div id="changes-summary" class="mt-3" style="display: none;">[39;22m[39;1m\n
                            [39;22m[39;1m<h6 class="text-primary mb-2">[39;22m[39;1m\n
                                [39;22m[39;1m<i class="bi bi-list-check me-1">[39;22m[39;1m</i>[39;22m[39;1mChanges Summary\n
                            [39;22m[39;1m</h6>[39;22m[39;1m\n
                            [39;22m[39;1m<div id="changes-list">[39;22m[39;1m\n
                                <!-- Changes will be listed here -->\n
                            [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                        \n
                        [39;22m[39;1m<div id="impact-results" class="mt-3" style="display: none;">[39;22m[39;1m\n
                            <!-- Impact analysis will appear here -->\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
\n
                <!-- Visual Translation Card -->\n
                [39;22m[39;1m<div class="card" id="translation-card">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card-header">[39;22m[39;1m\n
                        [39;22m[39;1m<h6 class="card-title mb-0">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-eye me-2">[39;22m[39;1m</i>[39;22m[39;1mVisual Translation\n
                        [39;22m[39;1m</h6>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card-body p-3">[39;22m[39;1m\n
                        [39;22m[39;1m<div id="visual-translation" style="font-size: 1rem; line-height: 1.5;">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="text-muted">[39;22m[39;1m\n
                                [39;22m[39;1m<i class="bi bi-info-circle me-1">[39;22m[39;1m</i>[39;22m[39;1m\n
                                Visual translation will appear here when YAML is valid\n
                            [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
        \n
        <!-- Right column: Tools & Information -->\n
        [39;22m[39;1m<div class="col-lg-3">[39;22m[39;1m\n
            \n
            <!-- Warning Card -->\n
            [39;22m[39;1m<div class="card mb-3 border-danger">[39;22m[39;1m\n
                [39;22m[39;1m<div class="card-header bg-danger text-white">[39;22m[39;1m\n
                    [39;22m[39;1m<h6 class="card-title mb-0">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-exclamation-triangle me-2">[39;22m[39;1m</i>[39;22m[39;1mMade you look!\n
                    [39;22m[39;1m</h6>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<div class="card-body">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="mb-0 py-2">[39;22m[39;1m\n
                        [39;22m[39;1m<p>[39;22m[39;1mThis is an [39;22m[39;1m<strong>[39;22m[39;1mexperimental feature[39;22m[39;1m</strong>[39;22m[39;1m.[39;22m[39;1m</p>[39;22m[39;1m\n
                        [39;22m[39;1m<p>[39;22m[39;1mThings may break a bit. Or a lot.[39;22m[39;1m</p>[39;22m[39;1m\n
                        [39;22m[39;1m<p>[39;22m[39;1mBe gentle.[39;22m[39;1m</p>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            <!-- YAML Tools -->\n
            [39;22m[39;1m<div class="card mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<div class="card-header">[39;22m[39;1m\n
                    [39;22m[39;1m<h6 class="card-title mb-0">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-tools me-2">[39;22m[39;1m</i>[39;22m[39;1m Tools\n
                    [39;22m[39;1m</h6>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<div class="card-body">[39;22m[39;1m                   \n
                    [39;22m[39;1m<div class="mb-3">[39;22m[39;1m\n
                        [39;22m[39;1m<label class="form-label small mb-1">[39;22m[39;1mAdd Connection:[39;22m[39;1m</label>[39;22m[39;1m\n
                                                [39;22m[39;1m<div class="alert alert-info py-2 mb-0">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-info-circle me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                            [39;22m[39;1m<small>[39;22m[39;1mConnection tools will be available after the span is created.[39;22m[39;1m</small>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                                            [39;22m[39;1m</div>[39;22m[39;1m\n
                    \n
                    [39;22m[39;1m<div class="mb-3">[39;22m[39;1m\n
                        [39;22m[39;1m<label class="form-label small mb-1">[39;22m[39;1mAdd Metadata Field:[39;22m[39;1m</label>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="row g-2">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="col-8">[39;22m[39;1m\n
                                [39;22m[39;1m<input type="text" class="form-control form-control-sm" id="metadata-key-input" placeholder="Field name...">[39;22m[39;1m\n
                            [39;22m[39;1m</div>[39;22m[39;1m\n
                            [39;22m[39;1m<div class="col-4">[39;22m[39;1m\n
                                [39;22m[39;1m<button class="btn btn-outline-secondary btn-sm w-100" onclick="addMetadataField()">[39;22m[39;1m\n
                                    [39;22m[39;1m<i class="bi bi-plus">[39;22m[39;1m</i>[39;22m[39;1m\n
                                [39;22m[39;1m</button>[39;22m[39;1m\n
                            [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                    \n
                    [39;22m[39;1m<div class="mb-3">[39;22m[39;1m\n
                        [39;22m[39;1m<label class="form-label small mb-1">[39;22m[39;1mQuick Actions:[39;22m[39;1m</label>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="d-grid gap-1">[39;22m[39;1m\n
                            [39;22m[39;1m<button class="btn btn-outline-info btn-sm" onclick="addDateFields()">[39;22m[39;1m\n
                                [39;22m[39;1m<i class="bi bi-calendar-range me-1">[39;22m[39;1m</i>[39;22m[39;1mAdd Start/End Dates\n
                            [39;22m[39;1m</button>[39;22m[39;1m\n
                            [39;22m[39;1m<button class="btn btn-outline-success btn-sm" onclick="addCustomFields()">[39;22m[39;1m\n
                                [39;22m[39;1m<i class="bi bi-gear me-1">[39;22m[39;1m</i>[39;22m[39;1mAdd Custom Fields\n
                            [39;22m[39;1m</button>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            <!-- Incoming Connections Panel -->\n
                        \n
            <!-- Merge Detection Section -->\n
                        \n
            <!-- Apply Changes Section -->\n
            [39;22m[39;1m<div class="card">[39;22m[39;1m\n
                [39;22m[39;1m<div class="card-header">[39;22m[39;1m\n
                    [39;22m[39;1m<h6 class="card-title mb-0">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-cloud-upload me-2">[39;22m[39;1m</i>[39;22m[39;1mNow what?\n
                    [39;22m[39;1m</h6>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<div class="card-body">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="alert alert-warning d-flex align-items-center py-2 mb-3">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-exclamation-triangle-fill me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                        [39;22m[39;1m<small>[39;22m[39;1mThe span will be created when you apply the YAML to the database.[39;22m[39;1m</small>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m<div class="d-grid gap-2">[39;22m[39;1m\n
                        [39;22m[39;1m<button type="button" id="apply-btn" class="btn btn-success" disabled>[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-cloud-upload me-2">[39;22m[39;1m</i>[39;22m[39;1mCreate Span from YAML\n
                        [39;22m[39;1m</button>[39;22m[39;1m\n
                                            [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m\n
\n
<!-- Validation Results -->\n
[39;22m[39;1m<div id="validation-results">[39;22m[39;1m</div>[39;22m[39;1m\n
\n
<!-- Debug Info (admin only) -->\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                \n
                <!-- Subtle Sidebar Toggle Button -->\n
                [39;22m[39;1m<button id="sidebar-toggle" class="sidebar-toggle-btn" type="button" title="Toggle Sidebar">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-chevron-left">[39;22m[39;1m</i>[39;22m[39;1m\n
                [39;22m[39;1m</button>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
        \n
        <!-- Modals -->\n
                \n
        <!-- Global Access Level Modal -->\n
        <!-- Access Level Selection Modal -->\n
[39;22m[39;1m<div class="modal fade" id="accessLevelModal" tabindex="-1" aria-labelledby="accessLevelModalLabel" aria-hidden="true">[39;22m[39;1m\n
    [39;22m[39;1m<div class="modal-dialog">[39;22m[39;1m\n
        [39;22m[39;1m<div class="modal-content">[39;22m[39;1m\n
            [39;22m[39;1m<div class="modal-header">[39;22m[39;1m\n
                [39;22m[39;1m<h5 class="modal-title" id="accessLevelModalLabel">[39;22m[39;1mChange Access Level[39;22m[39;1m</h5>[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">[39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m<div class="modal-body">[39;22m[39;1m\n
                [39;22m[39;1m<p class="text-muted mb-3">[39;22m[39;1mSelect the new access level for this item:[39;22m[39;1m</p>[39;22m[39;1m\n
                \n
                [39;22m[39;1m<div class="form-check mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<input class="form-check-input" type="radio" name="accessLevel" id="accessPrivate" value="private">[39;22m[39;1m\n
                    [39;22m[39;1m<label class="form-check-label d-flex align-items-center" for="accessPrivate">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-lock text-danger me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                        [39;22m[39;1m<div>[39;22m[39;1m\n
                            [39;22m[39;1m<strong>[39;22m[39;1mPrivate[39;22m[39;1m</strong>[39;22m[39;1m\n
                            [39;22m[39;1m<div class="text-muted small">[39;22m[39;1mOnly you can see this item[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</label>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                \n
                [39;22m[39;1m<div class="form-check mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<input class="form-check-input" type="radio" name="accessLevel" id="accessShared" value="shared">[39;22m[39;1m\n
                    [39;22m[39;1m<label class="form-check-label d-flex align-items-center" for="accessShared">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-people text-warning me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                        [39;22m[39;1m<div>[39;22m[39;1m\n
                            [39;22m[39;1m<strong>[39;22m[39;1mShared[39;22m[39;1m</strong>[39;22m[39;1m\n
                            [39;22m[39;1m<div class="text-muted small">[39;22m[39;1mVisible to people you've shared with[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</label>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                \n
                [39;22m[39;1m<div class="form-check mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<input class="form-check-input" type="radio" name="accessLevel" id="accessPublic" value="public">[39;22m[39;1m\n
                    [39;22m[39;1m<label class="form-check-label d-flex align-items-center" for="accessPublic">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-globe text-success me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                        [39;22m[39;1m<div>[39;22m[39;1m\n
                            [39;22m[39;1m<strong>[39;22m[39;1mPublic[39;22m[39;1m</strong>[39;22m[39;1m\n
                            [39;22m[39;1m<div class="text-muted small">[39;22m[39;1mVisible to everyone[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</label>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m<div class="modal-footer">[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">[39;22m[39;1mCancel[39;22m[39;1m</button>[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn btn-primary" id="confirmAccessLevel">[39;22m[39;1mConfirm Change[39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m         \n
        <!-- Consent Banner -->\n
                \n
        <!-- Global Sets Modal -->\n
        <!-- Sets Management Modal -->\n
[39;22m[39;1m<div class="modal fade" id="setsModal" tabindex="-1" aria-labelledby="setsModalLabel" aria-hidden="true">[39;22m[39;1m\n
    [39;22m[39;1m<div class="modal-dialog modal-lg">[39;22m[39;1m\n
        [39;22m[39;1m<div class="modal-content">[39;22m[39;1m\n
            [39;22m[39;1m<div class="modal-header">[39;22m[39;1m\n
                [39;22m[39;1m<h5 class="modal-title" id="setsModalLabel">[39;22m[39;1mAdd to Set[39;22m[39;1m</h5>[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">[39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m<div class="modal-body">[39;22m[39;1m\n
                [39;22m[39;1m<div id="setsModalContent">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="text-center">[39;22m[39;1m\n
                        [39;22m[39;1m<div class="spinner-border text-primary" role="status">[39;22m[39;1m\n
                            [39;22m[39;1m<span class="visually-hidden">[39;22m[39;1mLoading...[39;22m[39;1m</span>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m<p class="mt-2 text-muted">[39;22m[39;1mLoading sets...[39;22m[39;1m</p>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m<div class="modal-footer">[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">[39;22m[39;1mClose[39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m         \n
        <!-- New Span Modal -->\n
        <!-- New Span Modal -->\n
[39;22m[39;1m<div class="modal fade" id="newSpanModal" tabindex="-1" aria-labelledby="newSpanModalLabel" aria-hidden="true">[39;22m[39;1m\n
    [39;22m[39;1m<div class="modal-dialog modal-md">[39;22m[39;1m\n
        [39;22m[39;1m<div class="modal-content">[39;22m[39;1m\n
            [39;22m[39;1m<div class="modal-header border-bottom">[39;22m[39;1m\n
                [39;22m[39;1m<h5 class="modal-title fw-bold" id="newSpanModalLabel">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-plus-circle me-2 text-primary">[39;22m[39;1m</i>[39;22m[39;1mCreate New Span\n
                [39;22m[39;1m</h5>[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">[39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            <!-- Dynamic content area -->\n
            [39;22m[39;1m<div class="modal-body" id="modal-content">[39;22m[39;1m\n
                <!-- Content will be dynamically replaced -->\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
\n
            [39;22m[39;1m<div class="modal-footer border-top" id="modal-footer">[39;22m[39;1m\n
                <!-- Footer will be dynamically replaced -->\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        [39;22m[39;1m</div>[39;22m[39;1m\n
    [39;22m[39;1m</div>[39;22m[39;1m\n
[39;22m[39;1m</div>[39;22m[39;1m\n
\n
[39;22m[39;1m<style>[39;22m[39;1m\n
    /* Custom modal styling */\n
    #newSpanModal .modal-content {\n
        border: none;\n
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);\n
        border-radius: 0.75rem;\n
    }\n
    \n
    #newSpanModal .modal-header {\n
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);\n
        border-radius: 0.75rem 0.75rem 0 0;\n
        padding: 1rem 1.5rem;\n
    }\n
    \n
    #newSpanModal .modal-body {\n
        padding: 1.5rem;\n
    }\n
    \n
    #newSpanModal .modal-footer {\n
        padding: 1rem 1.5rem;\n
        background-color: #f8f9fa;\n
        border-radius: 0 0 0.75rem 0.75rem;\n
        display: flex;\n
        justify-content: space-between;\n
        align-items: flex-start;\n
    }\n
    \n
    #newSpanModal .form-label {\n
        color: #495057;\n
        margin-bottom: 0.5rem;\n
        font-size: 0.9rem;\n
    }\n
    \n
    #newSpanModal .form-control,\n
    #newSpanModal .form-select {\n
        border-radius: 0.5rem;\n
        border: 1px solid #dee2e6;\n
        transition: all 0.2s ease;\n
        font-size: 0.9rem;\n
    }\n
    \n
    #newSpanModal .form-control:focus,\n
    #newSpanModal .form-select:focus {\n
        border-color: #0d6efd;\n
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);\n
    }\n
    \n
    #newSpanModal .btn {\n
        border-radius: 0.5rem;\n
        font-weight: 500;\n
        transition: all 0.2s ease;\n
        font-size: 0.9rem;\n
    }\n
    \n
    #newSpanModal .btn-primary {\n
        background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);\n
        border: none;\n
    }\n
    \n
    #newSpanModal .btn-primary:hover {\n
        background: linear-gradient(135deg, #0b5ed7 0%, #0a58ca 100%);\n
        transform: translateY(-1px);\n
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);\n
    }\n
    \n
    /* Button group styling */\n
    #newSpanModal .btn-group {\n
        border-radius: 0.5rem;\n
        overflow: hidden;\n
    }\n
    \n
    #newSpanModal .btn-group .btn {\n
        border: 1px solid #dee2e6;\n
        border-radius: 0;\n
        transition: all 0.2s ease;\n
        font-weight: 500;\n
        font-size: 0.8rem;\n
        padding: 0.375rem 0.75rem;\n
    }\n
    \n
    #newSpanModal .btn-group .btn:first-child {\n
        border-top-left-radius: 0.5rem;\n
        border-bottom-left-radius: 0.5rem;\n
    }\n
    \n
    #newSpanModal .btn-group .btn:last-child {\n
        border-top-right-radius: 0.5rem;\n
        border-bottom-right-radius: 0.5rem;\n
    }\n
    \n
    #newSpanModal .btn-group .btn:hover {\n
        background-color: #e9ecef;\n
        border-color: #adb5bd;\n
    }\n
    \n
    #newSpanModal .btn-group .btn-check:checked + .btn {\n
        background-color: #0d6efd;\n
        border-color: #0d6efd;\n
        color: white;\n
    }\n
    \n
    #newSpanModal .btn-group.is-invalid {\n
        border: 1px solid #dc3545;\n
    }\n
    \n
    #newSpanModal .btn-group.is-invalid .btn {\n
        border-color: #dc3545;\n
    }\n
    \n
    /* Card selection styling */\n
    #newSpanModal .card {\n
        cursor: pointer;\n
        transition: all 0.2s ease;\n
        border: 2px solid #dee2e6;\n
        border-radius: 0.5rem;\n
    }\n
    \n
    #newSpanModal .card:hover {\n
        border-color: #0d6efd;\n
        transform: translateY(-2px);\n
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);\n
    }\n
    \n
    #newSpanModal .card.selected {\n
        border-color: #0d6efd;\n
        background-color: #f8f9ff;\n
    }\n
    \n
    #newSpanModal .card-body {\n
        padding: 1rem;\n
    }\n
    \n
    /* Badge styling */\n
    #newSpanModal .badge {\n
        font-size: 0.75rem;\n
        padding: 0.5rem 0.75rem;\n
    }\n
    \n
    /* Alert styling */\n
    #newSpanModal .alert {\n
        border-radius: 0.5rem;\n
        font-size: 0.85rem;\n
    }\n
    \n
    /* Responsive adjustments */\n
    @media (max-width: 768px) {\n
        #newSpanModal .modal-body {\n
            padding: 1rem;\n
        }\n
        \n
        #newSpanModal .modal-footer {\n
            padding: 0.75rem 1rem;\n
        }\n
    }\n
[39;22m[39;1m</style>[39;22m[39;1m\n
\n
[39;22m[39;1m<script>[39;22m[39;1m\n
$(document).ready(function() {\n
    let currentStep = 1;\n
    let aiData = null;\n
    let selectedCreationMethod = null;\n
    let formData = {};\n
    let isImproveMode = false;\n
    \n
    // Get timeless span types from the server\n
    const timelessSpanTypes = ["place","role","set"];\n
    \n
    // Handle Improve button click\n
    $('#improve-span-btn').on('click', function() {\n
        isImproveMode = true;\n
        const spanName = $(this).data('span-name');\n
        const spanType = $(this).data('span-type');\n
        \n
        // Prefill the form data\n
        formData.name = spanName;\n
        formData.type_id = spanType;\n
        \n
        // Update modal title\n
        $('#newSpanModalLabel').html('[39;22m[39;1m<i class="bi bi-magic me-2 text-success">[39;22m[39;1m</i>[39;22m[39;1mImprove Span');\n
        \n
        // For people, skip directly to the creation method selection\n
        if (spanType === 'person') {\n
            // Show step 1 first to set up the form, then immediately go to step 2\n
            showStep(1);\n
            setTimeout(() => {\n
                showStep(2);\n
            }, 100);\n
        }\n
    });\n
    \n
    // Handle New button click (reset improve mode)\n
    $('#new-span-btn').on('click', function() {\n
        isImproveMode = false;\n
        formData = {};\n
        $('#newSpanModalLabel').html('[39;22m[39;1m<i class="bi bi-plus-circle me-2 text-primary">[39;22m[39;1m</i>[39;22m[39;1mCreate New Span');\n
    });\n
    \n
    // Reset modal state when closed\n
    $('#newSpanModal').on('hidden.bs.modal', function() {\n
        isImproveMode = false;\n
        currentStep = 1;\n
        aiData = null;\n
        selectedCreationMethod = null;\n
        formData = {};\n
        $('#newSpanModalLabel').html('[39;22m[39;1m<i class="bi bi-plus-circle me-2 text-primary">[39;22m[39;1m</i>[39;22m[39;1mCreate New Span');\n
    });\n
    \n
    // Step content templates\n
    const stepContent = {\n
        1: `\n
            [39;22m[39;1m<div class="text-center mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<div class="badge bg-primary mb-2">[39;22m[39;1mStep 1 of 3[39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<h6 class="text-muted">[39;22m[39;1mBasic Information[39;22m[39;1m</h6>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            [39;22m[39;1m<div class="mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<label for="modal_name" class="form-label fw-medium">[39;22m[39;1mName [39;22m[39;1m<span class="text-danger">[39;22m[39;1m*[39;22m[39;1m</span>[39;22m[39;1m</label>[39;22m[39;1m\n
                [39;22m[39;1m<input type="text" class="form-control" \n
                       id="modal_name" name="name" required \n
                       placeholder="Enter span name...">[39;22m[39;1m\n
                [39;22m[39;1m<div class="invalid-feedback" id="name-error">[39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
\n
            [39;22m[39;1m<div class="mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<label for="modal_type_id" class="form-label fw-medium">[39;22m[39;1mType [39;22m[39;1m<span class="text-danger">[39;22m[39;1m*[39;22m[39;1m</span>[39;22m[39;1m</label>[39;22m[39;1m\n
                [39;22m[39;1m<select class="form-select" id="modal_type_id" name="type_id" required>[39;22m[39;1m\n
                    [39;22m[39;1m<option value="">[39;22m[39;1mChoose a type...[39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="thing">[39;22m[39;1m\n
                            Thing\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="organisation">[39;22m[39;1m\n
                            Organisation\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="place">[39;22m[39;1m\n
                            Place\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="person">[39;22m[39;1m\n
                            Person\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="event">[39;22m[39;1m\n
                            Event\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="band">[39;22m[39;1m\n
                            Band\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="connection">[39;22m[39;1m\n
                            Connection\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="phase">[39;22m[39;1m\n
                            Phase\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="role">[39;22m[39;1m\n
                            Role\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                            [39;22m[39;1m<option value="set">[39;22m[39;1m\n
                            Set\n
                        [39;22m[39;1m</option>[39;22m[39;1m\n
                                    [39;22m[39;1m</select>[39;22m[39;1m\n
                [39;22m[39;1m<div class="invalid-feedback" id="type_id-error">[39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `,\n
        \n
        2: `\n
            [39;22m[39;1m<div class="text-center mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<div class="badge bg-primary mb-2">[39;22m[39;1mStep 2 of 3[39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<h6 class="text-muted">[39;22m[39;1mCreate Person[39;22m[39;1m</h6>[39;22m[39;1m\n
                [39;22m[39;1m<p class="text-muted small">[39;22m[39;1mHow would you like to create this person?[39;22m[39;1m</p>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            [39;22m[39;1m<div class="row g-3">[39;22m[39;1m\n
                [39;22m[39;1m<div class="col-6">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card h-100 border-2" id="create-manual-card" \n
                         tabindex="2" role="button" aria-label="Create manually - fill in all details yourself"\n
                         onkeydown="if(event.key === 'Enter' || event.key === ' ') { event.preventDefault(); $(this).click(); }">[39;22m[39;1m\n
                        [39;22m[39;1m<div class="card-body text-center p-3">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-pencil-square text-primary mb-2" style="font-size: 1.5rem;">[39;22m[39;1m</i>[39;22m[39;1m\n
                            [39;22m[39;1m<h6 class="card-title mb-1">[39;22m[39;1mCreate Manually[39;22m[39;1m</h6>[39;22m[39;1m\n
                            [39;22m[39;1m<p class="card-text text-muted small mb-0">[39;22m[39;1mFill in all the details yourself[39;22m[39;1m</p>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<div class="col-6">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card h-100 border-2" id="create-ai-card" \n
                         tabindex="1" role="button" aria-label="Use AI to create - AI will research and fill in details" autofocus\n
                         onkeydown="if(event.key === 'Enter' || event.key === ' ') { event.preventDefault(); $(this).click(); }">[39;22m[39;1m\n
                        [39;22m[39;1m<div class="card-body text-center p-3">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-robot text-success mb-2" style="font-size: 1.5rem;">[39;22m[39;1m</i>[39;22m[39;1m\n
                            [39;22m[39;1m<h6 class="card-title mb-1">[39;22m[39;1mUse AI to Create[39;22m[39;1m</h6>[39;22m[39;1m\n
                            [39;22m[39;1m<p class="card-text text-muted small mb-0">[39;22m[39;1mAI will research and fill in details[39;22m[39;1m</p>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `,\n
        \n
        3: `\n
            [39;22m[39;1m<div class="text-center mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<div class="badge bg-primary mb-2">[39;22m[39;1mStep 3 of 3[39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<h6 class="text-muted">[39;22m[39;1mAdditional Details[39;22m[39;1m</h6>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            [39;22m[39;1m<form id="new-span-form">[39;22m[39;1m\n
                [39;22m[39;1m<div class="mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<label class="form-label fw-medium">[39;22m[39;1mStart Date[39;22m[39;1m</label>[39;22m[39;1m\n
                    [39;22m[39;1m<div class="row g-2">[39;22m[39;1m\n
                        [39;22m[39;1m<div class="col-4">[39;22m[39;1m\n
                            [39;22m[39;1m<input type="number" class="form-control form-control-sm" \n
                                   id="modal_start_year" name="start_year"\n
                                   placeholder="Year">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="invalid-feedback" id="start_year-error">[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="col-4">[39;22m[39;1m\n
                            [39;22m[39;1m<input type="number" class="form-control form-control-sm" \n
                                   id="modal_start_month" name="start_month" min="1" max="12"\n
                                   placeholder="Month">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="invalid-feedback" id="start_month-error">[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="col-4">[39;22m[39;1m\n
                            [39;22m[39;1m<input type="number" class="form-control form-control-sm" \n
                                   id="modal_start_day" name="start_day" min="1" max="31"\n
                                   placeholder="Day">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="invalid-feedback" id="start_day-error">[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
\n
                [39;22m[39;1m<div class="mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<label class="form-label fw-medium">[39;22m[39;1mEnd Date[39;22m[39;1m</label>[39;22m[39;1m\n
                    [39;22m[39;1m<div class="row g-2">[39;22m[39;1m\n
                        [39;22m[39;1m<div class="col-4">[39;22m[39;1m\n
                            [39;22m[39;1m<input type="number" class="form-control form-control-sm" \n
                                   id="modal_end_year" name="end_year"\n
                                   placeholder="Year">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="invalid-feedback" id="end_year-error">[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="col-4">[39;22m[39;1m\n
                            [39;22m[39;1m<input type="number" class="form-control form-control-sm" \n
                                   id="modal_end_month" name="end_month" min="1" max="12"\n
                                   placeholder="Month">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="invalid-feedback" id="end_month-error">[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m<div class="col-4">[39;22m[39;1m\n
                            [39;22m[39;1m<input type="number" class="form-control form-control-sm" \n
                                   id="modal_end_day" name="end_day" min="1" max="31"\n
                                   placeholder="Day">[39;22m[39;1m\n
                            [39;22m[39;1m<div class="invalid-feedback" id="end_day-error">[39;22m[39;1m</div>[39;22m[39;1m\n
                        [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                    \n
                    [39;22m[39;1m<small class="text-muted">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-info-circle me-1">[39;22m[39;1m</i>[39;22m[39;1m\n
                        Leave dates empty for timeless spans or placeholders\n
                    [39;22m[39;1m</small>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</form>[39;22m[39;1m\n
        `,\n
        \n
        4: `\n
            [39;22m[39;1m<div class="text-center">[39;22m[39;1m\n
                [39;22m[39;1m<div class="spinner-border text-primary mb-3" role="status">[39;22m[39;1m\n
                    [39;22m[39;1m<span class="visually-hidden">[39;22m[39;1mLoading...[39;22m[39;1m</span>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<h6 class="text-muted mb-2">[39;22m[39;1mAI is doing its thing...[39;22m[39;1m</h6>[39;22m[39;1m\n
                [39;22m[39;1m<p class="text-muted small">[39;22m[39;1mFinding out about [39;22m[39;1m<span id="ai-person-name">[39;22m[39;1m</span>[39;22m[39;1m</p>[39;22m[39;1m\n
                [39;22m[39;1m<p class="text-muted small">[39;22m[39;1mYes, it's [39;22m[39;1m<strike>[39;22m[39;1ma bit[39;22m[39;1m</strike>[39;22m[39;1m [39;22m[39;1m<strong>[39;22m[39;1mvery[39;22m[39;1m</strong>[39;22m[39;1m slow...[39;22m[39;1m</p>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `,\n
        \n
        5: `\n
            [39;22m[39;1m<div class="text-center mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<div class="badge bg-success mb-2">[39;22m[39;1mAI Results[39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<h6 class="text-muted">[39;22m[39;1mOK, I think it worked...[39;22m[39;1m</h6>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            [39;22m[39;1m<div id="ai-success-content" class="d-none">[39;22m[39;1m\n
                [39;22m[39;1m<div class="alert alert-success py-2">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-check-circle me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                    [39;22m[39;1m<strong>[39;22m[39;1mSuccess![39;22m[39;1m</strong>[39;22m[39;1m AI found information about this person.\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                \n
                [39;22m[39;1m<div class="card mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card-body p-3">[39;22m[39;1m\n
                        [39;22m[39;1m<h6 class="card-title">[39;22m[39;1mSummary of Found Information[39;22m[39;1m</h6>[39;22m[39;1m\n
                        [39;22m[39;1m<div id="ai-summary" class="small">[39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                \n
                [39;22m[39;1m<div class="card">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card-body p-3">[39;22m[39;1m\n
                        [39;22m[39;1m<h6 class="card-title">[39;22m[39;1mRaw YAML Data[39;22m[39;1m</h6>[39;22m[39;1m\n
                        [39;22m[39;1m<div id="ai-details" class="small">[39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            [39;22m[39;1m<div id="ai-error-content" class="d-none">[39;22m[39;1m\n
                [39;22m[39;1m<div class="alert alert-warning py-2">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-exclamation-triangle me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                    [39;22m[39;1m<strong>[39;22m[39;1mLimited Information[39;22m[39;1m</strong>[39;22m[39;1m AI couldn't find much information about this person.\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
                \n
                [39;22m[39;1m<div class="card">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card-body p-3">[39;22m[39;1m\n
                        [39;22m[39;1m<h6 class="card-title">[39;22m[39;1mAvailable Information[39;22m[39;1m</h6>[39;22m[39;1m\n
                        [39;22m[39;1m<div id="ai-error-details" class="small">[39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `,\n
        \n
        6: `\n
            [39;22m[39;1m<div class="text-center mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<div class="badge bg-warning mb-2">[39;22m[39;1mMerge Available[39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<h6 class="text-muted">[39;22m[39;1mMerge Confirmation[39;22m[39;1m</h6>[39;22m[39;1m\n
                [39;22m[39;1m<p class="mb-3">[39;22m[39;1mA span with this name and type already exists. Do you want to merge the AI data into the existing span?[39;22m[39;1m</p>[39;22m[39;1m\n
                [39;22m[39;1m<div class="card mb-3">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="card-body p-2">[39;22m[39;1m\n
                        [39;22m[39;1m<strong>[39;22m[39;1mExisting Span:[39;22m[39;1m</strong>[39;22m[39;1m<br>[39;22m[39;1m\n
                        [39;22m[39;1m<span id="merge-existing-name">[39;22m[39;1m</span>[39;22m[39;1m [39;22m[39;1m<span class="text-muted">[39;22m[39;1m([39;22m[39;1m<span id="merge-existing-type">[39;22m[39;1m</span>[39;22m[39;1m)[39;22m[39;1m</span>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `,\n
        \n
        7: `\n
            [39;22m[39;1m<div class="text-center mb-3">[39;22m[39;1m\n
                [39;22m[39;1m<div class="badge bg-success mb-2">[39;22m[39;1mSuccess![39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m<h6 class="text-muted">[39;22m[39;1mSpan Created Successfully[39;22m[39;1m</h6>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            [39;22m[39;1m<div class="alert alert-success">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-check-circle me-2">[39;22m[39;1m</i>[39;22m[39;1m\n
                [39;22m[39;1m<strong>[39;22m[39;1mSpan created successfully![39;22m[39;1m</strong>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `\n
    };\n
    \n
    // Footer templates\n
    const stepFooter = {\n
        1: `\n
            [39;22m[39;1m<button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-x-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mCancel\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m<button type="button" class="btn btn-primary px-4" id="next-step-btn" tabindex="1" autofocus>[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-arrow-right me-1">[39;22m[39;1m</i>[39;22m[39;1mNext\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
        `,\n
        \n
        2: `\n
            [39;22m[39;1m<button type="button" class="btn btn-outline-secondary me-2" id="back-to-step1">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-arrow-left me-1">[39;22m[39;1m</i>[39;22m[39;1mBack\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
        `,\n
        \n
        3: `\n
            [39;22m[39;1m<div class="d-flex align-items-center">[39;22m[39;1m\n
                [39;22m[39;1m<div class="me-3">[39;22m[39;1m\n
                    [39;22m[39;1m<div class="btn-group btn-group-sm" role="group" aria-label="Span state selection">[39;22m[39;1m                                 \n
                        [39;22m[39;1m<input type="radio" class="btn-check" name="state" id="state_placeholder" value="placeholder" checked>[39;22m[39;1m\n
                        [39;22m[39;1m<label class="btn btn-outline-secondary" for="state_placeholder">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-question-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mPlaceholder\n
                        [39;22m[39;1m</label>[39;22m[39;1m\n
                        \n
                        [39;22m[39;1m<input type="radio" class="btn-check" name="state" id="state_draft" value="draft">[39;22m[39;1m\n
                        [39;22m[39;1m<label class="btn btn-outline-secondary" for="state_draft">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-pencil me-1">[39;22m[39;1m</i>[39;22m[39;1mDraft\n
                        [39;22m[39;1m</label>[39;22m[39;1m\n
\n
                        [39;22m[39;1m<input type="radio" class="btn-check" name="state" id="state_complete" value="complete">[39;22m[39;1m\n
                        [39;22m[39;1m<label class="btn btn-outline-secondary" for="state_complete">[39;22m[39;1m\n
                            [39;22m[39;1m<i class="bi bi-check-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mComplete\n
                        [39;22m[39;1m</label>[39;22m[39;1m\n
                    [39;22m[39;1m</div>[39;22m[39;1m\n
                    [39;22m[39;1m<div class="invalid-feedback" id="state-error">[39;22m[39;1m</div>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
            \n
            [39;22m[39;1m<div class="ms-auto">[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-x-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mCancel\n
                [39;22m[39;1m</button>[39;22m[39;1m\n
                [39;22m[39;1m<button type="button" class="btn btn-primary px-4" id="save-span-btn" tabindex="1" autofocus>[39;22m[39;1m\n
                    [39;22m[39;1m<i class="bi bi-check-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mCreate Span\n
                [39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m</div>[39;22m[39;1m\n
        `,\n
        \n
        4: `\n
            [39;22m[39;1m<button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-x-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mCancel\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
        `,\n
        \n
        5: `\n
            [39;22m[39;1m<button type="button" class="btn btn-outline-secondary me-2" id="back-to-manual" \n
                    aria-label="Go back to manual creation form">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-pencil me-1">[39;22m[39;1m</i>[39;22m[39;1mCreate Manually\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m<button type="button" class="btn btn-primary px-4" id="confirm-ai-btn" \n
                    aria-label="Create span using AI generated data" tabindex="1" autofocus>[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-check-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mCreate with AI Data\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
        `,\n
        \n
        6: `\n
            [39;22m[39;1m<button type="button" class="btn btn-outline-secondary me-2" id="cancel-merge-btn">[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-x-circle me-1">[39;22m[39;1m</i>[39;22m[39;1mCancel\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
            [39;22m[39;1m<button type="button" class="btn btn-primary px-4" id="confirm-merge-btn" tabindex="1" autofocus>[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-arrow-repeat me-1">[39;22m[39;1m</i>[39;22m[39;1mMerge and Update\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
        `,\n
        \n
        7: `\n
            [39;22m[39;1m<button type="button" class="btn btn-primary px-4" id="view-span-btn" \n
                    aria-label="View the newly created span" tabindex="1" autofocus>[39;22m[39;1m\n
                [39;22m[39;1m<i class="bi bi-eye me-1">[39;22m[39;1m</i>[39;22m[39;1mView Span\n
            [39;22m[39;1m</button>[39;22m[39;1m\n
        `\n
    };\n
    \n
    function showStep(step) {\n
        currentStep = step;\n
        \n
        // Update modal content\n
        $('#modal-content').html(stepContent[step]);\n
        $('#modal-footer').html(stepFooter[step]);\n
        \n
        // Re-attach event listeners for the new content\n
        attachEventListeners(step);\n
        \n
        // Prefill form fields if in improve mode\n
        if (isImproveMode && step === 1) {\n
            $('#modal_name').val(formData.name);\n
            $('#modal_type_id').val(formData.type_id);\n
        }\n
        \n
        // Autofill merge info if merge step\n
        if (step === 6 && window.mergeData) {\n
            $('#merge-existing-name').text(window.mergeData.existing_span.name);\n
            $('#merge-existing-type').text(window.mergeData.existing_span.type_id);\n
        }\n
    }\n
    \n
    function attachEventListeners(step) {\n
        if (step === 1) {\n
            // Step 1: Next button\n
            $('#next-step-btn').on('click', function() {\n
                const name = $('#modal_name').val().trim();\n
                const typeId = $('#modal_type_id').val();\n
                \n
                if (!name || !typeId) {\n
                    if (!name) {\n
                        $('#modal_name').addClass('is-invalid');\n
                        $('#name-error').text('Name is required');\n
                    }\n
                    if (!typeId) {\n
                        $('#modal_type_id').addClass('is-invalid');\n
                        $('#type_id-error').text('Type is required');\n
                    }\n
                    return;\n
                }\n
                \n
                // Clear validation errors\n
                $('.is-invalid').removeClass('is-invalid');\n
                $('.invalid-feedback').text('');\n
                \n
                // Store form data\n
                formData.name = name;\n
                formData.type_id = typeId;\n
                \n
                if (typeId === 'person') {\n
                    showStep(2);\n
                } else {\n
                    showStep(3);\n
                }\n
            });\n
        }\n
        \n
        if (step === 2) {\n
            // Step 2: Card selection\n
            $('#create-manual-card, #create-ai-card').on('click', function() {\n
                $('.card').removeClass('selected');\n
                $(this).addClass('selected');\n
                \n
                if ($(this).attr('id') === 'create-manual-card') {\n
                    selectedCreationMethod = 'manual';\n
                    showStep(3);\n
                } else {\n
                    selectedCreationMethod = 'ai';\n
                    showStep(4);\n
                    startAiProcess();\n
                }\n
            });\n
            \n
            // Back button\n
            $('#back-to-step1').on('click', function() {\n
                showStep(1);\n
            });\n
        }\n
        \n
        if (step === 3) {\n
            // Step 3: Manual form\n
            $('#save-span-btn').on('click', function() {\n
                const form = $('#new-span-form');\n
                const formDataObj = new FormData(form[0]);\n
                \n
                // Add stored data\n
                formDataObj.append('name', formData.name);\n
                formDataObj.append('type_id', formData.type_id);\n
                formDataObj.append('_token', $('meta[name="csrf-token"]').attr('content'));\n
                \n
                // Ensure state is set\n
                const selectedState = $('input[name="state"]:checked').val();\n
                if (!selectedState) {\n
                    $('#state_placeholder').prop('checked', true);\n
                    formDataObj.set('state', 'placeholder');\n
                } else {\n
                    formDataObj.set('state', selectedState);\n
                }\n
                \n
                // Clear previous errors\n
                $('.is-invalid').removeClass('is-invalid');\n
                $('.invalid-feedback').text('');\n
                \n
                $.ajax({\n
                    url: 'http://localhost:8000/spans',\n
                    method: 'POST',\n
                    data: formDataObj,\n
                    processData: false,\n
                    contentType: false,\n
                    headers: {\n
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content'),\n
                        'Accept': 'application/json'\n
                    },\n
                    success: function(response) {\n
                        $('#newSpanModal').modal('hide');\n
                        \n
                        if (typeof showAlert === 'function') {\n
                            showAlert('Span created successfully!', 'success');\n
                        } else {\n
                            alert('Span created successfully!');\n
                        }\n
                        \n
                        if (response.span_id) {\n
                            window.location.href = '/spans/' + response.span_id;\n
                        } else {\n
                            window.location.reload();\n
                        }\n
                    },\n
                    error: function(xhr) {\n
                        if (xhr.status === 422) {\n
                            const errors = xhr.responseJSON.errors;\n
                            Object.keys(errors).forEach(function(field) {\n
                                let input;\n
                                if (field === 'state') {\n
                                    input = $('input[name="state"]').closest('.btn-group');\n
                                } else {\n
                                    input = $('#modal_' + field);\n
                                }\n
                                const errorDiv = $('#' + field + '-error');\n
                                \n
                                input.addClass('is-invalid');\n
                                errorDiv.text(errors[field][0]);\n
                            });\n
                        } else {\n
                            alert('An error occurred while creating the span. Please try again.');\n
                        }\n
                    }\n
                });\n
            });\n
        }\n
        \n
        if (step === 5) {\n
            // Step 5: AI results\n
            $('#back-to-manual').on('click', function() {\n
                showStep(3);\n
            });\n
            \n
            $('#confirm-ai-btn').on('click', function() {\n
                if (!aiData) {\n
                    alert('No AI data available');\n
                    return;\n
                }\n
                \n
                // Show loading state\n
                const btn = $(this);\n
                const originalText = btn.html();\n
                btn.prop('disabled', true);\n
                btn.html('[39;22m[39;1m<span class="spinner-border spinner-border-sm me-1">[39;22m[39;1m</span>[39;22m[39;1mCreating...');\n
                \n
                // Create span with AI data\n
                $.ajax({\n
                    url: 'http://localhost:8000/spans',\n
                    method: 'POST',\n
                    data: {\n
                        name: formData.name,\n
                        type_id: formData.type_id,\n
                        state: 'placeholder',\n
                        ai_yaml: aiData.yaml,\n
                        _token: $('meta[name="csrf-token"]').attr('content')\n
                    },\n
                    success: function(response) {\n
                        if (response.merge_available) {\n
                            window.mergeData = response;\n
                            showStep(6);\n
                            return;\n
                        }\n
                        showCreationSuccess(response);\n
                    },\n
                    error: function(xhr) {\n
                        // Reset button state\n
                        btn.prop('disabled', false);\n
                        btn.html(originalText);\n
                        showStep(5);\n
                        alert('Failed to create span with AI data. Please try again.');\n
                    }\n
                });\n
            });\n
        }\n
        if (step === 6) {\n
            // Merge confirmation step\n
            $('#confirm-merge-btn').on('click', function() {\n
                if (!window.mergeData) return;\n
                \n
                // Show loading state\n
                const btn = $(this);\n
                const originalText = btn.html();\n
                btn.prop('disabled', true);\n
                btn.html('[39;22m[39;1m<span class="spinner-border spinner-border-sm me-1">[39;22m[39;1m</span>[39;22m[39;1mMerging...');\n
                \n
                // Send confirm_merge=true\n
                $.ajax({\n
                    url: 'http://localhost:8000/spans',\n
                    method: 'POST',\n
                    data: {\n
                        name: formData.name,\n
                        type_id: formData.type_id,\n
                        state: 'placeholder',\n
                        ai_yaml: aiData.yaml,\n
                        confirm_merge: true,\n
                        _token: $('meta[name="csrf-token"]').attr('content')\n
                    },\n
                    success: function(response) {\n
                        showCreationSuccess(response);\n
                    },\n
                    error: function(xhr) {\n
                        // Reset button state\n
                        btn.prop('disabled', false);\n
                        btn.html(originalText);\n
                        alert('Failed to merge and update span. Please try again.');\n
                    }\n
                });\n
            });\n
            $('#cancel-merge-btn').on('click', function() {\n
                showStep(5);\n
            });\n
        }\n
        \n
        if (step === 7) {\n
            // Step 7: Success summary\n
            $('#view-span-btn').on('click', function() {\n
                $('#newSpanModal').modal('hide');\n
                \n
                if (window.aiCreationResponse && window.aiCreationResponse.span_id) {\n
                    window.location.href = '/spans/' + window.aiCreationResponse.span_id;\n
                } else {\n
                    window.location.reload();\n
                }\n
            });\n
        }\n
    }\n
    \n
    function updateStartYearRequirement() {\n
        const typeSelect = document.getElementById('modal_type_id');\n
        const stateInputs = document.querySelectorAll('input[name="state"]');\n
        const startYearInput = document.getElementById('modal_start_year');\n
        \n
        if (!typeSelect || !startYearInput) return;\n
        \n
        const selectedType = typeSelect.value;\n
        const selectedState = Array.from(stateInputs).find(input => input.checked)?.value;\n
        \n
        const isTimeless = timelessSpanTypes.includes(selectedType);\n
        const isPlaceholder = selectedState === 'placeholder';\n
        \n
        if (isTimeless || isPlaceholder) {\n
            startYearInput.removeAttribute('required');\n
        } else {\n
            startYearInput.setAttribute('required', 'required');\n
        }\n
    }\n
    \n
    // AI Process\n
    function startAiProcess() {\n
        const name = formData.name;\n
        $('#ai-person-name').text(name);\n
        \n
        $.ajax({\n
            url: 'http://localhost:8000/ai-yaml-generator/generate',\n
            method: 'POST',\n
            data: {\n
                name: name,\n
                _token: $('meta[name="csrf-token"]').attr('content')\n
            },\n
            success: function(response) {\n
                if (response.success) {\n
                    aiData = response;\n
                    showAiResults(true);\n
                } else {\n
                    showAiResults(false, response.error);\n
                }\n
            },\n
            error: function(xhr) {\n
                showAiResults(false, 'Failed to generate AI data');\n
            }\n
        });\n
    }\n
    \n
    function showAiResults(success, error = null) {\n
        if (success) {\n
            $('#ai-success-content').removeClass('d-none');\n
            $('#ai-error-content').addClass('d-none');\n
            \n
            // Parse YAML and generate summary\n
            const summary = parseYamlSummary(aiData.yaml);\n
            $('#ai-summary').html(summary);\n
            \n
            // Display AI generated details (truncated for compact view)\n
            const details = aiData.yaml;\n
            const truncatedDetails = details.length > 300 ? details.substring(0, 300) + '...' : details;\n
            $('#ai-details').html(`[39;22m[39;1m<pre class="mb-0 small">[39;22m[39;1m<code>[39;22m[39;1m${truncatedDetails}[39;22m[39;1m</code>[39;22m[39;1m</pre>[39;22m[39;1m`);\n
        } else {\n
            $('#ai-success-content').addClass('d-none');\n
            $('#ai-error-content').removeClass('d-none');\n
            $('#ai-error-details').text(error || 'An error occurred');\n
        }\n
        \n
        showStep(5);\n
    }\n
    \n
    function parseYamlSummary(yamlText) {\n
        try {\n
            // Simple YAML parsing to extract key information\n
            const lines = yamlText.split('\n');\n
            const summary = [];\n
            \n
            // Extract basic info\n
            const nameMatch = yamlText.match(/name:\s*['"]?([^'\n]+)['"]?/);\n
            const typeMatch = yamlText.match(/type:\s*(\w+)/);\n
            const startMatch = yamlText.match(/start:\s*['"]?([^'\n]+)['"]?/);\n
            const endMatch = yamlText.match(/end:\s*['"]?([^'\n]+)['"]?/);\n
            \n
            if (nameMatch) summary.push(`[39;22m[39;1m<strong>[39;22m[39;1mName:[39;22m[39;1m</strong>[39;22m[39;1m ${nameMatch[1]}`);\n
            if (typeMatch) summary.push(`[39;22m[39;1m<strong>[39;22m[39;1mType:[39;22m[39;1m</strong>[39;22m[39;1m ${typeMatch[1]}`);\n
            if (startMatch) summary.push(`[39;22m[39;1m<strong>[39;22m[39;1mStart:[39;22m[39;1m</strong>[39;22m[39;1m ${startMatch[1]}`);\n
            if (endMatch) summary.push(`[39;22m[39;1m<strong>[39;22m[39;1mEnd:[39;22m[39;1m</strong>[39;22m[39;1m ${endMatch[1]}`);\n
            \n
            // Count connections\n
            const connectionTypes = ['parents', 'children', 'relationship', 'employment', 'education', 'residence'];\n
            const connections = [];\n
            \n
            connectionTypes.forEach(type => {\n
                const regex = new RegExp(`${type}:\\s*\\n\\s*-\\s*name:`, 'g');\n
                const matches = yamlText.match(regex);\n
                if (matches) {\n
                    connections.push(`${matches.length} ${type}`);\n
                }\n
            });\n
            \n
            if (connections.length > 0) {\n
                summary.push(`[39;22m[39;1m<strong>[39;22m[39;1mConnections:[39;22m[39;1m</strong>[39;22m[39;1m ${connections.join(', ')}`);\n
            }\n
            \n
            // Extract metadata\n
            const metadataMatches = yamlText.match(/metadata:\s*\n((?:\s+[^:\n]+:\s*[^\n]+\n?)+)/);\n
            if (metadataMatches) {\n
                const metadataLines = metadataMatches[1].split('\n').filter(line => line.trim());\n
                const metadata = metadataLines.map(line => {\n
                    const match = line.match(/\s+([^:]+):\s*(.+)/);\n
                    return match ? `${match[1].trim()}: ${match[2].trim()}` : null;\n
                }).filter(Boolean);\n
                \n
                if (metadata.length > 0) {\n
                    summary.push(`[39;22m[39;1m<strong>[39;22m[39;1mDetails:[39;22m[39;1m</strong>[39;22m[39;1m ${metadata.join(', ')}`);\n
                }\n
            }\n
            \n
            return summary.length > 0 ? summary.join('[39;22m[39;1m<br>[39;22m[39;1m') : 'Information found but details not parsed';\n
            \n
        } catch (error) {\n
            return 'Information found but could not parse details';\n
        }\n
    }\n
    \n
    function showCreationSuccess(response) {\n
        // Store the response for the view button\n
        window.aiCreationResponse = response;\n
        \n
        // Show success step\n
        showStep(7);\n
    }\n
    \n
    function showCreationSummary(response) {\n
        if (response.span) {\n
            // Format the start date nicely\n
            let startDate = 'Not specified';\n
            if (response.span.start_year) {\n
                if (response.span.start_month && response.span.start_day) {\n
                    startDate = `${response.span.start_day}/${response.span.start_month}/${response.span.start_year}`;\n
                } else if (response.span.start_month) {\n
                    startDate = `${response.span.start_month}/${response.span.start_year}`;\n
                } else {\n
                    startDate = response.span.start_year.toString();\n
                }\n
            }\n
            \n
            return `\n
                [39;22m[39;1m<div class="text-center">[39;22m[39;1m\n
                    [39;22m[39;1m<h5 class="mb-3">[39;22m[39;1m${response.span.name}[39;22m[39;1m</h5>[39;22m[39;1m\n
                    [39;22m[39;1m<p class="text-muted mb-3">[39;22m[39;1m\n
                        [39;22m[39;1m<i class="bi bi-calendar-event me-1">[39;22m[39;1m</i>[39;22m[39;1m\n
                        ${startDate}\n
                    [39;22m[39;1m</p>[39;22m[39;1m\n
                [39;22m[39;1m</div>[39;22m[39;1m\n
            `;\n
        }\n
        \n
        return '[39;22m[39;1m<p class="text-muted">[39;22m[39;1mSpan created successfully[39;22m[39;1m</p>[39;22m[39;1m';\n
    }\n
    \n
    // Initialize modal\n
    $('#newSpanModal').on('show.bs.modal', function() {\n
        showStep(1);\n
    });\n
    \n
    // Reset form when modal is hidden\n
    $('#newSpanModal').on('hidden.bs.modal', function() {\n
        // Reset variables\n
        currentStep = 1;\n
        aiData = null;\n
        selectedCreationMethod = null;\n
        formData = {};\n
        window.aiCreationResponse = null;\n
        window.mergeData = null; // Reset merge data\n
        \n
        // Clear any validation errors\n
        $('.is-invalid').removeClass('is-invalid');\n
        $('.invalid-feedback').text('');\n
    });\n
});\n
[39;22m[39;1m</script>[39;22m[39;1m         \n
        <!-- Sidebar Toggle Script -->\n
                [39;22m[39;1m<script>[39;22m[39;1m\n
            $(document).ready(function() {\n
                // Get stored sidebar state from cookie\n
                const sidebarCollapsed = document.cookie.split('; ').find(row => row.startsWith('sidebarCollapsed='))?.split('=')[1] === 'true';\n
                \n
                // Set initial state based on cookie (no animation)\n
                if (sidebarCollapsed) {\n
                    $('#sidebar').addClass('collapsed');\n
                    $('#sidebar-toggle').addClass('collapsed');\n
                }\n
                \n
                // Enable animations after DOM is ready\n
                setTimeout(function() {\n
                    $('#sidebar').addClass('animated');\n
                    $('#main-content').addClass('animated');\n
                    $('#sidebar-toggle').addClass('animated');\n
                }, 50);\n
                \n
                // Sidebar toggle functionality\n
                $('#sidebar-toggle').on('click', function() {\n
                    const sidebar = $('#sidebar');\n
                    const toggle = $(this);\n
                    \n
                    // Add animating class to hide text during transition\n
                    sidebar.addClass('animating');\n
                    \n
                    sidebar.toggleClass('collapsed');\n
                    toggle.toggleClass('collapsed');\n
                    \n
                    // Remove animating class after transition completes\n
                    setTimeout(function() {\n
                        sidebar.removeClass('animating');\n
                    }, 300); // Match the transition duration\n
                    \n
                    // Store state in cookie (expires in 1 year)\n
                    const isCollapsed = sidebar.hasClass('collapsed');\n
                    document.cookie = `sidebarCollapsed=${isCollapsed}; path=/; max-age=${365 * 24 * 60 * 60}`;\n
                    \n
                    // Update tooltips\n
                    if (sidebar.hasClass('collapsed')) {\n
                        // Enable tooltips for collapsed state\n
                        $('.sidebar .nav-link, .sidebar .sidebar-brand').each(function() {\n
                            const $link = $(this);\n
                            const text = $link.text().trim();\n
                            if (text) {\n
                                $link.attr('data-bs-toggle', 'tooltip');\n
                                $link.attr('data-bs-placement', 'right');\n
                                $link.attr('title', text);\n
                            }\n
                        });\n
                        $('[data-bs-toggle="tooltip"]').tooltip();\n
                    } else {\n
                        // Disable tooltips for expanded state\n
                        $('.sidebar .nav-link, .sidebar .sidebar-brand').tooltip('dispose');\n
                        $('.sidebar .nav-link, .sidebar .sidebar-brand').removeAttr('data-bs-toggle data-bs-placement title');\n
                    }\n
                });\n
                \n
                // Initialize tooltips if sidebar starts collapsed\n
                if (sidebarCollapsed) {\n
                    $('.sidebar .nav-link, .sidebar .sidebar-brand').each(function() {\n
                        const $link = $(this);\n
                        const text = $link.text().trim();\n
                        if (text) {\n
                            $link.attr('data-bs-toggle', 'tooltip');\n
                            $link.attr('data-bs-placement', 'right');\n
                            $link.attr('title', text);\n
                        }\n
                    });\n
                    $('[data-bs-toggle="tooltip"]').tooltip();\n
                }\n
            });\n
        [39;22m[39;1m</script>[39;22m[39;1m\n
            [39;22m[39;1m</body>[39;22m[39;1m\n
[39;22m[39;1m</html>[39;22m[39;1m\n
' [UTF-8](length: 191995) contains "Existing Span Detected" [ASCII](length: 22).[39;22m

  at [32mtests/Feature/YamlMergeTest.php[39m:[32m71[39m
    [90m 67[0m[90m▕ [0m[35;1m        [0m[39;1m$foundSpan [0m[35;1m= [0m[39;1m$yamlSpanService[0m[35;1m->[0m[39;1mfindExistingSpan[0m[35;1m([0m[39;1m$data[0m[35;1m[[0m[37m'name'[0m[35;1m], [0m[39;1m$data[0m[35;1m[[0m[37m'type'[0m[35;1m]);[0m
    [90m 68[0m[90m▕ [0m[35;1m        [0m
    [90m 69[0m[90m▕ [0m[35;1m        if ([0m[39;1m$foundSpan[0m[35;1m) {[0m
    [90m 70[0m[90m▕ [0m[35;1m            [0m[90;3m// The span should be found, so let's check if the view has the merge section[0m
[31;1m  ➜ [0m[3;1m 71[0m[90m▕ [0m[90;3m            [0m[39;1m$response[0m[35;1m->[0m[39;1massertSee[0m[35;1m([0m[37m'Existing Span Detected'[0m[35;1m);[0m
    [90m 72[0m[90m▕ [0m[35;1m            [0m[39;1m$response[0m[35;1m->[0m[39;1massertSee[0m[35;1m([0m[37m'John Doe'[0m[35;1m);[0m
    [90m 73[0m[90m▕ [0m[35;1m            [0m[39;1m$response[0m[35;1m->[0m[39;1massertSee[0m[35;1m([0m[37m'Merge AI Data with Existing Span'[0m[35;1m);[0m
    [90m 74[0m[90m▕ [0m[35;1m        } else {[0m
    [90m 75[0m[90m▕ [0m[35;1m            [0m[39;1m$this[0m[35;1m->[0m[39;1mfail[0m[35;1m([0m[37m'Existing span was not found by the service'[0m[35;1m);[0m


  [90mTests:[39m    [31;1m24 failed[39;22m[90m,[39m[39m [39m[33;1m32 skipped[39;22m[90m,[39m[39m [39m[32;1m290 passed[39;22m[90m (3593 assertions)[39m
  [90mDuration:[39m [39m90.66s[39m

[0;31m[2025-07-09 18:24:50][0m Pest tests failed with exit code: 2
